import{playWave as Ru,setWaveVolume as F1,stopMidi as r1,setMidiVolume as k1,playMidi as _u}from"./deps.js";var d=document.getElementById("canvas"),C=d.getContext("2d",{willReadFrequently:!0}),p0=document.createElement("canvas"),P0=document.createElement("img"),u1=p0.getContext("2d",{willReadFrequently:!0});class n0{key=0n;next=null;prev=null;unlink(){if(this.prev!=null){if(this.prev.next=this.next,this.next)this.next.prev=this.prev;this.next=null,this.prev=null}}}class V0 extends n0{next2=null;prev2=null;unlink2(){if(this.prev2!==null){if(this.prev2.next2=this.next2,this.next2)this.next2.prev2=this.prev2;this.next2=null,this.prev2=null}}}class F extends V0{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind(u,R,m){this.pixels=u,this.width2d=R,this.height2d=m,this.setBounds(0,0,R,m)}static resetBounds(){this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0}static setBounds(u,R,m,_){if(u<0)u=0;if(R<0)R=0;if(m>this.width2d)m=this.width2d;if(_>this.height2d)_=this.height2d;this.top=R,this.bottom=_,this.left=u,this.right=m,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0}static clear(){let u=this.width2d*this.height2d;for(let R=0;R<u;R++)this.pixels[R]=0}static drawRect(u,R,m,_,b){this.drawHorizontalLine(u,R,b,m),this.drawHorizontalLine(u,R+_-1,b,m),this.drawVerticalLine(u,R,b,_),this.drawVerticalLine(u+m-1,R,b,_)}static drawRectAlpha(u,R,m,_,b,E){if(this.drawHorizontalLineAlpha(u,R,b,m,E),this.drawHorizontalLineAlpha(u,R+_-1,b,m,E),_>=3)this.drawVerticalLineAlpha(u,R,b,_,E),this.drawVerticalLineAlpha(u+m-1,R,b,_,E)}static drawHorizontalLine(u,R,m,_){if(R<this.top||R>=this.bottom)return;if(u<this.left)_-=this.left-u,u=this.left;if(u+_>this.right)_=this.right-u;let b=u+R*this.width2d;for(let E=0;E<_;E++)this.pixels[b+E]=m}static drawHorizontalLineAlpha=(u,R,m,_,b)=>{if(R<this.top||R>=this.bottom)return;if(u<this.left)_-=this.left-u,u=this.left;if(u+_>this.right)_=this.right-u;let E=256-b,O=(m>>16&255)*b,I=(m>>8&255)*b,L=(m&255)*b,H=this.width2d-_,N=u+R*this.width2d;for(let G=0;G<_;G++){let Q=(this.pixels[N]>>16&255)*E,$=(this.pixels[N]>>8&255)*E,T=(this.pixels[N]&255)*E,U=(O+Q>>8<<16)+(I+$>>8<<8)+(L+T>>8);this.pixels[N++]=U}};static drawVerticalLine(u,R,m,_){if(u<this.left||u>=this.right)return;if(R<this.top)_-=this.top-R,R=this.top;if(R+_>this.bottom)_=this.bottom-R;let b=u+R*this.width2d;for(let E=0;E<_;E++)this.pixels[b+E*this.width2d]=m}static drawVerticalLineAlpha=(u,R,m,_,b)=>{if(u<this.left||u>=this.right)return;if(R<this.top)_-=this.top-R,R=this.top;if(R+_>this.bottom)_=this.bottom-R;let E=256-b,O=(m>>16&255)*b,I=(m>>8&255)*b,L=(m&255)*b,H=u+R*this.width2d;for(let N=0;N<_;N++){let G=(this.pixels[H]>>16&255)*E,Q=(this.pixels[H]>>8&255)*E,$=(this.pixels[H]&255)*E,T=(O+G>>8<<16)+(I+Q>>8<<8)+(L+$>>8);this.pixels[H]=T,H+=this.width2d}};static drawLine(u,R,m,_,b){let E=Math.abs(m-u),O=Math.abs(_-R),I=u<m?1:-1,L=R<_?1:-1,H=E-O;while(!0){if(u>=this.left&&u<this.right&&R>=this.top&&R<this.bottom)this.pixels[u+R*this.width2d]=b;if(u===m&&R===_)break;let N=2*H;if(N>-O)H=H-O,u=u+I;if(N<E)H=H+E,R=R+L}}static fillRect2d(u,R,m,_,b){if(u<this.left)m-=this.left-u,u=this.left;if(R<this.top)_-=this.top-R,R=this.top;if(u+m>this.right)m=this.right-u;if(R+_>this.bottom)_=this.bottom-R;let E=this.width2d-m,O=u+R*this.width2d;for(let I=-_;I<0;I++){for(let L=-m;L<0;L++)this.pixels[O++]=b;O+=E}}static fillRectAlpha(u,R,m,_,b,E){if(u<this.left)m-=this.left-u,u=this.left;if(R<this.top)_-=this.top-R,R=this.top;if(u+m>this.right)m=this.right-u;if(R+_>this.bottom)_=this.bottom-R;let O=256-E,I=(b>>16&255)*E,L=(b>>8&255)*E,H=(b&255)*E,N=this.width2d-m,G=u+R*this.width2d;for(let Q=0;Q<_;Q++){for(let $=-m;$<0;$++){let T=(this.pixels[G]>>16&255)*O,U=(this.pixels[G]>>8&255)*O,K=(this.pixels[G]&255)*O,q=(I+T>>8<<16)+(L+U>>8<<8)+(H+K>>8);this.pixels[G++]=q}G+=N}}static fillCircle(u,R,m,_,b){let E=256-b,O=(_>>16&255)*b,I=(_>>8&255)*b,L=(_&255)*b,H=R-m;if(H<0)H=0;let N=R+m;if(N>=this.height2d)N=this.height2d-1;for(let G=H;G<=N;G++){let Q=G-R,$=Math.sqrt(m*m-Q*Q)|0,T=u-$;if(T<0)T=0;let U=u+$;if(U>=this.width2d)U=this.width2d-1;let K=T+G*this.width2d;for(let q=T;q<=U;q++){let w=(this.pixels[K]>>16&255)*E,V=(this.pixels[K]>>8&255)*E,Y=(this.pixels[K]&255)*E,A=(O+w>>8<<16)+(I+V>>8<<8)+(L+Y>>8);this.pixels[K++]=A}}}static setPixel(u,R,m){if(u<this.left||u>=this.right||R<this.top||R>=this.bottom)return;this.pixels[u+R*this.width2d]=m}}class J0{sentinel=new n0;cursor=null;constructor(){this.sentinel.next=this.sentinel,this.sentinel.prev=this.sentinel}push(u){if(u.prev)u.unlink();if(u.prev=this.sentinel.prev,u.next=this.sentinel,u.prev)u.prev.next=u;u.next.prev=u}addHead(u){if(u.prev)u.unlink();if(u.prev=this.sentinel,u.next=this.sentinel.next,u.prev.next=u,u.next)u.next.prev=u}pop(){let u=this.sentinel.next;if(u===this.sentinel)return null;return u?.unlink(),u}head(){let u=this.sentinel.next;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.next||null,u}tail(){let u=this.sentinel.prev;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.prev||null,u}next(){let u=this.cursor;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.next||null,u}prev(){let u=this.cursor;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.prev||null,u}clear(){while(!0){let u=this.sentinel.next;if(u===this.sentinel)return;u?.unlink()}}}var X0=async(u)=>new Promise((R)=>setTimeout(R,u)),r0=async(u)=>new Uint8Array(await(await fetch(u)).arrayBuffer());function V1(u,R,m,_,b){while(b--)m[_++]=u[R++]}function n1(u){let R=0n;for(let m=0;m<u.length;m++)R=R<<8n|BigInt(u[m]);return R}function X1(u){let R=[];while(u>0n)R.unshift(Number(u&0xffn)),u>>=8n;if(R[0]&128)R.unshift(0);return new Uint8Array(R)}function f1(u,R,m){let _=1n;while(R>0n){if(R%2n===1n)_=_*u%m;u=u*u%m,R>>=1n}return _}class z extends V0{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new J0;static cacheMid=new J0;static cacheMax=new J0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let u=0;u<32;u++)z.bitmask[u]=(1<<u)-1;z.bitmask[32]=4294967295;for(let u=0;u<256;u++){let R=u;for(let m=0;m<8;m++)if((R&1)===1)R=R>>>1^z.CRC32_POLYNOMIAL;else R>>>=1;z.crctable[u]=R}}static getcrc(u,R,m){let _=4294967295;for(let b=R;b<m;b++)_=_>>>8^this.crctable[(_^u[b])&255];return~_}static checkcrc(u,R,m,_=0){return z.getcrc(u,R,m)==_}view;data;pos=0;bitPos=0;random=null;constructor(u){if(!u)throw new Error;super();if(u instanceof Int8Array)this.data=new Uint8Array(u);else this.data=u;this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.view.byteLength-this.pos}static alloc(u){let R=null;if(u===0&&z.cacheMinCount>0)z.cacheMinCount--,R=z.cacheMin.pop();else if(u===1&&z.cacheMidCount>0)z.cacheMidCount--,R=z.cacheMid.pop();else if(u===2&&z.cacheMaxCount>0)z.cacheMaxCount--,R=z.cacheMax.pop();if(R)return R.pos=0,R;if(u===0)return new z(new Uint8Array(100));else if(u===1)return new z(new Uint8Array(5000));else return new z(new Uint8Array(30000))}release(){if(this.pos=0,this.length===100&&z.cacheMinCount<1000)z.cacheMin.push(this),z.cacheMinCount++;else if(this.length===5000&&z.cacheMidCount<250)z.cacheMid.push(this),z.cacheMidCount++;else if(this.length===30000&&z.cacheMaxCount<50)z.cacheMax.push(this),z.cacheMaxCount++}g1(){return this.view.getUint8(this.pos++)}g1b(){return this.view.getInt8(this.pos++)}g2(){let u=this.view.getUint16(this.pos);return this.pos+=2,u}g2b(){let u=this.view.getInt16(this.pos);return this.pos+=2,u}g3(){let u=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,u}g4(){let u=this.view.getInt32(this.pos);return this.pos+=4,u}g8(){let u=this.view.getBigInt64(this.pos);return this.pos+=8,u}gsmart(){return this.view.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmarts(){return this.view.getUint8(this.pos)<128?this.g1():this.g2()-32768}gjstr(){let u=this.view,R=u.byteLength,m="",_;while((_=u.getUint8(this.pos++))!==10&&this.pos<R)m+=String.fromCharCode(_);return m}gdata(u,R,m){m.set(this.data.subarray(this.pos,this.pos+u),R),this.pos+=u}p1isaac(u){this.view.setUint8(this.pos++,u+(this.random?.nextInt??0)&255)}p1(u){this.view.setUint8(this.pos++,u)}p2(u){this.view.setUint16(this.pos,u),this.pos+=2}ip2(u){this.view.setUint16(this.pos,u,!0),this.pos+=2}p3(u){this.view.setUint8(this.pos++,u>>16),this.view.setUint16(this.pos,u),this.pos+=2}p4(u){this.view.setInt32(this.pos,u),this.pos+=4}ip4(u){this.view.setInt32(this.pos,u,!0),this.pos+=4}p8(u){this.view.setBigInt64(this.pos,u),this.pos+=8}pjstr(u){let R=this.view,m=u.length;for(let _=0;_<m;_++)R.setUint8(this.pos++,u.charCodeAt(_));R.setUint8(this.pos++,10)}pdata(u,R,m){this.data.set(u.subarray(m,m+R),this.pos),this.pos+=R-m}psize1(u){this.view.setUint8(this.pos-u-1,u)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(u){let R=this.bitPos>>>3,m=8-(this.bitPos&7),_=0;this.bitPos+=u;for(;u>m;m=8)_+=(this.view.getUint8(R++)&z.bitmask[m])<<u-m,u-=m;if(u===m)_+=this.view.getUint8(R)&z.bitmask[m];else _+=this.view.getUint8(R)>>>m-u&z.bitmask[u];return _}rsaenc(u,R){let m=this.pos;this.pos=0;let _=new Uint8Array(m);this.gdata(m,0,_);let b=n1(_),E=f1(b,R,u),O=X1(E);this.pos=0,this.p1(O.length),this.pdata(O,O.length,0)}}class I0 extends V0{pixels;width2d;height2d;cropX;cropY;cropW;cropH;rgbPal;constructor(u,R,m){super();this.pixels=new Int8Array(u*R),this.width2d=this.cropW=u,this.height2d=this.cropH=R,this.cropX=this.cropY=0,this.rgbPal=m}static fromArchive(u,R,m=0){let _=new z(u.read(R+".dat")),b=new z(u.read("index.dat"));b.pos=_.g2();let E=b.g2(),O=b.g2(),I=b.g1(),L=new Int32Array(I);for(let K=1;K<I;K++)if(L[K]=b.g3(),L[K]===0)L[K]=1;for(let K=0;K<m;K++)b.pos+=2,_.pos+=b.g2()*b.g2(),b.pos+=1;if(_.pos>_.length||b.pos>b.length)throw new Error;let H=b.g1(),N=b.g1(),G=b.g2(),Q=b.g2(),$=new I0(G,Q,L);$.cropX=H,$.cropY=N,$.cropW=E,$.cropH=O;let T=$.pixels,U=b.g1();if(U===0){let K=$.width2d*$.height2d;for(let q=0;q<K;q++)T[q]=_.g1b()}else if(U===1){let{width2d:K,height2d:q}=$;for(let w=0;w<K;w++)for(let V=0;V<q;V++)T[w+V*K]=_.g1b()}return $}draw(u,R){u|=0,R|=0,u+=this.cropX,R+=this.cropY;let m=u+R*F.width2d,_=0,b=this.height2d,E=this.width2d,O=F.width2d-E,I=0;if(R<F.top){let L=F.top-R;b-=L,R=F.top,_+=L*E,m+=L*F.width2d}if(R+b>F.bottom)b-=R+b-F.bottom;if(u<F.left){let L=F.left-u;E-=L,u=F.left,_+=L,m+=L,I+=L,O+=L}if(u+E>F.right){let L=u+E-F.right;E-=L,I+=L,O+=L}if(E>0&&b>0)this.copyImage(E,b,this.pixels,_,I,F.pixels,m,O)}flipHorizontally(){let u=this.pixels,R=this.width2d,m=this.height2d;for(let _=0;_<m;_++){let b=R/2|0;for(let E=0;E<b;E++){let O=E+_*R,I=R-E-1+_*R,L=u[O];u[O]=u[I],u[I]=L}}}flipVertically(){let u=this.pixels,R=this.width2d,m=this.height2d;for(let _=0;_<(m/2|0);_++)for(let b=0;b<R;b++){let E=b+_*R,O=b+(m-_-1)*R,I=u[E];u[E]=u[O],u[O]=I}}translate2d(u,R,m){for(let _=0;_<this.rgbPal.length;_++){let b=this.rgbPal[_]>>16&255;if(b+=u,b<0)b=0;else if(b>255)b=255;let E=this.rgbPal[_]>>8&255;if(E+=R,E<0)E=0;else if(E>255)E=255;let O=this.rgbPal[_]&255;if(O+=m,O<0)O=0;else if(O>255)O=255;this.rgbPal[_]=(b<<16)+(E<<8)+O}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;let u=new Int8Array(this.cropW*this.cropH),R=0;for(let m=0;m<this.height2d;m++)for(let _=0;_<this.width2d;_++)u[(_+this.cropX>>1)+(m+this.cropY>>1)*this.cropW]=this.pixels[R++];this.pixels=u,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width2d===this.cropW&&this.height2d===this.cropH)return;let u=new Int8Array(this.cropW*this.cropH),R=0;for(let m=0;m<this.height2d;m++)for(let _=0;_<this.width2d;_++)u[_+this.cropX+(m+this.cropY)*this.cropW]=this.pixels[R++];this.pixels=u,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}copyImage(u,R,m,_,b,E,O,I){let L=-(u>>2);u=-(u&3);for(let H=-R;H<0;H++){for(let N=L;N<0;N++){let G=m[_++];if(G===0)O++;else E[O++]=this.rgbPal[G&255];if(G=m[_++],G===0)O++;else E[O++]=this.rgbPal[G&255];if(G=m[_++],G===0)O++;else E[O++]=this.rgbPal[G&255];if(G=m[_++],G===0)O++;else E[O++]=this.rgbPal[G&255]}for(let N=u;N<0;N++){let G=m[_++];if(G===0)O++;else E[O++]=this.rgbPal[G&255]}O+=I,_+=b}}clip(u,R,m,_){try{let b=this.width2d,E=this.height2d,O=0,I=0,L=(b<<16)/m|0,H=(E<<16)/_|0,N=this.cropW,G=this.cropH,Q=(N<<16)/m|0,$=(G<<16)/_|0;if(u=u+(this.cropX*m+N-1)/N|0,R=R+(this.cropY*_+G-1)/G|0,this.cropX*m%N!=0)O=(N-this.cropX*m%N<<16)/m|0;if(this.cropY*_%G!=0)I=(G-this.cropY*_%G<<16)/_|0;m=m*(this.width2d-(O>>16))/N|0,_=_*(this.height2d-(I>>16))/G|0;let T=u+R*F.width2d,U=F.width2d-m,K;if(R<F.top)K=F.top-R,_-=K,R=0,T+=K*F.width2d,I+=$*K;if(R+_>F.bottom)_-=R+_-F.bottom;if(u<F.left)K=F.left-u,m-=K,u=0,T+=K,O+=Q*K,U+=K;if(u+m>F.right)K=u+m-F.right,m-=K,U+=K;this.plot_scale(F.pixels,this.pixels,this.rgbPal,O,I,T,U,m,_,Q,$,b)}catch(b){}}plot_scale(u,R,m,_,b,E,O,I,L,H,N,G){try{let Q=_;for(let $=-L;$<0;$++){let T=(b>>16)*G;for(let U=-I;U<0;U++){let K=R[(_>>16)+T];if(K==0)E++;else u[E++]=m[K&255];_+=H}b+=N,_=Q,E+=O}}catch(Q){}}}class p extends Array{constructor(u,R){super(u);for(let m=0;m<u;m++)this[m]=R}}class Y1 extends Array{constructor(u,R,m){super(u);for(let _=0;_<u;_++){this[_]=new Array(R);for(let b=0;b<R;b++)this[_][b]=m}}}class x0 extends Array{constructor(u,R,m,_){super(u);for(let b=0;b<u;b++){this[b]=new Array(R);for(let E=0;E<R;E++){this[b][E]=new Array(m);for(let O=0;O<m;O++)this[b][E][O]=_}}}}class R1 extends Array{constructor(u,R,m,_,b){super(u);for(let E=0;E<u;E++){this[E]=new Array(R);for(let O=0;O<R;O++){this[E][O]=new Array(m);for(let I=0;I<m;I++){this[E][O][I]=new Array(_);for(let L=0;L<_;L++)this[E][O][I][L]=b}}}}}class S0 extends Array{constructor(u,R,m){super(u);for(let _=0;_<u;_++){this[_]=new Array(R);for(let b=0;b<R;b++)this[_][b]=new Uint8Array(m)}}}class f0 extends Array{constructor(u,R){super(u);for(let m=0;m<u;m++)this[m]=new Int32Array(R)}}class g0 extends Array{constructor(u,R,m){super(u);for(let _=0;_<u;_++){this[_]=new Array(R);for(let b=0;b<R;b++)this[_][b]=new Int32Array(m)}}}class Z extends F{static lowMemory=!1;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static hslPal=new Int32Array(65536);static textures=new p(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new p(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texPal=new p(50,null);static opaque=!1;static textureTranslucent=new p(50,!1);static averageTextureRGB=new Int32Array(50);static{for(let u=1;u<512;u++)this.reciprocal15[u]=32768/u|0;for(let u=1;u<2048;u++)this.reciprocal16[u]=65536/u|0;for(let u=0;u<2048;u++)this.sin[u]=Math.sin(u*0.0030679615757712823)*65536|0,this.cos[u]=Math.cos(u*0.0030679615757712823)*65536|0}static init2D(){this.lineOffset=new Int32Array(F.height2d);for(let u=0;u<F.height2d;u++)this.lineOffset[u]=F.width2d*u;this.centerX=F.width2d/2|0,this.centerY=F.height2d/2|0}static init3D(u,R){this.lineOffset=new Int32Array(R);for(let m=0;m<R;m++)this.lineOffset[m]=u*m;this.centerX=u/2|0,this.centerY=R/2|0}static clearTexels(){this.texelPool=null,this.activeTexels.fill(null)}static unpackTextures(u){this.textureCount=0;for(let R=0;R<50;R++)try{if(this.textures[R]=I0.fromArchive(u,R.toString()),this.lowMemory&&this.textures[R]?.cropW===128)this.textures[R]?.shrink();else this.textures[R]?.crop();this.textureCount++}catch(m){}}static getAverageTextureRGB(u){if(this.averageTextureRGB[u]!==0)return this.averageTextureRGB[u];let R=this.texPal[u];if(!R)return 0;let m=0,_=0,b=0,E=R.length;for(let I=0;I<E;I++)m+=R[I]>>16&255,_+=R[I]>>8&255,b+=R[I]&255;let O=((m/E|0)<<16)+((_/E|0)<<8)+(b/E|0);if(O=this.setGamma(O,1.4),O===0)O=1;return this.averageTextureRGB[u]=O,O}static setBrightness(u){let R=u+Math.random()*0.03-0.015,m=0;for(let _=0;_<512;_++){let b=(_/8|0)/64+0.0078125,E=(_&7)/8+0.0625;for(let O=0;O<128;O++){let I=O/128,L=I,H=I,N=I;if(E!==0){let U;if(I<0.5)U=I*(E+1);else U=I+E-I*E;let K=I*2-U,q=b+0.3333333333333333;if(q>1)q--;let w=b-0.3333333333333333;if(w<0)w++;if(q*6<1)L=K+(U-K)*6*q;else if(q*2<1)L=U;else if(q*3<2)L=K+(U-K)*(0.6666666666666666-q)*6;else L=K;if(b*6<1)H=K+(U-K)*6*b;else if(b*2<1)H=U;else if(b*3<2)H=K+(U-K)*(0.6666666666666666-b)*6;else H=K;if(w*6<1)N=K+(U-K)*6*w;else if(w*2<1)N=U;else if(w*3<2)N=K+(U-K)*(0.6666666666666666-w)*6;else N=K}let G=L*256|0,Q=H*256|0,$=N*256|0,T=(G<<16)+(Q<<8)+$;this.hslPal[m++]=this.setGamma(T,R)}}for(let _=0;_<50;_++){let b=this.textures[_];if(!b)continue;let E=b.rgbPal;this.texPal[_]=new Int32Array(E.length);for(let O=0;O<E.length;O++){let I=this.texPal[_];if(!I)continue;I[O]=this.setGamma(E[O],R)}}for(let _=0;_<50;_++)this.pushTexture(_)}static setGamma(u,R){let m=(u>>16)/256,_=(u>>8&255)/256,b=(u&255)/256,E=Math.pow(m,R),O=Math.pow(_,R),I=Math.pow(b,R),L=E*256|0,H=O*256|0,N=I*256|0;return(L<<16)+(H<<8)+N}static initPool(u){if(this.texelPool)return;if(this.poolSize=u,this.lowMemory)this.texelPool=new f0(u,16384);else this.texelPool=new f0(u,65536);this.activeTexels.fill(null)}static fillGouraudTriangle(u,R,m,_,b,E,O,I,L){let H=0,N=0;if(b!==_)H=(R-u<<16)/(b-_)|0,N=(I-O<<15)/(b-_)|0;let G=0,Q=0;if(E!==b)G=(m-R<<16)/(E-b)|0,Q=(L-I<<15)/(E-b)|0;let $=0,T=0;if(E!==_)$=(u-m<<16)/(_-E)|0,T=(O-L<<15)/(_-E)|0;if(_<=b&&_<=E){if(_<F.bottom){if(b>F.bottom)b=F.bottom;if(E>F.bottom)E=F.bottom;if(b<E){if(m=u<<=16,L=O<<=15,_<0)m-=$*_,u-=H*_,L-=T*_,O-=N*_,_=0;if(R<<=16,I<<=15,b<0)R-=G*b,I-=Q*b,b=0;if(_!==b&&$<H||_===b&&$>G){E-=b,b-=_,_=Z.lineOffset[_];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawGouraudScanline(m>>16,R>>16,L>>7,I>>7,F.pixels,_,0),m+=$,R+=G,L+=T,I+=Q,_+=F.width2d}this.drawGouraudScanline(m>>16,u>>16,L>>7,O>>7,F.pixels,_,0),m+=$,u+=H,L+=T,O+=N,_+=F.width2d}}else{E-=b,b-=_,_=Z.lineOffset[_];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawGouraudScanline(R>>16,m>>16,I>>7,L>>7,F.pixels,_,0),m+=$,R+=G,L+=T,I+=Q,_+=F.width2d}this.drawGouraudScanline(u>>16,m>>16,O>>7,L>>7,F.pixels,_,0),m+=$,u+=H,L+=T,O+=N,_+=F.width2d}}}else{if(R=u<<=16,I=O<<=15,_<0)R-=$*_,u-=H*_,I-=T*_,O-=N*_,_=0;if(m<<=16,L<<=15,E<0)m-=G*E,L-=Q*E,E=0;if(_!==E&&$<H||_===E&&G>H){b-=E,E-=_,_=Z.lineOffset[_];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(m>>16,u>>16,L>>7,O>>7,F.pixels,_,0),m+=G,u+=H,L+=Q,O+=N,_+=F.width2d}this.drawGouraudScanline(R>>16,u>>16,I>>7,O>>7,F.pixels,_,0),R+=$,u+=H,I+=T,O+=N,_+=F.width2d}}else{b-=E,E-=_,_=Z.lineOffset[_];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(u>>16,m>>16,O>>7,L>>7,F.pixels,_,0),m+=G,u+=H,L+=Q,O+=N,_+=F.width2d}this.drawGouraudScanline(u>>16,R>>16,O>>7,I>>7,F.pixels,_,0),R+=$,u+=H,I+=T,O+=N,_+=F.width2d}}}}}else if(b<=E){if(b<F.bottom){if(E>F.bottom)E=F.bottom;if(_>F.bottom)_=F.bottom;if(E<_){if(u=R<<=16,O=I<<=15,b<0)u-=H*b,R-=G*b,O-=N*b,I-=Q*b,b=0;if(m<<=16,L<<=15,E<0)m-=$*E,L-=T*E,E=0;if(b!==E&&H<G||b===E&&H>$){_-=E,E-=b,b=Z.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(_--,_<0)return;this.drawGouraudScanline(u>>16,m>>16,O>>7,L>>7,F.pixels,b,0),u+=H,m+=$,O+=N,L+=T,b+=F.width2d}this.drawGouraudScanline(u>>16,R>>16,O>>7,I>>7,F.pixels,b,0),u+=H,R+=G,O+=N,I+=Q,b+=F.width2d}}else{_-=E,E-=b,b=Z.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(_--,_<0)return;this.drawGouraudScanline(m>>16,u>>16,L>>7,O>>7,F.pixels,b,0),u+=H,m+=$,O+=N,L+=T,b+=F.width2d}this.drawGouraudScanline(R>>16,u>>16,I>>7,O>>7,F.pixels,b,0),u+=H,R+=G,O+=N,I+=Q,b+=F.width2d}}}else{if(m=R<<=16,L=I<<=15,b<0)m-=H*b,R-=G*b,L-=N*b,I-=Q*b,b=0;if(u<<=16,O<<=15,_<0)u-=$*_,O-=T*_,_=0;if(E-=_,_-=b,b=Z.lineOffset[b],H<G)while(!0){if(_--,_<0)while(!0){if(E--,E<0)return;this.drawGouraudScanline(u>>16,R>>16,O>>7,I>>7,F.pixels,b,0),u+=$,R+=G,O+=T,I+=Q,b+=F.width2d}this.drawGouraudScanline(m>>16,R>>16,L>>7,I>>7,F.pixels,b,0),m+=H,R+=G,L+=N,I+=Q,b+=F.width2d}else while(!0){if(_--,_<0)while(!0){if(E--,E<0)return;this.drawGouraudScanline(R>>16,u>>16,I>>7,O>>7,F.pixels,b,0),u+=$,R+=G,O+=T,I+=Q,b+=F.width2d}this.drawGouraudScanline(R>>16,m>>16,I>>7,L>>7,F.pixels,b,0),m+=H,R+=G,L+=N,I+=Q,b+=F.width2d}}}}else if(E<F.bottom){if(_>F.bottom)_=F.bottom;if(b>F.bottom)b=F.bottom;if(_<b){if(R=m<<=16,I=L<<=15,E<0)R-=G*E,m-=$*E,I-=Q*E,L-=T*E,E=0;if(u<<=16,O<<=15,_<0)u-=H*_,O-=N*_,_=0;if(b-=_,_-=E,E=Z.lineOffset[E],G<$)while(!0){if(_--,_<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(R>>16,u>>16,I>>7,O>>7,F.pixels,E,0),R+=G,u+=H,I+=Q,O+=N,E+=F.width2d}this.drawGouraudScanline(R>>16,m>>16,I>>7,L>>7,F.pixels,E,0),R+=G,m+=$,I+=Q,L+=T,E+=F.width2d}else while(!0){if(_--,_<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(u>>16,R>>16,O>>7,I>>7,F.pixels,E,0),R+=G,u+=H,I+=Q,O+=N,E+=F.width2d}this.drawGouraudScanline(m>>16,R>>16,L>>7,I>>7,F.pixels,E,0),R+=G,m+=$,I+=Q,L+=T,E+=F.width2d}}else{if(u=m<<=16,O=L<<=15,E<0)u-=G*E,m-=$*E,O-=Q*E,L-=T*E,E=0;if(R<<=16,I<<=15,b<0)R-=H*b,I-=N*b,b=0;if(_-=b,b-=E,E=Z.lineOffset[E],G<$)while(!0){if(b--,b<0)while(!0){if(_--,_<0)return;this.drawGouraudScanline(R>>16,m>>16,I>>7,L>>7,F.pixels,E,0),R+=H,m+=$,I+=N,L+=T,E+=F.width2d}this.drawGouraudScanline(u>>16,m>>16,O>>7,L>>7,F.pixels,E,0),u+=G,m+=$,O+=Q,L+=T,E+=F.width2d}else while(!0){if(b--,b<0)while(!0){if(_--,_<0)return;this.drawGouraudScanline(m>>16,R>>16,L>>7,I>>7,F.pixels,E,0),R+=H,m+=$,I+=N,L+=T,E+=F.width2d}this.drawGouraudScanline(m>>16,u>>16,L>>7,O>>7,F.pixels,E,0),u+=G,m+=$,O+=Q,L+=T,E+=F.width2d}}}}static drawGouraudScanline(u,R,m,_,b,E,O){let I;if(Z.jagged){let L;if(Z.clipX){if(R-u>3)L=(_-m)/(R-u)|0;else L=0;if(R>F.boundX)R=F.boundX;if(u<0)m-=u*L,u=0;if(u>=R)return;E+=u,O=R-u>>2,L<<=2}else if(u<R)if(E+=u,O=R-u>>2,O>0)L=(_-m)*Z.reciprocal15[O]>>15;else L=0;else return;if(Z.alpha===0)while(!0){if(O--,O<0){if(O=R-u&3,O>0){I=Z.hslPal[m>>8];do b[E++]=I,O--;while(O>0);return}break}I=Z.hslPal[m>>8],m+=L,b[E++]=I,b[E++]=I,b[E++]=I,b[E++]=I}else{let H=Z.alpha,N=256-Z.alpha;while(!0){if(O--,O<0){if(O=R-u&3,O>0){I=Z.hslPal[m>>8],I=((I&16711935)*N>>8&16711935)+((I&65280)*N>>8&65280);do b[E++]=I+((b[E]&16711935)*H>>8&16711935)+((b[E]&65280)*H>>8&65280),O--;while(O>0)}break}I=Z.hslPal[m>>8],m+=L,I=((I&16711935)*N>>8&16711935)+((I&65280)*N>>8&65280),b[E++]=I+((b[E]&16711935)*H>>8&16711935)+((b[E]&65280)*H>>8&65280),b[E++]=I+((b[E]&16711935)*H>>8&16711935)+((b[E]&65280)*H>>8&65280),b[E++]=I+((b[E]&16711935)*H>>8&16711935)+((b[E]&65280)*H>>8&65280),b[E++]=I+((b[E]&16711935)*H>>8&16711935)+((b[E]&65280)*H>>8&65280)}}}else if(u<R){let L=(_-m)/(R-u)|0;if(Z.clipX){if(R>F.boundX)R=F.boundX;if(u<0)m-=u*L,u=0;if(u>=R)return}if(E+=u,O=R-u,Z.alpha===0)do b[E++]=Z.hslPal[m>>8],m+=L,O--;while(O>0);else{let H=Z.alpha,N=256-Z.alpha;do I=Z.hslPal[m>>8],m+=L,I=((I&16711935)*N>>8&16711935)+((I&65280)*N>>8&65280),b[E++]=I+((b[E]&16711935)*H>>8&16711935)+((b[E]&65280)*H>>8&65280),O--;while(O>0)}}}static fillTriangle(u,R,m,_,b,E,O){let I=0;if(b!==_)I=(R-u<<16)/(b-_)|0;let L=0;if(E!==b)L=(m-R<<16)/(E-b)|0;let H=0;if(E!==_)H=(u-m<<16)/(_-E)|0;if(_<=b&&_<=E){if(_<F.bottom){if(b>F.bottom)b=F.bottom;if(E>F.bottom)E=F.bottom;if(b<E){if(m=u<<=16,_<0)m-=H*_,u-=I*_,_=0;if(R<<=16,b<0)R-=L*b,b=0;if(_!==b&&H<I||_===b&&H>L){E-=b,b-=_,_=this.lineOffset[_];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawScanline(m>>16,R>>16,F.pixels,_,O),m+=H,R+=L,_+=F.width2d}this.drawScanline(m>>16,u>>16,F.pixels,_,O),m+=H,u+=I,_+=F.width2d}}else{E-=b,b-=_,_=this.lineOffset[_];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawScanline(R>>16,m>>16,F.pixels,_,O),m+=H,R+=L,_+=F.width2d}this.drawScanline(u>>16,m>>16,F.pixels,_,O),m+=H,u+=I,_+=F.width2d}}}else{if(R=u<<=16,_<0)R-=H*_,u-=I*_,_=0;if(m<<=16,E<0)m-=L*E,E=0;if(_!==E&&H<I||_===E&&L>I){b-=E,E-=_,_=this.lineOffset[_];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawScanline(m>>16,u>>16,F.pixels,_,O),m+=L,u+=I,_+=F.width2d}this.drawScanline(R>>16,u>>16,F.pixels,_,O),R+=H,u+=I,_+=F.width2d}}else{b-=E,E-=_,_=this.lineOffset[_];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawScanline(u>>16,m>>16,F.pixels,_,O),m+=L,u+=I,_+=F.width2d}this.drawScanline(u>>16,R>>16,F.pixels,_,O),R+=H,u+=I,_+=F.width2d}}}}}else if(b<=E){if(b<F.bottom){if(E>F.bottom)E=F.bottom;if(_>F.bottom)_=F.bottom;if(E<_){if(u=R<<=16,b<0)u-=I*b,R-=L*b,b=0;if(m<<=16,E<0)m-=H*E,E=0;if(b!==E&&I<L||b===E&&I>H){_-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(_--,_<0)return;this.drawScanline(u>>16,m>>16,F.pixels,b,O),u+=I,m+=H,b+=F.width2d}this.drawScanline(u>>16,R>>16,F.pixels,b,O),u+=I,R+=L,b+=F.width2d}}else{_-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(_--,_<0)return;this.drawScanline(m>>16,u>>16,F.pixels,b,O),u+=I,m+=H,b+=F.width2d}this.drawScanline(R>>16,u>>16,F.pixels,b,O),u+=I,R+=L,b+=F.width2d}}}else{if(m=R<<=16,b<0)m-=I*b,R-=L*b,b=0;if(u<<=16,_<0)u-=H*_,_=0;if(I<L){E-=_,_-=b,b=this.lineOffset[b];while(!0){if(_--,_<0)while(!0){if(E--,E<0)return;this.drawScanline(u>>16,R>>16,F.pixels,b,O),u+=H,R+=L,b+=F.width2d}this.drawScanline(m>>16,R>>16,F.pixels,b,O),m+=I,R+=L,b+=F.width2d}}else{E-=_,_-=b,b=this.lineOffset[b];while(!0){if(_--,_<0)while(!0){if(E--,E<0)return;this.drawScanline(R>>16,u>>16,F.pixels,b,O),u+=H,R+=L,b+=F.width2d}this.drawScanline(R>>16,m>>16,F.pixels,b,O),m+=I,R+=L,b+=F.width2d}}}}}else if(E<F.bottom){if(_>F.bottom)_=F.bottom;if(b>F.bottom)b=F.bottom;if(_<b){if(R=m<<=16,E<0)R-=L*E,m-=H*E,E=0;if(u<<=16,_<0)u-=I*_,_=0;if(L<H){b-=_,_-=E,E=this.lineOffset[E];while(!0){if(_--,_<0)while(!0){if(b--,b<0)return;this.drawScanline(R>>16,u>>16,F.pixels,E,O),R+=L,u+=I,E+=F.width2d}this.drawScanline(R>>16,m>>16,F.pixels,E,O),R+=L,m+=H,E+=F.width2d}}else{b-=_,_-=E,E=this.lineOffset[E];while(!0){if(_--,_<0)while(!0){if(b--,b<0)return;this.drawScanline(u>>16,R>>16,F.pixels,E,O),R+=L,u+=I,E+=F.width2d}this.drawScanline(m>>16,R>>16,F.pixels,E,O),R+=L,m+=H,E+=F.width2d}}}else{if(u=m<<=16,E<0)u-=L*E,m-=H*E,E=0;if(R<<=16,b<0)R-=I*b,b=0;if(L<H){_-=b,b-=E,E=this.lineOffset[E];while(!0){if(b--,b<0)while(!0){if(_--,_<0)return;this.drawScanline(R>>16,m>>16,F.pixels,E,O),R+=I,m+=H,E+=F.width2d}this.drawScanline(u>>16,m>>16,F.pixels,E,O),u+=L,m+=H,E+=F.width2d}}else{_-=b,b-=E,E=this.lineOffset[E];while(!0){if(b--,b<0)while(!0){if(_--,_<0)return;this.drawScanline(m>>16,R>>16,F.pixels,E,O),R+=I,m+=H,E+=F.width2d}this.drawScanline(m>>16,u>>16,F.pixels,E,O),u+=L,m+=H,E+=F.width2d}}}}}static fillTexturedTriangle(u,R,m,_,b,E,O,I,L,H,N,G,Q,$,T,U,K,q,w){let V=this.getTexels(w);this.opaque=!this.textureTranslucent[w];let Y=H-Q,A=N-T,h=G-K,n=$-H,f=U-N,D=q-G,j=n*N-f*H<<14,W=f*G-D*N<<8,M=D*H-n*G<<5,X=Y*N-A*H<<14,P=A*G-h*N<<8,r=h*H-Y*G<<5,S=A*n-Y*f<<14,y=h*f-A*D<<8,a=Y*D-h*n<<5,x=0,O0=0;if(b!==_)x=(R-u<<16)/(b-_)|0,O0=(I-O<<16)/(b-_)|0;let R0=0,N0=0;if(E!==b)R0=(m-R<<16)/(E-b)|0,N0=(L-I<<16)/(E-b)|0;let H0=0,T0=0;if(E!==_)H0=(u-m<<16)/(_-E)|0,T0=(O-L<<16)/(_-E)|0;if(_<=b&&_<=E){if(_<F.bottom){if(b>F.bottom)b=F.bottom;if(E>F.bottom)E=F.bottom;if(b<E){if(m=u<<=16,L=O<<=16,_<0)m-=H0*_,u-=x*_,L-=T0*_,O-=O0*_,_=0;if(R<<=16,I<<=16,b<0)R-=R0*b,I-=N0*b,b=0;let $0=_-this.centerY;if(j+=M*$0,X+=r*$0,S+=a*$0,j|=0,X|=0,S|=0,_!==b&&H0<x||_===b&&H0>R0){E-=b,b-=_,_=this.lineOffset[_];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawTexturedScanline(m>>16,R>>16,F.pixels,_,V,0,0,j,X,S,W,P,y,L>>8,I>>8),m+=H0,R+=R0,L+=T0,I+=N0,_+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(m>>16,u>>16,F.pixels,_,V,0,0,j,X,S,W,P,y,L>>8,O>>8),m+=H0,u+=x,L+=T0,O+=O0,_+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}else{E-=b,b-=_,_=this.lineOffset[_];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawTexturedScanline(R>>16,m>>16,F.pixels,_,V,0,0,j,X,S,W,P,y,I>>8,L>>8),m+=H0,R+=R0,L+=T0,I+=N0,_+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(u>>16,m>>16,F.pixels,_,V,0,0,j,X,S,W,P,y,O>>8,L>>8),m+=H0,u+=x,L+=T0,O+=O0,_+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}}else{if(R=u<<=16,I=O<<=16,_<0)R-=H0*_,u-=x*_,I-=T0*_,O-=O0*_,_=0;if(m<<=16,L<<=16,E<0)m-=R0*E,L-=N0*E,E=0;let $0=_-this.centerY;if(j+=M*$0,X+=r*$0,S+=a*$0,j|=0,X|=0,S|=0,(_===E||H0>=x)&&(_!==E||R0<=x)){b-=E,E-=_,_=this.lineOffset[_];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(u>>16,m>>16,F.pixels,_,V,0,0,j,X,S,W,P,y,O>>8,L>>8),m+=R0,u+=x,L+=N0,O+=O0,_+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(u>>16,R>>16,F.pixels,_,V,0,0,j,X,S,W,P,y,O>>8,I>>8),R+=H0,u+=x,I+=T0,O+=O0,_+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}else{b-=E,E-=_,_=this.lineOffset[_];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(m>>16,u>>16,F.pixels,_,V,0,0,j,X,S,W,P,y,L>>8,O>>8),m+=R0,u+=x,L+=N0,O+=O0,_+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(R>>16,u>>16,F.pixels,_,V,0,0,j,X,S,W,P,y,I>>8,O>>8),R+=H0,u+=x,I+=T0,O+=O0,_+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}}}}else if(b<=E){if(b<F.bottom){if(E>F.bottom)E=F.bottom;if(_>F.bottom)_=F.bottom;if(E<_){if(u=R<<=16,O=I<<=16,b<0)u-=x*b,R-=R0*b,O-=O0*b,I-=N0*b,b=0;if(m<<=16,L<<=16,E<0)m-=H0*E,L-=T0*E,E=0;let $0=b-this.centerY;if(j+=M*$0,X+=r*$0,S+=a*$0,j|=0,X|=0,S|=0,b!==E&&x<R0||b===E&&x>H0){_-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(_--,_<0)return;this.drawTexturedScanline(u>>16,m>>16,F.pixels,b,V,0,0,j,X,S,W,P,y,O>>8,L>>8),u+=x,m+=H0,O+=O0,L+=T0,b+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(u>>16,R>>16,F.pixels,b,V,0,0,j,X,S,W,P,y,O>>8,I>>8),u+=x,R+=R0,O+=O0,I+=N0,b+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}else{_-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(_--,_<0)return;this.drawTexturedScanline(m>>16,u>>16,F.pixels,b,V,0,0,j,X,S,W,P,y,L>>8,O>>8),u+=x,m+=H0,O+=O0,L+=T0,b+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(R>>16,u>>16,F.pixels,b,V,0,0,j,X,S,W,P,y,I>>8,O>>8),u+=x,R+=R0,O+=O0,I+=N0,b+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}}else{if(m=R<<=16,L=I<<=16,b<0)m-=x*b,R-=R0*b,L-=O0*b,I-=N0*b,b=0;if(u<<=16,O<<=16,_<0)u-=H0*_,O-=T0*_,_=0;let $0=b-this.centerY;if(j+=M*$0,X+=r*$0,S+=a*$0,j|=0,X|=0,S|=0,E-=_,_-=b,b=this.lineOffset[b],x<R0)while(!0){if(_--,_<0)while(!0){if(E--,E<0)return;this.drawTexturedScanline(u>>16,R>>16,F.pixels,b,V,0,0,j,X,S,W,P,y,O>>8,I>>8),u+=H0,R+=R0,O+=T0,I+=N0,b+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(m>>16,R>>16,F.pixels,b,V,0,0,j,X,S,W,P,y,L>>8,I>>8),m+=x,R+=R0,L+=O0,I+=N0,b+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}else while(!0){if(_--,_<0)while(!0){if(E--,E<0)return;this.drawTexturedScanline(R>>16,u>>16,F.pixels,b,V,0,0,j,X,S,W,P,y,I>>8,O>>8),u+=H0,R+=R0,O+=T0,I+=N0,b+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(R>>16,m>>16,F.pixels,b,V,0,0,j,X,S,W,P,y,I>>8,L>>8),m+=x,R+=R0,L+=O0,I+=N0,b+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}}}else if(E<F.bottom){if(_>F.bottom)_=F.bottom;if(b>F.bottom)b=F.bottom;if(_<b){if(R=m<<=16,I=L<<=16,E<0)R-=R0*E,m-=H0*E,I-=N0*E,L-=T0*E,E=0;if(u<<=16,O<<=16,_<0)u-=x*_,O-=O0*_,_=0;let $0=E-this.centerY;if(j+=M*$0,X+=r*$0,S+=a*$0,j|=0,X|=0,S|=0,b-=_,_-=E,E=this.lineOffset[E],R0<H0)while(!0){if(_--,_<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(R>>16,u>>16,F.pixels,E,V,0,0,j,X,S,W,P,y,I>>8,O>>8),R+=R0,u+=x,I+=N0,O+=O0,E+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(R>>16,m>>16,F.pixels,E,V,0,0,j,X,S,W,P,y,I>>8,L>>8),R+=R0,m+=H0,I+=N0,L+=T0,E+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}else while(!0){if(_--,_<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(u>>16,R>>16,F.pixels,E,V,0,0,j,X,S,W,P,y,O>>8,I>>8),R+=R0,u+=x,I+=N0,O+=O0,E+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(m>>16,R>>16,F.pixels,E,V,0,0,j,X,S,W,P,y,L>>8,I>>8),R+=R0,m+=H0,I+=N0,L+=T0,E+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}else{if(u=m<<=16,O=L<<=16,E<0)u-=R0*E,m-=H0*E,O-=N0*E,L-=T0*E,E=0;if(R<<=16,I<<=16,b<0)R-=x*b,I-=O0*b,b=0;let $0=E-this.centerY;if(j+=M*$0,X+=r*$0,S+=a*$0,j|=0,X|=0,S|=0,_-=b,b-=E,E=this.lineOffset[E],R0<H0)while(!0){if(b--,b<0)while(!0){if(_--,_<0)return;this.drawTexturedScanline(R>>16,m>>16,F.pixels,E,V,0,0,j,X,S,W,P,y,I>>8,L>>8),R+=x,m+=H0,I+=O0,L+=T0,E+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(u>>16,m>>16,F.pixels,E,V,0,0,j,X,S,W,P,y,O>>8,L>>8),u+=R0,m+=H0,O+=N0,L+=T0,E+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}else while(!0){if(b--,b<0)while(!0){if(_--,_<0)return;this.drawTexturedScanline(m>>16,R>>16,F.pixels,E,V,0,0,j,X,S,W,P,y,L>>8,I>>8),R+=x,m+=H0,I+=O0,L+=T0,E+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}this.drawTexturedScanline(m>>16,u>>16,F.pixels,E,V,0,0,j,X,S,W,P,y,L>>8,O>>8),u+=R0,m+=H0,O+=N0,L+=T0,E+=F.width2d,j+=M,X+=r,S+=a,j|=0,X|=0,S|=0}}}}static drawTexturedScanline(u,R,m,_,b,E,O,I,L,H,N,G,Q,$,T){if(u>=R)return;let U,K;if(this.clipX){if(U=(T-$)/(R-u)|0,R>F.boundX)R=F.boundX;if(u<0)$-=u*U,u=0;if(u>=R)return;K=R-u>>3,U<<=12}else if(R-u>7)K=R-u>>3,U=(T-$)*this.reciprocal15[K]>>6;else K=0,U=0;$<<=9,_+=u;let q,w,V,Y,A,h,n;if(this.lowMemory&&b){if(q=0,w=0,Y=u-this.centerX,I=I+(N>>3)*Y,L=L+(G>>3)*Y,H=H+(Q>>3)*Y,I|=0,L|=0,H|=0,V=H>>12,V!==0){if(E=I/V|0,O=L/V|0,E<0)E=0;else if(E>4032)E=4032}if(I=I+N,L=L+G,H=H+Q,I|=0,L|=0,H|=0,V=H>>12,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>4032)q=4032}if(A=q-E>>3,h=w-O>>3,E+=$>>3&786432,n=$>>23,this.opaque){while(K-- >0){if(m[_++]=b[(O&4032)+(E>>6)]>>>n,E+=A,O+=h,m[_++]=b[(O&4032)+(E>>6)]>>>n,E+=A,O+=h,m[_++]=b[(O&4032)+(E>>6)]>>>n,E+=A,O+=h,m[_++]=b[(O&4032)+(E>>6)]>>>n,E+=A,O+=h,m[_++]=b[(O&4032)+(E>>6)]>>>n,E+=A,O+=h,m[_++]=b[(O&4032)+(E>>6)]>>>n,E+=A,O+=h,m[_++]=b[(O&4032)+(E>>6)]>>>n,E+=A,O+=h,m[_++]=b[(O&4032)+(E>>6)]>>>n,E=q,O=w,I+=N,L+=G,H+=Q,V=H>>12,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>4032)q=4032}A=q-E>>3,h=w-O>>3,$+=U,E+=$>>3&786432,n=$>>23}K=R-u&7;while(K-- >0)m[_++]=b[(O&4032)+(E>>6)]>>>n,E+=A,O+=h}else{while(K-- >0){let f;if((f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;if(_=_+1,E+=A,O+=h,(f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;if(_=_+1,E=q,O=w,I+=N,L+=G,H+=Q,I|=0,L|=0,H|=0,V=H>>12,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>4032)q=4032}A=q-E>>3,h=w-O>>3,$+=U,E+=$>>3&786432,n=$>>23}K=R-u&7;while(K-- >0){let f;if((f=b[(O&4032)+(E>>6)]>>>n)!==0)m[_]=f;_++,E+=A,O+=h}}return}if(q=0,w=0,Y=u-this.centerX,I=I+(N>>3)*Y,L=L+(G>>3)*Y,H=H+(Q>>3)*Y,I|=0,L|=0,H|=0,V=H>>14,V!==0){if(E=I/V|0,O=L/V|0,E<0)E=0;else if(E>16256)E=16256}if(I=I+N,L=L+G,H=H+Q,I|=0,L|=0,H|=0,V=H>>14,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>16256)q=16256}if(A=q-E>>3,h=w-O>>3,E+=$&6291456,n=$>>23,this.opaque&&b){while(K-- >0){if(m[_++]=b[(O&16256)+(E>>7)]>>>n,E+=A,O+=h,m[_++]=b[(O&16256)+(E>>7)]>>>n,E+=A,O+=h,m[_++]=b[(O&16256)+(E>>7)]>>>n,E+=A,O+=h,m[_++]=b[(O&16256)+(E>>7)]>>>n,E+=A,O+=h,m[_++]=b[(O&16256)+(E>>7)]>>>n,E+=A,O+=h,m[_++]=b[(O&16256)+(E>>7)]>>>n,E+=A,O+=h,m[_++]=b[(O&16256)+(E>>7)]>>>n,E+=A,O+=h,m[_++]=b[(O&16256)+(E>>7)]>>>n,E=q,O=w,I+=N,L+=G,H+=Q,I|=0,L|=0,H|=0,V=H>>14,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>16256)q=16256}A=q-E>>3,h=w-O>>3,$+=U,E+=$&6291456,n=$>>23}K=R-u&7;while(K-- >0)m[_++]=b[(O&16256)+(E>>7)]>>>n,E+=A,O+=h;return}while(K-- >0&&b){let f;if((f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;if(_=_+1,E+=A,O+=h,(f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;if(_++,E+=A,O+=h,(f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;if(_++,E=q,O=w,I+=N,L+=G,H+=Q,I|=0,L|=0,H|=0,V=H>>14,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>16256)q=16256}A=q-E>>3,h=w-O>>3,$+=U,E+=$&6291456,n=$>>23}K=R-u&7;while(K-- >0&&b){let f;if((f=b[(O&16256)+(E>>7)]>>>n)!==0)m[_]=f;_++,E+=A,O+=h}}static drawScanline(u,R,m,_,b){if(this.clipX){if(R>F.boundX)R=F.boundX;if(u<0)u=0}if(u>=R)return;_+=u;let E=R-u>>2;if(this.alpha===0)while(!0){if(E--,E<0){E=R-u&3;while(!0){if(E--,E<0)return;m[_++]=b}}m[_++]=b,m[_++]=b,m[_++]=b,m[_++]=b}let O=this.alpha,I=256-this.alpha;b=((b&16711935)*I>>8&16711935)+((b&65280)*I>>8&65280);while(!0){if(E--,E<0){E=R-u&3;while(!0){if(E--,E<0)return;m[_++]=b+((m[_]&16711935)*O>>8&16711935)+((m[_]&65280)*O>>8&65280)}}m[_++]=b+((m[_]&16711935)*O>>8&16711935)+((m[_]&65280)*O>>8&65280),m[_++]=b+((m[_]&16711935)*O>>8&16711935)+((m[_]&65280)*O>>8&65280),m[_++]=b+((m[_]&16711935)*O>>8&16711935)+((m[_]&65280)*O>>8&65280),m[_++]=b+((m[_]&16711935)*O>>8&16711935)+((m[_]&65280)*O>>8&65280)}}static pushTexture(u){if(this.activeTexels[u]&&this.texelPool)this.texelPool[this.poolSize++]=this.activeTexels[u],this.activeTexels[u]=null}static getTexels(u){if(this.textureCycle[u]=this.cycle++,this.activeTexels[u])return this.activeTexels[u];let R;if(this.poolSize>0&&this.texelPool)R=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let b=0,E=-1;for(let O=0;O<this.textureCount;O++)if(this.activeTexels[O]&&(this.textureCycle[O]<b||E===-1))b=this.textureCycle[O],E=O;R=this.activeTexels[E],this.activeTexels[E]=null}this.activeTexels[u]=R;let m=this.textures[u],_=this.texPal[u];if(!R||!m||!_)return null;if(this.lowMemory){this.textureTranslucent[u]=!1;for(let b=0;b<4096;b++){let E=R[b]=_[m.pixels[b]]&16316671;if(E===0)this.textureTranslucent[u]=!0;R[b+4096]=E-(E>>>3)&16316671,R[b+8192]=E-(E>>>2)&16316671,R[b+12288]=E-(E>>>2)-(E>>>3)&16316671}}else{if(m.width2d===64)for(let b=0;b<128;b++)for(let E=0;E<128;E++)R[E+(b<<7|0)]=_[m.pixels[(E>>1)+(b>>1<<6|0)]];else for(let b=0;b<16384;b++)R[b]=_[m.pixels[b]];this.textureTranslucent[u]=!1;for(let b=0;b<16384;b++){R[b]&=16316671;let E=R[b];if(E===0)this.textureTranslucent[u]=!0;R[b+16384]=E-(E>>>3)&16316671,R[b+32768]=E-(E>>>2)&16316671,R[b+49152]=E-(E>>>2)-(E>>>3)&16316671}}return R}}class L0{image;width2d;height2d;ctx;paint;pixels;constructor(u,R,m=C){this.ctx=m,this.image=this.ctx.getImageData(0,0,u,R),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(u*R),this.width2d=u,this.height2d=R,this.bind()}clear(){this.pixels.fill(0)}bind(){F.bind(this.pixels,this.width2d,this.height2d)}draw(u,R){this.#u(),this.ctx.putImageData(this.image,u,R)}#u(){let u=this.pixels.length,R=this.pixels,m=this.paint;for(let _=0;_<u;_++){let b=R[_];m[_]=b>>16&255|(b>>8&255)<<8|(b&255)<<16|4278190080}}}var j1=["q","w","e","r","t","y","u","i","o","p","a","s","d","f","g","h","j","k","l","Shift","z","x","c","v","b","n","m","Del","123",","," ",".","Enter"],C1=["Q","W","E","R","T","Y","U","I","O","P","A","S","D","F","G","H","J","K","L","Shift","Z","X","C","V","B","N","M","Del","123",","," ",".","Enter"],i1=["1","2","3","4","5","6","7","8","9","0","!",'"',"$","%","_","&","*","(",")","1/2","@","=","<",">","~",";",":","Del","abc","#"," ","?","Enter"],t1=["£","^","[","]","{","}","'","-","+","/","\\","|","","","","","","","","2/2","","","","","","","","Del","abc",""," ","","Enter"],s0=[0,10,19,28],h0=50,c0=30,y1=1000,h1=5,M1=75;function a1(){return document.fullscreenElement!==null}class B1{canvasKeyboard;nativeKeyboard;mode;constructor(){this.canvasKeyboard=new S1,this.nativeKeyboard=new W1;let u=localStorage.getItem("mobileKeyboardMode");if(u==="native")this.mode=1;else if(u==="canvas")this.mode=2;else this.mode=0}show(u,R){if(this.mode===0)if(a1())this.canvasKeyboard.show();else this.nativeKeyboard.show();else if(this.mode===2)this.canvasKeyboard.show(u,R);else if(this.mode===1)this.nativeKeyboard.show(u,R)}hide(){this.canvasKeyboard.hide(),this.nativeKeyboard.hide()}draw(){this.canvasKeyboard.draw()}isDisplayed(){return this.canvasKeyboard.isDisplayed()||this.nativeKeyboard.isDisplayed()}isWithinCanvasKeyboard(u,R){return this.canvasKeyboard.isDisplayed()&&this.canvasKeyboard.posWithinKeyboard(u,R)}captureMouseUp(u,R){if(this.canvasKeyboard.isDisplayed())return this.canvasKeyboard.captureMouseUp(u,R);else if(this.nativeKeyboard.isDisplayed())return this.nativeKeyboard.captureMouseUp(u,R);return!1}captureMouseDown(u,R){if(this.canvasKeyboard.isDisplayed())return this.canvasKeyboard.captureMouseDown(u,R);else if(this.nativeKeyboard.isDisplayed())return this.nativeKeyboard.captureMouseDown(u,R);return!1}notifyTouchMove(u,R){if(this.canvasKeyboard.isDisplayed())this.canvasKeyboard.notifyTouchMove(u,R);else if(this.nativeKeyboard.isDisplayed())this.nativeKeyboard.notifyTouchMove(u,R)}}class S1{displayed=!1;height=c0*4+10;width=h0*10+10;startX=0;startY=503-this.height;mode=0;animateBoxIndex=-1;animateBoxTimeout=0;touchStartAtX=0;touchStartAtY=0;touching=!1;touchStartTimestamp=0;getBoxColorForIndex(u){if(this.animateBoxIndex>-1){if(this.animateBoxIndex===u)return"#a6a6a6"}let R=this.getCharForIndex(u);if(R!==void 0&&R.length>1)return"#a9afba";return"#c8cdd1"}getBoxForIndex(u){let R=u<s0[1]?0:u<s0[2]?1:u<s0[3]?2:3,_={startX:(u-s0[R])*h0+5,startY:R*c0+5,width:h0,height:c0};if(R===1)_.startX+=h0/2;if(u===30)_.width*=6;if(u>30)_.startX+=h0*5;return _}getCharForIndex(u){if(this.mode===1)return C1[u];else if(this.mode===2)return i1[u];else if(this.mode===3)return t1[u];return j1[u]}drawKeyBoxes(){for(let u=0;u<j1.length;u++){let R=this.getBoxForIndex(u);C.fillStyle=this.getBoxColorForIndex(u),C.beginPath(),C.roundRect(this.startX+R.startX+2,this.startY+R.startY+2,R.width-2,R.height-2,5),C.fill()}}drawKeyChars(){C.fillStyle="black",C.textAlign="center",C.textBaseline="middle";for(let u=0;u<j1.length;u++){C.font="16px Roboto, sans-serif";let R=this.getBoxForIndex(u),m=this.startX+R.startX+h0/2,_=this.startY+R.startY+c0/2+2,b=this.getCharForIndex(u);if(b.length>1)C.font="14px Roboto, sans-serif";C.fillText(b,m,_)}}drawBackground(){C.fillStyle="#dadde2",C.beginPath(),C.roundRect(this.startX,this.startY,this.width,this.height,5),C.fill()}draw(){if(!this.isDisplayed())return;C.save(),this.drawBackground(),this.drawKeyBoxes(),this.drawKeyChars(),C.restore()}show(u,R){this.mode=0,this.displayed=!0}hide(){this.displayed=!1}isDisplayed(){return this.displayed}posWithinKeyboard(u,R){let m=u>=this.startX&&u<this.startX+this.width,_=R>=this.startY&&R<this.startY+this.height;return m&&_}getBoxIndexForClick(u,R){let m=u-this.startX,_=R-this.startY;if(m<0||_<0||m>=this.width||_>=this.height)return-1;let b=Math.floor(_/c0),E=Math.floor(m/h0);if(b===0)return E;if(b===1){if(m<h0/2||m>this.width-h0/2)return-1;return s0[1]+Math.floor((m-h0/2)/h0)}if(b===2){if(E>=9)return-1;return s0[2]+E}return s0[3]+E}getCharForClick(u,R){let m=this.getBoxIndexForClick(u,R);if(m>-1){let _="";if(m>=30&&m<=35)_=" ";else if(m===36)_=this.getCharForIndex(31);else if(m===37)_="Enter";else _=this.getCharForIndex(m);if(_==="Del")_="Backspace";return _}return""}captureMouseDown(u,R){if(this.posWithinKeyboard(u,R))return!0;return!1}captureMouseUp(u,R){if(this.touching=!1,this.posWithinKeyboard(u,R)){let m=this.getBoxIndexForClick(u,R),_=this.getCharForClick(u,R);if(_==="Shift"){if(this.mode===0)this.mode=1;else this.mode=0;return!0}else if(_==="123"||_==="2/2")return this.mode=2,!0;else if(_==="1/2")return this.mode=3,!0;else if(_==="abc")return this.mode=0,!0;else if(_==="")return!0;let b=new KeyboardEvent("keydown",{key:_,code:_}),E=new KeyboardEvent("keyup",{key:_,code:_});if(d.dispatchEvent(b),d.dispatchEvent(E),!this.animateBoxTimeout){if(m>=30&&m<=35)this.animateBoxIndex=30;else if(m>35)this.animateBoxIndex=m-5;else this.animateBoxIndex=m;this.animateBoxTimeout=window.setTimeout(()=>{this.animateBoxIndex=-1,this.animateBoxTimeout=0},100)}return!0}return!1}notifyTouchMove(u,R){if(!this.posWithinKeyboard(u,R))return;if(this.touching&&performance.now()>this.touchStartTimestamp+y1){this.touching=!1;return}if(!this.touching){this.touching=!0,this.touchStartTimestamp=performance.now(),this.touchStartAtX=u-this.startX,this.touchStartAtY=R-this.startY;return}let m=Math.abs(Math.abs(this.touchStartAtX-u)-this.startX),_=Math.abs(Math.abs(this.touchStartAtY-R)-this.startY);if(m>M1||_>M1)return;if(m>h1||_>h1){let b=Math.max(0,Math.min(789-this.width,u-this.touchStartAtX)),E=Math.max(0,Math.min(532-this.height,R-this.touchStartAtY));this.startX=b,this.startY=E,d.dispatchEvent(new FocusEvent("focus"))}}}class W1{virtualInputElement;displayed=!1;isAndroid=!1;constructor(){if(this.isAndroid=navigator.userAgent.includes("Android"),this.virtualInputElement=document.createElement("input"),this.virtualInputElement.setAttribute("type","password"),this.virtualInputElement.setAttribute("autofocus","autofocus"),this.virtualInputElement.setAttribute("spellcheck","false"),this.virtualInputElement.setAttribute("autocomplete","off"),this.virtualInputElement.setAttribute("style","position: fixed; top: 0px; left: 0px; width: 1px; height: 1px; opacity: 0;"),this.isAndroid)this.virtualInputElement.addEventListener("input",(u)=>{if(!(u instanceof InputEvent))return;let R=u.data;if(R===null)return;if(u.inputType!=="insertText")return;d.dispatchEvent(new KeyboardEvent("keydown",{key:R,code:R})),d.dispatchEvent(new KeyboardEvent("keyup",{key:R,code:R}))}),this.virtualInputElement.addEventListener("keydown",(u)=>{if(u.key==="Enter"||u.key==="Backspace")d.dispatchEvent(new KeyboardEvent("keydown",{key:u.key,code:u.key}))}),this.virtualInputElement.addEventListener("keyup",(u)=>{if(u.key==="Enter"||u.key==="Backspace")d.dispatchEvent(new KeyboardEvent("keyup",{key:u.key,code:u.key}))});else this.virtualInputElement.addEventListener("keydown",(u)=>{d.dispatchEvent(new KeyboardEvent("keydown",{key:u.key,code:u.key}))}),this.virtualInputElement.addEventListener("keyup",(u)=>{d.dispatchEvent(new KeyboardEvent("keyup",{key:u.key,code:u.key}))});document.body.appendChild(this.virtualInputElement)}draw(){}show(u,R){if(u&&R)this.virtualInputElement.style.left=`${u}px`,this.virtualInputElement.style.top=`${R}px`;d.blur(),this.virtualInputElement.focus(),this.virtualInputElement.click(),this.displayed=!0}hide(){this.virtualInputElement.blur(),d.focus(),this.displayed=!1}isDisplayed(){return this.displayed}captureMouseUp(u,R){return!1}captureMouseDown(u,R){return!1}notifyTouchMove(u,R){return}}var Y0=new B1;var w1=["F11","F12"],B=new Map;B.set("ArrowLeft",{code:37,ch:1});B.set("ArrowRight",{code:39,ch:2});B.set("ArrowUp",{code:38,ch:3});B.set("ArrowDown",{code:40,ch:4});B.set("Control",{code:17,ch:5});B.set("Shift",{code:16,ch:6});B.set("Alt",{code:18,ch:7});B.set("Backspace",{code:8,ch:8});B.set("Tab",{code:9,ch:9});B.set("Enter",{code:10,ch:10});B.set("Escape",{code:27,ch:27});B.set(" ",{code:32,ch:32});B.set("Delete",{code:127,ch:127});B.set("Home",{code:36,ch:1000});B.set("End",{code:35,ch:1001});B.set("PageUp",{code:33,ch:1002});B.set("PageDown",{code:34,ch:1003});B.set("F1",{code:112,ch:1008});B.set("F2",{code:113,ch:1009});B.set("F3",{code:114,ch:1010});B.set("F4",{code:115,ch:1011});B.set("F5",{code:116,ch:1012});B.set("F6",{code:117,ch:1013});B.set("F7",{code:118,ch:1014});B.set("F8",{code:119,ch:1015});B.set("F9",{code:120,ch:1016});B.set("F10",{code:121,ch:1017});B.set("F11",{code:122,ch:1018});B.set("F12",{code:123,ch:1019});B.set("CapsLock",{code:20,ch:65535});B.set("Meta",{code:524,ch:65535});B.set("Insert",{code:155,ch:65535});B.set("`",{code:192,ch:96});B.set("~",{code:192,ch:126});B.set("!",{code:49,ch:33});B.set("@",{code:50,ch:64});B.set("#",{code:51,ch:35});B.set("£",{code:51,ch:163});B.set("$",{code:52,ch:36});B.set("%",{code:53,ch:37});B.set("^",{code:54,ch:94});B.set("&",{code:55,ch:38});B.set("*",{code:56,ch:42});B.set("(",{code:57,ch:40});B.set(")",{code:48,ch:41});B.set("-",{code:45,ch:45});B.set("_",{code:45,ch:95});B.set("=",{code:61,ch:61});B.set("+",{code:61,ch:43});B.set("[",{code:91,ch:91});B.set("{",{code:91,ch:123});B.set("]",{code:93,ch:93});B.set("}",{code:93,ch:125});B.set("\\",{code:92,ch:92});B.set("|",{code:92,ch:124});B.set(";",{code:59,ch:59});B.set(":",{code:59,ch:58});B.set("'",{code:222,ch:39});B.set('"',{code:222,ch:34});B.set(",",{code:44,ch:44});B.set("<",{code:44,ch:60});B.set(".",{code:46,ch:46});B.set(">",{code:46,ch:62});B.set("/",{code:47,ch:47});B.set("?",{code:47,ch:63});B.set("0",{code:48,ch:48});B.set("1",{code:49,ch:49});B.set("2",{code:50,ch:50});B.set("3",{code:51,ch:51});B.set("4",{code:52,ch:52});B.set("5",{code:53,ch:53});B.set("6",{code:54,ch:54});B.set("7",{code:55,ch:55});B.set("8",{code:56,ch:56});B.set("9",{code:57,ch:57});B.set("a",{code:65,ch:97});B.set("b",{code:66,ch:98});B.set("c",{code:67,ch:99});B.set("d",{code:68,ch:100});B.set("e",{code:69,ch:101});B.set("f",{code:70,ch:102});B.set("g",{code:71,ch:103});B.set("h",{code:72,ch:104});B.set("i",{code:73,ch:105});B.set("j",{code:74,ch:106});B.set("k",{code:75,ch:107});B.set("l",{code:76,ch:108});B.set("m",{code:77,ch:109});B.set("n",{code:78,ch:110});B.set("o",{code:79,ch:111});B.set("p",{code:80,ch:112});B.set("q",{code:81,ch:113});B.set("r",{code:82,ch:114});B.set("s",{code:83,ch:115});B.set("t",{code:84,ch:116});B.set("u",{code:85,ch:117});B.set("v",{code:86,ch:118});B.set("w",{code:87,ch:119});B.set("x",{code:88,ch:120});B.set("y",{code:89,ch:121});B.set("z",{code:90,ch:122});B.set("A",{code:65,ch:65});B.set("B",{code:66,ch:66});B.set("C",{code:67,ch:67});B.set("D",{code:68,ch:68});B.set("E",{code:69,ch:69});B.set("F",{code:70,ch:70});B.set("G",{code:71,ch:71});B.set("H",{code:72,ch:72});B.set("I",{code:73,ch:73});B.set("J",{code:74,ch:74});B.set("K",{code:75,ch:75});B.set("L",{code:76,ch:76});B.set("M",{code:77,ch:77});B.set("N",{code:78,ch:78});B.set("O",{code:79,ch:79});B.set("P",{code:80,ch:80});B.set("Q",{code:81,ch:81});B.set("R",{code:82,ch:82});B.set("S",{code:83,ch:83});B.set("T",{code:84,ch:84});B.set("U",{code:85,ch:85});B.set("V",{code:86,ch:86});B.set("W",{code:87,ch:87});B.set("X",{code:88,ch:88});B.set("Y",{code:89,ch:89});B.set("Z",{code:90,ch:90});class G0{static enabled=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled(){this.outBuffer=z.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.enabled=!0}static setDisabled(){this.enabled=!1,this.outBuffer=null,this.oldBuffer=null}static flush(){let u=null;if(this.oldBuffer&&this.enabled)u=this.oldBuffer;return this.oldBuffer=null,u}static stop(){let u=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.enabled)u=this.outBuffer;return this.setDisabled(),u}static ensureCapacity(u){if(!this.outBuffer)return;if(this.outBuffer.pos+u>=500){let R=this.outBuffer;this.outBuffer=z.alloc(1),this.oldBuffer=R}}static mousePressed(u,R,m){if(!this.outBuffer)return;if(!this.enabled&&(u>=0&&u<789&&R>=0&&R<532))return;this.trackedCount++;let _=performance.now(),b=(_-this.lastTime)/10|0;if(b>250)b=250;if(this.lastTime=_,this.ensureCapacity(5),m===2)this.outBuffer.p1(1);else this.outBuffer.p1(2);this.outBuffer.p1(b),this.outBuffer.p3(u+(R<<10))}static mouseReleased(u){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let R=performance.now(),m=(R-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=R,this.ensureCapacity(2),u===2)this.outBuffer.p1(3);else this.outBuffer.p1(4);this.outBuffer.p1(m)}static mouseMoved(u,R){if(!this.outBuffer)return;if(!this.enabled&&(u>=0&&u<789&&R>=0&&R<532))return;let m=performance.now();if(m-this.lastMoveTime<50)return;this.lastMoveTime=m,this.trackedCount++;let _=(m-this.lastTime)/10|0;if(_>250)_=250;if(this.lastTime=m,u-this.lastX<8&&u-this.lastX>=-8&&R-this.lastY<8&&R-this.lastY>=-8)this.ensureCapacity(3),this.outBuffer.p1(5),this.outBuffer.p1(_),this.outBuffer.p1(u+(R-this.lastY+8<<4)+8-this.lastX);else if(u-this.lastX<128&&u-this.lastX>=-128&&R-this.lastY<128&&R-this.lastY>=-128)this.ensureCapacity(4),this.outBuffer.p1(6),this.outBuffer.p1(_),this.outBuffer.p1(u+128-this.lastX),this.outBuffer.p1(R+128-this.lastY);else this.ensureCapacity(5),this.outBuffer.p1(7),this.outBuffer.p1(_),this.outBuffer.p3(u+(R<<10));this.lastX=u,this.lastY=R}static keyPressed(u){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let R=performance.now(),m=(R-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=R,u===1000)u=11;else if(u===1001)u=12;else if(u===1002)u=14;else if(u===1003)u=15;else if(u>=1008)u-=992;this.ensureCapacity(3),this.outBuffer.p1(8),this.outBuffer.p1(m),this.outBuffer.p1(u)}static keyReleased(u){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let R=performance.now(),m=(R-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=R,u===1000)u=11;else if(u===1001)u=12;else if(u===1002)u=14;else if(u===1003)u=15;else if(u>=1008)u-=992;this.ensureCapacity(3),this.outBuffer.p1(9),this.outBuffer.p1(m),this.outBuffer.p1(u)}static focusGained(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),R=(u-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=u,this.ensureCapacity(2),this.outBuffer.p1(10),this.outBuffer.p1(R)}static focusLost(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),R=(u-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=u,this.ensureCapacity(2),this.outBuffer.p1(11),this.outBuffer.p1(R)}static mouseEntered(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),R=(u-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=u,this.ensureCapacity(2),this.outBuffer.p1(12),this.outBuffer.p1(R)}static mouseExited(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),R=(u-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=u,this.ensureCapacity(2),this.outBuffer.p1(13),this.outBuffer.p1(R)}}class _1{state=0;deltime=20;mindel=1;otim=new Array(10);fps=0;debug=!1;drawArea=null;redrawScreen=!0;hasFocus=!0;idleCycles=performance.now();mouseButton=0;mouseX=-1;mouseY=-1;lastMouseClickButton=0;lastMouseClickX=0;lastMouseClickY=0;mouseClickButton=0;mouseClickX=-1;mouseClickY=-1;lastMouseClickTime=0;mouseClickTime=0;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;slowestMS=0;averageMS=[];averageIndexMS=0;resizeToFit=!1;tfps=50;fpos=0;frameTime=[];ingame=!1;touching=!1;startedInViewport=!1;startedInTabArea=!1;time=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;async load(){}async update(){}async draw(){}async refresh(){}constructor(u=!1){if(d.tabIndex=-1,C.fillStyle="black",C.fillRect(0,0,d.width,d.height),this.resizeToFit=u,this.resizeToFit)this.resize(window.innerWidth,window.innerHeight);else this.resize(d.width,d.height)}get width(){return d.width}get height(){return d.height}resize(u,R){d.width=u,d.height=R,this.drawArea=new L0(u,R),Z.init2D()}async run(){if(d.addEventListener("resize",()=>{if(this.resizeToFit)this.resize(window.innerWidth,window.innerHeight)},!1),d.onfocus=this.onfocus.bind(this),d.onblur=this.onblur.bind(this),d.onmousedown=this.onmousedown.bind(this),d.onmouseup=this.onmouseup.bind(this),d.onmouseenter=this.onmouseenter.bind(this),d.onmouseleave=this.onmouseleave.bind(this),d.onmousemove=this.onmousemove.bind(this),d.onkeydown=this.onkeydown.bind(this),d.onkeyup=this.onkeyup.bind(this),this.isMobile)d.ontouchstart=this.ontouchstart.bind(this),d.ontouchend=this.ontouchend.bind(this),d.ontouchmove=this.ontouchmove.bind(this);d.oncontextmenu=(E)=>{E.preventDefault()},window.oncontextmenu=(E)=>{E.preventDefault()},await this.drawProgress(0,"Loading..."),await this.load();let u=0,R=0,m=256,_=1,b=0;for(let E=0;E<10;E++)this.otim[E]=performance.now();while(this.state>=0){if(this.state>0){if(this.state--,this.state===0){this.shutdown();return}}let E=m,O=_;m=300,_=1,u=performance.now();let I=this.otim[R];if(I===0)m=E,_=O;else if(u>I)m=this.deltime*2560/(u-I)|0;if(m<25)m=25;else if(m>256)m=256,_=this.deltime-(u-I)/10|0;if(this.otim[R]=u,R=(R+1)%10,_>1){for(let H=0;H<10;H++)if(this.otim[H]!==0)this.otim[H]+=_}if(_<this.mindel)_=this.mindel;await X0(_);while(b<256)this.mouseClickButton=this.lastMouseClickButton,this.mouseClickX=this.lastMouseClickX,this.mouseClickY=this.lastMouseClickY,this.mouseClickTime=this.lastMouseClickTime,this.lastMouseClickButton=0,await this.update(),b+=m;if(b&=255,this.deltime>0)this.fps=m*1000/(this.deltime*256)|0;let L=performance.now();if(await this.draw(),this.isMobile)Y0.draw();if(this.frameTime[this.fpos]=(performance.now()-L)/1000,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50){let H=1000/this.tfps-(performance.now()-u);if(H>0)await X0(H)}if(this.debug){for(let H=0;H<10;H++){let N=(R-H-1+20)%10}this.debug=!1}}if(this.state===-1)this.shutdown()}shutdown(){this.state=-2}setFramerate(u){this.deltime=1000/u|0}setTargetedFramerate(u){this.tfps=Math.max(Math.min(50,u|0),0)}start(){if(this.state>=0)this.state=0}stop(){if(this.state>=0)this.state=4000/this.deltime|0}async drawProgress(u,R){let m=this.width,_=this.height;if(this.redrawScreen)C.fillStyle="black",C.fillRect(0,0,m,_),this.redrawScreen=!1;let b=_/2-18;C.strokeStyle="rgb(140, 17, 17)",C.strokeRect((m/2|0)-152,b,304,34),C.fillStyle="rgb(140, 17, 17)",C.fillRect((m/2|0)-150,b+2,u*3,30),C.fillStyle="black",C.fillRect((m/2|0)-150+u*3,b+2,300-u*3,30),C.font="bold 13px helvetica, sans-serif",C.textAlign="center",C.fillStyle="white",C.fillText(R,m/2|0,b+22),await X0(5)}pollKey(){let u=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos)u=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127;return u}get ms(){let u=this.frameTime.length,R=0;for(let _=0;_<u;_++)R+=this.frameTime[_];let m=R/u*1000;if(m>this.slowestMS)this.slowestMS=m;return this.averageMS[this.averageIndexMS]=m,this.averageIndexMS=(this.averageIndexMS+1)%250,m}get msAvg(){return this.averageMS.reduce((u,R)=>u+R,0)/250}onkeydown(u){this.idleCycles=performance.now();let R=B.get(u.key);if(!R||u.code.length===0&&!u.isTrusted)return;let m=R.ch;if(u.ctrlKey){if(m>=65&&m<=93||m==95)m-=64;else if(m>=97&&m<=122)m-=96}if(m>0&&m<128)this.actionKey[m]=1;if(m>4)this.keyQueue[this.keyQueueWritePos]=m,this.keyQueueWritePos=this.keyQueueWritePos+1&127;if(G0.enabled)G0.keyPressed(m);if(!w1.includes(u.key))u.preventDefault()}onkeyup(u){this.idleCycles=performance.now();let R=B.get(u.key);if(!R||u.code.length===0&&!u.isTrusted)return;let m=R.ch;if(u.ctrlKey){if(m>=65&&m<=93||m==95)m-=64;else if(m>=97&&m<=122)m-=96}if(m>0&&m<128)this.actionKey[m]=0;if(G0.enabled)G0.keyReleased(m);if(!w1.includes(u.key))u.preventDefault()}onmousedown(u){if(this.touching=!1,u.clientX>0||u.clientY>0)this.setMousePosition(u);if(this.idleCycles=performance.now(),this.lastMouseClickX=this.mouseX,this.lastMouseClickY=this.mouseY,this.lastMouseClickTime=performance.now(),this.isMobile&&!this.isCapacitor){if(this.insideMobileInputArea()&&!this.insideChatPopupArea()){this.lastMouseClickButton=1,this.mouseButton=1;return}if(u.timeStamp>=this.time+500)this.lastMouseClickButton=2,this.mouseButton=2;else this.lastMouseClickButton=1,this.mouseButton=1}else if(u.button===2)this.lastMouseClickButton=2,this.mouseButton=2;else if(u.button===0)this.lastMouseClickButton=1,this.mouseButton=1;if(Y0.isDisplayed()){if(Y0.captureMouseDown(this.mouseX,this.mouseY))this.mouseButton=0,this.mouseClickButton=0}if(G0.enabled)G0.mousePressed(this.lastMouseClickX,this.lastMouseClickY,u.button)}onmouseup(u){if(this.setMousePosition(u),this.idleCycles=performance.now(),this.mouseButton=0,this.isMobile){if(this.insideMobileInputArea()&&!Y0.isDisplayed())Y0.show(this.mouseX,this.mouseY);else if(Y0.isDisplayed()){if(!Y0.captureMouseUp(this.mouseX,this.mouseY))Y0.hide(),this.refresh()}}if(G0.enabled)G0.mouseReleased(u.button)}onmouseenter(u){if(this.setMousePosition(u),G0.enabled)G0.mouseEntered()}onmouseleave(u){if(this.setMousePosition(u),this.idleCycles=performance.now(),this.mouseX=-1,this.mouseY=-1,this.mouseButton=0,this.mouseClickX=-1,this.mouseClickY=-1,G0.enabled)G0.mouseExited()}onmousemove(u){if(this.setMousePosition(u),this.idleCycles=performance.now(),this.isMobile&&this.touching){if(Y0.isDisplayed())Y0.notifyTouchMove(this.mouseX,this.mouseY)}if(G0.enabled)G0.mouseMoved(this.mouseX,this.mouseY)}onfocus(u){if(this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),G0.enabled)G0.focusGained()}onblur(u){this.hasFocus=!1;for(let R=0;R<128;R++)this.actionKey[R]=0;if(G0.enabled)G0.focusLost()}ontouchstart(u){if(!this.isMobile)return;this.touching=!0;let R=u.changedTouches[0],m=R.clientX|0,_=R.clientY|0;this.onmousemove(new MouseEvent("mousemove",{clientX:m,clientY:_})),this.sx=this.nx=this.mx=R.screenX|0,this.sy=this.ny=this.my=R.screenY|0,this.time=u.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea()}ontouchend(u){if(!this.isMobile||!this.touching)return;let R=u.changedTouches[0],m=R.clientX|0,_=R.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:m,clientY:_})),this.nx=R.screenX|0,this.ny=R.screenY|0,this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.startedInViewport&&!this.insideViewportArea()){this.touching=!1;return}else if(this.startedInTabArea&&!this.insideTabArea()){this.touching=!1;return}else if(this.insideMobileInputArea()){this.touching=!1;return}let E=u.timeStamp>=this.time+500,O=Math.abs(this.sx-this.nx)>16||Math.abs(this.sy-this.ny)>16;if(E&&!O)this.touching=!0,this.onmousedown(new MouseEvent("mousedown",{clientX:m,clientY:_,button:2})),this.onmouseup(new MouseEvent("mouseup",{clientX:m,clientY:_,button:2}))}ontouchmove(u){if(!this.isMobile||!this.touching)return;if(u.touches.length>1)return;u.preventDefault();let R=u.changedTouches[0],m=R.clientX|0,_=R.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:m,clientY:_})),this.nx=R.screenX|0,this.ny=R.screenY|0,!Y0.isWithinCanvasKeyboard(this.mouseX,this.mouseY)){if(this.startedInViewport&&this.getViewportInterfaceId()===-1){if(this.mx-this.nx>0)this.rotate(2);else if(this.mx-this.nx<0)this.rotate(0);if(this.my-this.ny>0)this.rotate(3);else if(this.my-this.ny<0)this.rotate(1)}else if(this.startedInTabArea||this.getViewportInterfaceId()!==-1)this.onmousedown(new MouseEvent("mousedown",{clientX:m,clientY:_,button:1}))}this.mx=this.nx,this.my=this.ny}get isMobile(){if(["Android","webOS","iPhone","iPad","iPod","BlackBerry","Windows Phone"].some((R)=>navigator.userAgent.includes(R)))return!0;if(navigator){if(navigator.maxTouchPoints!==void 0&&navigator.maxTouchPoints>2&&navigator.standalone!==void 0)return!0}return!1}get isAndroid(){return["Android"].some((R)=>navigator.userAgent.includes(R))}get isCapacitor(){return["Capacitor"].some((R)=>navigator.userAgent.includes(R))}insideViewportArea(){return this.ingame&&this.mouseX>=4&&this.mouseX<=516&&this.mouseY>=4&&this.mouseY<=338}insideMobileInputArea(){return this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()||this.insideReportInterfaceTextArea()}insideChatInputArea(){return this.ingame&&this.getChatInterfaceId()===-1&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=17&&this.mouseX<=496&&this.mouseY>=434&&this.mouseY<=460}insideChatPopupArea(){return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=17&&this.mouseX<=496&&this.mouseY>=357&&this.mouseY<=453}insideReportInterfaceTextArea(){if(!this.ingame)return!1;let u=this.getViewportInterfaceId(),R=this.getReportAbuseInterfaceId();if(u===-1||R===-1)return!1;if(u!==R)return!1;let m=82,_=137,b=m+366,E=_+26;return this.mouseX>=m&&this.mouseX<=b&&this.mouseY>=_&&this.mouseY<=E}insideTabArea(){return this.ingame&&this.mouseX>=553&&this.mouseX<=743&&this.mouseY>=205&&this.mouseY<=466}insideUsernameArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=280&&this.mouseX<=470&&this.mouseY>=233&&this.mouseY<=264}inPasswordArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=280&&this.mouseX<=558&&this.mouseY>=264&&this.mouseY<=284}rotate(u){if(u===0)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowLeft",code:"ArrowLeft"}));else if(u===1)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowUp",code:"ArrowUp"}));else if(u===2)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowRight",code:"ArrowRight"}));else if(u===3)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown"}))}isFullScreen(){return document.fullscreenElement!==null}setMousePosition(u){let R=this.width,m=this.height,_=d.getBoundingClientRect(),b={x:u.clientX-_.left,y:u.clientY-_.top};if(this.isFullScreen()){let E=R/m,I=window.innerWidth/window.innerHeight>=E,L=0,H=0,N=0,G=0;if(I)L=window.innerHeight*E,H=window.innerHeight,N=(window.innerWidth-L)/2;else L=window.innerWidth,H=window.innerWidth/E,G=(window.innerHeight-H)/2;let Q=R/L,$=m/H;this.mouseX=(b.x-N)*Q|0,this.mouseY=(b.y-G)*$|0}else{let E=d.width/_.width,O=d.height/_.height;this.mouseX=b.x*E|0,this.mouseY=b.y*O|0}if(this.mouseX<0)this.mouseX=0;if(this.mouseY<0)this.mouseY=0;if(this.mouseX>R)this.mouseX=R;if(this.mouseY>m)this.mouseY=m}}class U0{id;debugname=null;constructor(u){this.id=u}unpackType(u){while(!0){let R=u.g1();if(R===0)break;this.unpack(R,u)}return this}}class M0 extends U0{static count=0;static types=[];rgb=0;texture=-1;overlay=!1;occlude=!0;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;static unpack(u){let R=new z(u.read("flo.dat"));this.count=R.g2(),this.types=new Array(this.count);for(let m=0;m<this.count;m++){if(!this.types[m])this.types[m]=new M0(m);this.types[m].unpackType(R)}}unpack(u,R){if(u===1)this.rgb=R.g3(),this.setColour(this.rgb);else if(u===2)this.texture=R.g1();else if(u===3)this.overlay=!0;else if(u===5)this.occlude=!1;else if(u===6)this.debugname=R.gjstr()}setColour(u){let R=(u>>16&255)/256,m=(u>>8&255)/256,_=(u&255)/256,b=R;if(m<R)b=m;if(_<b)b=_;let E=R;if(m>R)E=m;if(_>E)E=_;let O=0,I=0,L=(b+E)/2;if(b!==E){if(L<0.5)I=(E-b)/(E+b);if(L>=0.5)I=(E-b)/(2-E-b);if(R===E)O=(m-_)/(E-b);else if(m===E)O=(_-R)/(E-b)+2;else if(_===E)O=(R-m)/(E-b)+4}if(O/=6,this.hue=O*256|0,this.saturation=I*256|0,this.lightness=L*256|0,this.saturation<0)this.saturation=0;else if(this.saturation>255)this.saturation=255;if(this.lightness<0)this.lightness=0;else if(this.lightness>255)this.lightness=255;if(L>0.5)this.luminance=(1-L)*I*512|0;else this.luminance=L*I*512|0;if(this.luminance<1)this.luminance=1;this.chroma=O*this.luminance|0;let H=this.hue+(Math.random()*16|0)-8;if(H<0)H=0;else if(H>255)H=255;let N=this.saturation+(Math.random()*48|0)-24;if(N<0)N=0;else if(N>255)N=255;let G=this.lightness+(Math.random()*48|0)-24;if(G<0)G=0;else if(G>255)G=255;this.hsl=M0.hsl24to16(H,N,G)}static hsl24to16(u,R,m){if(m>179)R=R/2|0;if(m>192)R=R/2|0;if(m>217)R=R/2|0;if(m>243)R=R/2|0;return((u/4|0)<<10)+((R/32|0)<<7)+(m/2|0)}}class m1{length=0;types=null;labels=null;constructor(u){this.length=u.g1(),this.types=new Uint8Array(this.length),this.labels=new p(this.length,null);for(let R=0;R<this.length;R++)this.types[R]=u.g1();for(let R=0;R<this.length;R++){let m=u.g1();this.labels[R]=new Uint8Array(m);for(let _=0;_<m;_++)this.labels[R][_]=u.g1()}}}class A0{static instances=[];delay=-1;base=null;length=0;groups=null;x=null;y=null;z=null;static init(u){this.instances=new Array(u+1)}static unpack(u){let R=new z(u);R.pos=u.length-8;let m=R.g2(),_=R.g2(),b=R.g2(),E=R.g2(),O=0,I=new z(u);I.pos=O,O+=m+2;let L=new z(u);L.pos=O,O+=_;let H=new z(u);H.pos=O,O+=b;let N=new z(u);N.pos=O,O+=E;let G=new z(u);G.pos=O;let Q=new m1(G),$=I.g2(),T=new Int32Array(500),U=new Int32Array(500),K=new Int32Array(500),q=new Int32Array(500);for(let w=0;w<$;w++){let V=I.g2(),Y=this.instances[V]=new A0;Y.delay=N.g1(),Y.base=Q;let A=I.g1(),h=-1,n=0;for(let f=0;f<A;f++){if(!Q.types)throw new Error;let D=L.g1();if(D>0){if(Q.types[f]!==0){for(let W=f-1;W>h;W--)if(Q.types[W]===0){T[n]=W,U[n]=0,K[n]=0,q[n]=0,n++;break}}T[n]=f;let j=0;if(Q.types[T[n]]===3)j=128;if((D&1)===0)U[n]=j;else U[n]=H.gsmart();if((D&2)===0)K[n]=j;else K[n]=H.gsmart();if((D&4)===0)q[n]=j;else q[n]=H.gsmart();h=f,n++}}Y.length=n,Y.groups=new Int32Array(n),Y.x=new Int32Array(n),Y.y=new Int32Array(n),Y.z=new Int32Array(n);for(let f=0;f<n;f++)Y.groups[f]=T[f],Y.x[f]=U[f],Y.y[f]=K[f],Y.z[f]=q[f]}}static get(u){return A0.instances[u]}}class o extends U0{static count=0;static types=[];frameCount=0;frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=!1;priority=5;righthand=-1;lefthand=-1;replaycount=99;preanim_move=-1;postanim_move=-1;restart_mode=-1;static unpack(u){let R=new z(u.read("seq.dat"));this.count=R.g2(),this.types=new Array(this.count);for(let m=0;m<this.count;m++){if(!this.types[m])this.types[m]=new o(m);let _=this.types[m].unpackType(R);if(_.preanim_move===-1)if(_.walkmerge===null)_.preanim_move=0;else _.preanim_move=2;if(_.postanim_move===-1)if(_.walkmerge===null)_.postanim_move=0;else _.postanim_move=2;if(_.frameCount===0)_.frameCount=1,_.frames=new Int16Array(1),_.frames[0]=-1,_.iframes=new Int16Array(1),_.iframes[0]=-1,_.delay=new Int16Array(1),_.delay[0]=-1}}getFrameDuration(u){if(!this.delay||!this.frames)return 0;let R=this.delay[u];if(R===0){let m=A0.get(this.frames[u]);if(m!=null)R=this.delay[u]=m.delay}if(R===0)R=1;return R}unpack(u,R){if(u===1){this.frameCount=R.g1(),this.frames=new Int16Array(this.frameCount),this.iframes=new Int16Array(this.frameCount),this.delay=new Int16Array(this.frameCount);for(let m=0;m<this.frameCount;m++){if(this.frames[m]=R.g2(),this.iframes[m]=R.g2(),this.iframes[m]===65535)this.iframes[m]=-1;this.delay[m]=R.g2()}}else if(u===2)this.replayoff=R.g2();else if(u===3){let m=R.g1();this.walkmerge=new Int32Array(m+1);for(let _=0;_<m;_++)this.walkmerge[_]=R.g1();this.walkmerge[m]=9999999}else if(u===4)this.stretches=!0;else if(u===5)this.priority=R.g1();else if(u===6)this.righthand=R.g2();else if(u===7)this.lefthand=R.g2();else if(u===8)this.replaycount=R.g1();else if(u===9)this.preanim_move=R.g1();else if(u===10)this.postanim_move=R.g1();else if(u===11)this.restart_mode=R.g1()}}class b1{bucketCount;buckets;constructor(u){this.buckets=new Array(u),this.bucketCount=u;for(let R=0;R<u;R++){let m=this.buckets[R]=new n0;m.next=m,m.prev=m}}get(u){let R=this.buckets[Number(u&BigInt(this.bucketCount-1))];for(let m=R.next;m!==R;m=m.next){if(!m)continue;if(m.key===u)return m}return null}put(u,R){if(R.prev)R.unlink();let m=this.buckets[Number(u&BigInt(this.bucketCount-1))];if(R.prev=m.prev,R.next=m,R.prev)R.prev.next=R;R.next.prev=R,R.key=u}}class C0{sentinel=new V0;cursor=null;constructor(){this.sentinel.next2=this.sentinel,this.sentinel.prev2=this.sentinel}push(u){if(u.prev2)u.unlink2();if(u.prev2=this.sentinel.prev2,u.next2=this.sentinel,u.prev2)u.prev2.next2=u;u.next2.prev2=u}pop(){let u=this.sentinel.next2;if(u===this.sentinel)return null;else return u?.unlink2(),u}head(){let u=this.sentinel.next2;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.next2||null,u}next(){let u=this.cursor;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.next2||null,u}size(){let u=0;for(let R=this.sentinel.next2;R!==this.sentinel&&R;R=R.next2)u++;return u}}class F0{capacity;hashtable=new b1(1024);cacheHistory=new C0;cacheAvailable;constructor(u){this.capacity=u,this.cacheAvailable=u}get(u){let R=this.hashtable.get(u);if(R)this.cacheHistory.push(R);return R}put(u,R){if(this.cacheAvailable===0){let m=this.cacheHistory.pop();m?.unlink(),m?.unlink2()}else this.cacheAvailable--;this.hashtable.put(u,R),this.cacheHistory.push(R)}clear(){while(!0){let u=this.cacheHistory.pop();if(!u){this.cacheAvailable=this.capacity;return}u.unlink(),u.unlink2()}}}class g{static WALL_STRAIGHT=new g(0,0);static WALL_DIAGONAL_CORNER=new g(1,0);static WALL_L=new g(2,0);static WALL_SQUARE_CORNER=new g(3,0);static WALLDECOR_STRAIGHT_NOOFFSET=new g(4,1);static WALLDECOR_STRAIGHT_OFFSET=new g(5,1);static WALLDECOR_DIAGONAL_OFFSET=new g(6,1);static WALLDECOR_DIAGONAL_NOOFFSET=new g(7,1);static WALLDECOR_DIAGONAL_BOTH=new g(8,1);static WALL_DIAGONAL=new g(9,2);static CENTREPIECE_STRAIGHT=new g(10,2);static CENTREPIECE_DIAGONAL=new g(11,2);static ROOF_STRAIGHT=new g(12,2);static ROOF_DIAGONAL_WITH_ROOFEDGE=new g(13,2);static ROOF_DIAGONAL=new g(14,2);static ROOF_L_CONCAVE=new g(15,2);static ROOF_L_CONVEX=new g(16,2);static ROOF_FLAT=new g(17,2);static ROOFEDGE_STRAIGHT=new g(18,2);static ROOFEDGE_DIAGONAL_CORNER=new g(19,2);static ROOFEDGE_L=new g(20,2);static ROOFEDGE_SQUARE_CORNER=new g(21,2);static GROUND_DECOR=new g(22,3);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(u){let R=this.values();for(let m=0;m<R.length;m++){let _=R[m];if(_.id===u)return _}throw Error("shape not found")}id;layer;constructor(u,R){this.id=u,this.layer=R}}class j0 extends V0{vertexNormal=null;minY=1000;draw(u,R,m,_,b,E,O,I,L,H){let N=this.getModel(u);if(N)this.minY=N.minY,N.draw(0,R,m,_,b,E,O,I,L,H)}getModel(u){return null}}class i0{x=0;y=0;z=0;w=0}class A1{data=null;vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColoursOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1}class J extends j0{static loaded=0;static empty=new J;static tmpVertexX=new Int32Array(2000);static tmpVertexY=new Int32Array(2000);static tmpVertexZ=new Int32Array(2000);static tmpFaceAlpha=new Int32Array(2000);maxDepth=0;minDepth=0;objRaise=0;vertexLabel=null;faceLabel=null;labelVertices=null;labelFaces=null;picking=!1;vertexNormalOriginal=null;static meta=null;static provider;static faceClippedX=new p(4096,!1);static faceNearClipped=new p(4096,!1);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new f0(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new f0(12,2000);static tmpPriority10FaceDepth=new Int32Array(2000);static tmpPriority11FaceDepth=new Int32Array(2000);static tmpPriorityDepthSum=new Int32Array(12);vertexCount=0;faceCount=0;texturedFaceCount=0;vertexX=null;vertexY=null;vertexZ=null;faceVertexA=null;faceVertexB=null;faceVertexC=null;texturedVertexA=null;texturedVertexB=null;texturedVertexC=null;faceInfo=null;facePriority=null;priority=0;faceAlpha=null;faceColour=null;faceColourA=null;faceColourB=null;faceColourC=null;maxY=0;radius=0;minX=0;maxX=0;minZ=0;maxZ=0;static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColour=new Int32Array(10);static pickedBitsets=new Int32Array(1000);static baseX=0;static baseY=0;static baseZ=0;static mouseX=0;static mouseY=0;static pickedCount=0;static checkHover=!1;static init(u,R){J.meta=new Array(u),J.provider=R}static unpack(u,R){if(!J.meta)return;if(!R){let T=J.meta[u]=new A1;T.vertexCount=0,T.faceCount=0,T.texturedFaceCount=0;return}let m=new z(R);m.pos=R.length-18;let _=J.meta[u]=new A1;_.data=R,_.vertexCount=m.g2(),_.faceCount=m.g2(),_.texturedFaceCount=m.g1();let b=m.g1(),E=m.g1(),O=m.g1(),I=m.g1(),L=m.g1(),H=m.g2(),N=m.g2(),G=m.g2(),Q=m.g2(),$=0;if(_.vertexFlagsOffset=$,$+=_.vertexCount,_.faceOrientationsOffset=$,$+=_.faceCount,_.facePrioritiesOffset=$,E==255)$+=_.faceCount;else _.facePrioritiesOffset=-E-1;if(_.faceLabelsOffset=$,I==1)$+=_.faceCount;else _.faceLabelsOffset=-1;if(_.faceInfosOffset=$,b==1)$+=_.faceCount;else _.faceInfosOffset=-1;if(_.vertexLabelsOffset=$,L==1)$+=_.vertexCount;else _.vertexLabelsOffset=-1;if(_.faceAlphasOffset=$,O==1)$+=_.faceCount;else _.faceAlphasOffset=-1;_.faceVerticesOffset=$,$+=Q,_.faceColoursOffset=$,$+=_.faceCount*2,_.faceTextureAxisOffset=$,$+=_.texturedFaceCount*6,_.vertexXOffset=$,$+=H,_.vertexYOffset=$,$+=N,_.vertexZOffset=$,$+=G}static unload(u){if(J.meta)J.meta[u]=null}static tryGet(u){if(!J.meta)return null;if(!J.meta[u])return J.provider.requestModel(u),null;return J.fromId(u)}static isReady(u){if(!J.meta)return!1;if(!J.meta[u])return J.provider.requestModel(u),!1;return!0}constructor(u){super();if(u)this.vertexCount=u.vertexCount,this.vertexX=u.vertexX,this.vertexY=u.vertexY,this.vertexZ=u.vertexZ,this.faceCount=u.faceCount,this.faceVertexA=u.faceVertexA,this.faceVertexB=u.faceVertexB,this.faceVertexC=u.faceVertexC,this.faceColourA=u.faceColorA,this.faceColourB=u.faceColorB,this.faceColourC=u.faceColorC,this.faceInfo=u.faceInfo,this.facePriority=u.facePriority,this.faceAlpha=u.faceAlpha,this.faceColour=u.faceColor,this.priority=u.priorityVal,this.texturedFaceCount=u.texturedFaceCount,this.texturedVertexA=u.texturedVertexA,this.texturedVertexB=u.texturedVertexB,this.texturedVertexC=u.texturedVertexC,this.minX=u.minX??0,this.maxX=u.maxX??0,this.minZ=u.minZ??0,this.maxZ=u.maxZ??0,this.radius=u.radius??0,this.maxY=u.minY??0,this.minY=u.maxY??0,this.maxDepth=u.maxDepth??0,this.minDepth=u.minDepth??0,this.vertexLabel=u.vertexLabel??null,this.faceLabel=u.faceLabel??null,this.labelVertices=u.labelVertices??null,this.labelFaces=u.labelFaces??null,this.vertexNormal=u.vertexNormal??null,this.vertexNormalOriginal=u.vertexNormalOriginal??null}static fromId(u){if(!J.meta||!J.meta[u])return new J;J.loaded++;let R=J.meta[u],m=new J;if(m.vertexCount=R.vertexCount,m.faceCount=R.faceCount,m.texturedFaceCount=R.texturedFaceCount,m.vertexX=new Int32Array(m.vertexCount),m.vertexY=new Int32Array(m.vertexCount),m.vertexZ=new Int32Array(m.vertexCount),m.faceVertexA=new Int32Array(m.faceCount),m.faceVertexB=new Int32Array(m.faceCount),m.faceVertexC=new Int32Array(m.faceCount),m.texturedVertexA=new Int32Array(m.texturedFaceCount),m.texturedVertexB=new Int32Array(m.texturedFaceCount),m.texturedVertexC=new Int32Array(m.texturedFaceCount),R.vertexLabelsOffset>=0)m.vertexLabel=new Int32Array(m.vertexCount);if(R.faceInfosOffset>=0)m.faceInfo=new Int32Array(m.faceCount);if(R.facePrioritiesOffset>=0)m.facePriority=new Int32Array(m.faceCount);else m.priority=-R.facePrioritiesOffset-1;if(R.faceAlphasOffset>=0)m.faceAlpha=new Int32Array(m.faceCount);if(R.faceLabelsOffset>=0)m.faceLabel=new Int32Array(m.faceCount);m.faceColour=new Int32Array(m.faceCount);let _=new z(R.data);_.pos=R.vertexFlagsOffset;let b=new z(R.data);b.pos=R.vertexXOffset;let E=new z(R.data);E.pos=R.vertexYOffset;let O=new z(R.data);O.pos=R.vertexZOffset;let I=new z(R.data);I.pos=R.vertexLabelsOffset;let L=0,H=0,N=0;for(let n=0;n<m.vertexCount;n++){let f=_.g1(),D=0;if((f&1)!=0)D=b.gsmart();let j=0;if((f&2)!=0)j=E.gsmart();let W=0;if((f&4)!=0)W=O.gsmart();if(m.vertexX[n]=L+D,m.vertexY[n]=H+j,m.vertexZ[n]=N+W,L=m.vertexX[n],H=m.vertexY[n],N=m.vertexZ[n],m.vertexLabel!=null)m.vertexLabel[n]=I.g1()}let G=new z(R.data);G.pos=R.faceColoursOffset;let Q=new z(R.data);Q.pos=R.faceInfosOffset;let $=new z(R.data);$.pos=R.facePrioritiesOffset;let T=new z(R.data);T.pos=R.faceAlphasOffset;let U=new z(R.data);U.pos=R.faceLabelsOffset;for(let n=0;n<m.faceCount;n++){if(m.faceColour[n]=G.g2(),m.faceInfo!=null)m.faceInfo[n]=Q.g1();if(m.facePriority!=null)m.facePriority[n]=$.g1();if(m.faceAlpha!=null)m.faceAlpha[n]=T.g1();if(m.faceLabel!=null)m.faceLabel[n]=U.g1()}let K=new z(R.data);K.pos=R.faceVerticesOffset;let q=new z(R.data);q.pos=R.faceOrientationsOffset;let w=0,V=0,Y=0,A=0;for(let n=0;n<m.faceCount;n++){let f=q.g1();if(f==1)w=K.gsmart()+A,V=K.gsmart()+w,Y=K.gsmart()+V,A=Y;else if(f==2)w=w,V=Y,Y=K.gsmart()+A,A=Y;else if(f==3)w=Y,V=V,Y=K.gsmart()+A,A=Y;else if(f==4){let D=w;w=V,V=D,Y=K.gsmart()+A,A=Y}m.faceVertexA[n]=w,m.faceVertexB[n]=V,m.faceVertexC[n]=Y}let h=new z(R.data);h.pos=R.faceTextureAxisOffset;for(let n=0;n<m.texturedFaceCount;n++)m.texturedVertexA[n]=h.g2(),m.texturedVertexB[n]=h.g2(),m.texturedVertexC[n]=h.g2();return m}static modelCopyFaces(u,R,m){let{vertexCount:_,faceCount:b,texturedFaceCount:E}=u,O;if(R){O=new Int32Array(_);for(let $=0;$<_;$++)O[$]=u.vertexY[$]}else O=u.vertexY;let I,L,H,N,G=null,Q=null;if(m){I=new Int32Array(b),L=new Int32Array(b),H=new Int32Array(b);for(let $=0;$<b;$++){if(u.faceColourA)I[$]=u.faceColourA[$];if(u.faceColourB)L[$]=u.faceColourB[$];if(u.faceColourC)H[$]=u.faceColourC[$]}if(N=new Int32Array(b),!u.faceInfo)for(let $=0;$<b;$++)N[$]=0;else for(let $=0;$<b;$++)N[$]=u.faceInfo[$];G=new p(_,null);for(let $=0;$<_;$++){let T=G[$]=new i0;if(u.vertexNormal){let U=u.vertexNormal[$];if(U)T.x=U.x,T.y=U.y,T.z=U.z,T.w=U.w}}Q=u.vertexNormalOriginal}else I=u.faceColourA,L=u.faceColourB,H=u.faceColourC,N=u.faceInfo;return new J({vertexCount:_,vertexX:u.vertexX,vertexY:O,vertexZ:u.vertexZ,faceCount:b,faceVertexA:u.faceVertexA,faceVertexB:u.faceVertexB,faceVertexC:u.faceVertexC,faceColorA:I,faceColorB:L,faceColorC:H,faceInfo:N,facePriority:u.facePriority,faceAlpha:u.faceAlpha,faceColor:u.faceColour,priorityVal:u.priority,texturedFaceCount:E,texturedVertexA:u.texturedVertexA,texturedVertexB:u.texturedVertexB,texturedVertexC:u.texturedVertexC,minX:u.minX,maxX:u.maxX,minZ:u.minZ,maxZ:u.maxZ,radius:u.radius,minY:u.maxY,maxY:u.minY,maxDepth:u.maxDepth,minDepth:u.minDepth,vertexNormal:G,vertexNormalOriginal:Q})}static modelShareColored(u,R,m,_){let{vertexCount:b,faceCount:E,texturedFaceCount:O}=u,I,L,H;if(_)I=u.vertexX,L=u.vertexY,H=u.vertexZ;else{I=new Int32Array(b),L=new Int32Array(b),H=new Int32Array(b);for(let Q=0;Q<b;Q++)I[Q]=u.vertexX[Q],L[Q]=u.vertexY[Q],H[Q]=u.vertexZ[Q]}let N;if(R)N=u.faceColour;else{N=new Int32Array(E);for(let Q=0;Q<E;Q++)if(u.faceColour)N[Q]=u.faceColour[Q]}let G;if(m)G=u.faceAlpha;else if(G=new Int32Array(E),!u.faceAlpha)for(let Q=0;Q<E;Q++)G[Q]=0;else for(let Q=0;Q<E;Q++)G[Q]=u.faceAlpha[Q];return new J({vertexCount:b,vertexX:I,vertexY:L,vertexZ:H,faceCount:E,faceVertexA:u.faceVertexA,faceVertexB:u.faceVertexB,faceVertexC:u.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:u.faceInfo,facePriority:u.facePriority,faceAlpha:G,faceColor:N,priorityVal:u.priority,texturedFaceCount:O,texturedVertexA:u.texturedVertexA,texturedVertexB:u.texturedVertexB,texturedVertexC:u.texturedVertexC,vertexLabel:u.vertexLabel,faceLabel:u.faceLabel})}static modelShareAlpha(u,R){let{vertexCount:m,faceCount:_,texturedFaceCount:b}=u,E=new Int32Array(m),O=new Int32Array(m),I=new Int32Array(m);for(let H=0;H<m;H++)E[H]=u.vertexX[H],O[H]=u.vertexY[H],I[H]=u.vertexZ[H];let L;if(R)L=u.faceAlpha;else if(L=new Int32Array(_),!u.faceAlpha)for(let H=0;H<_;H++)L[H]=0;else for(let H=0;H<_;H++)L[H]=u.faceAlpha[H];return new J({vertexCount:m,vertexX:E,vertexY:O,vertexZ:I,faceCount:_,faceVertexA:u.faceVertexA,faceVertexB:u.faceVertexB,faceVertexC:u.faceVertexC,faceColorA:u.faceColourA,faceColorB:u.faceColourB,faceColorC:u.faceColourC,faceInfo:u.faceInfo,facePriority:u.facePriority,faceAlpha:L,faceColor:u.faceColour,priorityVal:u.priority,texturedFaceCount:b,texturedVertexA:u.texturedVertexA,texturedVertexB:u.texturedVertexB,texturedVertexC:u.texturedVertexC,labelVertices:u.labelVertices,labelFaces:u.labelFaces})}static modelFromModelsBounds(u,R){let m=!1,_=!1,b=!1,E=!1,O=0,I=0,L=0,H=-1;for(let W=0;W<R;W++){let M=u[W];if(M){if(O+=M.vertexCount,I+=M.faceCount,L+=M.texturedFaceCount,m||=M.faceInfo!==null,!M.facePriority){if(H===-1)H=M.priority;if(H!==M.priority)_=!0}else _=!0;b||=M.faceAlpha!==null,E||=M.faceColour!==null}}let N=new Int32Array(O),G=new Int32Array(O),Q=new Int32Array(O),$=new Int32Array(I),T=new Int32Array(I),U=new Int32Array(I),K=new Int32Array(I),q=new Int32Array(I),w=new Int32Array(I),V=new Int32Array(L),Y=new Int32Array(L),A=new Int32Array(L),h=null;if(m)h=new Int32Array(I);let n=null;if(_)n=new Int32Array(I);let f=null;if(b)f=new Int32Array(I);let D=null;if(E)D=new Int32Array(I);O=0,I=0,L=0;for(let W=0;W<R;W++){let M=u[W];if(M){let X=O;for(let P=0;P<M.vertexCount;P++)N[O]=M.vertexX[P],G[O]=M.vertexY[P],Q[O]=M.vertexZ[P],O++;for(let P=0;P<M.faceCount;P++){if($[I]=M.faceVertexA[P]+X,T[I]=M.faceVertexB[P]+X,U[I]=M.faceVertexC[P]+X,M.faceColourA)K[I]=M.faceColourA[P];if(M.faceColourB)q[I]=M.faceColourB[P];if(M.faceColourC)w[I]=M.faceColourC[P];if(m){if(!M.faceInfo){if(h)h[I]=0}else if(h)h[I]=M.faceInfo[P]}if(_){if(!M.facePriority){if(n)n[I]=M.priority}else if(n)n[I]=M.facePriority[P]}if(b){if(!M.faceAlpha){if(f)f[I]=0}else if(f)f[I]=M.faceAlpha[P]}if(E&&M.faceColour){if(D)D[I]=M.faceColour[P]}I++}for(let P=0;P<M.texturedFaceCount;P++)V[L]=M.texturedVertexA[P]+X,Y[L]=M.texturedVertexB[P]+X,A[L]=M.texturedVertexC[P]+X,L++}}let j=new J({vertexCount:O,vertexX:N,vertexY:G,vertexZ:Q,faceCount:I,faceVertexA:$,faceVertexB:T,faceVertexC:U,faceColorA:K,faceColorB:q,faceColorC:w,faceInfo:h,facePriority:n,faceAlpha:f,faceColor:D,priorityVal:H,texturedFaceCount:L,texturedVertexA:V,texturedVertexB:Y,texturedVertexC:A});return j.calculateBoundsCylinder(),j}static modelFromModels(u,R){let m=!1,_=!1,b=!1,E=!1,O=0,I=0,L=0,H=-1;for(let D=0;D<R;D++){let j=u[D];if(j){if(O+=j.vertexCount,I+=j.faceCount,L+=j.texturedFaceCount,m||=j.faceInfo!==null,!j.facePriority){if(H===-1)H=j.priority;if(H!==j.priority)_=!0}else _=!0;b||=j.faceAlpha!==null,E||=j.faceLabel!==null}}let N=new Int32Array(O),G=new Int32Array(O),Q=new Int32Array(O),$=new Int32Array(O),T=new Int32Array(I),U=new Int32Array(I),K=new Int32Array(I),q=new Int32Array(L),w=new Int32Array(L),V=new Int32Array(L),Y=null;if(m)Y=new Int32Array(I);let A=null;if(_)A=new Int32Array(I);let h=null;if(b)h=new Int32Array(I);let n=null;if(E)n=new Int32Array(I);let f=new Int32Array(I);O=0,I=0,L=0;for(let D=0;D<R;D++){let j=u[D];if(j){for(let W=0;W<j.faceCount;W++){if(m){if(!j.faceInfo){if(Y)Y[I]=0}else if(Y)Y[I]=j.faceInfo[W]}if(_){if(!j.facePriority){if(A)A[I]=j.priority}else if(A)A[I]=j.facePriority[W]}if(b){if(!j.faceAlpha){if(h)h[I]=0}else if(h)h[I]=j.faceAlpha[W]}if(E&&j.faceLabel){if(n)n[I]=j.faceLabel[W]}if(j.faceColour)f[I]=j.faceColour[W];let M=J.addVertex(j,j.faceVertexA[W],N,G,Q,$,O);O=M.vertexCount;let X=J.addVertex(j,j.faceVertexB[W],N,G,Q,$,O);O=X.vertexCount;let P=J.addVertex(j,j.faceVertexC[W],N,G,Q,$,O);O=P.vertexCount,T[I]=M.vertex,U[I]=X.vertex,K[I]=P.vertex,I++}for(let W=0;W<j.texturedFaceCount;W++){let M=J.addVertex(j,j.texturedVertexA[W],N,G,Q,$,O);O=M.vertexCount;let X=J.addVertex(j,j.texturedVertexB[W],N,G,Q,$,O);O=X.vertexCount;let P=J.addVertex(j,j.texturedVertexC[W],N,G,Q,$,O);O=P.vertexCount,q[L]=M.vertex,w[L]=X.vertex,V[L]=P.vertex,L++}}}return new J({vertexCount:O,vertexX:N,vertexY:G,vertexZ:Q,faceCount:I,faceVertexA:T,faceVertexB:U,faceVertexC:K,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:Y,facePriority:A,faceAlpha:h,faceColor:f,priorityVal:H,texturedFaceCount:L,texturedVertexA:q,texturedVertexB:w,texturedVertexC:V,vertexLabel:$,faceLabel:n})}set(u,R){if(J.tmpVertexX.length<this.vertexCount)J.tmpVertexX=new Int32Array(this.vertexCount+100),J.tmpVertexY=new Int32Array(this.vertexCount+100),J.tmpVertexZ=new Int32Array(this.vertexCount+100);this.vertexX=J.tmpVertexX,this.vertexY=J.tmpVertexY,this.vertexZ=J.tmpVertexZ;for(let m=0;m<this.vertexCount;m++)this.vertexX[m]=u.vertexX[m],this.vertexY[m]=u.vertexY[m],this.vertexZ[m]=u.vertexZ[m];if(R)this.faceAlpha=u.faceAlpha;else{if(J.tmpFaceAlpha.length<this.faceCount)J.tmpFaceAlpha=new Int32Array(this.faceCount+100);if(this.faceAlpha=new Int32Array(this.faceCount),!u.faceAlpha)for(let m=0;m<this.faceCount;m++)this.faceAlpha[m]=0;else for(let m=0;m<this.faceCount;m++)this.faceAlpha[m]=u.faceAlpha[m]}this.faceInfo=u.faceInfo,this.faceColour=u.faceColour,this.facePriority=u.facePriority,this.priority=u.priority,this.labelFaces=u.labelFaces,this.labelVertices=u.labelVertices,this.faceVertexA=u.faceVertexA,this.faceVertexB=u.faceVertexB,this.faceVertexC=u.faceVertexC,this.faceColourA=u.faceColourA,this.faceColourB=u.faceColourB,this.faceColourC=u.faceColourC,this.texturedVertexA=u.texturedVertexA,this.texturedVertexB=u.texturedVertexB,this.texturedVertexC=u.texturedVertexC}static addVertex=(u,R,m,_,b,E,O)=>{let I=-1;if(u.vertexX&&u.vertexY&&u.vertexZ){let L=u.vertexX[R],H=u.vertexY[R],N=u.vertexZ[R];for(let G=0;G<O;G++)if(L===m[G]&&H===_[G]&&N===b[G]){I=G;break}if(I===-1){if(m[O]=L,_[O]=H,b[O]=N,E&&u.vertexLabel)E[O]=u.vertexLabel[R];I=O++}}return{vertex:I,vertexCount:O}};calculateBoundsCylinder(){this.minY=0,this.radius=0,this.maxY=0;for(let u=0;u<this.vertexCount;u++){let R=this.vertexX[u],m=this.vertexY[u],_=this.vertexZ[u];if(-m>this.minY)this.minY=-m;if(m>this.maxY)this.maxY=m;let b=R*R+_*_;if(b>this.radius)this.radius=b}this.radius=Math.sqrt(this.radius)+0.99|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0)}calculateBoundsY(){this.minY=0,this.maxY=0;for(let u=0;u<this.vertexCount;u++){let R=this.vertexY[u];if(-R>this.minY)this.minY=-R;if(R>this.maxY)this.maxY=R}this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0)}calculateBoundsAABB(){this.minY=0,this.radius=0,this.maxY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let u=0;u<this.vertexCount;u++){let R=this.vertexX[u],m=this.vertexY[u],_=this.vertexZ[u];if(R<this.minX)this.minX=R;if(R>this.maxX)this.maxX=R;if(_<this.minZ)this.minZ=_;if(_>this.maxZ)this.maxZ=_;if(-m>this.minY)this.minY=-m;if(m>this.maxY)this.maxY=m;let b=R*R+_*_;if(b>this.radius)this.radius=b}this.radius=Math.sqrt(this.radius)|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0)}createLabelReferences(){if(this.vertexLabel){let u=new Int32Array(256),R=0;for(let _=0;_<this.vertexCount;_++){let b=this.vertexLabel[_];if(u[b]++,b>R)R=b}this.labelVertices=new p(R+1,null);for(let _=0;_<=R;_++)this.labelVertices[_]=new Int32Array(u[_]),u[_]=0;let m=0;while(m<this.vertexCount){let _=this.vertexLabel[m],b=this.labelVertices[_];if(!b)continue;b[u[_]++]=m++}this.vertexLabel=null}if(this.faceLabel){let u=new Int32Array(256),R=0;for(let _=0;_<this.faceCount;_++){let b=this.faceLabel[_];if(u[b]++,b>R)R=b}this.labelFaces=new p(R+1,null);for(let _=0;_<=R;_++)this.labelFaces[_]=new Int32Array(u[_]),u[_]=0;let m=0;while(m<this.faceCount){let _=this.faceLabel[m],b=this.labelFaces[_];if(!b)continue;b[u[_]++]=m++}this.faceLabel=null}}applyTransform(u){if(!this.labelVertices||u===-1)return;let R=A0.instances[u];if(!R)return;let m=R.base;J.baseX=0,J.baseY=0,J.baseZ=0;for(let _=0;_<R.length;_++){if(!R.groups||!R.x||!R.y||!R.z||!m||!m.labels||!m.types)continue;let b=R.groups[_];this.applyTransform2(R.x[_],R.y[_],R.z[_],m.labels[b],m.types[b])}}applyTransforms(u,R,m){if(u===-1)return;if(!m||R===-1){this.applyTransform(u);return}let _=A0.get(u);if(!_)return;let b=A0.get(R);if(!b){this.applyTransform(u);return}let E=_.base;J.baseX=0,J.baseY=0,J.baseZ=0;let O=0,I=m[O++];for(let L=0;L<_.length;L++){if(!_.groups)continue;let H=_.groups[L];while(H>I)I=m[O++];if(E&&E.types&&_.x&&_.y&&_.z&&E.labels&&(H!==I||E.types[H]===0))this.applyTransform2(_.x[L],_.y[L],_.z[L],E.labels[H],E.types[H])}J.baseX=0,J.baseY=0,J.baseZ=0,O=0,I=m[O++];for(let L=0;L<b.length;L++){if(!b.groups)continue;let H=b.groups[L];while(H>I)I=m[O++];if(E&&E.types&&b.x&&b.y&&b.z&&E.labels&&(H===I||E.types[H]===0))this.applyTransform2(b.x[L],b.y[L],b.z[L],E.labels[H],E.types[H])}}applyTransform2(u,R,m,_,b){if(!_)return;let E=_.length;if(b===0){let O=0;J.baseX=0,J.baseY=0,J.baseZ=0;for(let I=0;I<E;I++){if(!this.labelVertices)continue;let L=_[I];if(L<this.labelVertices.length){let H=this.labelVertices[L];if(H)for(let N=0;N<H.length;N++){let G=H[N];J.baseX+=this.vertexX[G],J.baseY+=this.vertexY[G],J.baseZ+=this.vertexZ[G],O++}}}if(O>0)J.baseX=(J.baseX/O|0)+u,J.baseY=(J.baseY/O|0)+R,J.baseZ=(J.baseZ/O|0)+m;else J.baseX=u,J.baseY=R,J.baseZ=m}else if(b===1)for(let O=0;O<E;O++){let I=_[O];if(!this.labelVertices||I>=this.labelVertices.length)continue;let L=this.labelVertices[I];if(L)for(let H=0;H<L.length;H++){let N=L[H];this.vertexX[N]+=u,this.vertexY[N]+=R,this.vertexZ[N]+=m}}else if(b===2)for(let O=0;O<E;O++){let I=_[O];if(!this.labelVertices||I>=this.labelVertices.length)continue;let L=this.labelVertices[I];if(L)for(let H=0;H<L.length;H++){let N=L[H];this.vertexX[N]-=J.baseX,this.vertexY[N]-=J.baseY,this.vertexZ[N]-=J.baseZ;let G=(u&255)*8,Q=(R&255)*8,$=(m&255)*8,T,U;if($!==0){T=Z.sin[$],U=Z.cos[$];let K=this.vertexY[N]*T+this.vertexX[N]*U>>16;this.vertexY[N]=this.vertexY[N]*U-this.vertexX[N]*T>>16,this.vertexX[N]=K}if(G!==0){T=Z.sin[G],U=Z.cos[G];let K=this.vertexY[N]*U-this.vertexZ[N]*T>>16;this.vertexZ[N]=this.vertexY[N]*T+this.vertexZ[N]*U>>16,this.vertexY[N]=K}if(Q!==0){T=Z.sin[Q],U=Z.cos[Q];let K=this.vertexZ[N]*T+this.vertexX[N]*U>>16;this.vertexZ[N]=this.vertexZ[N]*U-this.vertexX[N]*T>>16,this.vertexX[N]=K}this.vertexX[N]+=J.baseX,this.vertexY[N]+=J.baseY,this.vertexZ[N]+=J.baseZ}}else if(b===3)for(let O=0;O<E;O++){let I=_[O];if(!this.labelVertices||I>=this.labelVertices.length)continue;let L=this.labelVertices[I];if(L)for(let H=0;H<L.length;H++){let N=L[H];this.vertexX[N]-=J.baseX,this.vertexY[N]-=J.baseY,this.vertexZ[N]-=J.baseZ,this.vertexX[N]=this.vertexX[N]*u/128|0,this.vertexY[N]=this.vertexY[N]*R/128|0,this.vertexZ[N]=this.vertexZ[N]*m/128|0,this.vertexX[N]+=J.baseX,this.vertexY[N]+=J.baseY,this.vertexZ[N]+=J.baseZ}}else if(b===5&&this.labelFaces&&this.faceAlpha)for(let O=0;O<E;O++){let I=_[O];if(I>=this.labelFaces.length)continue;let L=this.labelFaces[I];if(L)for(let H=0;H<L.length;H++){let N=L[H];if(this.faceAlpha[N]+=u*8,this.faceAlpha[N]<0)this.faceAlpha[N]=0;if(this.faceAlpha[N]>255)this.faceAlpha[N]=255}}}rotateY90(){for(let u=0;u<this.vertexCount;u++){let R=this.vertexX[u];this.vertexX[u]=this.vertexZ[u],this.vertexZ[u]=-R}}rotateX(u){let R=Z.sin[u],m=Z.cos[u];for(let _=0;_<this.vertexCount;_++){let b=this.vertexY[_]*m-this.vertexZ[_]*R>>16;this.vertexZ[_]=this.vertexY[_]*R+this.vertexZ[_]*m>>16,this.vertexY[_]=b}}translate(u,R,m){for(let _=0;_<this.vertexCount;_++)this.vertexX[_]+=R,this.vertexY[_]+=u,this.vertexZ[_]+=m}recolour(u,R){if(!this.faceColour)return;for(let m=0;m<this.faceCount;m++)if(this.faceColour[m]===u)this.faceColour[m]=R}rotateY180(){for(let u=0;u<this.vertexCount;u++)this.vertexZ[u]=-this.vertexZ[u];for(let u=0;u<this.faceCount;u++){let R=this.faceVertexA[u];this.faceVertexA[u]=this.faceVertexC[u],this.faceVertexC[u]=R}}scale(u,R,m){for(let _=0;_<this.vertexCount;_++)this.vertexX[_]=this.vertexX[_]*u/128|0,this.vertexY[_]=this.vertexY[_]*R/128|0,this.vertexZ[_]=this.vertexZ[_]*m/128|0}calculateNormals(u,R,m,_,b,E){let O=Math.sqrt(m*m+_*_+b*b)|0,I=R*O>>8;if(!this.faceColourA||!this.faceColourB||!this.faceColourC)this.faceColourA=new Int32Array(this.faceCount),this.faceColourB=new Int32Array(this.faceCount),this.faceColourC=new Int32Array(this.faceCount);if(!this.vertexNormal){this.vertexNormal=new p(this.vertexCount,null);for(let L=0;L<this.vertexCount;L++)this.vertexNormal[L]=new i0}for(let L=0;L<this.faceCount;L++){let H=this.faceVertexA[L],N=this.faceVertexB[L],G=this.faceVertexC[L],Q=this.vertexX[N]-this.vertexX[H],$=this.vertexY[N]-this.vertexY[H],T=this.vertexZ[N]-this.vertexZ[H],U=this.vertexX[G]-this.vertexX[H],K=this.vertexY[G]-this.vertexY[H],q=this.vertexZ[G]-this.vertexZ[H],w=$*q-K*T,V=T*U-q*Q,Y=Q*K-U*$;while(w>8192||V>8192||Y>8192||w<-8192||V<-8192||Y<-8192)w>>=1,V>>=1,Y>>=1;let A=Math.sqrt(w*w+V*V+Y*Y)|0;if(A<=0)A=1;if(w=w*256/A|0,V=V*256/A|0,Y=Y*256/A|0,!this.faceInfo||(this.faceInfo[L]&1)===0){let h=this.vertexNormal[H];if(h)h.x+=w,h.y+=V,h.z+=Y,h.w++;if(h=this.vertexNormal[N],h)h.x+=w,h.y+=V,h.z+=Y,h.w++;if(h=this.vertexNormal[G],h)h.x+=w,h.y+=V,h.z+=Y,h.w++}else{let h=u+((m*w+_*V+b*Y)/(I+(I/2|0))|0);if(this.faceColour)this.faceColourA[L]=J.mulColourLightness(this.faceColour[L],h,this.faceInfo[L])}}if(E)this.applyLighting(u,I,m,_,b);else{this.vertexNormalOriginal=new p(this.vertexCount,null);for(let L=0;L<this.vertexCount;L++){let H=this.vertexNormal[L],N=new i0;if(H)N.x=H.x,N.y=H.y,N.z=H.z,N.w=H.w;this.vertexNormalOriginal[L]=N}}if(E)this.calculateBoundsCylinder();else this.calculateBoundsAABB()}applyLighting(u,R,m,_,b){for(let E=0;E<this.faceCount;E++){let O=this.faceVertexA[E],I=this.faceVertexB[E],L=this.faceVertexC[E];if(!this.faceInfo&&this.faceColour&&this.vertexNormal&&this.faceColourA&&this.faceColourB&&this.faceColourC){let H=this.faceColour[E],N=this.vertexNormal[O];if(N)this.faceColourA[E]=J.mulColourLightness(H,u+((m*N.x+_*N.y+b*N.z)/(R*N.w)|0),0);let G=this.vertexNormal[I];if(G)this.faceColourB[E]=J.mulColourLightness(H,u+((m*G.x+_*G.y+b*G.z)/(R*G.w)|0),0);let Q=this.vertexNormal[L];if(Q)this.faceColourC[E]=J.mulColourLightness(H,u+((m*Q.x+_*Q.y+b*Q.z)/(R*Q.w)|0),0)}else if(this.faceInfo&&(this.faceInfo[E]&1)===0&&this.faceColour&&this.vertexNormal&&this.faceColourA&&this.faceColourB&&this.faceColourC){let H=this.faceColour[E],N=this.faceInfo[E],G=this.vertexNormal[O];if(G)this.faceColourA[E]=J.mulColourLightness(H,u+((m*G.x+_*G.y+b*G.z)/(R*G.w)|0),N);let Q=this.vertexNormal[I];if(Q)this.faceColourB[E]=J.mulColourLightness(H,u+((m*Q.x+_*Q.y+b*Q.z)/(R*Q.w)|0),N);let $=this.vertexNormal[L];if($)this.faceColourC[E]=J.mulColourLightness(H,u+((m*$.x+_*$.y+b*$.z)/(R*$.w)|0),N)}}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo){for(let E=0;E<this.faceCount;E++)if((this.faceInfo[E]&2)===2)return}this.faceColour=null}static mulColourLightness(u,R,m){if((m&2)===2){if(R<0)R=0;else if(R>127)R=127;return 127-R}if(R=R*(u&127)>>7,R<2)R=2;else if(R>126)R=126;return(u&65408)+R}drawSimple(u,R,m,_,b,E,O){let I=Z.sin[u],L=Z.cos[u],H=Z.sin[R],N=Z.cos[R],G=Z.sin[m],Q=Z.cos[m],$=Z.sin[_],T=Z.cos[_],U=E*$+O*T>>16;for(let K=0;K<this.vertexCount;K++){let q=this.vertexX[K],w=this.vertexY[K],V=this.vertexZ[K],Y;if(m!==0)Y=w*G+q*Q>>16,w=w*Q-q*G>>16,q=Y;if(u!==0)Y=w*L-V*I>>16,V=w*I+V*L>>16,w=Y;if(R!==0)Y=V*H+q*N>>16,V=V*N-q*H>>16,q=Y;if(q+=b,w+=E,V+=O,Y=w*T-V*$>>16,V=w*$+V*T>>16,w=Y,J.vertexScreenX&&J.vertexScreenY&&J.vertexScreenZ)J.vertexScreenZ[K]=V-U,J.vertexScreenX[K]=Z.centerX+((q<<9)/V|0),J.vertexScreenY[K]=Z.centerY+((w<<9)/V|0);if(this.texturedFaceCount>0&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ)J.vertexViewSpaceX[K]=q,J.vertexViewSpaceY[K]=w,J.vertexViewSpaceZ[K]=V}try{this.draw2(!1,!1,0)}catch(K){}}draw(u,R,m,_,b,E,O,I,L,H){let N=L*E-O*b>>16,G=I*m+N*_>>16,Q=this.radius*_>>16,$=G+Q;if($<=50||G>=3500)return;let T=L*b+O*E>>16,U=T-this.radius<<9;if((U/$|0)>=F.centerX2d)return;let K=T+this.radius<<9;if((K/$|0)<=-F.centerX2d)return;let q=I*_-N*m>>16,w=this.radius*m>>16,V=q+w<<9;if((V/$|0)<=-F.centerY2d)return;let Y=w+(this.minY*_>>16),A=q-Y<<9;if((A/$|0)>=F.centerY2d)return;let h=Q+(this.minY*m>>16),n=G-h<=50,f=!1;if(H>0&&J.checkHover){let X=G-Q;if(X<=50)X=50;if(T>0)U=U/$|0,K=K/X|0;else K=K/$|0,U=U/X|0;if(q>0)A=A/$|0,V=V/X|0;else V=V/$|0,A=A/X|0;let P=J.mouseX-Z.centerX,r=J.mouseY-Z.centerY;if(P>U&&P<K&&r>A&&r<V)if(this.picking)J.pickedBitsets[J.pickedCount++]=H;else f=!0}let D=Z.centerX,j=Z.centerY,W=0,M=0;if(R!==0)W=Z.sin[R],M=Z.cos[R];for(let X=0;X<this.vertexCount;X++){let P=this.vertexX[X],r=this.vertexY[X],S=this.vertexZ[X],y;if(R!==0)y=S*W+P*M>>16,S=S*M-P*W>>16,P=y;if(P+=O,r+=I,S+=L,y=S*b+P*E>>16,S=S*E-P*b>>16,P=y,y=r*_-S*m>>16,S=r*m+S*_>>16,r=y,J.vertexScreenZ)J.vertexScreenZ[X]=S-G;if(S>=50&&J.vertexScreenX&&J.vertexScreenY)J.vertexScreenX[X]=D+((P<<9)/S|0),J.vertexScreenY[X]=j+((r<<9)/S|0);else if(J.vertexScreenX)J.vertexScreenX[X]=-5000,n=!0;if((n||this.texturedFaceCount>0)&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ)J.vertexViewSpaceX[X]=P,J.vertexViewSpaceY[X]=r,J.vertexViewSpaceZ[X]=S}try{this.draw2(n,f,H)}catch(X){}}draw2(u,R,m,_=!1){for(let I=0;I<this.maxDepth;I++)if(J.tmpDepthFaceCount)J.tmpDepthFaceCount[I]=0;for(let I=0;I<this.faceCount;I++){if(this.faceInfo&&this.faceInfo[I]===-1)continue;if(J.vertexScreenX&&J.vertexScreenY&&J.vertexScreenZ&&J.tmpDepthFaces&&J.tmpDepthFaceCount){let L=this.faceVertexA[I],H=this.faceVertexB[I],N=this.faceVertexC[I],G=J.vertexScreenX[L],Q=J.vertexScreenX[H],$=J.vertexScreenX[N],T=J.vertexScreenY[L],U=J.vertexScreenY[H],K=J.vertexScreenY[N],q=J.vertexScreenZ[L],w=J.vertexScreenZ[H],V=J.vertexScreenZ[N];if(u&&(G===-5000||Q===-5000||$===-5000)){if(J.faceNearClipped)J.faceNearClipped[I]=!0;if(J.tmpDepthFaces&&J.tmpDepthFaceCount){let Y=((q+w+V)/3|0)+this.minDepth;J.tmpDepthFaces[Y][J.tmpDepthFaceCount[Y]++]=I}}else{if(R&&this.pointWithinTriangle(J.mouseX,J.mouseY,T,U,K,G,Q,$))J.pickedBitsets[J.pickedCount++]=m,R=!1;let Y=G-Q,A=T-U,h=$-Q,n=K-U;if(Y*n-A*h<=0)continue;if(J.faceNearClipped)J.faceNearClipped[I]=!1;if(J.faceClippedX)J.faceClippedX[I]=G<0||Q<0||$<0||G>F.boundX||Q>F.boundX||$>F.boundX;if(J.tmpDepthFaces&&J.tmpDepthFaceCount){let f=((q+w+V)/3|0)+this.minDepth;J.tmpDepthFaces[f][J.tmpDepthFaceCount[f]++]=I}}}}if(!this.facePriority&&J.tmpDepthFaceCount){for(let I=this.maxDepth-1;I>=0;I--){let L=J.tmpDepthFaceCount[I];if(L<=0)continue;if(J.tmpDepthFaces){let H=J.tmpDepthFaces[I];for(let N=0;N<L;N++)try{this.drawFace(H[N],_)}catch(G){}}}return}for(let I=0;I<12;I++)if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum)J.tmpPriorityFaceCount[I]=0,J.tmpPriorityDepthSum[I]=0;if(J.tmpDepthFaceCount)for(let I=this.maxDepth-1;I>=0;I--){let L=J.tmpDepthFaceCount[I];if(L>0&&J.tmpDepthFaces){let H=J.tmpDepthFaces[I];for(let N=0;N<L;N++)if(this.facePriority&&J.tmpPriorityFaceCount&&J.tmpPriorityFaces){let G=H[N],Q=this.facePriority[G],$=J.tmpPriorityFaceCount[Q]++;if(J.tmpPriorityFaces[Q][$]=G,Q<10&&J.tmpPriorityDepthSum)J.tmpPriorityDepthSum[Q]+=I;else if(Q===10&&J.tmpPriority10FaceDepth)J.tmpPriority10FaceDepth[$]=I;else if(J.tmpPriority11FaceDepth)J.tmpPriority11FaceDepth[$]=I}}}let b=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[1]>0||J.tmpPriorityFaceCount[2]>0))b=(J.tmpPriorityDepthSum[1]+J.tmpPriorityDepthSum[2])/(J.tmpPriorityFaceCount[1]+J.tmpPriorityFaceCount[2])|0;let E=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[3]>0||J.tmpPriorityFaceCount[4]>0))E=(J.tmpPriorityDepthSum[3]+J.tmpPriorityDepthSum[4])/(J.tmpPriorityFaceCount[3]+J.tmpPriorityFaceCount[4])|0;let O=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[6]>0||J.tmpPriorityFaceCount[8]>0))O=(J.tmpPriorityDepthSum[6]+J.tmpPriorityDepthSum[8])/(J.tmpPriorityFaceCount[6]+J.tmpPriorityFaceCount[8])|0;if(J.tmpPriorityFaceCount&&J.tmpPriorityFaces){let I=0,L=J.tmpPriorityFaceCount[10],H=J.tmpPriorityFaces[10],N=J.tmpPriority10FaceDepth;if(I===L)I=0,L=J.tmpPriorityFaceCount[11],H=J.tmpPriorityFaces[11],N=J.tmpPriority11FaceDepth;let G;if(I<L&&N)G=N[I];else G=-1000;for(let Q=0;Q<10;Q++){while(Q===0&&G>b)try{if(this.drawFace(H[I++],_),I===L&&H!==J.tmpPriorityFaces[11])I=0,L=J.tmpPriorityFaceCount[11],H=J.tmpPriorityFaces[11],N=J.tmpPriority11FaceDepth;if(I<L&&N)G=N[I];else G=-1000}catch(U){}while(Q===3&&G>E)try{if(this.drawFace(H[I++],_),I===L&&H!==J.tmpPriorityFaces[11])I=0,L=J.tmpPriorityFaceCount[11],H=J.tmpPriorityFaces[11],N=J.tmpPriority11FaceDepth;if(I<L&&N)G=N[I];else G=-1000}catch(U){}while(Q===5&&G>O)try{if(this.drawFace(H[I++],_),I===L&&H!==J.tmpPriorityFaces[11])I=0,L=J.tmpPriorityFaceCount[11],H=J.tmpPriorityFaces[11],N=J.tmpPriority11FaceDepth;if(I<L&&N)G=N[I];else G=-1000}catch(U){}let $=J.tmpPriorityFaceCount[Q],T=J.tmpPriorityFaces[Q];for(let U=0;U<$;U++)try{this.drawFace(T[U],_)}catch(K){}}while(G!==-1000)try{if(this.drawFace(H[I++],_),I===L&&H!==J.tmpPriorityFaces[11])I=0,H=J.tmpPriorityFaces[11],L=J.tmpPriorityFaceCount[11],N=J.tmpPriority11FaceDepth;if(I<L&&N)G=N[I];else G=-1000}catch(Q){}}}drawFace(u,R=!1){if(J.faceNearClipped&&J.faceNearClipped[u]){this.drawNearClippedFace(u,R);return}let m=this.faceVertexA[u],_=this.faceVertexB[u],b=this.faceVertexC[u];if(J.faceClippedX)Z.clipX=J.faceClippedX[u];if(!this.faceAlpha)Z.alpha=0;else Z.alpha=this.faceAlpha[u];let E;if(!this.faceInfo)E=0;else E=this.faceInfo[u]&3;if(R&&J.vertexScreenX&&J.vertexScreenY&&this.faceColourA&&this.faceColourB&&this.faceColourC)Z.drawLine(J.vertexScreenX[m],J.vertexScreenY[m],J.vertexScreenX[_],J.vertexScreenY[_],Z.hslPal[this.faceColourA[u]]),Z.drawLine(J.vertexScreenX[_],J.vertexScreenY[_],J.vertexScreenX[b],J.vertexScreenY[b],Z.hslPal[this.faceColourB[u]]),Z.drawLine(J.vertexScreenX[b],J.vertexScreenY[b],J.vertexScreenX[m],J.vertexScreenY[m],Z.hslPal[this.faceColourC[u]]);else if(E===0&&this.faceColourA&&this.faceColourB&&this.faceColourC&&J.vertexScreenX&&J.vertexScreenY)Z.fillGouraudTriangle(J.vertexScreenX[m],J.vertexScreenX[_],J.vertexScreenX[b],J.vertexScreenY[m],J.vertexScreenY[_],J.vertexScreenY[b],this.faceColourA[u],this.faceColourB[u],this.faceColourC[u]);else if(E===1&&this.faceColourA&&J.vertexScreenX&&J.vertexScreenY)Z.fillTriangle(J.vertexScreenX[m],J.vertexScreenX[_],J.vertexScreenX[b],J.vertexScreenY[m],J.vertexScreenY[_],J.vertexScreenY[b],Z.hslPal[this.faceColourA[u]]);else if(E===2&&this.faceInfo&&this.faceColour&&this.faceColourA&&this.faceColourB&&this.faceColourC&&J.vertexScreenX&&J.vertexScreenY&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let O=this.faceInfo[u]>>2,I=this.texturedVertexA[O],L=this.texturedVertexB[O],H=this.texturedVertexC[O];Z.fillTexturedTriangle(J.vertexScreenX[m],J.vertexScreenX[_],J.vertexScreenX[b],J.vertexScreenY[m],J.vertexScreenY[_],J.vertexScreenY[b],this.faceColourA[u],this.faceColourB[u],this.faceColourC[u],J.vertexViewSpaceX[I],J.vertexViewSpaceY[I],J.vertexViewSpaceZ[I],J.vertexViewSpaceX[L],J.vertexViewSpaceX[H],J.vertexViewSpaceY[L],J.vertexViewSpaceY[H],J.vertexViewSpaceZ[L],J.vertexViewSpaceZ[H],this.faceColour[u])}else if(E===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&J.vertexScreenX&&J.vertexScreenY&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let O=this.faceInfo[u]>>2,I=this.texturedVertexA[O],L=this.texturedVertexB[O],H=this.texturedVertexC[O];Z.fillTexturedTriangle(J.vertexScreenX[m],J.vertexScreenX[_],J.vertexScreenX[b],J.vertexScreenY[m],J.vertexScreenY[_],J.vertexScreenY[b],this.faceColourA[u],this.faceColourA[u],this.faceColourA[u],J.vertexViewSpaceX[I],J.vertexViewSpaceY[I],J.vertexViewSpaceZ[I],J.vertexViewSpaceX[L],J.vertexViewSpaceX[H],J.vertexViewSpaceY[L],J.vertexViewSpaceY[H],J.vertexViewSpaceZ[L],J.vertexViewSpaceZ[H],this.faceColour[u])}}drawNearClippedFace(u,R=!1){let m=0;if(J.vertexViewSpaceZ){let H=Z.centerX,N=Z.centerY,G=this.faceVertexA[u],Q=this.faceVertexB[u],$=this.faceVertexC[u],T=J.vertexViewSpaceZ[G],U=J.vertexViewSpaceZ[Q],K=J.vertexViewSpaceZ[$];if(T>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColourA)J.clippedX[m]=J.vertexScreenX[G],J.clippedY[m]=J.vertexScreenY[G],J.clippedColour[m++]=this.faceColourA[u];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColourA){let q=J.vertexViewSpaceX[G],w=J.vertexViewSpaceY[G],V=this.faceColourA[u];if(K>=50&&this.faceColourC){let Y=(50-T)*Z.reciprocal16[K-T];J.clippedX[m]=H+((q+((J.vertexViewSpaceX[$]-q)*Y>>16)<<9)/50|0),J.clippedY[m]=N+((w+((J.vertexViewSpaceY[$]-w)*Y>>16)<<9)/50|0),J.clippedColour[m++]=V+((this.faceColourC[u]-V)*Y>>16)}if(U>=50&&this.faceColourB){let Y=(50-T)*Z.reciprocal16[U-T];J.clippedX[m]=H+((q+((J.vertexViewSpaceX[Q]-q)*Y>>16)<<9)/50|0),J.clippedY[m]=N+((w+((J.vertexViewSpaceY[Q]-w)*Y>>16)<<9)/50|0),J.clippedColour[m++]=V+((this.faceColourB[u]-V)*Y>>16)}}if(U>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColourB)J.clippedX[m]=J.vertexScreenX[Q],J.clippedY[m]=J.vertexScreenY[Q],J.clippedColour[m++]=this.faceColourB[u];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColourB){let q=J.vertexViewSpaceX[Q],w=J.vertexViewSpaceY[Q],V=this.faceColourB[u];if(T>=50&&this.faceColourA){let Y=(50-U)*Z.reciprocal16[T-U];J.clippedX[m]=H+((q+((J.vertexViewSpaceX[G]-q)*Y>>16)<<9)/50|0),J.clippedY[m]=N+((w+((J.vertexViewSpaceY[G]-w)*Y>>16)<<9)/50|0),J.clippedColour[m++]=V+((this.faceColourA[u]-V)*Y>>16)}if(K>=50&&this.faceColourC){let Y=(50-U)*Z.reciprocal16[K-U];J.clippedX[m]=H+((q+((J.vertexViewSpaceX[$]-q)*Y>>16)<<9)/50|0),J.clippedY[m]=N+((w+((J.vertexViewSpaceY[$]-w)*Y>>16)<<9)/50|0),J.clippedColour[m++]=V+((this.faceColourC[u]-V)*Y>>16)}}if(K>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColourC)J.clippedX[m]=J.vertexScreenX[$],J.clippedY[m]=J.vertexScreenY[$],J.clippedColour[m++]=this.faceColourC[u];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColourC){let q=J.vertexViewSpaceX[$],w=J.vertexViewSpaceY[$],V=this.faceColourC[u];if(U>=50&&this.faceColourB){let Y=(50-K)*Z.reciprocal16[U-K];J.clippedX[m]=H+((q+((J.vertexViewSpaceX[Q]-q)*Y>>16)<<9)/50|0),J.clippedY[m]=N+((w+((J.vertexViewSpaceY[Q]-w)*Y>>16)<<9)/50|0),J.clippedColour[m++]=V+((this.faceColourB[u]-V)*Y>>16)}if(T>=50&&this.faceColourA){let Y=(50-K)*Z.reciprocal16[T-K];J.clippedX[m]=H+((q+((J.vertexViewSpaceX[G]-q)*Y>>16)<<9)/50|0),J.clippedY[m]=N+((w+((J.vertexViewSpaceY[G]-w)*Y>>16)<<9)/50|0),J.clippedColour[m++]=V+((this.faceColourA[u]-V)*Y>>16)}}}let _=J.clippedX[0],b=J.clippedX[1],E=J.clippedX[2],O=J.clippedY[0],I=J.clippedY[1],L=J.clippedY[2];if((_-b)*(L-I)-(O-I)*(E-b)<=0)return;if(Z.clipX=!1,m===3){if(_<0||b<0||E<0||_>F.boundX||b>F.boundX||E>F.boundX)Z.clipX=!0;let H;if(!this.faceInfo)H=0;else H=this.faceInfo[u]&3;if(R)Z.drawLine(_,b,O,I,J.clippedColour[0]),Z.drawLine(b,E,I,L,J.clippedColour[1]),Z.drawLine(E,_,L,O,J.clippedColour[2]);else if(H===0)Z.fillGouraudTriangle(_,b,E,O,I,L,J.clippedColour[0],J.clippedColour[1],J.clippedColour[2]);else if(H===1&&this.faceColourA)Z.fillTriangle(_,b,E,O,I,L,Z.hslPal[this.faceColourA[u]]);else if(H===2&&this.faceInfo&&this.faceColour&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let N=this.faceInfo[u]>>2,G=this.texturedVertexA[N],Q=this.texturedVertexB[N],$=this.texturedVertexC[N];Z.fillTexturedTriangle(_,b,E,O,I,L,J.clippedColour[0],J.clippedColour[1],J.clippedColour[2],J.vertexViewSpaceX[G],J.vertexViewSpaceY[G],J.vertexViewSpaceZ[G],J.vertexViewSpaceX[Q],J.vertexViewSpaceX[$],J.vertexViewSpaceY[Q],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[Q],J.vertexViewSpaceZ[$],this.faceColour[u])}else if(H===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let N=this.faceInfo[u]>>2,G=this.texturedVertexA[N],Q=this.texturedVertexB[N],$=this.texturedVertexC[N];Z.fillTexturedTriangle(_,b,E,O,I,L,this.faceColourA[u],this.faceColourA[u],this.faceColourA[u],J.vertexViewSpaceX[G],J.vertexViewSpaceY[G],J.vertexViewSpaceZ[G],J.vertexViewSpaceX[Q],J.vertexViewSpaceX[$],J.vertexViewSpaceY[Q],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[Q],J.vertexViewSpaceZ[$],this.faceColour[u])}}else if(m===4){if(_<0||b<0||E<0||_>F.boundX||b>F.boundX||E>F.boundX||J.clippedX[3]<0||J.clippedX[3]>F.boundX)Z.clipX=!0;let H;if(!this.faceInfo)H=0;else H=this.faceInfo[u]&3;if(R)Z.drawLine(_,b,O,I,J.clippedColour[0]),Z.drawLine(b,E,I,L,J.clippedColour[1]),Z.drawLine(E,J.clippedX[3],L,J.clippedY[3],J.clippedColour[2]),Z.drawLine(J.clippedX[3],_,J.clippedY[3],O,J.clippedColour[3]);else if(H===0)Z.fillGouraudTriangle(_,b,E,O,I,L,J.clippedColour[0],J.clippedColour[1],J.clippedColour[2]),Z.fillGouraudTriangle(_,E,J.clippedX[3],O,L,J.clippedY[3],J.clippedColour[0],J.clippedColour[2],J.clippedColour[3]);else if(H===1){if(this.faceColourA){let N=Z.hslPal[this.faceColourA[u]];Z.fillTriangle(_,b,E,O,I,L,N),Z.fillTriangle(_,E,J.clippedX[3],O,L,J.clippedY[3],N)}}else if(H===2&&this.faceInfo&&this.faceColour&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let N=this.faceInfo[u]>>2,G=this.texturedVertexA[N],Q=this.texturedVertexB[N],$=this.texturedVertexC[N];Z.fillTexturedTriangle(_,b,E,O,I,L,J.clippedColour[0],J.clippedColour[1],J.clippedColour[2],J.vertexViewSpaceX[G],J.vertexViewSpaceY[G],J.vertexViewSpaceZ[G],J.vertexViewSpaceX[Q],J.vertexViewSpaceX[$],J.vertexViewSpaceY[Q],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[Q],J.vertexViewSpaceZ[$],this.faceColour[u]),Z.fillTexturedTriangle(_,E,J.clippedX[3],O,L,J.clippedY[3],J.clippedColour[0],J.clippedColour[2],J.clippedColour[3],J.vertexViewSpaceX[G],J.vertexViewSpaceY[G],J.vertexViewSpaceZ[G],J.vertexViewSpaceX[Q],J.vertexViewSpaceX[$],J.vertexViewSpaceY[Q],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[Q],J.vertexViewSpaceZ[$],this.faceColour[u])}else if(H===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let N=this.faceInfo[u]>>2,G=this.texturedVertexA[N],Q=this.texturedVertexB[N],$=this.texturedVertexC[N];Z.fillTexturedTriangle(_,b,E,O,I,L,this.faceColourA[u],this.faceColourA[u],this.faceColourA[u],J.vertexViewSpaceX[G],J.vertexViewSpaceY[G],J.vertexViewSpaceZ[G],J.vertexViewSpaceX[Q],J.vertexViewSpaceX[$],J.vertexViewSpaceY[Q],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[Q],J.vertexViewSpaceZ[$],this.faceColour[u]),Z.fillTexturedTriangle(_,E,J.clippedX[3],O,L,J.clippedY[3],this.faceColourA[u],this.faceColourA[u],this.faceColourA[u],J.vertexViewSpaceX[G],J.vertexViewSpaceY[G],J.vertexViewSpaceZ[G],J.vertexViewSpaceX[Q],J.vertexViewSpaceX[$],J.vertexViewSpaceY[Q],J.vertexViewSpaceY[$],J.vertexViewSpaceZ[Q],J.vertexViewSpaceZ[$],this.faceColour[u])}}}pointWithinTriangle(u,R,m,_,b,E,O,I){if(R<m&&R<_&&R<b)return!1;else if(R>m&&R>_&&R>b)return!1;else if(u<E&&u<O&&u<I)return!1;else return u<=E||u<=O||u<=I}}class _0 extends U0{static ignoreCache=!1;static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=!1;_active=-1;hillskew=!1;sharelight=!1;occlude=!1;static modelCacheStatic=new F0(500);static modelCacheDynamic=new F0(30);ambient=0;contrast=0;anim=-1;wallwidth=16;mapfunction=-1;mapscene=-1;resizex=128;resizey=128;resizez=128;offsetx=0;offsety=0;offsetz=0;forceapproach=0;animHasAlpha=!1;mirror=!1;shadow=!0;forcedecor=!1;op=null;static unpack(u){this.data=new z(u.read("loc.dat"));let R=new z(u.read("loc.idx"));this.count=R.g2(),this.idx=new Int32Array(this.count);let m=2;for(let _=0;_<this.count;_++)this.idx[_]=m,m+=R.g2();this.cache=new p(10,null);for(let _=0;_<10;_++)this.cache[_]=new _0(-1)}static get(u){if(!this.cache||!this.idx||!this.data)throw new Error;for(let m=0;m<10;m++){let _=this.cache[m];if(!_)continue;if(_.id===u)return _}this.cachePos=(this.cachePos+1)%10;let R=this.cache[this.cachePos];if(this.data.pos=this.idx[u],R.id=u,R.reset(),R.unpackType(this.data),!R.shapes)R.shapes=new Int32Array(1);if(R._active===-1&&R.shapes){if(R.active=R.shapes.length>0&&R.shapes[0]===g.CENTREPIECE_STRAIGHT.id,R.op)R.active=!0}return R}unpack(u,R){if(u===1){let m=R.g1();this.models=new Int32Array(m),this.shapes=new Int32Array(m);for(let _=0;_<m;_++)this.models[_]=R.g2(),this.shapes[_]=R.g1()}else if(u===2)this.name=R.gjstr();else if(u===3)this.desc=R.gjstr();else if(u===14)this.width=R.g1();else if(u===15)this.length=R.g1();else if(u===17)this.blockwalk=!1;else if(u===18)this.blockrange=!1;else if(u===19){if(this._active=R.g1(),this._active===1)this.active=!0}else if(u===21)this.hillskew=!0;else if(u===22)this.sharelight=!0;else if(u===23)this.occlude=!0;else if(u===24){if(this.anim=R.g2(),this.anim===65535)this.anim=-1}else if(u===25)this.animHasAlpha=!0;else if(u===28)this.wallwidth=R.g1();else if(u===29)this.ambient=R.g1b();else if(u===39)this.contrast=R.g1b();else if(u>=30&&u<39){if(!this.op)this.op=new p(5,null);if(this.op[u-30]=R.gjstr(),this.op[u-30]?.toLowerCase()==="hidden")this.op[u-30]=null}else if(u===40){let m=R.g1();this.recol_s=new Uint16Array(m),this.recol_d=new Uint16Array(m);for(let _=0;_<m;_++)this.recol_s[_]=R.g2(),this.recol_d[_]=R.g2()}else if(u===60)this.mapfunction=R.g2();else if(u===62)this.mirror=!0;else if(u===64)this.shadow=!1;else if(u===65)this.resizex=R.g2();else if(u===66)this.resizey=R.g2();else if(u===67)this.resizez=R.g2();else if(u===68)this.mapscene=R.g2();else if(u===69)this.forceapproach=R.g1();else if(u===70)this.offsetx=R.g2b();else if(u===71)this.offsety=R.g2b();else if(u===72)this.offsetz=R.g2b();else if(u===73)this.forcedecor=!0}shapeModelsAreReady(u){if(this.shapes===null)return!0;let R=-1;for(let _=0;_<this.shapes.length;_++)if(this.shapes[_]==u){R=_;break}if(R==-1)return!0;if(this.models==null)return!0;let m=this.models[R];return m==-1?!0:J.isReady(m&65535)}modelsAreReady(){let u=!0;if(this.models==null)return!0;for(let R=0;R<this.models.length;R++){let m=this.models[R];if(m!=-1)u&&=J.isReady(m&65535)}return u}prefetch(u){if(this.models==null)return;for(let R=0;R<this.models.length;R++){let m=this.models[R];if(m!=-1)u.prefetch(0,m&65535)}}getModel(u,R,m,_,b,E,O){if(!this.shapes)return null;let I=-1;for(let K=0;K<this.shapes.length;K++)if(this.shapes[K]===u){I=K;break}if(I===-1)return null;let L=(BigInt(O)+1n<<32n)+(BigInt(this.id)<<6n)+(BigInt(I)<<3n)+BigInt(R);if(_0.ignoreCache)L=0n;let H=_0.modelCacheDynamic?.get(L);if(H){if(_0.ignoreCache)return H;if(this.hillskew||this.sharelight)H=J.modelCopyFaces(H,this.hillskew,this.sharelight);if(this.hillskew){let K=(m+_+b+E)/4|0;for(let q=0;q<H.vertexCount;q++){let w=H.vertexX[q],V=H.vertexZ[q],Y=m+((_-m)*(w+64)/128|0),A=E+((b-E)*(w+64)/128|0),h=Y+((A-Y)*(V+64)/128|0);H.vertexY[q]+=h-K}H.calculateBoundsY()}return H}if(!this.models||I>=this.models.length)return null;let N=this.models[I];if(N===-1)return null;let G=this.mirror!==R>3;if(G)N+=65536;let Q=_0.modelCacheStatic?.get(BigInt(N));if(!Q){if(Q=J.tryGet(N&65535),!Q)return null;if(G)Q.rotateY180();_0.modelCacheStatic?.put(BigInt(N),Q)}let $=this.resizex!==128||this.resizey!==128||this.resizez!==128,T=this.offsetx!==0||this.offsety!==0||this.offsetz!==0,U=J.modelShareColored(Q,!this.recol_s,!this.animHasAlpha,R===0&&O===-1&&!$&&!T);if(O!==-1)U.createLabelReferences(),U.applyTransform(O),U.labelFaces=null,U.labelVertices=null;while(R-- >0)U.rotateY90();if(this.recol_s&&this.recol_d)for(let K=0;K<this.recol_s.length;K++)U.recolour(this.recol_s[K],this.recol_d[K]);if($)U.scale(this.resizex,this.resizey,this.resizez);if(T)U.translate(this.offsety,this.offsetx,this.offsetz);if(U.calculateNormals((this.ambient&255)+64,(this.contrast&255)*5+768,-50,-10,-50,!this.sharelight),this.blockwalk)U.objRaise=U.minY;if(_0.modelCacheDynamic?.put(L,U),this.hillskew||this.sharelight)U=J.modelCopyFaces(U,this.hillskew,this.sharelight);if(this.hillskew){let K=(m+_+b+E)/4|0;for(let q=0;q<U.vertexCount;q++){let w=U.vertexX[q],V=U.vertexZ[q],Y=m+((_-m)*(w+64)/128|0),A=E+((b-E)*(w+64)/128|0),h=Y+((A-Y)*(V+64)/128|0);U.vertexY[q]+=h-K}U.calculateBoundsY()}return U}reset(){this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.active=!1,this._active=-1,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.wallwidth=16,this.ambient=0,this.contrast=0,this.op=null,this.animHasAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.offsetx=0,this.offsety=0,this.offsetz=0,this.forcedecor=!1}}async function z1(u){if(u[0]!==255)u[0]=255;URL.revokeObjectURL(P0.src),P0.src=URL.createObjectURL(new Blob([u],{type:"image/jpeg"})),await new Promise((_)=>P0.onload=()=>_()),u1.clearRect(0,0,p0.width,p0.height);let R=P0.naturalWidth,m=P0.naturalHeight;return p0.width=R,p0.height=m,u1.drawImage(P0,0,0),u1.getImageData(0,0,R,m)}class m0 extends F{pixels;cropRight;cropBottom;cropLeft;cropTop;width;height;constructor(u,R){super();this.pixels=new Int32Array(u*R),this.cropRight=this.width=u,this.cropBottom=this.height=R,this.cropLeft=this.cropTop=0}static async fromJpeg(u,R){let m=u.read(R+".dat");if(!m)throw new Error;let _=await z1(m),b=new m0(_.width,_.height),E=new Uint32Array(_.data.buffer),O=b.pixels;for(let I=0;I<O.length;I++){let L=E[I];O[I]=(L>>24&255)<<24|(L&255)<<16|(L>>8&255)<<8|L>>16&255}return b}static fromArchive(u,R,m=0){let _=new z(u.read(R+".dat")),b=new z(u.read("index.dat"));b.pos=_.g2();let E=b.g2(),O=b.g2(),I=b.g1(),L=[],H=I-1;for(let K=0;K<H;K++)if(L[K+1]=b.g3(),L[K+1]===0)L[K+1]=1;for(let K=0;K<m;K++)b.pos+=2,_.pos+=b.g2()*b.g2(),b.pos+=1;if(_.pos>_.length||b.pos>b.length)throw new Error;let N=b.g1(),G=b.g1(),Q=b.g2(),$=b.g2(),T=new m0(Q,$);T.cropLeft=N,T.cropTop=G,T.width=E,T.height=O;let U=b.g1();if(U===0){let K=T.cropRight*T.cropBottom;for(let q=0;q<K;q++)T.pixels[q]=L[_.g1()]}else if(U===1){let K=T.cropRight;for(let q=0;q<K;q++){let w=T.cropBottom;for(let V=0;V<w;V++)T.pixels[q+V*K]=L[_.g1()]}}return T}bind(){F.bind(this.pixels,this.cropRight,this.cropBottom)}draw(u,R){u|=0,R|=0,u+=this.cropLeft,R+=this.cropTop;let m=u+R*F.width2d,_=0,b=this.cropBottom,E=this.cropRight,O=F.width2d-E,I=0;if(R<F.top){let L=F.top-R;b-=L,R=F.top,_+=L*E,m+=L*F.width2d}if(R+b>F.bottom)b-=R+b-F.bottom;if(u<F.left){let L=F.left-u;E-=L,u=F.left,_+=L,m+=L,I+=L,O+=L}if(u+E>F.right){let L=u+E-F.right;E-=L,I+=L,O+=L}if(E>0&&b>0)this.copyImageDraw(E,b,this.pixels,_,I,F.pixels,m,O)}drawAlpha(u,R,m){R|=0,m|=0,R+=this.cropLeft,m+=this.cropTop;let _=R+m*F.width2d,b=0,E=this.cropBottom,O=this.cropRight,I=F.width2d-O,L=0;if(m<F.top){let H=F.top-m;E-=H,m=F.top,b+=H*O,_+=H*F.width2d}if(m+E>F.bottom)E-=m+E-F.bottom;if(R<F.left){let H=F.left-R;O-=H,R=F.left,b+=H,_+=H,L+=H,I+=H}if(R+O>F.right){let H=R+O-F.right;O-=H,L+=H,I+=H}if(O>0&&E>0)this.copyPixelsAlpha(O,E,this.pixels,b,L,F.pixels,_,I,u)}blitOpaque(u,R){u|=0,R|=0,u+=this.cropLeft,R+=this.cropTop;let m=u+R*F.width2d,_=0,b=this.cropBottom,E=this.cropRight,O=F.width2d-E,I=0;if(R<F.top){let L=F.top-R;b-=L,R=F.top,_+=L*E,m+=L*F.width2d}if(R+b>F.bottom)b-=R+b-F.bottom;if(u<F.left){let L=F.left-u;E-=L,u=F.left,_+=L,m+=L,I+=L,O+=L}if(u+E>F.right){let L=u+E-F.right;E-=L,I+=L,O+=L}if(E>0&&b>0)this.copyImageBlitOpaque(E,b,this.pixels,_,I,F.pixels,m,O)}flipHorizontally(){let u=this.pixels,R=this.cropRight,m=this.cropBottom;for(let _=0;_<m;_++){let b=R/2|0;for(let E=0;E<b;E++){let O=E+_*R,I=R-E-1+_*R,L=u[O];u[O]=u[I],u[I]=L}}}flipVertically(){let u=this.pixels,R=this.cropRight,m=this.cropBottom;for(let _=0;_<(m/2|0);_++)for(let b=0;b<R;b++){let E=b+_*R,O=b+(m-_-1)*R,I=u[E];u[E]=u[O],u[O]=I}}translate2d(u,R,m){for(let _=0;_<this.pixels.length;_++){let b=this.pixels[_];if(b!==0){let E=b>>16&255;if(E+=u,E<1)E=1;else if(E>255)E=255;let O=b>>8&255;if(O+=R,O<1)O=1;else if(O>255)O=255;let I=b&255;if(I+=m,I<1)I=1;else if(I>255)I=255;this.pixels[_]=(E<<16)+(O<<8)+I}}}crop(){let u=new Int32Array(this.width*this.height);for(let R=0;R<this.cropBottom;R++)for(let m=0;m<this.cropRight;m++)u[(this.cropTop+R)*this.width+this.cropLeft+m]=this.pixels[this.cropRight*R+m];this.pixels=u,this.cropRight=this.width,this.cropBottom=this.height,this.cropLeft=0,this.cropTop=0}drawRotated(u,R,m,_,b,E,O,I){I|=0,u|=0,E|=0,O|=0;try{let L=-E/2|0,H=-O/2|0,N=Math.sin(R)*65536|0,G=Math.cos(R)*65536|0,Q=N*m>>8,$=G*m>>8,T=(_<<16)+(H*Q+L*$),U=(b<<16)+(H*$-L*Q),K=I+u*F.width2d;for(let q=0;q<O;q++){let w=K,V=T,Y=U;for(let A=-E;A<0;A++){let h=this.pixels[(V>>16)+(Y>>16)*this.width];if(h==0)w++;else F.pixels[w++]=h;V+=$,Y-=Q}T+=Q,U+=$,K+=F.width2d}}catch(L){}}drawRotatedMasked(u,R,m,_,b,E,O,I,L,H){u|=0,R|=0,m|=0,_|=0;try{let N=-m/2|0,G=-_/2|0,Q=Math.sin(L/326.11)*65536|0,$=Math.cos(L/326.11)*65536|0,T=Q*H>>8,U=$*H>>8,K=(O<<16)+G*T+N*U,q=(I<<16)+(G*U-N*T),w=u+R*F.width2d;for(let V=0;V<_;V++){let Y=b[V],A=w+Y,h=K+U*Y,n=q-T*Y;for(let f=-E[V];f<0;f++)F.pixels[A++]=this.pixels[(h>>16)+(n>>16)*this.cropRight],h+=U,n-=T;K+=T,q+=U,w+=F.width2d}}catch(N){}}drawMasked(u,R,m){u|=0,R|=0,u+=this.cropLeft,R+=this.cropTop;let _=u+R*F.width2d,b=0,E=this.cropBottom,O=this.cropRight,I=F.width2d-O,L=0;if(R<F.top){let H=F.top-R;E-=H,R=F.top,b+=H*O,_+=H*F.width2d}if(R+E>F.bottom)E-=R+E-F.bottom;if(u<F.left){let H=F.left-u;O-=H,u=F.left,b+=H,_+=H,L+=H,I+=H}if(u+O>F.right){let H=u+O-F.right;O-=H,L+=H,I+=H}if(O>0&&E>0)this.copyPixelsMasked(O,E,this.pixels,L,b,F.pixels,_,I,m.pixels)}scale(u,R,m,_,b,E,O,I,L,H,N){try{let G=_;for(let Q=-R;Q<0;Q++){let $=(b>>16)*L;for(let T=-u;T<0;T++){let U=m[(_>>16)+$];if(U===0)I++;else E[I++]=U;_+=H}b+=N,_=G,I+=O}}catch(G){}}copyImageBlitOpaque(u,R,m,_,b,E,O,I){let L=-(u>>2);u=-(u&3);for(let H=-R;H<0;H++){for(let N=L;N<0;N++)E[O++]=m[_++],E[O++]=m[_++],E[O++]=m[_++],E[O++]=m[_++];for(let N=u;N<0;N++)E[O++]=m[_++];O+=I,_+=b}}copyPixelsAlpha(u,R,m,_,b,E,O,I,L){let H=256-L;for(let N=-R;N<0;N++){for(let G=-u;G<0;G++){let Q=m[_++];if(Q===0)O++;else{let $=E[O];E[O++]=((Q&16711935)*L+($&16711935)*H&4278255360)+((Q&65280)*L+($&65280)*H&16711680)>>8}}O+=I,_+=b}}copyImageDraw(u,R,m,_,b,E,O,I){let L=-(u>>2);u=-(u&3);for(let H=-R;H<0;H++){for(let N=L;N<0;N++){let G=m[_++];if(G===0)O++;else E[O++]=G;if(G=m[_++],G===0)O++;else E[O++]=G;if(G=m[_++],G===0)O++;else E[O++]=G;if(G=m[_++],G===0)O++;else E[O++]=G}for(let N=u;N<0;N++){let G=m[_++];if(G===0)O++;else E[O++]=G}O+=I,_+=b}}copyPixelsMasked(u,R,m,_,b,E,O,I,L){let H=-(u>>2);u=-(u&3);for(let N=-R;N<0;N++){for(let G=H;G<0;G++){let Q=m[b++];if(Q!==0&&L[O]===0)E[O++]=Q;else O++;if(Q=m[b++],Q!==0&&L[O]===0)E[O++]=Q;else O++;if(Q=m[b++],Q!==0&&L[O]===0)E[O++]=Q;else O++;if(Q=m[b++],Q!==0&&L[O]===0)E[O++]=Q;else O++}for(let G=u;G<0;G++){let Q=m[b++];if(Q!==0&&L[O]===0)E[O++]=Q;else O++}O+=I,b+=_}}}class l extends U0{static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;static membersWorld=!0;model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2000;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;static modelCache=new F0(50);static iconCache=new F0(200);manwearOffsetY=0;womanwearOffsetY=0;manwear=-1;manwear2=-1;womanwear=-1;womanwear2=-1;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;certlink=-1;certtemplate=-1;resizex=0;resizey=0;resizez=0;ambient=0;contrast=0;countobj=null;countco=null;op=null;iop=null;static unpack(u,R){this.membersWorld=R,this.data=new z(u.read("obj.dat"));let m=new z(u.read("obj.idx"));this.count=m.g2(),this.idx=new Int32Array(this.count);let _=2;for(let b=0;b<this.count;b++)this.idx[b]=_,_+=m.g2();this.cache=new p(10,null);for(let b=0;b<10;b++)this.cache[b]=new l(-1)}static get(u){if(!this.cache||!this.idx||!this.data)throw new Error;for(let m=0;m<10;m++){let _=this.cache[m];if(_&&_.id===u)return _}this.cachePos=(this.cachePos+1)%10;let R=this.cache[this.cachePos];if(this.data.pos=this.idx[u],R.id=u,R.reset(),R.unpackType(this.data),R.certtemplate!==-1)R.toCertificate();if(!this.membersWorld&&R.members)R.name="Members Object",R.desc="Login to a members' server to use this object.",R.op=null,R.iop=null;return R}reset(){this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2000,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.op=null,this.iop=null,this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1,this.resizex=128,this.resizey=128,this.resizez=128,this.ambient=0,this.contrast=0}unpack(u,R){if(u===1)this.model=R.g2();else if(u===2)this.name=R.gjstr();else if(u===3)this.desc=R.gjstr();else if(u===4)this.zoom2d=R.g2();else if(u===5)this.xan2d=R.g2();else if(u===6)this.yan2d=R.g2();else if(u===7){if(this.xof2d=R.g2b(),this.xof2d>32767)this.xof2d-=65536}else if(u===8){if(this.yof2d=R.g2b(),this.yof2d>32767)this.yof2d-=65536}else if(u===9)this.code9=!0;else if(u===10)this.code10=R.g2();else if(u===11)this.stackable=!0;else if(u===12)this.cost=R.g4();else if(u===16)this.members=!0;else if(u===23)this.manwear=R.g2(),this.manwearOffsetY=R.g1b();else if(u===24)this.manwear2=R.g2();else if(u===25)this.womanwear=R.g2(),this.womanwearOffsetY=R.g1b();else if(u===26)this.womanwear2=R.g2();else if(u>=30&&u<35){if(!this.op)this.op=new p(5,null);if(this.op[u-30]=R.gjstr(),this.op[u-30]?.toLowerCase()==="hidden")this.op[u-30]=null}else if(u>=35&&u<40){if(!this.iop)this.iop=new p(5,null);this.iop[u-35]=R.gjstr()}else if(u===40){let m=R.g1();this.recol_s=new Uint16Array(m),this.recol_d=new Uint16Array(m);for(let _=0;_<m;_++)this.recol_s[_]=R.g2(),this.recol_d[_]=R.g2()}else if(u===78)this.manwear3=R.g2();else if(u===79)this.womanwear3=R.g2();else if(u===90)this.manhead=R.g2();else if(u===91)this.womanhead=R.g2();else if(u===92)this.manhead2=R.g2();else if(u===93)this.womanhead2=R.g2();else if(u===95)this.zan2d=R.g2();else if(u===97)this.certlink=R.g2();else if(u===98)this.certtemplate=R.g2();else if(u>=100&&u<110){if(!this.countobj||!this.countco)this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10);this.countobj[u-100]=R.g2(),this.countco[u-100]=R.g2()}else if(u===110)this.resizex=R.g2();else if(u===111)this.resizey=R.g2();else if(u===112)this.resizez=R.g2();else if(u===113)this.ambient=R.g1b();else if(u===114)this.ambient=R.g1b()*5}toCertificate(){let u=l.get(this.certtemplate);this.model=u.model,this.zoom2d=u.zoom2d,this.xan2d=u.xan2d,this.yan2d=u.yan2d,this.zan2d=u.zan2d,this.xof2d=u.xof2d,this.yof2d=u.yof2d,this.recol_s=u.recol_s,this.recol_d=u.recol_d;let R=l.get(this.certlink);this.name=R.name,this.members=R.members,this.cost=R.cost;let m="a",_=(R.name||"").toLowerCase().charAt(0);if(_==="a"||_==="e"||_==="i"||_==="o"||_==="u")m="an";this.desc=`Swap this note at any bank for ${m} ${R.name}.`,this.stackable=!0}getModel(u){if(this.countobj&&this.countco&&u>1){let m=-1;for(let _=0;_<10;_++)if(u>=this.countco[_]&&this.countco[_]!==0)m=this.countobj[_];if(m!==-1)return l.get(m).getModel(1)}let R=null;if(l.modelCache){if(R=l.modelCache.get(BigInt(this.id)),R)return R}if(R=J.tryGet(this.model),!R)return null;if(this.resizex!==128||this.resizey!==128||this.resizez!==128)R.scale(this.resizex,this.resizey,this.resizez);if(this.recol_s&&this.recol_d)for(let m=0;m<this.recol_s.length;m++)R.recolour(this.recol_s[m],this.recol_d[m]);if(R.calculateNormals(this.ambient+64,this.contrast+768,-50,-10,-50,!0),R.picking=!0,l.modelCache)l.modelCache.put(BigInt(this.id),R);return R}getInvModel(u){if(this.countobj&&this.countco&&u>1){let m=-1;for(let _=0;_<10;_++)if(u>=this.countco[_]&&this.countco[_]!==0)m=this.countobj[_];if(m!==-1)return l.get(m).getInvModel(1)}let R=J.tryGet(this.model);if(!R)return null;if(this.recol_s&&this.recol_d)for(let m=0;m<this.recol_s.length;m++)R.recolour(this.recol_s[m],this.recol_d[m]);return R}static getIcon(u,R,m){if(l.iconCache&&m===0){let Y=l.iconCache.get(BigInt(u));if(Y&&Y.height!==R&&Y.height!==-1)Y.unlink(),Y=null;if(Y)return Y}let _=l.get(u);if(!_.countobj)R=-1;if(_.countobj&&_.countco&&R>1){let Y=-1;for(let A=0;A<10;A++)if(R>=_.countco[A]&&_.countco[A]!==0)Y=_.countobj[A];if(Y!==-1)_=l.get(Y)}let b=_.getModel(1);if(!b)return null;let E=null;if(_.certtemplate!==-1){if(E=this.getIcon(_.certlink,10,-1),!E)return null}let O=new m0(32,32),I=Z.centerX,L=Z.centerY,H=Z.lineOffset,N=F.pixels,G=F.width2d,Q=F.height2d,$=F.left,T=F.right,U=F.top,K=F.bottom;Z.jagged=!1,F.bind(O.pixels,32,32),F.fillRect2d(0,0,32,32,0),Z.init2D();let q=_.zoom2d;if(m===-1)q=q*1.5|0;else if(m>0)q=q*1.04|0;let w=Z.sin[_.xan2d]*q>>16,V=Z.cos[_.xan2d]*q>>16;b.drawSimple(0,_.yan2d,_.zan2d,_.xan2d,_.xof2d,w+(b.minY/2|0)+_.yof2d,V+_.yof2d);for(let Y=31;Y>=0;Y--)for(let A=31;A>=0;A--){if(O.pixels[Y+A*32]!==0)continue;if(Y>0&&O.pixels[Y+A*32-1]>1)O.pixels[Y+A*32]=1;else if(A>0&&O.pixels[Y+(A-1)*32]>1)O.pixels[Y+A*32]=1;else if(Y<31&&O.pixels[Y+A*32+1]>1)O.pixels[Y+A*32]=1;else if(A<31&&O.pixels[Y+(A+1)*32]>1)O.pixels[Y+A*32]=1}if(m>0)for(let Y=31;Y>=0;Y--)for(let A=31;A>=0;A--){if(O.pixels[Y+A*32]!==0)continue;if(Y>0&&O.pixels[Y+A*32-1]===1)O.pixels[Y+A*32]=m;else if(A>0&&O.pixels[Y+(A-1)*32]===1)O.pixels[Y+A*32]=m;else if(Y<31&&O.pixels[Y+A*32+1]===1)O.pixels[Y+A*32]=m;else if(A<31&&O.pixels[Y+(A+1)*32]===1)O.pixels[Y+A*32]=m}else for(let Y=31;Y>=0;Y--)for(let A=31;A>=0;A--)if(O.pixels[Y+A*32]===0&&Y>0&&A>0&&O.pixels[Y+(A-1)*32-1]>0)O.pixels[Y+A*32]=3153952;if(E&&_.certtemplate!==-1){let{width:Y,height:A}=E;E.width=32,E.height=32,E.draw(0,0),E.width=Y,E.height=A}if(l.iconCache&&m===0)l.iconCache.put(BigInt(u),O);if(F.bind(N,G,Q),F.setBounds($,U,T,K),Z.centerX=I,Z.centerY=L,Z.lineOffset=H,Z.jagged=!0,_.stackable)O.width=33;else O.width=32;return O.height=R,O}wornModelIsReady(u){let R=this.manwear,m=this.manwear2,_=this.manwear3;if(u==1)R=this.womanwear,m=this.womanwear2,_=this.womanwear3;if(R==-1)return!0;let b=!0;if(!J.isReady(R))b=!1;if(m!=-1&&!J.isReady(m))b=!1;if(_!=-1&&!J.isReady(_))b=!1;return b}getWornModel(u){let R=this.manwear;if(u===1)R=this.womanwear;if(R===-1)return null;let m=this.manwear2,_=this.manwear3;if(u===1)m=this.womanwear2,_=this.womanwear3;let b=J.tryGet(R);if(!b)return null;if(m!==-1){let E=J.tryGet(m);if(!E)return null;if(_===-1){let O=[b,E];b=J.modelFromModels(O,2)}else{let O=J.tryGet(_);if(!O)return null;let I=[b,E,O];b=J.modelFromModels(I,3)}}if(u===0&&this.manwearOffsetY!==0)b.translate(this.manwearOffsetY,0,0);else if(u===1&&this.womanwearOffsetY!==0)b.translate(this.womanwearOffsetY,0,0);if(this.recol_s&&this.recol_d)for(let E=0;E<this.recol_s.length;E++)b.recolour(this.recol_s[E],this.recol_d[E]);return b}headModelIsReady(u){let R=this.manhead,m=this.manhead2;if(u==1)R=this.womanhead,m=this.womanhead2;if(R==-1)return!0;let _=!0;if(!J.isReady(R))_=!1;if(m!=-1&&!J.isReady(m))_=!1;return _}getHeadModel(u){let R=this.manhead;if(u===1)R=this.womanhead;if(R===-1)return null;let m=this.manhead2;if(u===1)m=this.womanhead2;let _=J.tryGet(R);if(!_)return null;if(m!==-1){let b=J.tryGet(m);if(!b)return null;let E=[_,b];_=J.modelFromModels(E,2)}if(this.recol_s&&this.recol_d)for(let b=0;b<this.recol_s.length;b++)_.recolour(this.recol_s[b],this.recol_d[b]);return _}}class w0 extends U0{static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;name=null;desc=null;size=1;models=null;heads=null;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;animHasAlpha=!1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;alwaysontop=!1;headicon=-1;static modelCache=new F0(30);ambient=0;contrast=0;static unpack(u){this.data=new z(u.read("npc.dat"));let R=new z(u.read("npc.idx"));this.count=R.g2(),this.idx=new Int32Array(this.count);let m=2;for(let _=0;_<this.count;_++)this.idx[_]=m,m+=R.g2();this.cache=new p(20,null);for(let _=0;_<20;_++)this.cache[_]=new w0(-1)}static get(u){if(!this.cache||!this.idx||!this.data)throw new Error;for(let m=0;m<20;m++){let _=this.cache[m];if(_&&_.id===u)return _}this.cachePos=(this.cachePos+1)%20;let R=this.cache[this.cachePos]=new w0(u);return this.data.pos=this.idx[u],R.unpackType(this.data),R}unpack(u,R){if(u===1){let m=R.g1();this.models=new Uint16Array(m);for(let _=0;_<m;_++)this.models[_]=R.g2()}else if(u===2)this.name=R.gjstr();else if(u===3)this.desc=R.gjstr();else if(u===12)this.size=R.g1b();else if(u===13)this.readyanim=R.g2();else if(u===14)this.walkanim=R.g2();else if(u===16)this.animHasAlpha=!0;else if(u===17)this.walkanim=R.g2(),this.walkanim_b=R.g2(),this.walkanim_r=R.g2(),this.walkanim_l=R.g2();else if(u>=30&&u<40){if(!this.op)this.op=new p(5,null);if(this.op[u-30]=R.gjstr(),this.op[u-30]?.toLowerCase()==="hidden")this.op[u-30]=null}else if(u===40){let m=R.g1();this.recol_s=new Uint16Array(m),this.recol_d=new Uint16Array(m);for(let _=0;_<m;_++)this.recol_s[_]=R.g2(),this.recol_d[_]=R.g2()}else if(u===60){let m=R.g1();this.heads=new Uint16Array(m);for(let _=0;_<m;_++)this.heads[_]=R.g2()}else if(u===90)this.resizex=R.g2();else if(u===91)this.resizey=R.g2();else if(u===92)this.resizez=R.g2();else if(u===93)this.minimap=!1;else if(u===95)this.vislevel=R.g2();else if(u===97)this.resizeh=R.g2();else if(u===98)this.resizev=R.g2();else if(u===99)this.alwaysontop=!0;else if(u===100)this.ambient=R.g1b();else if(u===101)this.contrast=R.g1b()*5;else if(u===102)this.headicon=R.g2()}getModel(u,R,m){let _=null;if(w0.modelCache){if(_=w0.modelCache.get(BigInt(this.id)),!_&&this.models){let E=!1;for(let I=0;I<this.models.length;I++)if(!J.isReady(this.models[I]))E=!0;if(E)return null;let O=new p(this.models.length,null);for(let I=0;I<this.models.length;I++)O[I]=J.tryGet(this.models[I]);if(O.length===1)_=O[0];else _=J.modelFromModels(O,O.length);if(_){if(this.recol_s&&this.recol_d)for(let I=0;I<this.recol_s.length;I++)_.recolour(this.recol_s[I],this.recol_d[I]);_.createLabelReferences(),_.calculateNormals(64,850,-30,-50,-30,!0),w0.modelCache.put(BigInt(this.id),_)}}}let b=null;if(_){if(b=J.modelShareAlpha(_,!this.animHasAlpha),u!==-1&&R!==-1)b.applyTransforms(u,R,m);else if(u!==-1)b.applyTransform(u);if(this.resizeh!==128||this.resizev!==128)b.scale(this.resizeh,this.resizev,this.resizeh);if(b.calculateBoundsCylinder(),b.labelFaces=null,b.labelVertices=null,this.size===1)b.picking=!0}return b}getHeadModel(){if(!this.heads)return null;let u=!1;for(let _=0;_<this.heads.length;_++)if(!J.isReady(this.heads[_]))u=!0;if(u)return null;let R=new p(this.heads.length,null);for(let _=0;_<this.heads.length;_++)R[_]=J.tryGet(this.heads[_]);let m;if(R.length===1)m=R[0];else m=J.modelFromModels(R,R.length);if(m&&this.recol_s&&this.recol_d)for(let _=0;_<this.recol_s.length;_++)m.recolour(this.recol_s[_],this.recol_d[_]);return m}}class K0 extends U0{static count=0;static types=[];type=-1;models=null;recol_s=new Int32Array(6);recol_d=new Int32Array(6);heads=new Int32Array(5).fill(-1);disable=!1;static unpack(u){let R=new z(u.read("idk.dat"));this.count=R.g2(),this.types=new Array(this.count);for(let m=0;m<this.count;m++){if(!this.types[m])this.types[m]=new K0(m);this.types[m].unpackType(R)}}unpack(u,R){if(u===1)this.type=R.g1();else if(u===2){let m=R.g1();this.models=new Int32Array(m);for(let _=0;_<m;_++)this.models[_]=R.g2()}else if(u===3)this.disable=!0;else if(u>=40&&u<50)this.recol_s[u-40]=R.g2();else if(u>=50&&u<60)this.recol_d[u-50]=R.g2();else if(u>=60&&u<70)this.heads[u-60]=R.g2()}modelIsReady(){if(!this.models)return!0;let u=!0;for(let R=0;R<this.models.length;R++)if(!J.isReady(this.models[R]))u=!1;return u}getModel(){if(!this.models)return null;let u=new p(this.models.length,null);for(let m=0;m<this.models.length;m++)u[m]=J.tryGet(this.models[m]);let R;if(u.length===1)R=u[0];else R=J.modelFromModels(u,u.length);for(let m=0;m<6&&this.recol_s[m]!==0;m++)R?.recolour(this.recol_s[m],this.recol_d[m]);return R}headModelIsReady(){let u=!0;for(let R=0;R<this.heads.length;R++)if(this.heads[R]!=-1&&!J.isReady(this.heads[R]))u=!1;return u}getHeadModel(){let u=0,R=new p(5,null);for(let _=0;_<5;_++)if(this.heads[_]!==-1)R[u++]=J.tryGet(this.heads[_]);let m=J.modelFromModels(R,u);for(let _=0;_<6&&this.recol_s[_]!==0;_++)m.recolour(this.recol_s[_],this.recol_d[_]);return m}}class q0 extends U0{static count=0;static types=[];model=0;anim=-1;seq=null;animHasAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;angle=0;ambient=0;contrast=0;static modelCache=new F0(30);static unpack(u){let R=new z(u.read("spotanim.dat"));this.count=R.g2();for(let m=0;m<this.count;m++)this.types[m]=new q0(m).unpackType(R)}unpack(u,R){if(u===1)this.model=R.g2();else if(u===2){if(this.anim=R.g2(),o.types)this.seq=o.types[this.anim]}else if(u===3)this.animHasAlpha=!0;else if(u===4)this.resizeh=R.g2();else if(u===5)this.resizev=R.g2();else if(u===6)this.angle=R.g2();else if(u===7)this.ambient=R.g1();else if(u===8)this.contrast=R.g1();else if(u>=40&&u<50)this.recol_s[u-40]=R.g2();else if(u>=50&&u<60)this.recol_d[u-50]=R.g2()}getModel(){let u=null;if(q0.modelCache){if(u=q0.modelCache.get(BigInt(this.id)),u)return u}if(u=J.tryGet(this.model),!u)return null;for(let R=0;R<6;R++)if(this.recol_s[0]!==0)u.recolour(this.recol_s[R],this.recol_d[R]);if(q0.modelCache)q0.modelCache.put(BigInt(this.id),u);return u}}class W0 extends U0{static count=0;static types=[];static code3s=[];static code3Count=0;code1=0;code2=0;code3=!1;code4=!0;clientcode=0;code7=0;code6=!1;code8=!1;code11=!1;static unpack(u){let R=new z(u.read("varp.dat"));this.count=R.g2();for(let m=0;m<this.count;m++)this.types[m]=new W0(m).unpackType(R)}unpack(u,R){if(u===1)this.code1=R.g1();else if(u===2)this.code2=R.g1();else if(u===3)this.code3=!0,W0.code3s[W0.code3Count++]=this.id;else if(u===4)this.code4=!1;else if(u===5)this.clientcode=R.g2();else if(u===6)this.code6=!0;else if(u===7)this.code7=R.g4();else if(u===8)this.code8=!0,this.code11=!0;else if(u===10)this.debugname=R.gjstr();else if(u===11)this.code11=!0}}class c{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37(u){u=u.trim();let R=0n;for(let m=0;m<u.length&&m<12;m++){let _=u.charCodeAt(m);if(R*=37n,_>=65&&_<=90)R+=BigInt(_+1-65);else if(_>=97&&_<=122)R+=BigInt(_+1-97);else if(_>=48&&_<=57)R+=BigInt(_+27-48)}return R}static fromBase37(u){if(u<0n||u>=6582952005840035281n)return"invalid_name";if(u%37n===0n)return"invalid_name";let R=0,m=Array(12);while(u!==0n){let _=u;u/=37n,m[11-R++]=this.BASE37_LOOKUP[Number(_-u*37n)]}return m.slice(12-R).join("")}static toSentenceCase(u){let R=[...u.toLowerCase()],m=!0;for(let _=0;_<R.length;_++){let b=R[_];if(m&&b>="a"&&b<="z")R[_]=b.toUpperCase(),m=!1;if(b==="."||b==="!")m=!0}return R.join("")}static toAsterisks(u){let R="";for(let m=0;m<u.length;m++)R=R+"*";return R}static formatIPv4(u){return(u>>24&255)+"."+(u>>16&255)+"."+(u>>8&255)+"."+(u&255)}static formatName(u){if(u.length===0)return u;let R=[...u];for(let m=0;m<R.length;m++)if(R[m]==="_"){if(R[m]=" ",m+1<R.length&&R[m+1]>="a"&&R[m+1]<="z")R[m+1]=String.fromCharCode(R[m+1].charCodeAt(0)+65-97)}if(R[0]>="a"&&R[0]<="z")R[0]=String.fromCharCode(R[0].charCodeAt(0)+65-97);return R.join("")}static hashCode(u){let R=u.toUpperCase(),m=0n;for(let _=0;_<R.length;_++)m=m*61n+BigInt(R.charCodeAt(_))-32n,m=m+(m>>56n)&0xffffffffffffffn;return m}}class s{static types=[];invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;id=-1;layer=-1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;alpha=0;x=0;y=0;scripts=null;scriptComparator=null;scriptOperand=null;overlayer=-1;scroll=0;scrollPosition=0;hide=!1;children=null;activeModelType=0;activeModel=0;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;targetVerb=null;targetText=null;targetMask=-1;option=null;static modelCache=new F0(30);static imageCache=null;marginX=0;marginY=0;colour=0;activeColour=0;overColour=0;modelType=0;model=0;graphic=null;activeGraphic=null;font=null;text=null;activeText=null;draggable=!1;interactable=!1;usable=!1;fill=!1;center=!1;shadowed=!1;invSlotOffsetX=null;invSlotOffsetY=null;childX=null;childY=null;invSlotGraphic=null;iop=null;static unpack(u,R,m){this.imageCache=new F0(50000);let _=new z(u.read("data")),b=-1,E=_.g2();this.types=new Array(E);while(_.pos<_.length){let O=_.g2();if(O===65535)b=_.g2(),O=_.g2();let I=this.types[O]=new s;if(I.id=O,I.layer=b,I.type=_.g1(),I.buttonType=_.g1(),I.clientCode=_.g2(),I.width=_.g2(),I.height=_.g2(),I.alpha=_.g1(),I.overlayer=_.g1(),I.overlayer===0)I.overlayer=-1;else I.overlayer=(I.overlayer-1<<8)+_.g1();let L=_.g1();if(L>0){I.scriptComparator=new Uint8Array(L),I.scriptOperand=new Uint16Array(L);for(let N=0;N<L;N++)I.scriptComparator[N]=_.g1(),I.scriptOperand[N]=_.g2()}let H=_.g1();if(H>0){I.scripts=new p(H,null);for(let N=0;N<H;N++){let G=_.g2(),Q=new Uint16Array(G);I.scripts[N]=Q;for(let $=0;$<G;$++)Q[$]=_.g2()}}if(I.type===0){I.scroll=_.g2(),I.hide=_.g1()===1;let N=_.g2();I.children=new Array(N),I.childX=new Array(N),I.childY=new Array(N);for(let G=0;G<N;G++)I.children[G]=_.g2(),I.childX[G]=_.g2b(),I.childY[G]=_.g2b()}if(I.type===1)_.pos+=3;if(I.type===2){I.invSlotObjId=new Int32Array(I.width*I.height),I.invSlotObjCount=new Int32Array(I.width*I.height),I.draggable=_.g1()===1,I.interactable=_.g1()===1,I.usable=_.g1()===1,I.marginX=_.g1(),I.marginY=_.g1(),I.invSlotOffsetX=new Int16Array(20),I.invSlotOffsetY=new Int16Array(20),I.invSlotGraphic=new p(20,null);for(let N=0;N<20;N++)if(_.g1()===1){I.invSlotOffsetX[N]=_.g2b(),I.invSlotOffsetY[N]=_.g2b();let G=_.gjstr();if(R&&G.length>0){let Q=G.lastIndexOf(",");I.invSlotGraphic[N]=this.getImage(R,G.substring(0,Q),parseInt(G.substring(Q+1)))}}I.iop=new p(5,null);for(let N=0;N<5;N++)if(I.iop[N]=_.gjstr(),I.iop[N].length===0)I.iop[N]=null}if(I.type===3)I.fill=_.g1()===1;if(I.type===4||I.type===1){I.center=_.g1()===1;let N=_.g1();if(m)I.font=m[N];I.shadowed=_.g1()===1}if(I.type===4)I.text=_.gjstr(),I.activeText=_.gjstr();if(I.type===1||I.type===3||I.type===4)I.colour=_.g4();if(I.type===3||I.type===4)I.activeColour=_.g4(),I.overColour=_.g4();if(I.type===5){let N=_.gjstr();if(R&&N.length>0){let Q=N.lastIndexOf(",");I.graphic=this.getImage(R,N.substring(0,Q),parseInt(N.substring(Q+1),10))}let G=_.gjstr();if(R&&G.length>0){let Q=G.lastIndexOf(",");I.activeGraphic=this.getImage(R,G.substring(0,Q),parseInt(G.substring(Q+1),10))}}if(I.type===6){let N=_.g1();if(N!==0)I.modelType=1,I.model=(N-1<<8)+_.g1();let G=_.g1();if(G!==0)I.activeModelType=1,I.activeModel=(G-1<<8)+_.g1();if(I.anim=_.g1(),I.anim===0)I.anim=-1;else I.anim=(I.anim-1<<8)+_.g1();if(I.activeAnim=_.g1(),I.activeAnim===0)I.activeAnim=-1;else I.activeAnim=(I.activeAnim-1<<8)+_.g1();I.zoom=_.g2(),I.xan=_.g2(),I.yan=_.g2()}if(I.type===7){I.invSlotObjId=new Int32Array(I.width*I.height),I.invSlotObjCount=new Int32Array(I.width*I.height),I.center=_.g1()===1;let N=_.g1();if(m)I.font=m[N];I.shadowed=_.g1()===1,I.colour=_.g4(),I.marginX=_.g2b(),I.marginY=_.g2b(),I.interactable=_.g1()===1,I.iop=new p(5,null);for(let G=0;G<5;G++)if(I.iop[G]=_.gjstr(),I.iop[G].length===0)I.iop[G]=null}if(I.buttonType===2||I.type===2)I.targetVerb=_.gjstr(),I.targetText=_.gjstr(),I.targetMask=_.g2();if(I.buttonType===1||I.buttonType===4||I.buttonType===5||I.buttonType===6){if(I.option=_.gjstr(),I.option.length===0){if(I.buttonType===1)I.option="Ok";else if(I.buttonType===4)I.option="Select";else if(I.buttonType===5)I.option="Select";else if(I.buttonType===6)I.option="Continue"}}}this.imageCache=null}swapObj(u,R){if(!this.invSlotObjId||!this.invSlotObjCount)return;let m=this.invSlotObjId[u];this.invSlotObjId[u]=this.invSlotObjId[R],this.invSlotObjId[R]=m,m=this.invSlotObjCount[u],this.invSlotObjCount[u]=this.invSlotObjCount[R],this.invSlotObjCount[R]=m}getModel(u,R,m,_){let b=null;if(m)b=this.loadModel(this.activeModelType,this.activeModel,_);else b=this.loadModel(this.modelType,this.model,_);if(!b)return null;if(u===-1&&R===-1&&!b.faceColour)return b;let E=J.modelShareColored(b,!0,!0,!1);if(u!==-1||R!==-1)E.createLabelReferences();if(u!==-1)E.applyTransform(u);if(R!==-1)E.applyTransform(R);return E.calculateNormals(64,768,-50,-10,-50,!0),E}loadModel(u,R,m){let _=s.modelCache.get(BigInt((u<<16)+R));if(_)return _;if(u===1)_=J.tryGet(R);else if(u===2)_=w0.get(R).getHeadModel();else if(u===3){if(m)_=m.getHeadModel()}else if(u===4)_=l.get(R).getInvModel(50);else if(u===5)_=null;if(_)s.modelCache.put(BigInt((u<<16)+R),_);return _}static cacheModel(u,R,m){if(s.modelCache.clear(),u&&R!=4)s.modelCache.put(BigInt((R<<16)+m),u)}getAbsoluteX(){if(this.layer===this.id)return this.x;let u=s.types[this.layer];if(!u.children||!u.childX||!u.childY)return this.x;let R=u.children.indexOf(this.id);if(R===-1)return this.x;let m=u.childX[R];while(u.layer!==u.id){let _=s.types[u.layer];if(_.children&&_.childX&&_.childY){if(R=_.children.indexOf(u.id),R!==-1)m+=_.childX[R]}u=_}return m}static getImage(u,R,m){let _=c.hashCode(R)<<8n|BigInt(m);if(this.imageCache){let b=this.imageCache.get(_);if(b)return b}try{let b=m0.fromArchive(u,R,m);return this.imageCache?.put(_,b),b}catch(b){return null}}}class e{static index=(u,R)=>u*104+R;startX;startZ;sizeX;sizeZ;flags;constructor(){this.startX=0,this.startZ=0,this.sizeX=104,this.sizeZ=104,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset(){for(let u=0;u<this.sizeX;u++)for(let R=0;R<this.sizeZ;R++){let m=e.index(u,R);if(u===0||R===0||u===this.sizeX-1||R===this.sizeZ-1)this.flags[m]=16777215;else this.flags[m]=0}}addFloor(u,R){this.flags[e.index(u-this.startX,R-this.startZ)]|=2097152}removeFloor(u,R){this.flags[e.index(u-this.startX,R-this.startZ)]&=~2097152}addLoc(u,R,m,_,b,E){let O=256;if(E)O|=131072;let I=u-this.startX,L=R-this.startZ;if(b===1||b===3){let H=m;m=_,_=H}for(let H=I;H<I+m;H++){if(!(H>=0&&H<this.sizeX))continue;for(let N=L;N<L+_;N++){if(!(N>=0&&N<this.sizeZ))continue;this.add(H,N,O)}}}removeLoc(u,R,m,_,b,E){let O=256;if(E)O|=131072;let I=u-this.startX,L=R-this.startZ;if(b===1||b===3){let H=m;m=_,_=H}for(let H=I;H<I+m;H++){if(!(H>=0&&H<this.sizeX))continue;for(let N=L;N<L+_;N++){if(!(N>=0&&N<this.sizeZ))continue;this.remove(H,N,O)}}}addWall(u,R,m,_,b){let E=u-this.startX,O=R-this.startZ,I=b?65536:128,L=b?4096:8,H=b?1024:2,N=b?16384:32,G=b?512:1,Q=b?8192:16,$=b?2048:4,T=b?32768:64;if(m===g.WALL_STRAIGHT.id){if(_===0)this.add(E,O,I),this.add(E-1,O,L);else if(_===1)this.add(E,O,H),this.add(E,O+1,N);else if(_===2)this.add(E,O,L),this.add(E+1,O,I);else if(_===3)this.add(E,O,N),this.add(E,O-1,H)}else if(m===g.WALL_DIAGONAL_CORNER.id||m===g.WALL_SQUARE_CORNER.id){if(_===0)this.add(E,O,G),this.add(E-1,O+1,Q);else if(_===1)this.add(E,O,$),this.add(E+1,O+1,T);else if(_===2)this.add(E,O,Q),this.add(E+1,O-1,G);else if(_===3)this.add(E,O,T),this.add(E-1,O-1,$)}else if(m===g.WALL_L.id){if(_===0)this.add(E,O,H|I),this.add(E-1,O,L),this.add(E,O+1,N);else if(_===1)this.add(E,O,H|L),this.add(E,O+1,N),this.add(E+1,O,I);else if(_===2)this.add(E,O,N|L),this.add(E+1,O,I),this.add(E,O-1,H);else if(_===3)this.add(E,O,N|I),this.add(E,O-1,H),this.add(E-1,O,L)}if(b)this.addWall(u,R,m,_,!1)}removeWall(u,R,m,_,b){let E=u-this.startX,O=R-this.startZ,I=b?65536:128,L=b?4096:8,H=b?1024:2,N=b?16384:32,G=b?512:1,Q=b?8192:16,$=b?2048:4,T=b?32768:64;if(m===g.WALL_STRAIGHT.id){if(_===0)this.remove(E,O,I),this.remove(E-1,O,L);else if(_===1)this.remove(E,O,H),this.remove(E,O+1,N);else if(_===2)this.remove(E,O,L),this.remove(E+1,O,I);else if(_===3)this.remove(E,O,N),this.remove(E,O-1,H)}else if(m===g.WALL_DIAGONAL_CORNER.id||m===g.WALL_SQUARE_CORNER.id){if(_===0)this.remove(E,O,G),this.remove(E-1,O+1,Q);else if(_===1)this.remove(E,O,$),this.remove(E+1,O+1,T);else if(_===2)this.remove(E,O,Q),this.remove(E+1,O-1,G);else if(_===3)this.remove(E,O,T),this.remove(E-1,O-1,$)}else if(m===g.WALL_L.id){if(_===0)this.remove(E,O,H|I),this.remove(E-1,O,L),this.remove(E,O+1,N);else if(_===1)this.remove(E,O,H|L),this.remove(E,O+1,N),this.remove(E+1,O,I);else if(_===2)this.remove(E,O,N|L),this.remove(E+1,O,I),this.remove(E,O-1,H);else if(_===3)this.remove(E,O,N|I),this.remove(E,O-1,H),this.remove(E-1,O,L)}if(b)this.removeWall(u,R,m,_,!1)}reachedWall(u,R,m,_,b,E){if(u===m&&R===_)return!0;let O=u-this.startX,I=R-this.startZ,L=m-this.startX,H=_-this.startZ,N=e.index(O,I);if(b===g.WALL_STRAIGHT.id){if(E===0){if(O===L-1&&I===H)return!0;else if(O===L&&I===H+1&&(this.flags[N]&2621728)===0)return!0;else if(O===L&&I===H-1&&(this.flags[N]&2621698)===0)return!0}else if(E===1){if(O===L&&I===H+1)return!0;else if(O===L-1&&I===H&&(this.flags[N]&2621704)===0)return!0;else if(O===L+1&&I===H&&(this.flags[N]&2621824)===0)return!0}else if(E===2){if(O===L+1&&I===H)return!0;else if(O===L&&I===H+1&&(this.flags[N]&2621728)===0)return!0;else if(O===L&&I===H-1&&(this.flags[N]&2621698)===0)return!0}else if(E===3){if(O===L&&I===H-1)return!0;else if(O===L-1&&I===H&&(this.flags[N]&2621704)===0)return!0;else if(O===L+1&&I===H&&(this.flags[N]&2621824)===0)return!0}}else if(b===g.WALL_L.id){if(E===0){if(O===L-1&&I===H)return!0;else if(O===L&&I===H+1)return!0;else if(O===L+1&&I===H&&(this.flags[N]&2621824)===0)return!0;else if(O===L&&I===H-1&&(this.flags[N]&2621698)===0)return!0}else if(E===1){if(O===L-1&&I===H&&(this.flags[N]&2621704)===0)return!0;else if(O===L&&I===H+1)return!0;else if(O===L+1&&I===H)return!0;else if(O===L&&I===H-1&&(this.flags[N]&2621698)===0)return!0}else if(E===2){if(O===L-1&&I===H&&(this.flags[N]&2621704)===0)return!0;else if(O===L&&I===H+1&&(this.flags[N]&2621728)===0)return!0;else if(O===L+1&&I===H)return!0;else if(O===L&&I===H-1)return!0}else if(E===3){if(O===L-1&&I===H)return!0;else if(O===L&&I===H+1&&(this.flags[N]&2621728)===0)return!0;else if(O===L+1&&I===H&&(this.flags[N]&2621824)===0)return!0;else if(O===L&&I===H-1)return!0}}else if(b===g.WALL_DIAGONAL.id){if(O===L&&I===H+1&&(this.flags[N]&32)===0)return!0;else if(O===L&&I===H-1&&(this.flags[N]&2)===0)return!0;else if(O===L-1&&I===H&&(this.flags[N]&8)===0)return!0;else if(O===L+1&&I===H&&(this.flags[N]&128)===0)return!0}return!1}reachedWallDecoration(u,R,m,_,b,E){if(u===m&&R===_)return!0;let O=u-this.startX,I=R-this.startZ,L=m-this.startX,H=_-this.startZ,N=e.index(O,I);if(b===g.WALLDECOR_DIAGONAL_OFFSET.id||b===g.WALLDECOR_DIAGONAL_NOOFFSET.id){if(b===g.WALLDECOR_DIAGONAL_NOOFFSET.id)E=E+2&3;if(E===0){if(O===L+1&&I===H&&(this.flags[N]&128)===0)return!0;else if(O===L&&I===H-1&&(this.flags[N]&2)===0)return!0}else if(E===1){if(O===L-1&&I===H&&(this.flags[N]&8)===0)return!0;else if(O===L&&I===H-1&&(this.flags[N]&2)===0)return!0}else if(E===2){if(O===L-1&&I===H&&(this.flags[N]&8)===0)return!0;else if(O===L&&I===H+1&&(this.flags[N]&32)===0)return!0}else if(E===3){if(O===L+1&&I===H&&(this.flags[N]&128)===0)return!0;else if(O===L&&I===H+1&&(this.flags[N]&32)===0)return!0}}else if(b===g.WALLDECOR_DIAGONAL_BOTH.id){if(O===L&&I===H+1&&(this.flags[N]&32)===0)return!0;else if(O===L&&I===H-1&&(this.flags[N]&2)===0)return!0;else if(O===L-1&&I===H&&(this.flags[N]&8)===0)return!0;else if(O===L+1&&I===H&&(this.flags[N]&128)===0)return!0}return!1}reachedLoc(u,R,m,_,b,E,O){let I=m+b-1,L=_+E-1,H=e.index(u-this.startX,R-this.startZ);if(u>=m&&u<=I&&R>=_&&R<=L)return!0;else if(u===m-1&&R>=_&&R<=L&&(this.flags[H]&8)===0&&(O&8)===0)return!0;else if(u===I+1&&R>=_&&R<=L&&(this.flags[H]&128)===0&&(O&2)===0)return!0;else if(R===_-1&&u>=m&&u<=I&&(this.flags[H]&2)===0&&(O&4)===0)return!0;else if(R===L+1&&u>=m&&u<=I&&(this.flags[H]&32)===0&&(O&1)===0)return!0;return!1}add(u,R,m){this.flags[e.index(u,R)]|=m}remove(u,R,m){this.flags[e.index(u,R)]&=16777215-m}}class O1{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(u,R,m,_,b,E,O,I,L,H,N){this.minTileX=u,this.maxTileX=R,this.minTileZ=m,this.maxTileZ=_,this.type=b,this.minX=E,this.maxX=O,this.minZ=I,this.maxZ=L,this.minY=H,this.maxY=N}}class I1{y;x;z;model;typecode;info;constructor(u,R,m,_,b,E){this.y=u,this.x=R,this.z=m,this.model=_,this.typecode=b,this.info=E}}class L1{locLevel;y;x;z;model;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;typecode;info;distance=0;cycle=0;constructor(u,R,m,_,b,E,O,I,L,H,N,G){this.locLevel=u,this.y=R,this.x=m,this.z=_,this.model=b,this.yaw=E,this.minSceneTileX=O,this.maxSceneTileX=I,this.minSceneTileZ=L,this.maxSceneTileZ=H,this.typecode=N,this.info=G}}class H1{y;x;z;topObj;middleObj;bottomObj;typecode;offset;constructor(u,R,m,_,b,E,O,I){this.y=u,this.x=R,this.z=m,this.topObj=_,this.middleObj=b,this.bottomObj=E,this.typecode=O,this.offset=I}}class Z0 extends n0{level;x;z;originalLevel;locs;primaryExtendDirections;quickGround=null;ground=null;wall=null;decor=null;groundDecor=null;groundObject=null;linkedSquare=null;primaryCount=0;combinedPrimaryExtendDirections=0;drawLevel=0;drawFront=!1;drawBack=!1;drawPrimaries=!1;cornerSides=0;sidesBeforeCorner=0;sidesAfterCorner=0;backWallTypes=0;constructor(u,R,m){super();this.originalLevel=this.level=u,this.x=R,this.z=m,this.locs=new p(5,null),this.primaryExtendDirections=new Int32Array(5)}}class i{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=this.FULL_SQUARE*3/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;shapeAngle;backgroundRgb;foregroundRgb;constructor(u,R,m,_,b,E,O,I,L,H,N,G,Q,$,T,U,K,q,w){this.flat=!(K!==_||K!==$||K!==I),this.shape=R,this.shapeAngle=E,this.backgroundRgb=Q,this.foregroundRgb=L;let V=i.SHAPE_POINTS[R],Y=V.length;this.vertexX=new Int32Array(Y),this.vertexY=new Int32Array(Y),this.vertexZ=new Int32Array(Y);let A=new Int32Array(Y),h=new Int32Array(Y),n=u*i.FULL_SQUARE,f=q*i.FULL_SQUARE;for(let M=0;M<Y;M++){let X=V[M];if((X&1)===0&&X<=8)X=(X-E-E-1&7)+1;if(X>8&&X<=12)X=(X-E-9&3)+9;if(X>12&&X<=16)X=(X-E-13&3)+13;let P,r,S,y,a;if(X===1)P=n,r=f,S=K,y=O,a=H;else if(X===2)P=n+i.HALF_SQUARE,r=f,S=K+_>>1,y=O+w>>1,a=H+m>>1;else if(X===3)P=n+i.FULL_SQUARE,r=f,S=_,y=w,a=m;else if(X===4)P=n+i.FULL_SQUARE,r=f+i.HALF_SQUARE,S=_+$>>1,y=w+b>>1,a=m+T>>1;else if(X===5)P=n+i.FULL_SQUARE,r=f+i.FULL_SQUARE,S=$,y=b,a=T;else if(X===6)P=n+i.HALF_SQUARE,r=f+i.FULL_SQUARE,S=$+I>>1,y=b+U>>1,a=T+G>>1;else if(X===7)P=n,r=f+i.FULL_SQUARE,S=I,y=U,a=G;else if(X===8)P=n,r=f+i.HALF_SQUARE,S=I+K>>1,y=U+O>>1,a=G+H>>1;else if(X===9)P=n+i.HALF_SQUARE,r=f+i.CORNER_SMALL,S=K+_>>1,y=O+w>>1,a=H+m>>1;else if(X===10)P=n+i.CORNER_BIG,r=f+i.HALF_SQUARE,S=_+$>>1,y=w+b>>1,a=m+T>>1;else if(X===11)P=n+i.HALF_SQUARE,r=f+i.CORNER_BIG,S=$+I>>1,y=b+U>>1,a=T+G>>1;else if(X===12)P=n+i.CORNER_SMALL,r=f+i.HALF_SQUARE,S=I+K>>1,y=U+O>>1,a=G+H>>1;else if(X===13)P=n+i.CORNER_SMALL,r=f+i.CORNER_SMALL,S=K,y=O,a=H;else if(X===14)P=n+i.CORNER_BIG,r=f+i.CORNER_SMALL,S=_,y=w,a=m;else if(X===15)P=n+i.CORNER_BIG,r=f+i.CORNER_BIG,S=$,y=b,a=T;else P=n+i.CORNER_SMALL,r=f+i.CORNER_BIG,S=I,y=U,a=G;this.vertexX[M]=P,this.vertexY[M]=S,this.vertexZ[M]=r,A[M]=y,h[M]=a}let D=i.SHAPE_PATHS[R],j=D.length/4|0;if(this.triangleVertexA=new Int32Array(j),this.triangleVertexB=new Int32Array(j),this.triangleVertexC=new Int32Array(j),this.triangleColorA=new Int32Array(j),this.triangleColorB=new Int32Array(j),this.triangleColorC=new Int32Array(j),N!==-1)this.triangleTextureIds=new Int32Array(j);else this.triangleTextureIds=null;let W=0;for(let M=0;M<j;M++){let X=D[W],P=D[W+1],r=D[W+2],S=D[W+3];if(W+=4,P<4)P=P-E&3;if(r<4)r=r-E&3;if(S<4)S=S-E&3;if(this.triangleVertexA[M]=P,this.triangleVertexB[M]=r,this.triangleVertexC[M]=S,X===0){if(this.triangleColorA[M]=A[P],this.triangleColorB[M]=A[r],this.triangleColorC[M]=A[S],this.triangleTextureIds)this.triangleTextureIds[M]=-1}else if(this.triangleColorA[M]=h[P],this.triangleColorB[M]=h[r],this.triangleColorC[M]=h[S],this.triangleTextureIds)this.triangleTextureIds[M]=N}}}class d0{southwestColor;southeastColor;northeastColor;northwestColor;textureId;colour;flat;constructor(u,R,m,_,b,E,O){this.southwestColor=u,this.southeastColor=R,this.northeastColor=m,this.northwestColor=_,this.textureId=b,this.colour=E,this.flat=O}}class N1{y;x;z;angle1;angle2;model1;model2;typecode;typecode2;constructor(u,R,m,_,b,E,O,I,L){this.y=u,this.x=R,this.z=m,this.angle1=_,this.angle2=b,this.model1=E,this.model2=O,this.typecode=I,this.typecode2=L}}class G1{y;x;z;angle1;angle2;model;typecode;info;constructor(u,R,m,_,b,E,O,I){this.y=u,this.x=R,this.z=m,this.angle1=_,this.angle2=b,this.model=E,this.typecode=O,this.info=I}}class k{static visibilityMatrix=new R1(8,32,51,51,!1);static locBuffer=new p(100,null);static levelOccluderCount=new Int32Array(4);static levelOccluders=new Y1(4,500,null);static activeOccluders=new p(500,null);static drawTileQueue=new J0;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=!1;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static MIDDEP_16=Int8Array.of(0,0,2,0,0,2,1,1,0);static MIDDEP_32=Int8Array.of(2,0,0,2,0,0,0,4,4);static MIDDEP_64=Int8Array.of(0,4,4,8,0,0,8,0,0);static MIDDEP_128=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=!0;static init(u,R,m,_,b){this.viewportLeft=0,this.viewportTop=0,this.viewportRight=u,this.viewportBottom=R,this.viewportCenterX=u/2|0,this.viewportCenterY=R/2|0;let E=new R1(9,32,53,53,!1);for(let O=128;O<=384;O+=32)for(let I=0;I<2048;I+=64){this.sinEyePitch=Z.sin[O],this.cosEyePitch=Z.cos[O],this.sinEyeYaw=Z.sin[I],this.cosEyeYaw=Z.cos[I];let L=(O-128)/32|0,H=I/64|0;for(let N=-26;N<=26;N++)for(let G=-26;G<=26;G++){let Q=N*128,$=G*128,T=!1;for(let U=-m;U<=_;U+=128)if(this.testPoint(Q,$,b[L]+U)){T=!0;break}E[L][H][N+25+1][G+25+1]=T}}for(let O=0;O<8;O++)for(let I=0;I<32;I++)for(let L=-25;L<25;L++)for(let H=-25;H<25;H++){let N=!1;u:for(let G=-1;G<=1;G++)for(let Q=-1;Q<=1;Q++){if(E[O][I][L+G+25+1][H+Q+25+1]){N=!0;break u}if(E[O][(I+1)%31][L+G+25+1][H+Q+25+1]){N=!0;break u}if(E[O+1][I][L+G+25+1][H+Q+25+1]){N=!0;break u}if(E[O+1][(I+1)%31][L+G+25+1][H+Q+25+1]){N=!0;break u}}this.visibilityMatrix[O][I][L+25][H+25]=N}}static addOccluder(u,R,m,_,b,E,O,I){k.levelOccluders[u][k.levelOccluderCount[u]++]=new O1(m/128|0,E/128|0,b/128|0,I/128|0,R,m,E,b,I,_,O)}static testPoint(u,R,m){let _=R*this.sinEyeYaw+u*this.cosEyeYaw>>16,b=R*this.cosEyeYaw-u*this.sinEyeYaw>>16,E=m*this.sinEyePitch+b*this.cosEyePitch>>16,O=m*this.cosEyePitch-b*this.sinEyePitch>>16;if(E<50||E>3500)return!1;let I=this.viewportCenterX+((_<<9)/E|0),L=this.viewportCenterY+((O<<9)/E|0);return I>=this.viewportLeft&&I<=this.viewportRight&&L>=this.viewportTop&&L<=this.viewportBottom}maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;temporaryLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;temporaryLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(u,R,m,_){this.maxLevel=m,this.maxTileX=_,this.maxTileZ=R,this.levelTiles=new x0(m,_,R,null),this.levelTileOcclusionCycles=new g0(m,_+1,R+1),this.levelHeightmaps=u,this.temporaryLocs=new p(5000,null),this.mergeIndexA=new Int32Array(1e4),this.mergeIndexB=new Int32Array(1e4),this.reset()}reset(){for(let u=0;u<this.maxLevel;u++)for(let R=0;R<this.maxTileX;R++)for(let m=0;m<this.maxTileZ;m++)this.levelTiles[u][R][m]=null;for(let u=0;u<4;u++){for(let R=0;R<k.levelOccluderCount[u];R++)k.levelOccluders[u][R]=null;k.levelOccluderCount[u]=0}for(let u=0;u<this.temporaryLocCount;u++)this.temporaryLocs[u]=null;this.temporaryLocCount=0,k.locBuffer.fill(null)}setMinLevel(u){this.minLevel=u;for(let R=0;R<this.maxTileX;R++)for(let m=0;m<this.maxTileZ;m++)this.levelTiles[u][R][m]=new Z0(u,R,m)}setBridge(u,R){let m=this.levelTiles[0][u][R];for(let b=0;b<3;b++){this.levelTiles[b][u][R]=this.levelTiles[b+1][u][R];let E=this.levelTiles[b][u][R];if(E)E.level--}if(!this.levelTiles[0][u][R])this.levelTiles[0][u][R]=new Z0(0,u,R);let _=this.levelTiles[0][u][R];if(_)_.linkedSquare=m;this.levelTiles[3][u][R]=null}setDrawLevel(u,R,m,_){let b=this.levelTiles[u][R][m];if(!b)return;b.drawLevel=_}setTile(u,R,m,_,b,E,O,I,L,H,N,G,Q,$,T,U,K,q,w,V){if(_===0){for(let A=u;A>=0;A--)if(!this.levelTiles[A][R][m])this.levelTiles[A][R][m]=new Z0(A,R,m);let Y=this.levelTiles[u][R][m];if(Y)Y.quickGround=new d0(N,G,Q,$,-1,w,!1)}else if(_===1){for(let A=u;A>=0;A--)if(!this.levelTiles[A][R][m])this.levelTiles[A][R][m]=new Z0(A,R,m);let Y=this.levelTiles[u][R][m];if(Y)Y.quickGround=new d0(T,U,K,q,E,V,O===I&&O===L&&O===H)}else{for(let A=u;A>=0;A--)if(!this.levelTiles[A][R][m])this.levelTiles[A][R][m]=new Z0(A,R,m);let Y=this.levelTiles[u][R][m];if(Y)Y.ground=new i(R,_,U,I,Q,b,N,H,V,T,E,q,w,L,K,$,O,m,G)}}addGroundDecoration(u,R,m,_,b,E,O){if(!this.levelTiles[R][m][_])this.levelTiles[R][m][_]=new Z0(R,m,_);let I=this.levelTiles[R][m][_];if(I)I.groundDecor=new I1(b,m*128+64,_*128+64,u,E,O)}removeGroundDecoration(u,R,m){let _=this.levelTiles[u][R][m];if(!_)return;_.groundDecor=null}addGroundObject(u,R,m,_,b,E,O,I){let L=0,H=this.levelTiles[_][u][R];if(H)for(let G=0;G<H.primaryCount;G++){let Q=H.locs[G];if(!Q||!Q.model||!(Q.model instanceof J))continue;let $=Q.model.objRaise;if($>L)L=$}else this.levelTiles[_][u][R]=new Z0(_,u,R);let N=this.levelTiles[_][u][R];if(N)N.groundObject=new H1(m,u*128+64,R*128+64,E,O,I,b,L)}removeGroundObject(u,R,m){let _=this.levelTiles[u][R][m];if(!_)return;_.groundObject=null}addWall(u,R,m,_,b,E,O,I,L,H){if(!O&&!I)return;for(let G=u;G>=0;G--)if(!this.levelTiles[G][R][m])this.levelTiles[G][R][m]=new Z0(G,R,m);let N=this.levelTiles[u][R][m];if(N)N.wall=new N1(_,R*128+64,m*128+64,b,E,O,I,L,H)}removeWall(u,R,m,_){let b=this.levelTiles[u][R][m];if(_===1&&b)b.wall=null}setWallDecoration(u,R,m,_,b,E,O,I,L,H,N){if(!I)return;for(let Q=u;Q>=0;Q--)if(!this.levelTiles[Q][R][m])this.levelTiles[Q][R][m]=new Z0(Q,R,m);let G=this.levelTiles[u][R][m];if(G)G.decor=new G1(_,R*128+b+64,m*128+E+64,N,H,I,O,L)}removeWallDecoration(u,R,m){let _=this.levelTiles[u][R][m];if(!_)return;_.decor=null}setWallDecorationOffset(u,R,m,_){let b=this.levelTiles[u][R][m];if(!b)return;let E=b.decor;if(!E)return;let O=R*128+64,I=m*128+64;E.x=O+((E.x-O)*_/16|0),E.z=I+((E.z-I)*_/16|0)}setWallDecorationModel(u,R,m,_){if(!_)return;let b=this.levelTiles[u][R][m];if(!b)return;let E=b.decor;if(!E)return;E.model=_}setGroundDecorationModel(u,R,m,_){if(!_)return;let b=this.levelTiles[u][R][m];if(!b)return;let E=b.groundDecor;if(!E)return;E.model=_}setWallModel(u,R,m,_){if(!_)return;let b=this.levelTiles[u][R][m];if(!b)return;let E=b.wall;if(!E)return;E.model1=_}setWallModels(u,R,m,_,b){if(!_)return;let E=this.levelTiles[m][u][R];if(!E)return;let O=E.wall;if(!O)return;O.model1=_,O.model2=b}addLoc(u,R,m,_,b,E,O,I,L,H){if(!b)return!0;let N=R*128+I*64,G=m*128+L*64;return this.addModel(N,G,_,u,R,m,I,L,b,E,O,H,!1)}addTemporary(u,R,m,_,b,E,O,I,L){if(!b)return!0;let H=R-I,N=_-I,G=R+I,Q=_+I;if(L){if(O>640&&O<1408)Q+=128;if(O>1152&&O<1920)G+=128;if(O>1664||O<384)N-=128;if(O>128&&O<896)H-=128}return H=H/128|0,N=N/128|0,G=G/128|0,Q=Q/128|0,this.addModel(R,_,m,u,H,N,G+1-H,Q-N+1,b,E,0,O,!0)}addTemporary2(u,R,m,_,b,E,O,I,L,H,N){return!L||this.addModel(R,_,m,u,b,E,O+1-b,I-E+1,L,H,0,N,!0)}removeLoc(u,R,m){let _=this.levelTiles[u][R][m];if(!_)return;for(let b=0;b<_.primaryCount;b++){let E=_.locs[b];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===R&&E.minSceneTileZ===m){this.removeLoc2(E);return}}}clearLocChanges(){for(let u=0;u<this.temporaryLocCount;u++){let R=this.temporaryLocs[u];if(R)this.removeLoc2(R);this.temporaryLocs[u]=null}this.temporaryLocCount=0}getWallTypecode(u,R,m){let _=this.levelTiles[u][R][m];return!_||!_.wall?0:_.wall.typecode}getDecorTypecode(u,R,m){let _=this.levelTiles[u][m][R];return!_||!_.decor?0:_.decor.typecode}getLocTypecode(u,R,m){let _=this.levelTiles[u][R][m];if(!_)return 0;for(let b=0;b<_.primaryCount;b++){let E=_.locs[b];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===R&&E.minSceneTileZ===m)return E.typecode}return 0}getGroundDecorTypecode(u,R,m){let _=this.levelTiles[u][R][m];return!_||!_.groundDecor?0:_.groundDecor.typecode}getWall(u,R,m){let _=this.levelTiles[u][R][m];return!_||!_.wall?null:_.wall}getDecor(u,R,m){let _=this.levelTiles[u][m][R];return!_||!_.decor?null:_.decor}getLoc(u,R,m){let _=this.levelTiles[u][R][m];if(!_)return null;for(let b=0;b<_.primaryCount;b++){let E=_.locs[b];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===R&&E.minSceneTileZ===m)return E}return null}getGroundDecor(u,R,m){let _=this.levelTiles[u][R][m];return!_||!_.groundDecor?null:_.groundDecor}getInfo(u,R,m,_){let b=this.levelTiles[u][R][m];if(!b)return-1;else if(b.wall&&b.wall.typecode===_)return b.wall.typecode2&255;else if(b.decor&&b.decor.typecode===_)return b.decor.info&255;else if(b.groundDecor&&b.groundDecor.typecode===_)return b.groundDecor.info&255;else{for(let E=0;E<b.primaryCount;E++){let O=b.locs[E];if(O&&O.typecode===_)return O.info&255}return-1}}buildModels(u,R,m,_,b){let E=Math.sqrt(m*m+_*_+b*b)|0,O=R*E>>8;for(let I=0;I<this.maxLevel;I++)for(let L=0;L<this.maxTileX;L++)for(let H=0;H<this.maxTileZ;H++){let N=this.levelTiles[I][L][H];if(!N)continue;let G=N.wall;if(G&&G.model1&&G.model1.vertexNormal){if(this.mergeLocNormals(I,L,H,1,1,G.model1),G.model2&&G.model2.vertexNormal)this.mergeLocNormals(I,L,H,1,1,G.model2),this.mergeNormals(G.model1,G.model2,0,0,0,!1),G.model2.applyLighting(u,O,m,_,b);G.model1.applyLighting(u,O,m,_,b)}for(let $=0;$<N.primaryCount;$++){let T=N.locs[$];if(T&&T.model&&T.model.vertexNormal)this.mergeLocNormals(I,L,H,T.maxSceneTileX+1-T.minSceneTileX,T.maxSceneTileZ-T.minSceneTileZ+1,T.model),T.model.applyLighting(u,O,m,_,b)}let Q=N.groundDecor;if(Q&&Q.model&&Q.model.vertexNormal)this.mergeGroundDecorationNormals(I,L,H,Q.model),Q.model.applyLighting(u,O,m,_,b)}}mergeGroundDecorationNormals(u,R,m,_){if(R<this.maxTileX){let b=this.levelTiles[u][R+1][m];if(b&&b.groundDecor&&b.groundDecor.model&&b.groundDecor.model.vertexNormal)this.mergeNormals(_,b.groundDecor.model,128,0,0,!0)}if(m<this.maxTileX){let b=this.levelTiles[u][R][m+1];if(b&&b.groundDecor&&b.groundDecor.model&&b.groundDecor.model.vertexNormal)this.mergeNormals(_,b.groundDecor.model,0,0,128,!0)}if(R<this.maxTileX&&m<this.maxTileZ){let b=this.levelTiles[u][R+1][m+1];if(b&&b.groundDecor&&b.groundDecor.model&&b.groundDecor.model.vertexNormal)this.mergeNormals(_,b.groundDecor.model,128,0,128,!0)}if(R<this.maxTileX&&m>0){let b=this.levelTiles[u][R+1][m-1];if(b&&b.groundDecor&&b.groundDecor.model&&b.groundDecor.model.vertexNormal)this.mergeNormals(_,b.groundDecor.model,128,0,-128,!0)}}mergeLocNormals(u,R,m,_,b,E){let O=!0,I=R,L=R+_,H=m-1,N=m+b;for(let G=u;G<=u+1;G++){if(G===this.maxLevel)continue;for(let Q=I;Q<=L;Q++){if(Q<0||Q>=this.maxTileX)continue;for(let $=H;$<=N;$++){if($<0||$>=this.maxTileZ||O&&Q<L&&$<N&&($>=m||Q===R))continue;let T=this.levelTiles[G][Q][$];if(!T)continue;let U=(Q-R)*128+(1-_)*64,K=($-m)*128+(1-b)*64,q=((this.levelHeightmaps[G][Q][$]+this.levelHeightmaps[G][Q+1][$]+this.levelHeightmaps[G][Q][$+1]+this.levelHeightmaps[G][Q+1][$+1])/4|0)-((this.levelHeightmaps[u][R][m]+this.levelHeightmaps[u][R+1][m]+this.levelHeightmaps[u][R][m+1]+this.levelHeightmaps[u][R+1][m+1])/4|0),w=T.wall;if(w&&w.model1&&w.model1.vertexNormal)this.mergeNormals(E,w.model1,U,q,K,O);if(w&&w.model2&&w.model2.vertexNormal)this.mergeNormals(E,w.model2,U,q,K,O);for(let V=0;V<T.primaryCount;V++){let Y=T.locs[V];if(!Y||!Y.model||!Y.model.vertexNormal)continue;let A=Y.maxSceneTileX+1-Y.minSceneTileX,h=Y.maxSceneTileZ+1-Y.minSceneTileZ;this.mergeNormals(E,Y.model,(Y.minSceneTileX-R)*128+(A-_)*64,q,(Y.minSceneTileZ-m)*128+(h-b)*64,O)}}}I--,O=!1}}mergeNormals(u,R,m,_,b,E){this.tmpMergeIndex++;let O=0,I=R.vertexX,L=R.vertexCount;if(u.vertexNormal&&u.vertexNormalOriginal)for(let H=0;H<u.vertexCount;H++){let N=u.vertexNormal[H],G=u.vertexNormalOriginal[H];if(G&&G.w!==0){let Q=u.vertexY[H]-_;if(Q>R.maxY)continue;let $=u.vertexX[H]-m;if($<R.minX||$>R.maxX)continue;let T=u.vertexZ[H]-b;if(T<R.minZ||T>R.maxZ)continue;if(R.vertexNormal&&R.vertexNormalOriginal)for(let U=0;U<L;U++){let K=R.vertexNormal[U],q=R.vertexNormalOriginal[U];if($!==I[U]||T!==R.vertexZ[U]||Q!==R.vertexY[U]||q&&q.w===0)continue;if(N&&K&&q)N.x+=q.x,N.y+=q.y,N.z+=q.z,N.w+=q.w,K.x+=G.x,K.y+=G.y,K.z+=G.z,K.w+=G.w,O++;this.mergeIndexA[H]=this.tmpMergeIndex,this.mergeIndexB[U]=this.tmpMergeIndex}}}if(O<3||!E)return;if(u.faceInfo){for(let H=0;H<u.faceCount;H++)if(this.mergeIndexA[u.faceVertexA[H]]===this.tmpMergeIndex&&this.mergeIndexA[u.faceVertexB[H]]===this.tmpMergeIndex&&this.mergeIndexA[u.faceVertexC[H]]===this.tmpMergeIndex)u.faceInfo[H]=-1}if(R.faceInfo){for(let H=0;H<R.faceCount;H++)if(this.mergeIndexB[R.faceVertexA[H]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexB[H]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexC[H]]===this.tmpMergeIndex)R.faceInfo[H]=-1}}drawMinimapTile(u,R,m,_,b,E){let O=this.levelTiles[u][R][m];if(!O)return;let I=O.quickGround;if(I){let K=I.colour;if(K!==0)for(let q=0;q<4;q++)_[b]=K,_[b+1]=K,_[b+2]=K,_[b+3]=K,b+=E;return}let L=O.ground;if(!L)return;let{shape:H,shapeAngle:N,backgroundRgb:G,foregroundRgb:Q}=L,$=k.MINIMAP_TILE_MASK[H],T=k.MINIMAP_TILE_ROTATION_MAP[N],U=0;if(G!==0){for(let K=0;K<4;K++)_[b]=$[T[U++]]===0?G:Q,_[b+1]=$[T[U++]]===0?G:Q,_[b+2]=$[T[U++]]===0?G:Q,_[b+3]=$[T[U++]]===0?G:Q,b+=E;return}for(let K=0;K<4;K++){if($[T[U++]]!==0)_[b]=Q;if($[T[U++]]!==0)_[b+1]=Q;if($[T[U++]]!==0)_[b+2]=Q;if($[T[U++]]!==0)_[b+3]=Q;b+=E}}click(u,R){k.takingInput=!0,k.mouseX=u,k.mouseY=R,k.clickTileX=-1,k.clickTileZ=-1}draw(u,R,m,_,b,E,O){if(u<0)u=0;else if(u>=this.maxTileX*128)u=this.maxTileX*128-1;if(m<0)m=0;else if(m>=this.maxTileZ*128)m=this.maxTileZ*128-1;if(k.cycle++,k.sinEyePitch=Z.sin[E],k.cosEyePitch=Z.cos[E],k.sinEyeYaw=Z.sin[b],k.cosEyeYaw=Z.cos[b],k.visibilityMap=k.visibilityMatrix[(E-128)/32|0][b/64|0],k.eyeX=u,k.eyeY=R,k.eyeZ=m,k.eyeTileX=u/128|0,k.eyeTileZ=m/128|0,k.topLevel=_,k.minDrawTileX=k.eyeTileX-25,k.minDrawTileX<0)k.minDrawTileX=0;if(k.minDrawTileZ=k.eyeTileZ-25,k.minDrawTileZ<0)k.minDrawTileZ=0;if(k.maxDrawTileX=k.eyeTileX+25,k.maxDrawTileX>this.maxTileX)k.maxDrawTileX=this.maxTileX;if(k.maxDrawTileZ=k.eyeTileZ+25,k.maxDrawTileZ>this.maxTileZ)k.maxDrawTileZ=this.maxTileZ;this.updateActiveOccluders(),k.tilesRemaining=0;for(let I=this.minLevel;I<this.maxLevel;I++){let L=this.levelTiles[I];for(let H=k.minDrawTileX;H<k.maxDrawTileX;H++)for(let N=k.minDrawTileZ;N<k.maxDrawTileZ;N++){let G=L[H][N];if(!G)continue;if(G.drawLevel<=_&&(k.visibilityMap[H+25-k.eyeTileX][N+25-k.eyeTileZ]||this.levelHeightmaps[I][H][N]-R>=2000))G.drawFront=!0,G.drawBack=!0,G.drawPrimaries=G.primaryCount>0,k.tilesRemaining++;else G.drawFront=!1,G.drawBack=!1,G.cornerSides=0}}for(let I=this.minLevel;I<this.maxLevel;I++){let L=this.levelTiles[I];for(let H=-25;H<=0;H++){let N=k.eyeTileX+H,G=k.eyeTileX-H;if(N<k.minDrawTileX&&G>=k.maxDrawTileX)continue;for(let Q=-25;Q<=0;Q++){let $=k.eyeTileZ+Q,T=k.eyeTileZ-Q,U;if(N>=k.minDrawTileX){if($>=k.minDrawTileZ){if(U=L[N][$],U&&U.drawFront)this.drawTile(U,!0,O)}if(T<k.maxDrawTileZ){if(U=L[N][T],U&&U.drawFront)this.drawTile(U,!0,O)}}if(G<k.maxDrawTileX){if($>=k.minDrawTileZ){if(U=L[G][$],U&&U.drawFront)this.drawTile(U,!0,O)}if(T<k.maxDrawTileZ){if(U=L[G][T],U&&U.drawFront)this.drawTile(U,!0,O)}}if(k.tilesRemaining===0){k.takingInput=!1;return}}}}for(let I=this.minLevel;I<this.maxLevel;I++){let L=this.levelTiles[I];for(let H=-25;H<=0;H++){let N=k.eyeTileX+H,G=k.eyeTileX-H;if(N<k.minDrawTileX&&G>=k.maxDrawTileX)continue;for(let Q=-25;Q<=0;Q++){let $=k.eyeTileZ+Q,T=k.eyeTileZ-Q,U;if(N>=k.minDrawTileX){if($>=k.minDrawTileZ){if(U=L[N][$],U&&U.drawFront)this.drawTile(U,!1,O)}if(T<k.maxDrawTileZ){if(U=L[N][T],U&&U.drawFront)this.drawTile(U,!1,O)}}if(G<k.maxDrawTileX){if($>=k.minDrawTileZ){if(U=L[G][$],U&&U.drawFront)this.drawTile(U,!1,O)}if(T<k.maxDrawTileZ){if(U=L[G][T],U&&U.drawFront)this.drawTile(U,!1,O)}}if(k.tilesRemaining===0){k.takingInput=!1;return}}}}}addModel(u,R,m,_,b,E,O,I,L,H,N,G,Q){if(!L)return!1;for(let T=b;T<b+O;T++)for(let U=E;U<E+I;U++){if(T<0||U<0||T>=this.maxTileX||U>=this.maxTileZ)return!1;let K=this.levelTiles[_][T][U];if(K&&K.primaryCount>=5)return!1}let $=new L1(_,m,u,R,L,G,b,b+O-1,E,E+I-1,H,N);for(let T=b;T<b+O;T++)for(let U=E;U<E+I;U++){let K=0;if(T>b)K|=1;if(T<b+O-1)K+=4;if(U>E)K+=8;if(U<E+I-1)K+=2;for(let w=_;w>=0;w--)if(!this.levelTiles[w][T][U])this.levelTiles[w][T][U]=new Z0(w,T,U);let q=this.levelTiles[_][T][U];if(q)q.locs[q.primaryCount]=$,q.primaryExtendDirections[q.primaryCount]=K,q.combinedPrimaryExtendDirections|=K,q.primaryCount++}if(Q)this.temporaryLocs[this.temporaryLocCount++]=$;return!0}removeLoc2(u){for(let R=u.minSceneTileX;R<=u.maxSceneTileX;R++)for(let m=u.minSceneTileZ;m<=u.maxSceneTileZ;m++){let _=this.levelTiles[u.locLevel][R][m];if(!_)continue;for(let b=0;b<_.primaryCount;b++)if(_.locs[b]===u){_.primaryCount--;for(let E=b;E<_.primaryCount;E++)_.locs[E]=_.locs[E+1],_.primaryExtendDirections[E]=_.primaryExtendDirections[E+1];_.locs[_.primaryCount]=null;break}_.combinedPrimaryExtendDirections=0;for(let b=0;b<_.primaryCount;b++)_.combinedPrimaryExtendDirections|=_.primaryExtendDirections[b]}}updateActiveOccluders(){let u=k.levelOccluderCount[k.topLevel],R=k.levelOccluders[k.topLevel];k.activeOccluderCount=0;for(let m=0;m<u;m++){let _=R[m];if(!_)continue;let b,E,O,I;if(_.type===1){if(b=_.minTileX+25-k.eyeTileX,b>=0&&b<=50){if(E=_.minTileZ+25-k.eyeTileZ,E<0)E=0;if(O=_.maxTileZ+25-k.eyeTileZ,O>50)O=50;let L=!1;while(E<=O)if(k.visibilityMap&&k.visibilityMap[b][E++]){L=!0;break}if(L){if(I=k.eyeX-_.minX,I>32)_.mode=1;else{if(I>=-32)continue;_.mode=2,I=-I}_.minDeltaZ=(_.minZ-k.eyeZ<<8)/I|0,_.maxDeltaZ=(_.maxZ-k.eyeZ<<8)/I|0,_.minDeltaY=(_.minY-k.eyeY<<8)/I|0,_.maxDeltaY=(_.maxY-k.eyeY<<8)/I|0,k.activeOccluders[k.activeOccluderCount++]=_}}}else if(_.type===2){if(b=_.minTileZ+25-k.eyeTileZ,b>=0&&b<=50){if(E=_.minTileX+25-k.eyeTileX,E<0)E=0;if(O=_.maxTileX+25-k.eyeTileX,O>50)O=50;let L=!1;while(E<=O)if(k.visibilityMap&&k.visibilityMap[E++][b]){L=!0;break}if(L){if(I=k.eyeZ-_.minZ,I>32)_.mode=3;else{if(I>=-32)continue;_.mode=4,I=-I}_.minDeltaX=(_.minX-k.eyeX<<8)/I|0,_.maxDeltaX=(_.maxX-k.eyeX<<8)/I|0,_.minDeltaY=(_.minY-k.eyeY<<8)/I|0,_.maxDeltaY=(_.maxY-k.eyeY<<8)/I|0,k.activeOccluders[k.activeOccluderCount++]=_}}}else if(_.type===4){if(b=_.minY-k.eyeY,b>128){if(E=_.minTileZ+25-k.eyeTileZ,E<0)E=0;if(O=_.maxTileZ+25-k.eyeTileZ,O>50)O=50;if(E<=O){let L=_.minTileX+25-k.eyeTileX;if(L<0)L=0;if(I=_.maxTileX+25-k.eyeTileX,I>50)I=50;let H=!1;u:for(let N=L;N<=I;N++)for(let G=E;G<=O;G++)if(k.visibilityMap&&k.visibilityMap[N][G]){H=!0;break u}if(H)_.mode=5,_.minDeltaX=(_.minX-k.eyeX<<8)/b|0,_.maxDeltaX=(_.maxX-k.eyeX<<8)/b|0,_.minDeltaZ=(_.minZ-k.eyeZ<<8)/b|0,_.maxDeltaZ=(_.maxZ-k.eyeZ<<8)/b|0,k.activeOccluders[k.activeOccluderCount++]=_}}}}}drawTile(u,R,m){k.drawTileQueue.push(u);while(!0){let _;do if(_=k.drawTileQueue.pop(),!_)return;while(!_.drawBack);let{x:b,z:E,level:O,originalLevel:I}=_,L=this.levelTiles[O];if(_.drawFront){if(R){if(O>0){let K=this.levelTiles[O-1][b][E];if(K&&K.drawBack)continue}if(b<=k.eyeTileX&&b>k.minDrawTileX){let K=L[b-1][E];if(K&&K.drawBack&&(K.drawFront||(_.combinedPrimaryExtendDirections&1)===0))continue}if(b>=k.eyeTileX&&b<k.maxDrawTileX-1){let K=L[b+1][E];if(K&&K.drawBack&&(K.drawFront||(_.combinedPrimaryExtendDirections&4)===0))continue}if(E<=k.eyeTileZ&&E>k.minDrawTileZ){let K=L[b][E-1];if(K&&K.drawBack&&(K.drawFront||(_.combinedPrimaryExtendDirections&8)===0))continue}if(E>=k.eyeTileZ&&E<k.maxDrawTileZ-1){let K=L[b][E+1];if(K&&K.drawBack&&(K.drawFront||(_.combinedPrimaryExtendDirections&2)===0))continue}}else R=!0;if(_.drawFront=!1,_.linkedSquare){let K=_.linkedSquare;if(!K.quickGround){if(K.ground&&!this.tileVisible(0,b,E))this.drawTileOverlay(b,E,K.ground,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw)}else if(!this.tileVisible(0,b,E))this.drawTileUnderlay(K.quickGround,0,b,E,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw);let q=K.wall;if(q)q.model1?.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,q.x-k.eyeX,q.y-k.eyeY,q.z-k.eyeZ,q.typecode);for(let w=0;w<K.primaryCount;w++){let V=K.locs[w];if(V)V.model?.draw(m,V.yaw,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,V.x-k.eyeX,V.y-k.eyeY,V.z-k.eyeZ,V.typecode)}}let N=!1;if(!_.quickGround){if(_.ground&&!this.tileVisible(I,b,E))N=!0,this.drawTileOverlay(b,E,_.ground,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw)}else if(!this.tileVisible(I,b,E))N=!0,this.drawTileUnderlay(_.quickGround,I,b,E,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw);let G=0,Q=0,$=_.wall,T=_.decor;if($||T){if(k.eyeTileX===b)G+=1;else if(k.eyeTileX<b)G+=2;if(k.eyeTileZ===E)G+=3;else if(k.eyeTileZ>E)G+=6;Q=k.FRONT_WALL_TYPES[G],_.backWallTypes=k.BACK_WALL_TYPES[G]}if($){if(($.angle1&k.DIRECTION_ALLOW_WALL_CORNER_TYPE[G])===0)_.cornerSides=0;else if($.angle1===16)_.cornerSides=3,_.sidesBeforeCorner=k.MIDDEP_16[G],_.sidesAfterCorner=3-_.sidesBeforeCorner;else if($.angle1===32)_.cornerSides=6,_.sidesBeforeCorner=k.MIDDEP_32[G],_.sidesAfterCorner=6-_.sidesBeforeCorner;else if($.angle1===64)_.cornerSides=12,_.sidesBeforeCorner=k.MIDDEP_64[G],_.sidesAfterCorner=12-_.sidesBeforeCorner;else _.cornerSides=9,_.sidesBeforeCorner=k.MIDDEP_128[G],_.sidesAfterCorner=9-_.sidesBeforeCorner;if(($.angle1&Q)!==0&&!this.isTileSideOccluded(I,b,E,$.angle1))$.model1?.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,$.x-k.eyeX,$.y-k.eyeY,$.z-k.eyeZ,$.typecode);if(($.angle2&Q)!==0&&!this.isTileSideOccluded(I,b,E,$.angle2))$.model2?.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,$.x-k.eyeX,$.y-k.eyeY,$.z-k.eyeZ,$.typecode)}if(T&&!this.isTileColumnOccluded(I,b,E,T.model.minY)){if((T.angle1&Q)!==0)T.model.draw(m,T.angle2,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,T.x-k.eyeX,T.y-k.eyeY,T.z-k.eyeZ,T.typecode);else if((T.angle1&768)!==0){let K=T.x-k.eyeX,q=T.y-k.eyeY,w=T.z-k.eyeZ,V=T.angle2,Y;if(V===1||V===2)Y=-K;else Y=K;let A;if(V===2||V===3)A=-w;else A=w;if((T.angle1&256)!==0&&A<Y){let h=K+k.WALL_DECORATION_INSET_X[V],n=w+k.WALL_DECORATION_INSET_Z[V];T.model.draw(m,V*512+256,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,h,q,n,T.typecode)}if((T.angle1&512)!==0&&A>Y){let h=K+k.WALL_DECORATION_OUTSET_X[V],n=w+k.WALL_DECORATION_OUTSET_Z[V];T.model.draw(m,V*512+1280&2047,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,h,q,n,T.typecode)}}}if(N){let K=_.groundDecor;if(K)K.model?.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,K.x-k.eyeX,K.y-k.eyeY,K.z-k.eyeZ,K.typecode);let q=_.groundObject;if(q&&q.offset===0){if(q.bottomObj)q.bottomObj.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,q.x-k.eyeX,q.y-k.eyeY,q.z-k.eyeZ,q.typecode);if(q.middleObj)q.middleObj.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,q.x-k.eyeX,q.y-k.eyeY,q.z-k.eyeZ,q.typecode);if(q.topObj)q.topObj.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,q.x-k.eyeX,q.y-k.eyeY,q.z-k.eyeZ,q.typecode)}}let U=_.combinedPrimaryExtendDirections;if(U!==0){if(b<k.eyeTileX&&(U&4)!==0){let K=L[b+1][E];if(K&&K.drawBack)k.drawTileQueue.push(K)}if(E<k.eyeTileZ&&(U&2)!==0){let K=L[b][E+1];if(K&&K.drawBack)k.drawTileQueue.push(K)}if(b>k.eyeTileX&&(U&1)!==0){let K=L[b-1][E];if(K&&K.drawBack)k.drawTileQueue.push(K)}if(E>k.eyeTileZ&&(U&8)!==0){let K=L[b][E-1];if(K&&K.drawBack)k.drawTileQueue.push(K)}}}if(_.cornerSides!==0){let N=!0;for(let G=0;G<_.primaryCount;G++){let Q=_.locs[G];if(!Q)continue;if(Q.cycle!==k.cycle&&(_.primaryExtendDirections[G]&_.cornerSides)===_.sidesBeforeCorner){N=!1;break}}if(N){let G=_.wall;if(G&&!this.isTileSideOccluded(I,b,E,G.angle1))G.model1?.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,G.x-k.eyeX,G.y-k.eyeY,G.z-k.eyeZ,G.typecode);_.cornerSides=0}}if(_.drawPrimaries){let N=_.primaryCount;_.drawPrimaries=!1;let G=0;u:for(let Q=0;Q<N;Q++){let $=_.locs[Q];if(!$||$.cycle===k.cycle)continue;for(let w=$.minSceneTileX;w<=$.maxSceneTileX;w++)for(let V=$.minSceneTileZ;V<=$.maxSceneTileZ;V++){let Y=L[w][V];if(!Y)continue;if(Y.drawFront){_.drawPrimaries=!0;continue u}if(Y.cornerSides===0)continue;let A=0;if(w>$.minSceneTileX)A+=1;if(w<$.maxSceneTileX)A+=4;if(V>$.minSceneTileZ)A+=8;if(V<$.maxSceneTileZ)A+=2;if((A&Y.cornerSides)!==_.sidesAfterCorner)continue}k.locBuffer[G++]=$;let T=k.eyeTileX-$.minSceneTileX,U=$.maxSceneTileX-k.eyeTileX;if(U>T)T=U;let K=k.eyeTileZ-$.minSceneTileZ,q=$.maxSceneTileZ-k.eyeTileZ;if(q>K)$.distance=T+q;else $.distance=T+K}while(G>0){let Q=-50,$=-1;for(let U=0;U<G;U++){let K=k.locBuffer[U];if(!K)continue;if(K.distance>Q&&K.cycle!==k.cycle)Q=K.distance,$=U}if($===-1)break;let T=k.locBuffer[$];if(T){if(T.cycle=k.cycle,!this.locVisible(I,T.minSceneTileX,T.maxSceneTileX,T.minSceneTileZ,T.maxSceneTileZ,T.model?.minY??0))T.model?.draw(m,T.yaw,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,T.x-k.eyeX,T.y-k.eyeY,T.z-k.eyeZ,T.typecode);for(let U=T.minSceneTileX;U<=T.maxSceneTileX;U++)for(let K=T.minSceneTileZ;K<=T.maxSceneTileZ;K++){let q=L[U][K];if(!q)continue;if(q.cornerSides!==0)k.drawTileQueue.push(q);else if((U!==b||K!==E)&&q.drawBack)k.drawTileQueue.push(q)}}}if(_.drawPrimaries)continue}if(!_.drawBack||_.cornerSides!==0)continue;if(b<=k.eyeTileX&&b>k.minDrawTileX){let N=L[b-1][E];if(N&&N.drawBack)continue}if(b>=k.eyeTileX&&b<k.maxDrawTileX-1){let N=L[b+1][E];if(N&&N.drawBack)continue}if(E<=k.eyeTileZ&&E>k.minDrawTileZ){let N=L[b][E-1];if(N&&N.drawBack)continue}if(E>=k.eyeTileZ&&E<k.maxDrawTileZ-1){let N=L[b][E+1];if(N&&N.drawBack)continue}_.drawBack=!1,k.tilesRemaining--;let H=_.groundObject;if(H&&H.offset!==0){if(H.bottomObj)H.bottomObj.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,H.x-k.eyeX,H.y-k.eyeY-H.offset,H.z-k.eyeZ,H.typecode);if(H.middleObj)H.middleObj.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,H.x-k.eyeX,H.y-k.eyeY-H.offset,H.z-k.eyeZ,H.typecode);if(H.topObj)H.topObj.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,H.x-k.eyeX,H.y-k.eyeY-H.offset,H.z-k.eyeZ,H.typecode)}if(_.backWallTypes!==0){let N=_.decor;if(N&&!this.isTileColumnOccluded(I,b,E,N.model.minY)){if((N.angle1&_.backWallTypes)!==0)N.model.draw(m,N.angle2,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,N.x-k.eyeX,N.y-k.eyeY,N.z-k.eyeZ,N.typecode);else if((N.angle1&768)!==0){let Q=N.x-k.eyeX,$=N.y-k.eyeY,T=N.z-k.eyeZ,U=N.angle2,K;if(U===1||U===2)K=-Q;else K=Q;let q;if(U===2||U===3)q=-T;else q=T;if((N.angle1&256)!==0&&q>=K){let w=Q+k.WALL_DECORATION_INSET_X[U],V=T+k.WALL_DECORATION_INSET_Z[U];N.model.draw(m,U*512+256,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,w,$,V,N.typecode)}if((N.angle1&512)!==0&&q<=K){let w=Q+k.WALL_DECORATION_OUTSET_X[U],V=T+k.WALL_DECORATION_OUTSET_Z[U];N.model.draw(m,U*512+1280&2047,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,w,$,V,N.typecode)}}}let G=_.wall;if(G){if((G.angle2&_.backWallTypes)!==0&&!this.isTileSideOccluded(I,b,E,G.angle2))G.model2?.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,G.x-k.eyeX,G.y-k.eyeY,G.z-k.eyeZ,G.typecode);if((G.angle1&_.backWallTypes)!==0&&!this.isTileSideOccluded(I,b,E,G.angle1))G.model1?.draw(m,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,G.x-k.eyeX,G.y-k.eyeY,G.z-k.eyeZ,G.typecode)}}if(O<this.maxLevel-1){let N=this.levelTiles[O+1][b][E];if(N&&N.drawBack)k.drawTileQueue.push(N)}if(b<k.eyeTileX){let N=L[b+1][E];if(N&&N.drawBack)k.drawTileQueue.push(N)}if(E<k.eyeTileZ){let N=L[b][E+1];if(N&&N.drawBack)k.drawTileQueue.push(N)}if(b>k.eyeTileX){let N=L[b-1][E];if(N&&N.drawBack)k.drawTileQueue.push(N)}if(E>k.eyeTileZ){let N=L[b][E-1];if(N&&N.drawBack)k.drawTileQueue.push(N)}}}drawTileUnderlay(u,R,m,_,b,E,O,I){let L,H=L=(m<<7)-k.eyeX,N,G=N=(_<<7)-k.eyeZ,Q,$=Q=H+128,T,U=T=G+128,K=this.levelHeightmaps[R][m][_]-k.eyeY,q=this.levelHeightmaps[R][m+1][_]-k.eyeY,w=this.levelHeightmaps[R][m+1][_+1]-k.eyeY,V=this.levelHeightmaps[R][m][_+1]-k.eyeY,Y=G*O+H*I>>16;if(G=G*I-H*O>>16,H=Y,Y=K*E-G*b>>16,G=K*b+G*E>>16,K=Y,G<50)return;if(Y=N*O+$*I>>16,N=N*I-$*O>>16,$=Y,Y=q*E-N*b>>16,N=q*b+N*E>>16,q=Y,N<50)return;if(Y=U*O+Q*I>>16,U=U*I-Q*O>>16,Q=Y,Y=w*E-U*b>>16,U=w*b+U*E>>16,w=Y,U<50)return;if(Y=T*O+L*I>>16,T=T*I-L*O>>16,L=Y,Y=V*E-T*b>>16,T=V*b+T*E>>16,V=Y,T<50)return;let A=Z.centerX+((H<<9)/G|0),h=Z.centerY+((K<<9)/G|0),n=Z.centerX+(($<<9)/N|0),f=Z.centerY+((q<<9)/N|0),D=Z.centerX+((Q<<9)/U|0),j=Z.centerY+((w<<9)/U|0),W=Z.centerX+((L<<9)/T|0),M=Z.centerY+((V<<9)/T|0);if(Z.alpha=0,(D-W)*(f-M)-(j-M)*(n-W)>0){if(Z.clipX=D<0||W<0||n<0||D>F.boundX||W>F.boundX||n>F.boundX,k.takingInput&&this.pointInsideTriangle(k.mouseX,k.mouseY,j,M,f,D,W,n))k.clickTileX=m,k.clickTileZ=_;if(u.textureId===-1){if(u.northeastColor!==12345678)Z.fillGouraudTriangle(D,W,n,j,M,f,u.northeastColor,u.northwestColor,u.southeastColor)}else if(k.lowMemory){let X=k.TEXTURE_HSL[u.textureId];Z.fillGouraudTriangle(D,W,n,j,M,f,this.mulLightness(X,u.northeastColor),this.mulLightness(X,u.northwestColor),this.mulLightness(X,u.southeastColor))}else if(u.flat)Z.fillTexturedTriangle(D,W,n,j,M,f,u.northeastColor,u.northwestColor,u.southeastColor,H,K,G,$,L,q,V,N,T,u.textureId);else Z.fillTexturedTriangle(D,W,n,j,M,f,u.northeastColor,u.northwestColor,u.southeastColor,Q,w,U,L,$,V,q,T,N,u.textureId)}if((A-n)*(M-f)-(h-f)*(W-n)<=0)return;if(Z.clipX=A<0||n<0||W<0||A>F.boundX||n>F.boundX||W>F.boundX,k.takingInput&&this.pointInsideTriangle(k.mouseX,k.mouseY,h,f,M,A,n,W))k.clickTileX=m,k.clickTileZ=_;if(u.textureId!==-1){if(!k.lowMemory){Z.fillTexturedTriangle(A,n,W,h,f,M,u.southwestColor,u.southeastColor,u.northwestColor,H,K,G,$,L,q,V,N,T,u.textureId);return}let X=k.TEXTURE_HSL[u.textureId];Z.fillGouraudTriangle(A,n,W,h,f,M,this.mulLightness(X,u.southwestColor),this.mulLightness(X,u.southeastColor),this.mulLightness(X,u.northwestColor))}else if(u.southwestColor!==12345678)Z.fillGouraudTriangle(A,n,W,h,f,M,u.southwestColor,u.southeastColor,u.northwestColor)}drawTileOverlay(u,R,m,_,b,E,O){let I=m.vertexX.length;for(let L=0;L<I;L++){let H=m.vertexX[L]-k.eyeX,N=m.vertexY[L]-k.eyeY,G=m.vertexZ[L]-k.eyeZ,Q=G*E+H*O>>16;if(G=G*O-H*E>>16,H=Q,Q=N*b-G*_>>16,G=N*_+G*b>>16,N=Q,G<50)return;if(m.triangleTextureIds)i.tmpViewspaceX[L]=H,i.tmpViewspaceY[L]=N,i.tmpViewspaceZ[L]=G;i.tmpScreenX[L]=Z.centerX+((H<<9)/G|0),i.tmpScreenY[L]=Z.centerY+((N<<9)/G|0)}Z.alpha=0,I=m.triangleVertexA.length;for(let L=0;L<I;L++){let H=m.triangleVertexA[L],N=m.triangleVertexB[L],G=m.triangleVertexC[L],Q=i.tmpScreenX[H],$=i.tmpScreenX[N],T=i.tmpScreenX[G],U=i.tmpScreenY[H],K=i.tmpScreenY[N],q=i.tmpScreenY[G];if((Q-$)*(q-K)-(U-K)*(T-$)>0){if(Z.clipX=Q<0||$<0||T<0||Q>F.boundX||$>F.boundX||T>F.boundX,k.takingInput&&this.pointInsideTriangle(k.mouseX,k.mouseY,U,K,q,Q,$,T))k.clickTileX=u,k.clickTileZ=R;if(!m.triangleTextureIds||m.triangleTextureIds[L]===-1){if(m.triangleColorA[L]!==12345678)Z.fillGouraudTriangle(Q,$,T,U,K,q,m.triangleColorA[L],m.triangleColorB[L],m.triangleColorC[L])}else if(k.lowMemory){let w=k.TEXTURE_HSL[m.triangleTextureIds[L]];Z.fillGouraudTriangle(Q,$,T,U,K,q,this.mulLightness(w,m.triangleColorA[L]),this.mulLightness(w,m.triangleColorB[L]),this.mulLightness(w,m.triangleColorC[L]))}else if(m.flat)Z.fillTexturedTriangle(Q,$,T,U,K,q,m.triangleColorA[L],m.triangleColorB[L],m.triangleColorC[L],i.tmpViewspaceX[0],i.tmpViewspaceY[0],i.tmpViewspaceZ[0],i.tmpViewspaceX[1],i.tmpViewspaceX[3],i.tmpViewspaceY[1],i.tmpViewspaceY[3],i.tmpViewspaceZ[1],i.tmpViewspaceZ[3],m.triangleTextureIds[L]);else Z.fillTexturedTriangle(Q,$,T,U,K,q,m.triangleColorA[L],m.triangleColorB[L],m.triangleColorC[L],i.tmpViewspaceX[H],i.tmpViewspaceY[H],i.tmpViewspaceZ[H],i.tmpViewspaceX[N],i.tmpViewspaceX[G],i.tmpViewspaceY[N],i.tmpViewspaceY[G],i.tmpViewspaceZ[N],i.tmpViewspaceZ[G],m.triangleTextureIds[L])}}}tileVisible(u,R,m){let _=this.levelTileOcclusionCycles[u][R][m];if(_===-k.cycle)return!1;else if(_===k.cycle)return!0;else{let b=R<<7,E=m<<7;if(this.occluded(b+1,this.levelHeightmaps[u][R][m],E+1)&&this.occluded(b+128-1,this.levelHeightmaps[u][R+1][m],E+1)&&this.occluded(b+128-1,this.levelHeightmaps[u][R+1][m+1],E+128-1)&&this.occluded(b+1,this.levelHeightmaps[u][R][m+1],E+128-1))return this.levelTileOcclusionCycles[u][R][m]=k.cycle,!0;else return this.levelTileOcclusionCycles[u][R][m]=-k.cycle,!1}}isTileSideOccluded(u,R,m,_){if(!this.tileVisible(u,R,m))return!1;let b=R<<7,E=m<<7,O=this.levelHeightmaps[u][R][m]-1,I=O-120,L=O-230,H=O-238;if(_<16){if(_===1){if(b>k.eyeX){if(!this.occluded(b,O,E))return!1;if(!this.occluded(b,O,E+128))return!1}if(u>0){if(!this.occluded(b,I,E))return!1;if(!this.occluded(b,I,E+128))return!1}if(!this.occluded(b,L,E))return!1;return this.occluded(b,L,E+128)}if(_===2){if(E<k.eyeZ){if(!this.occluded(b,O,E+128))return!1;if(!this.occluded(b+128,O,E+128))return!1}if(u>0){if(!this.occluded(b,I,E+128))return!1;if(!this.occluded(b+128,I,E+128))return!1}if(!this.occluded(b,L,E+128))return!1;return this.occluded(b+128,L,E+128)}if(_===4){if(b<k.eyeX){if(!this.occluded(b+128,O,E))return!1;if(!this.occluded(b+128,O,E+128))return!1}if(u>0){if(!this.occluded(b+128,I,E))return!1;if(!this.occluded(b+128,I,E+128))return!1}if(!this.occluded(b+128,L,E))return!1;return this.occluded(b+128,L,E+128)}if(_===8){if(E>k.eyeZ){if(!this.occluded(b,O,E))return!1;if(!this.occluded(b+128,O,E))return!1}if(u>0){if(!this.occluded(b,I,E))return!1;if(!this.occluded(b+128,I,E))return!1}if(!this.occluded(b,L,E))return!1;return this.occluded(b+128,L,E)}}if(!this.occluded(b+64,H,E+64))return!1;else if(_===16)return this.occluded(b,L,E+128);else if(_===32)return this.occluded(b+128,L,E+128);else if(_===64)return this.occluded(b+128,L,E);else if(_===128)return this.occluded(b,L,E);return!0}isTileColumnOccluded(u,R,m,_){if(this.tileVisible(u,R,m)){let b=R<<7,E=m<<7;return this.occluded(b+1,this.levelHeightmaps[u][R][m]-_,E+1)&&this.occluded(b+128-1,this.levelHeightmaps[u][R+1][m]-_,E+1)&&this.occluded(b+128-1,this.levelHeightmaps[u][R+1][m+1]-_,E+128-1)&&this.occluded(b+1,this.levelHeightmaps[u][R][m+1]-_,E+128-1)}return!1}locVisible(u,R,m,_,b,E){let O,I;if(R!==m||_!==b){for(O=R;O<=m;O++)for(I=_;I<=b;I++)if(this.levelTileOcclusionCycles[u][O][I]===-k.cycle)return!1;I=(R<<7)+1;let L=(_<<7)+2,H=this.levelHeightmaps[u][R][_]-E;if(!this.occluded(I,H,L))return!1;let N=(m<<7)-1;if(!this.occluded(N,H,L))return!1;let G=(b<<7)-1;if(!this.occluded(I,H,G))return!1;else return this.occluded(N,H,G)}else if(this.tileVisible(u,R,_))return O=R<<7,I=_<<7,this.occluded(O+1,this.levelHeightmaps[u][R][_]-E,I+1)&&this.occluded(O+128-1,this.levelHeightmaps[u][R+1][_]-E,I+1)&&this.occluded(O+128-1,this.levelHeightmaps[u][R+1][_+1]-E,I+128-1)&&this.occluded(O+1,this.levelHeightmaps[u][R][_+1]-E,I+128-1);return!1}occluded(u,R,m){for(let _=0;_<k.activeOccluderCount;_++){let b=k.activeOccluders[_];if(!b)continue;if(b.mode===1){let E=b.minX-u;if(E>0){let O=b.minZ+(b.minDeltaZ*E>>8),I=b.maxZ+(b.maxDeltaZ*E>>8),L=b.minY+(b.minDeltaY*E>>8),H=b.maxY+(b.maxDeltaY*E>>8);if(m>=O&&m<=I&&R>=L&&R<=H)return!0}}else if(b.mode===2){let E=u-b.minX;if(E>0){let O=b.minZ+(b.minDeltaZ*E>>8),I=b.maxZ+(b.maxDeltaZ*E>>8),L=b.minY+(b.minDeltaY*E>>8),H=b.maxY+(b.maxDeltaY*E>>8);if(m>=O&&m<=I&&R>=L&&R<=H)return!0}}else if(b.mode===3){let E=b.minZ-m;if(E>0){let O=b.minX+(b.minDeltaX*E>>8),I=b.maxX+(b.maxDeltaX*E>>8),L=b.minY+(b.minDeltaY*E>>8),H=b.maxY+(b.maxDeltaY*E>>8);if(u>=O&&u<=I&&R>=L&&R<=H)return!0}}else if(b.mode===4){let E=m-b.minZ;if(E>0){let O=b.minX+(b.minDeltaX*E>>8),I=b.maxX+(b.maxDeltaX*E>>8),L=b.minY+(b.minDeltaY*E>>8),H=b.maxY+(b.maxDeltaY*E>>8);if(u>=O&&u<=I&&R>=L&&R<=H)return!0}}else if(b.mode===5){let E=R-b.minY;if(E>0){let O=b.minX+(b.minDeltaX*E>>8),I=b.maxX+(b.maxDeltaX*E>>8),L=b.minZ+(b.minDeltaZ*E>>8),H=b.maxZ+(b.maxDeltaZ*E>>8);if(u>=O&&u<=I&&m>=L&&m<=H)return!0}}}return!1}pointInsideTriangle(u,R,m,_,b,E,O,I){if(R<m&&R<_&&R<b)return!1;else if(R>m&&R>_&&R>b)return!1;else if(u<E&&u<O&&u<I)return!1;else if(u>E&&u>O&&u>I)return!1;let L=(R-m)*(O-E)-(u-E)*(_-m),H=(R-b)*(E-I)-(u-I)*(m-b),N=(R-_)*(I-O)-(u-O)*(b-_);return L*N>0&&N*H>0}mulLightness(u,R){if(R=(127-R)*(u&127)/160|0,R<2)R=2;else if(R>126)R=126;return(u&65408)+R}}class u0 extends j0{index;shape;angle;heightmapSW;heightmapSE;heightmapNE;heightmapNW;seq;seqFrame;seqCycle;constructor(u,R,m,_,b,E,O,I,L,H){super();if(this.index=R,this.shape=m,this.angle=_,this.heightmapSW=b,this.heightmapSE=E,this.heightmapNE=O,this.heightmapNW=I,this.seq=o.types[L],this.seqFrame=0,this.seqCycle=u,H&&this.seq.replayoff!==-1)this.seqFrame=Math.random()*this.seq.frameCount|0,this.seqCycle-=Math.random()*this.seq.getFrameDuration(this.seqFrame)|0}getModel(u){if(this.seq){let _=u-this.seqCycle;if(_>100&&this.seq.replayoff>0)_=100;while(_>this.seq.getFrameDuration(this.seqFrame)){if(_-=this.seq.getFrameDuration(this.seqFrame),this.seqFrame++,this.seqFrame<this.seq.frameCount)continue;if(this.seqFrame-=this.seq.replayoff,this.seqFrame<0||this.seqFrame>=this.seq.frameCount){this.seq=null;break}}this.seqCycle=u-_}let R=-1;if(this.seq&&this.seq.frames&&typeof this.seq.frames[this.seqFrame]!=="undefined")R=this.seq.frames[this.seqFrame];return _0.get(this.index).getModel(this.shape,this.angle,this.heightmapSW,this.heightmapSE,this.heightmapNE,this.heightmapNW,R)}}class t{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(Math.random()*17|0)-8;static randomLightnessOffset=(Math.random()*33|0)-16;static lowMemory=!0;static levelBuilt=0;static fullbright=!1;static perlin(u,R){let m=this.perlinScale(u+45365,R+91923,4)+(this.perlinScale(u+10294,R+37821,2)-128>>1)+(this.perlinScale(u,R,1)-128>>2)-128;if(m=(m*0.3|0)+35,m<10)m=10;else if(m>60)m=60;return m}static perlinScale(u,R,m){let _=u/m|0,b=u&m-1,E=R/m|0,O=R&m-1,I=this.smoothNoise(_,E),L=this.smoothNoise(_+1,E),H=this.smoothNoise(_,E+1),N=this.smoothNoise(_+1,E+1),G=this.interpolate(I,L,b,m),Q=this.interpolate(H,N,b,m);return this.interpolate(G,Q,O,m)}static interpolate(u,R,m,_){let b=65536-Z.cos[m*1024/_|0]>>1;return(u*(65536-b)>>16)+(R*b>>16)}static smoothNoise(u,R){let m=this.noise(u-1,R-1)+this.noise(u+1,R-1)+this.noise(u-1,R+1)+this.noise(u+1,R+1),_=this.noise(u-1,R)+this.noise(u+1,R)+this.noise(u,R-1)+this.noise(u,R+1),b=this.noise(u,R);return(m/16|0)+(_/8|0)+(b/4|0)}static noise(u,R){let m=u+R*57,_=BigInt(m<<13^m);return Number((_*(_*_*15731n+789221n)+1376312589n&0x7fffffffn)>>19n)&255}static isLocReady(u,R){let m=_0.get(u);if(R==11)R=10;if(R>=5&&R<=8)R=4;return m.shapeModelsAreReady(R)}static addLoc(u,R,m,_,b,E,O,I,L,H,N){let G=E[N][m][_],Q=E[N][m+1][_],$=E[N][m+1][_+1],T=E[N][m][_+1],U=G+Q+$+T>>2,K=_0.get(I),q=m+(_<<7)+(I<<14)+1073741824|0;if(!K.active)q+=-2147483648;q|=0;let w=((H<<6)+L|0)<<24>>24;if(L===g.GROUND_DECOR.id){let V;if(K.anim===-1)V=K.getModel(22,H,G,Q,T,$,-1);else V=new u0(u,I,22,L,G,Q,T,$,K.anim,!0);if(b?.addGroundDecoration(V,R,m,_,U,q,w),K.blockwalk&&K.active&&O)O.addFloor(m,_)}else if(L===g.CENTREPIECE_STRAIGHT.id||L===g.CENTREPIECE_DIAGONAL.id){let V;if(K.anim===-1)V=K.getModel(10,H,G,Q,T,$,-1);else V=new u0(u,I,10,H,G,Q,T,$,K.anim,!0);if(V){let Y=0;if(L===g.CENTREPIECE_DIAGONAL.id)Y+=256;let A,h;if(H===1||H===3)A=K.length,h=K.width;else A=K.width,h=K.length;b?.addLoc(R,m,_,U,V,q,w,A,h,Y)}if(K.blockwalk&&O)O.addLoc(m,_,K.width,K.length,H,K.blockrange)}else if(L>=g.ROOF_STRAIGHT.id){let V;if(K.anim===-1)V=K.getModel(L,H,G,Q,T,$,-1);else V=new u0(u,I,L,H,G,Q,T,$,K.anim,!0);if(b?.addLoc(R,m,_,U,V,q,w,1,1,0),K.blockwalk&&O)O.addLoc(m,_,K.width,K.length,H,K.blockrange)}else if(L===g.WALL_STRAIGHT.id){let V;if(K.anim===-1)V=K.getModel(0,H,G,Q,T,$,-1);else V=new u0(u,I,0,H,G,Q,T,$,K.anim,!0);if(b?.addWall(R,m,_,U,t.ROTATION_WALL_TYPE[H],0,V,null,q,w),K.blockwalk&&O)O.addWall(m,_,L,H,K.blockrange)}else if(L===g.WALL_DIAGONAL_CORNER.id){let V;if(K.anim===-1)V=K.getModel(1,H,G,Q,T,$,-1);else V=new u0(u,I,1,H,G,Q,T,$,K.anim,!0);if(b?.addWall(R,m,_,U,t.ROTATION_WALL_CORNER_TYPE[H],0,V,null,q,w),K.blockwalk&&O)O.addWall(m,_,L,H,K.blockrange)}else if(L===g.WALL_L.id){let V=H+1&3,Y,A;if(K.anim===-1)Y=K.getModel(2,H+4,G,Q,T,$,-1),A=K.getModel(2,V,G,Q,T,$,-1);else Y=new u0(u,I,2,H+4,G,Q,T,$,K.anim,!0),A=new u0(u,I,2,V,G,Q,T,$,K.anim,!0);if(b?.addWall(R,m,_,U,t.ROTATION_WALL_TYPE[H],t.ROTATION_WALL_TYPE[V],Y,A,q,w),K.blockwalk&&O)O.addWall(m,_,L,H,K.blockrange)}else if(L===g.WALL_SQUARE_CORNER.id){let V;if(K.anim===-1)V=K.getModel(3,H,G,Q,T,$,-1);else V=new u0(u,I,3,H,G,Q,T,$,K.anim,!0);if(b?.addWall(R,m,_,U,t.ROTATION_WALL_CORNER_TYPE[H],0,V,null,q,w),K.blockwalk&&O)O.addWall(m,_,L,H,K.blockrange)}else if(L===g.WALL_DIAGONAL.id){let V;if(K.anim===-1)V=K.getModel(L,H,G,Q,T,$,-1);else V=new u0(u,I,L,H,G,Q,T,$,K.anim,!0);if(b?.addLoc(R,m,_,U,V,q,w,1,1,0),K.blockwalk&&O)O.addLoc(m,_,K.width,K.length,H,K.blockrange)}else if(L===g.WALLDECOR_STRAIGHT_NOOFFSET.id){let V;if(K.anim===-1)V=K.getModel(4,0,G,Q,T,$,-1);else V=new u0(u,I,4,0,G,Q,T,$,K.anim,!0);b?.setWallDecoration(R,m,_,U,0,0,q,V,w,H*512,t.ROTATION_WALL_TYPE[H])}else if(L===g.WALLDECOR_STRAIGHT_OFFSET.id){let V=16;if(b){let A=b.getWallTypecode(R,m,_);if(A>0)V=_0.get(A>>14&32767).wallwidth}let Y;if(K.anim===-1)Y=K.getModel(4,0,G,Q,T,$,-1);else Y=new u0(u,I,4,0,G,Q,T,$,K.anim,!0);b?.setWallDecoration(R,m,_,U,t.WALL_DECORATION_ROTATION_FORWARD_X[H]*V,t.WALL_DECORATION_ROTATION_FORWARD_Z[H]*V,q,Y,w,H*512,t.ROTATION_WALL_TYPE[H])}else if(L===g.WALLDECOR_DIAGONAL_OFFSET.id){let V;if(K.anim===-1)V=K.getModel(4,0,G,Q,T,$,-1);else V=new u0(u,I,4,0,G,Q,T,$,K.anim,!0);b?.setWallDecoration(R,m,_,U,0,0,q,V,w,H,256)}else if(L===g.WALLDECOR_DIAGONAL_NOOFFSET.id){let V;if(K.anim===-1)V=K.getModel(4,0,G,Q,T,$,-1);else V=new u0(u,I,4,0,G,Q,T,$,K.anim,!0);b?.setWallDecoration(R,m,_,U,0,0,q,V,w,H,512)}else if(L===g.WALLDECOR_DIAGONAL_BOTH.id){let V;if(K.anim===-1)V=K.getModel(4,0,G,Q,T,$,-1);else V=new u0(u,I,4,0,G,Q,T,$,K.anim,!0);b?.setWallDecoration(R,m,_,U,0,0,q,V,w,H,768)}}maxTileX;maxTileZ;heightmap;levelTileFlags;levelTileUnderlayIds;levelTileOverlayIds;levelTileOverlayShape;levelTileOverlayRotation;shadow;levelLightmap;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;occlusion;constructor(u,R,m,_){this.maxTileX=u,this.maxTileZ=R,this.heightmap=m,this.levelTileFlags=_,this.levelTileUnderlayIds=new S0(4,u,R),this.levelTileOverlayIds=new S0(4,u,R),this.levelTileOverlayShape=new S0(4,u,R),this.levelTileOverlayRotation=new S0(4,u,R),this.occlusion=new g0(4,u+1,R+1),this.shadow=new S0(4,u+1,R+1),this.levelLightmap=new f0(u+1,R+1),this.blendChroma=new Int32Array(R),this.blendSaturation=new Int32Array(R),this.blendLightness=new Int32Array(R),this.blendLuminance=new Int32Array(R),this.blendMagnitude=new Int32Array(R)}build(u,R){for(let m=0;m<4;m++)for(let _=0;_<104;_++)for(let b=0;b<104;b++)if((this.levelTileFlags[m][_][b]&1)===1){let E=m;if((this.levelTileFlags[1][_][b]&2)===2)E--;if(E>=0)R[E]?.addFloor(_,b)}if(t.randomHueOffset+=(Math.random()*5|0)-2,t.randomHueOffset<-8)t.randomHueOffset=-8;else if(t.randomHueOffset>8)t.randomHueOffset=8;if(t.randomLightnessOffset+=(Math.random()*5|0)-2,t.randomLightnessOffset<-16)t.randomLightnessOffset=-16;else if(t.randomLightnessOffset>16)t.randomLightnessOffset=16;for(let m=0;m<4;m++){let _=this.shadow[m],b=96,E=768,O=-50,I=-10,L=-50,N=768*(Math.sqrt(5100)|0)>>8;for(let G=1;G<this.maxTileZ-1;G++)for(let Q=1;Q<this.maxTileX-1;Q++){let $=this.heightmap[m][Q+1][G]-this.heightmap[m][Q-1][G],T=this.heightmap[m][Q][G+1]-this.heightmap[m][Q][G-1],U=Math.sqrt($*$+T*T+65536)|0,K=($<<8)/U|0,q=65536/U|0,w=(T<<8)/U|0,V=96+((-50*K+-10*q+-50*w)/N|0),Y=(_[Q-1][G]>>2)+(_[Q+1][G]>>3)+(_[Q][G-1]>>2)+(_[Q][G+1]>>3)+(_[Q][G]>>1);this.levelLightmap[Q][G]=V-Y}for(let G=0;G<this.maxTileZ;G++)this.blendChroma[G]=0,this.blendSaturation[G]=0,this.blendLightness[G]=0,this.blendLuminance[G]=0,this.blendMagnitude[G]=0;for(let G=-5;G<this.maxTileX+5;G++){for(let Q=0;Q<this.maxTileZ;Q++){let $=G+5,T;if($>=0&&$<this.maxTileX){let K=this.levelTileUnderlayIds[m][$][Q]&255;if(K>0){let q=M0.types[K-1];this.blendChroma[Q]+=q.chroma,this.blendSaturation[Q]+=q.saturation,this.blendLightness[Q]+=q.lightness,this.blendLuminance[Q]+=q.luminance,T=this.blendMagnitude[Q]++}}let U=G-5;if(U>=0&&U<this.maxTileX){let K=this.levelTileUnderlayIds[m][U][Q]&255;if(K>0){let q=M0.types[K-1];this.blendChroma[Q]-=q.chroma,this.blendSaturation[Q]-=q.saturation,this.blendLightness[Q]-=q.lightness,this.blendLuminance[Q]-=q.luminance,T=this.blendMagnitude[Q]--}}}if(G>=1&&G<this.maxTileX-1){let Q=0,$=0,T=0,U=0,K=0;for(let q=-5;q<this.maxTileZ+5;q++){let w=q+5;if(w>=0&&w<this.maxTileZ)Q+=this.blendChroma[w],$+=this.blendSaturation[w],T+=this.blendLightness[w],U+=this.blendLuminance[w],K+=this.blendMagnitude[w];let V=q-5;if(V>=0&&V<this.maxTileZ)Q-=this.blendChroma[V],$-=this.blendSaturation[V],T-=this.blendLightness[V],U-=this.blendLuminance[V],K-=this.blendMagnitude[V];if(q>=1&&q<this.maxTileZ-1&&(!t.lowMemory||(this.levelTileFlags[m][G][q]&16)===0&&this.getDrawLevel(m,G,q)===t.levelBuilt)){let Y=this.levelTileUnderlayIds[m][G][q]&255,A=this.levelTileOverlayIds[m][G][q]&255;if(Y>0||A>0){let h=this.heightmap[m][G][q],n=this.heightmap[m][G+1][q],f=this.heightmap[m][G+1][q+1],D=this.heightmap[m][G][q+1],j=this.levelLightmap[G][q],W=this.levelLightmap[G+1][q],M=this.levelLightmap[G+1][q+1],X=this.levelLightmap[G][q+1],P=-1,r=-1;if(Y>0){let y=Q*256/U|0,a=$/K|0,x=T/K|0;P=this.hsl24to16(y,a,x);let O0=y+t.randomHueOffset&255;if(x+=t.randomLightnessOffset,x<0)x=0;else if(x>255)x=255;r=this.hsl24to16(O0,a,x)}if(m>0){let y=Y!==0||this.levelTileOverlayShape[m][G][q]===0;if(A>0&&!M0.types[A-1].occlude)y=!1;if(y&&h===n&&h===f&&h===D)this.occlusion[m][G][q]|=2340}let S=0;if(P!==-1)S=Z.hslPal[t.mulHSL(r,96)];if(A===0)u?.setTile(m,G,q,0,0,-1,h,n,f,D,t.mulHSL(P,j),t.mulHSL(P,W),t.mulHSL(P,M),t.mulHSL(P,X),0,0,0,0,S,0);else{let y=this.levelTileOverlayShape[m][G][q]+1,a=this.levelTileOverlayRotation[m][G][q],x=M0.types[A-1],O0=x.texture,R0,N0;if(O0>=0)N0=Z.getAverageTextureRGB(O0),R0=-1;else if(x.rgb===16711935)N0=0,R0=-2,O0=-1;else R0=this.hsl24to16(x.hue,x.saturation,x.lightness),N0=Z.hslPal[this.adjustLightness(x.hsl,96)];u?.setTile(m,G,q,y,a,O0,h,n,f,D,t.mulHSL(P,j),t.mulHSL(P,W),t.mulHSL(P,M),t.mulHSL(P,X),this.adjustLightness(R0,j),this.adjustLightness(R0,W),this.adjustLightness(R0,M),this.adjustLightness(R0,X),S,N0)}}}}}}for(let G=1;G<this.maxTileZ-1;G++)for(let Q=1;Q<this.maxTileX-1;Q++)u?.setDrawLevel(m,Q,G,this.getDrawLevel(m,Q,G))}if(!t.fullbright)u?.buildModels(64,768,-50,-10,-50);for(let m=0;m<this.maxTileX;m++)for(let _=0;_<this.maxTileZ;_++)if((this.levelTileFlags[1][m][_]&2)===2)u?.setBridge(m,_);if(!t.fullbright){let m=1,_=2,b=4;for(let E=0;E<4;E++){if(E>0)m<<=3,_<<=3,b<<=3;for(let O=0;O<=E;O++)for(let I=0;I<=this.maxTileZ;I++)for(let L=0;L<=this.maxTileX;L++){if((this.occlusion[O][L][I]&m)!==0){let H=I,N=I,G=O,Q=O;while(H>0&&(this.occlusion[O][L][H-1]&m)!==0)H--;while(N<this.maxTileZ&&(this.occlusion[O][L][N+1]&m)!==0)N++;u:while(G>0){for(let T=H;T<=N;T++)if((this.occlusion[G-1][L][T]&m)===0)break u;G--}u:while(Q<E){for(let T=H;T<=N;T++)if((this.occlusion[Q+1][L][T]&m)===0)break u;Q++}if((Q+1-G)*(N+1-H)>=8){let T=this.heightmap[Q][L][H]-240,U=this.heightmap[G][L][H];k.addOccluder(E,1,L*128,T,H*128,L*128,U,N*128+128);for(let K=G;K<=Q;K++)for(let q=H;q<=N;q++)this.occlusion[K][L][q]&=~m}}if((this.occlusion[O][L][I]&_)!==0){let H=L,N=L,G=O,Q=O;while(H>0&&(this.occlusion[O][H-1][I]&_)!==0)H--;while(N<this.maxTileX&&(this.occlusion[O][N+1][I]&_)!==0)N++;u:while(G>0){for(let T=H;T<=N;T++)if((this.occlusion[G-1][T][I]&_)===0)break u;G--}u:while(Q<E){for(let T=H;T<=N;T++)if((this.occlusion[Q+1][T][I]&_)===0)break u;Q++}if((Q+1-G)*(N+1-H)>=8){let T=this.heightmap[Q][H][I]-240,U=this.heightmap[G][H][I];k.addOccluder(E,2,H*128,T,I*128,N*128+128,U,I*128);for(let K=G;K<=Q;K++)for(let q=H;q<=N;q++)this.occlusion[K][q][I]&=~_}}if((this.occlusion[O][L][I]&b)!==0){let H=L,N=L,G=I,Q=I;while(G>0&&(this.occlusion[O][L][G-1]&b)!==0)G--;while(Q<this.maxTileZ&&(this.occlusion[O][L][Q+1]&b)!==0)Q++;u:while(H>0){for(let $=G;$<=Q;$++)if((this.occlusion[O][H-1][$]&b)===0)break u;H--}u:while(N<this.maxTileX){for(let $=G;$<=Q;$++)if((this.occlusion[O][N+1][$]&b)===0)break u;N++}if((N+1-H)*(Q+1-G)>=4){let $=this.heightmap[O][H][G];k.addOccluder(E,4,H*128,$,G*128,N*128+128,$,Q*128+128);for(let T=H;T<=N;T++)for(let U=G;U<=Q;U++)this.occlusion[O][T][U]&=~b}}}}}}spreadHeight(u,R,m,_){for(let b=u;b<u+m;b++)for(let E=R;E<R+_;E++)if(E>=0&&E<this.maxTileX&&b>=0&&b<this.maxTileZ){if(this.shadow[0][E][b]=127,R==E&&E>0)this.heightmap[0][E][b]=this.heightmap[0][E-1][b];if(R+_==E&&E<this.maxTileX-1)this.heightmap[0][E][b]=this.heightmap[0][E+1][b];if(u==b&&b>0)this.heightmap[0][E][b]=this.heightmap[0][E][b-1];if(u+m==b&&b<this.maxTileZ-1)this.heightmap[0][E][b]=this.heightmap[0][E][b+1]}}loadGround(u,R,m,_,b){let E=new z(b);for(let O=0;O<4;O++)for(let I=0;I<64;I++)for(let L=0;L<64;L++){let H=I+m,N=L+_,G;if(H>=0&&H<104&&N>=0&&N<104){this.levelTileFlags[O][H][N]=0;while(!0){if(G=E.g1(),G===0){if(O===0)this.heightmap[0][H][N]=-t.perlin(H+u+932731,N+556238+R)*8;else this.heightmap[O][H][N]=this.heightmap[O-1][H][N]-240;break}if(G===1){let Q=E.g1();if(Q===1)Q=0;if(O===0)this.heightmap[0][H][N]=-Q*8;else this.heightmap[O][H][N]=this.heightmap[O-1][H][N]-Q*8;break}if(G<=49)this.levelTileOverlayIds[O][H][N]=E.g1b(),this.levelTileOverlayShape[O][H][N]=((G-2)/4|0)<<24>>24,this.levelTileOverlayRotation[O][H][N]=(G-2&3)<<24>>24;else if(G<=81)this.levelTileFlags[O][H][N]=G-49<<24>>24;else this.levelTileUnderlayIds[O][H][N]=G-81<<24>>24}}else while(!0){if(G=E.g1(),G===0)break;if(G===1){E.g1();break}if(G<=49)E.g1()}}}static locsAreReady(u,R,m){let _=!0,b=new z(u),E=-1;while(!0){let O=b.gsmarts();if(O==0)break;E+=O;let I=0,L=!1;while(!0)if(L){if(b.gsmarts()==0)break;b.g1()}else{let H=b.gsmarts();if(H==0)break;I+=H-1;let N=I&63,G=I>>6&63,Q=b.g1()>>2,$=R+G,T=m+N;if($>0&&T>0&&$<103&&T<103){let U=_0.get(E);if(Q!=22||!t.lowMemory||U.active||U.forcedecor){if(!U.modelsAreReady())_=!1;L=!0}}}}return _}static prefetchLocs(u,R){let m=-1;while(!0){let _=u.gsmarts();if(_==0)return;m+=_,_0.get(m).prefetch(R);while(!0){if(u.gsmarts()==0)break;u.g1()}}}loadLocations(u,R,m,_,b,E){let O=new z(_),I=-1;while(!0){let L=O.gsmarts();if(L===0)return;I+=L;let H=0;while(!0){let N=O.gsmarts();if(N===0)break;H+=N-1;let G=H&63,Q=H>>6&63,$=H>>12,T=O.g1(),U=T>>2,K=T&3,q=Q+b,w=G+E;if(q>0&&w>0&&q<104-1&&w<104-1){let V=$;if((this.levelTileFlags[1][q][w]&2)===2)V=$-1;let Y=null;if(V>=0)Y=m[V];this.addLoc(u,$,q,w,R,Y,I,U,K)}}}}addLoc(u,R,m,_,b,E,O,I,L){if(t.lowMemory){if((this.levelTileFlags[R][m][_]&16)!==0)return;if(this.getDrawLevel(R,m,_)!==t.levelBuilt)return}let H=this.heightmap[R][m][_],N=this.heightmap[R][m+1][_],G=this.heightmap[R][m+1][_+1],Q=this.heightmap[R][m][_+1],$=H+N+G+Q>>2,T=_0.get(O),U=m+(_<<7)+(O<<14)+1073741824|0;if(!T.active)U+=-2147483648;U|=0;let K=((L<<6)+I|0)<<24>>24;if(I===g.GROUND_DECOR.id){if(!t.lowMemory||T.active||T.forcedecor){let q;if(T.anim===-1)q=T.getModel(22,L,H,N,G,Q,-1);else q=new u0(u,O,22,I,H,N,G,Q,T.anim,!0);if(b?.addGroundDecoration(q,R,m,_,$,U,K),T.blockwalk&&T.active&&E)E.addFloor(m,_)}}else if(I===g.CENTREPIECE_STRAIGHT.id||I===g.CENTREPIECE_DIAGONAL.id){let q;if(T.anim===-1)q=T.getModel(10,L,H,N,G,Q,-1);else q=new u0(u,O,10,L,H,N,G,Q,T.anim,!0);if(q){let w=0;if(I===g.CENTREPIECE_DIAGONAL.id)w+=256;let V,Y;if(L===1||L===3)V=T.length,Y=T.width;else V=T.width,Y=T.length;if(b?.addLoc(R,m,_,$,q,U,K,V,Y,w)&&T.shadow){let A;if(q instanceof J)A=q;else A=T.getModel(10,L,H,N,G,Q,-1);if(A)for(let h=0;h<=V;h++)for(let n=0;n<=Y;n++){let f=A.radius/4|0;if(f>30)f=30;if(f>this.shadow[R][m+h][_+n])this.shadow[R][m+h][_+n]=f<<24>>24}}}if(T.blockwalk&&E)E.addLoc(m,_,T.width,T.length,L,T.blockrange)}else if(I>=g.ROOF_STRAIGHT.id){let q;if(T.anim===-1)q=T.getModel(I,L,H,N,G,Q,-1);else q=new u0(u,O,I,L,H,N,G,Q,T.anim,!0);if(b?.addLoc(R,m,_,$,q,U,K,1,1,0),I>=g.ROOF_STRAIGHT.id&&I<=g.ROOF_FLAT.id&&I!==g.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&R>0)this.occlusion[R][m][_]|=2340;if(T.blockwalk&&E)E.addLoc(m,_,T.width,T.length,L,T.blockrange)}else if(I===g.WALL_STRAIGHT.id){let q;if(T.anim===-1)q=T.getModel(0,L,H,N,G,Q,-1);else q=new u0(u,O,0,L,H,N,G,Q,T.anim,!0);if(b?.addWall(R,m,_,$,t.ROTATION_WALL_TYPE[L],0,q,null,U,K),L===0){if(T.shadow)this.shadow[R][m][_]=50,this.shadow[R][m][_+1]=50;if(T.occlude)this.occlusion[R][m][_]|=585}else if(L===1){if(T.shadow)this.shadow[R][m][_+1]=50,this.shadow[R][m+1][_+1]=50;if(T.occlude)this.occlusion[R][m][_+1]|=1170}else if(L===2){if(T.shadow)this.shadow[R][m+1][_]=50,this.shadow[R][m+1][_+1]=50;if(T.occlude)this.occlusion[R][m+1][_]|=585}else if(L===3){if(T.shadow)this.shadow[R][m][_]=50,this.shadow[R][m+1][_]=50;if(T.occlude)this.occlusion[R][m][_]|=1170}if(T.blockwalk&&E)E.addWall(m,_,I,L,T.blockrange);if(T.wallwidth!==16)b?.setWallDecorationOffset(R,m,_,T.wallwidth)}else if(I===g.WALL_DIAGONAL_CORNER.id){let q;if(T.anim===-1)q=T.getModel(1,L,H,N,G,Q,-1);else q=new u0(u,O,1,L,H,N,G,Q,T.anim,!0);if(b?.addWall(R,m,_,$,t.ROTATION_WALL_CORNER_TYPE[L],0,q,null,U,K),T.shadow){if(L===0)this.shadow[R][m][_+1]=50;else if(L===1)this.shadow[R][m+1][_+1]=50;else if(L===2)this.shadow[R][m+1][_]=50;else if(L===3)this.shadow[R][m][_]=50}if(T.blockwalk&&E)E.addWall(m,_,I,L,T.blockrange)}else if(I===g.WALL_L.id){let q=L+1&3,w,V;if(T.anim===-1)w=T.getModel(2,L+4,H,N,G,Q,-1),V=T.getModel(2,q,H,N,G,Q,-1);else w=new u0(u,O,2,L+4,H,N,G,Q,T.anim,!0),V=new u0(u,O,2,q,H,N,G,Q,T.anim,!0);if(b?.addWall(R,m,_,$,t.ROTATION_WALL_TYPE[L],t.ROTATION_WALL_TYPE[q],w,V,U,K),T.occlude){if(L===0)this.occlusion[R][m][_]|=265,this.occlusion[R][m][_+1]|=1170;else if(L===1)this.occlusion[R][m][_+1]|=1170,this.occlusion[R][m+1][_]|=585;else if(L===2)this.occlusion[R][m+1][_]|=585,this.occlusion[R][m][_]|=1170;else if(L===3)this.occlusion[R][m][_]|=1170,this.occlusion[R][m][_]|=585}if(T.blockwalk&&E)E.addWall(m,_,I,L,T.blockrange);if(T.wallwidth!==16)b?.setWallDecorationOffset(R,m,_,T.wallwidth)}else if(I===g.WALL_SQUARE_CORNER.id){let q;if(T.anim===-1)q=T.getModel(3,L,H,N,G,Q,-1);else q=new u0(u,O,3,L,H,N,G,Q,T.anim,!0);if(b?.addWall(R,m,_,$,t.ROTATION_WALL_CORNER_TYPE[L],0,q,null,U,K),T.shadow){if(L===0)this.shadow[R][m][_+1]=50;else if(L===1)this.shadow[R][m+1][_+1]=50;else if(L===2)this.shadow[R][m+1][_]=50;else if(L===3)this.shadow[R][m][_]=50}if(T.blockwalk&&E)E.addWall(m,_,I,L,T.blockrange)}else if(I===g.WALL_DIAGONAL.id){let q;if(T.anim===-1)q=T.getModel(I,L,H,N,G,Q,-1);else q=new u0(u,O,I,L,H,N,G,Q,T.anim,!0);if(b?.addLoc(R,m,_,$,q,U,K,1,1,0),T.blockwalk&&E)E.addLoc(m,_,T.width,T.length,L,T.blockrange)}else if(I===g.WALLDECOR_STRAIGHT_NOOFFSET.id){let q;if(T.anim===-1)q=T.getModel(4,0,H,N,G,Q,-1);else q=new u0(u,O,4,0,H,N,G,Q,T.anim,!0);b?.setWallDecoration(R,m,_,$,0,0,U,q,K,L*512,t.ROTATION_WALL_TYPE[L])}else if(I===g.WALLDECOR_STRAIGHT_OFFSET.id){let q=16;if(b){let V=b.getWallTypecode(R,m,_);if(V>0)q=_0.get(V>>14&32767).wallwidth}let w;if(T.anim===-1)w=T.getModel(4,0,H,N,G,Q,-1);else w=new u0(u,O,4,0,H,N,G,Q,T.anim,!0);b?.setWallDecoration(R,m,_,$,t.WALL_DECORATION_ROTATION_FORWARD_X[L]*q,t.WALL_DECORATION_ROTATION_FORWARD_Z[L]*q,U,w,K,L*512,t.ROTATION_WALL_TYPE[L])}else if(I===g.WALLDECOR_DIAGONAL_OFFSET.id){let q;if(T.anim===-1)q=T.getModel(4,0,H,N,G,Q,-1);else q=new u0(u,O,4,0,H,N,G,Q,T.anim,!0);b?.setWallDecoration(R,m,_,$,0,0,U,q,K,L,256)}else if(I===g.WALLDECOR_DIAGONAL_NOOFFSET.id){let q;if(T.anim===-1)q=T.getModel(4,0,H,N,G,Q,-1);else q=new u0(u,O,4,0,H,N,G,Q,T.anim,!0);b?.setWallDecoration(R,m,_,$,0,0,U,q,K,L,512)}else if(I===g.WALLDECOR_DIAGONAL_BOTH.id){let q;if(T.anim===-1)q=T.getModel(4,0,H,N,G,Q,-1);else q=new u0(u,O,4,0,H,N,G,Q,T.anim,!0);b?.setWallDecoration(R,m,_,$,0,0,U,q,K,L,768)}}getDrawLevel(u,R,m){if((this.levelTileFlags[u][R][m]&8)===0)return u<=0||(this.levelTileFlags[1][R][m]&2)===0?u:u-1;return 0}hsl24to16(u,R,m){if(m>179)R=R/2|0;if(m>192)R=R/2|0;if(m>217)R=R/2|0;if(m>243)R=R/2|0;return((u/4|0)<<10)+((R/32|0)<<7)+(m/2|0)}static mulHSL(u,R){if(u===-1)return 12345678;if(R=R*(u&127)/128|0,R<2)R=2;else if(R>126)R=126;return(u&65408)+R}adjustLightness(u,R){if(u===-2)return 12345678;if(u===-1){if(R<0)R=0;else if(R>127)R=127;return 127-R}else{if(R=R*(u&127)/128|0,R<2)R=2;else if(R>126)R=126;return(u&65408)+R}}}class t0 extends j0{x=0;z=0;yaw=0;needsForwardDrawPadding=!1;size=1;readyanim=-1;turnanim=-1;walkanim=-1;walkanim_b=-1;walkanim_l=-1;walkanim_r=-1;runanim=-1;chatMessage=null;chatTimer=100;chatColour=0;chatEffect=0;combatCycle=-1000;damageValues=new Int32Array(4);damageTypes=new Int32Array(4);damageCycles=new Int32Array(4);health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimHeight=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;height=0;dstYaw=0;routeLength=0;routeTileX=new Int32Array(10);routeTileZ=new Int32Array(10);routeRun=new p(10,!1);seqDelayMove=0;preanimRouteLength=0;move(u,R,m){if(this.primarySeqId!==-1&&o.types[this.primarySeqId].postanim_move===1)this.primarySeqId=-1;if(!u){let _=R-this.routeTileX[0],b=m-this.routeTileZ[0];if(_>=-8&&_<=8&&b>=-8&&b<=8){if(this.routeLength<9)this.routeLength++;for(let E=this.routeLength;E>0;E--)this.routeTileX[E]=this.routeTileX[E-1],this.routeTileZ[E]=this.routeTileZ[E-1],this.routeRun[E]=this.routeRun[E-1];this.routeTileX[0]=R,this.routeTileZ[0]=m,this.routeRun[0]=!1;return}}this.routeLength=0,this.preanimRouteLength=0,this.seqDelayMove=0,this.routeTileX[0]=R,this.routeTileZ[0]=m,this.x=this.routeTileX[0]*128+this.size*64,this.z=this.routeTileZ[0]*128+this.size*64}step(u,R){let m=this.routeTileX[0],_=this.routeTileZ[0];if(R===0)m--,_++;else if(R===1)_++;else if(R===2)m++,_++;else if(R===3)m--;else if(R===4)m++;else if(R===5)m--,_--;else if(R===6)_--;else if(R===7)m++,_--;if(this.primarySeqId!==-1&&o.types[this.primarySeqId].postanim_move===1)this.primarySeqId=-1;if(this.routeLength<9)this.routeLength++;for(let b=this.routeLength;b>0;b--)this.routeTileX[b]=this.routeTileX[b-1],this.routeTileZ[b]=this.routeTileZ[b-1],this.routeRun[b]=this.routeRun[b-1];this.routeTileX[0]=m,this.routeTileZ[0]=_,this.routeRun[0]=u}clearRoute(){this.routeLength=0,this.preanimRouteLength=0}hit(u,R,m){for(let _=0;_<4;_++)if(this.damageCycles[_]<=u){this.damageValues[_]=m,this.damageTypes[_]=R,this.damageCycles[_]=u+70;return}}}class Q1 extends t0{type=null;getModel(){if(this.type==null)return null;let u=this.getAnimatedModel();if(u==null)return null;if(this.height=u.minY,this.spotanimId!=-1&&this.spotanimFrame!=-1){let R=q0.types[this.spotanimId],m=R.getModel();if(m!=null){let _=J.modelShareColored(m,!0,!R.animHasAlpha,!1);if(_.translate(-this.spotanimHeight,0,0),_.createLabelReferences(),R.seq&&R.seq.frames)_.applyTransform(R.seq.frames[this.spotanimFrame]);if(_.labelFaces=null,_.labelVertices=null,R.resizeh!=128||R.resizev!=128)_.scale(R.resizev,R.resizeh,R.resizeh);_.calculateNormals(R.ambient+64,R.contrast+850,-30,-50,-30,!0);let b=[u,_];u=J.modelFromModelsBounds(b,2)}}if(this.type.size==1)u.picking=!0;return u}getAnimatedModel(){if(!this.type)return null;if(this.primarySeqId<0||this.primarySeqDelay!=0){let u=o.types[this.secondarySeqId],R=-1;if(this.secondarySeqId>=0&&u.frames)R=u.frames[this.secondarySeqFrame];return this.type.getModel(R,-1,null)}else{let u=o.types[this.primarySeqId],R=-1;if(u.frames)R=u.frames[this.primarySeqFrame];let m=o.types[this.secondarySeqId],_=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!=this.readyanim&&m.frames)_=m.frames[this.secondarySeqFrame];return this.type.getModel(R,_,u.walkmerge)}}isVisible(){return this.type!==null}}class Q0 extends t0{static TORSO_RECOLORS=[9104,10275,7595,3610,7975,8526,918,38802,24466,10145,58654,5027,1457,16565,34991,25486];static DESIGN_IDK_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];name=null;visible=!1;gender=0;headicons=0;appearance=new Uint16Array(12);colour=new Uint16Array(5);combatLevel=0;hash=0n;lowMemory=!1;modelCacheKey=-1n;static modelCache=new F0(200);y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;read(u){u.pos=0,this.gender=u.g1(),this.headicons=u.g1();for(let R=0;R<12;R++){let m=u.g1();if(m===0)this.appearance[R]=0;else this.appearance[R]=(m<<8)+u.g1()}for(let R=0;R<5;R++){let m=u.g1();if(m<0||m>=Q0.DESIGN_IDK_COLORS[R].length)m=0;this.colour[R]=m}if(this.readyanim=u.g2(),this.readyanim===65535)this.readyanim=-1;if(this.turnanim=u.g2(),this.turnanim===65535)this.turnanim=-1;if(this.walkanim=u.g2(),this.walkanim===65535)this.walkanim=-1;if(this.walkanim_b=u.g2(),this.walkanim_b===65535)this.walkanim_b=-1;if(this.walkanim_l=u.g2(),this.walkanim_l===65535)this.walkanim_l=-1;if(this.walkanim_r=u.g2(),this.walkanim_r===65535)this.walkanim_r=-1;if(this.runanim=u.g2(),this.runanim===65535)this.runanim=-1;this.name=c.formatName(c.fromBase37(u.g8())),this.combatLevel=u.g1(),this.visible=!0,this.hash=0n;for(let R=0;R<12;R++)if(this.hash<<=0x4n,this.appearance[R]>=256)this.hash+=BigInt(this.appearance[R])-256n;if(this.appearance[0]>=256)this.hash+=BigInt(this.appearance[0])-256n>>4n;if(this.appearance[1]>=256)this.hash+=BigInt(this.appearance[1])-256n>>8n;for(let R=0;R<5;R++)this.hash<<=0x3n,this.hash+=BigInt(this.colour[R]);this.hash<<=0x1n,this.hash+=BigInt(this.gender)}getModel(u){if(!this.visible)return null;let R=this.getAnimatedModel();if(R==null)return null;if(this.height=R.minY,R.picking=!0,this.lowMemory)return R;if(this.spotanimId!=-1&&this.spotanimFrame!=-1){let m=q0.types[this.spotanimId],_=m.getModel();if(_!=null){let b=J.modelShareColored(_,!0,!m.animHasAlpha,!1);if(b.translate(-this.spotanimHeight,0,0),b.createLabelReferences(),m.seq&&m.seq.frames)b.applyTransform(m.seq.frames[this.spotanimFrame]);if(b.labelFaces=null,b.labelVertices=null,m.resizeh!=128||m.resizev!=128)b.scale(m.resizev,m.resizeh,m.resizeh);b.calculateNormals(m.ambient+64,m.contrast+850,-30,-50,-30,!0);let E=[R,b];R=J.modelFromModelsBounds(E,2)}}if(this.locModel!=null){if(u>=this.locStopCycle)this.locModel=null;if(u>=this.locStartCycle&&u<this.locStopCycle){let m=this.locModel;if(m){if(m.translate(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),this.dstYaw==512)m.rotateY90(),m.rotateY90(),m.rotateY90();else if(this.dstYaw==1024)m.rotateY90(),m.rotateY90();else if(this.dstYaw==1536)m.rotateY90();let _=[R,m];if(R=J.modelFromModelsBounds(_,2),this.dstYaw==512)m.rotateY90();else if(this.dstYaw==1024)m.rotateY90(),m.rotateY90();else if(this.dstYaw==1536)m.rotateY90(),m.rotateY90(),m.rotateY90();m.translate(this.y-this.locOffsetY,super.x-this.locOffsetX,super.z-this.locOffsetZ)}}}return R.picking=!0,R}getAnimatedModel(){let u=this.hash,R=-1,m=-1,_=-1,b=-1;if(this.primarySeqId>=0&&this.primarySeqDelay===0){let I=o.types[this.primarySeqId];if(I.frames)R=I.frames[this.primarySeqFrame];if(this.secondarySeqId>=0&&this.secondarySeqId!==this.readyanim){let L=o.types[this.secondarySeqId].frames;if(L)m=L[this.secondarySeqFrame]}if(I.righthand>=0)_=I.righthand,u+=BigInt(_-this.appearance[5])<<40n;if(I.lefthand>=0)b=I.lefthand,u+=BigInt(b-this.appearance[3])<<48n}else if(this.secondarySeqId>=0){let I=o.types[this.secondarySeqId].frames;if(I)R=I[this.secondarySeqFrame]}let E=Q0.modelCache?.get(u);if(!E){let I=!1;for(let L=0;L<12;L++){let H=this.appearance[L];if(b>=0&&L==3)H=b;if(_>=0&&L==5)H=_;if(H>=256&&H<512&&!K0.types[H-256].modelIsReady())I=!0;if(H>=512&&!l.get(H-512).wornModelIsReady(this.gender))I=!0}if(I){if(this.modelCacheKey!==-1n&&Q0.modelCache)E=Q0.modelCache.get(this.hash);if(E==null)return null}}if(!E){let I=new p(12,null),L=0;for(let H=0;H<12;H++){let N=this.appearance[H];if(b>=0&&H===3)N=b;if(_>=0&&H===5)N=_;if(N>=256&&N<512){let G=K0.types[N-256].getModel();if(G)I[L++]=G}if(N>=512){let Q=l.get(N-512).getWornModel(this.gender);if(Q)I[L++]=Q}}E=J.modelFromModels(I,L);for(let H=0;H<5;H++){if(this.colour[H]===0)continue;if(E.recolour(Q0.DESIGN_IDK_COLORS[H][0],Q0.DESIGN_IDK_COLORS[H][this.colour[H]]),H===1)E.recolour(Q0.TORSO_RECOLORS[0],Q0.TORSO_RECOLORS[this.colour[H]])}E.createLabelReferences(),E.calculateNormals(64,850,-30,-50,-30,!0),Q0.modelCache?.put(u,E),this.modelCacheKey=u}if(this.lowMemory)return E;let O=J.modelShareAlpha(E,!0);if(R!==-1&&m!==-1)O.applyTransforms(R,m,o.types[this.primarySeqId].walkmerge);else if(R!==-1)O.applyTransform(R);return O.calculateBoundsCylinder(),O.labelFaces=null,O.labelVertices=null,O}getHeadModel(){if(!this.visible)return null;let u=!1;for(let b=0;b<12;b++){let E=this.appearance[b];if(E>=256&&E<512&&!K0.types[E-256].headModelIsReady())u=!0;if(E>=512&&!l.get(E-512).headModelIsReady(this.gender))u=!0}if(u)return null;let R=new p(12,null),m=0;for(let b=0;b<12;b++){let E=this.appearance[b];if(E>=256&&E<512){let O=K0.types[E-256].getHeadModel();if(O)R[m++]=O}if(E>=512){let O=l.get(E-512).getHeadModel(this.gender);if(O)R[m++]=O}}let _=J.modelFromModels(R,m);for(let b=0;b<5;b++){if(this.colour[b]===0)continue;if(_.recolour(Q0.DESIGN_IDK_COLORS[b][0],Q0.DESIGN_IDK_COLORS[b][this.colour[b]]),b===1)_.recolour(Q0.TORSO_RECOLORS[0],Q0.TORSO_RECOLORS[this.colour[b]])}return _}isVisible(){return this.visible}}class T1 extends n0{endTime=-1;newType=0;newAngle=0;newShape=0;level=0;layer=0;x=0;z=0;oldType=0;oldAngle=0;oldShape=0;startTime=0}class l0 extends j0{index;count;constructor(u,R){super();this.index=u,this.count=R}getModel(){return l.get(this.index).getModel(this.count)}}class $1 extends j0{spotanim;projLevel;srcX;srcZ;srcY;projOffsetY;startCycle;lastCycle;peakPitch;projArc;projTarget;mobile=!1;x=0;z=0;y=0;projVelocityX=0;projVelocityZ=0;projVelocity=0;projVelocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(u,R,m,_,b,E,O,I,L,H,N){super();this.spotanim=q0.types[u],this.projLevel=R,this.srcX=m,this.srcZ=b,this.srcY=_,this.startCycle=E,this.lastCycle=O,this.peakPitch=I,this.projArc=L,this.projTarget=H,this.projOffsetY=N}updateVelocity(u,R,m,_){if(!this.mobile){let E=u-this.srcX,O=m-this.srcZ,I=Math.sqrt(E*E+O*O);this.x=this.srcX+E*this.projArc/I,this.z=this.srcZ+O*this.projArc/I,this.y=this.srcY}let b=this.lastCycle+1-_;if(this.projVelocityX=(u-this.x)/b,this.projVelocityZ=(m-this.z)/b,this.projVelocity=Math.sqrt(this.projVelocityX*this.projVelocityX+this.projVelocityZ*this.projVelocityZ),!this.mobile)this.projVelocityY=-this.projVelocity*Math.tan(this.peakPitch*0.02454369);this.accelerationY=(R-this.y-this.projVelocityY*b)*2/(b*b)}update(u){if(this.mobile=!0,this.x+=this.projVelocityX*u,this.z+=this.projVelocityZ*u,this.y+=this.projVelocityY*u+this.accelerationY*0.5*u*u,this.projVelocityY+=this.accelerationY*u,this.yaw=(Math.atan2(this.projVelocityX,this.projVelocityZ)*325.949+1024|0)&2047,this.pitch=(Math.atan2(this.projVelocityY,this.projVelocity)*325.949|0)&2047,!this.spotanim.seq)return;this.seqCycle+=u;while(this.seqCycle>this.spotanim.seq.getFrameDuration(this.seqFrame))if(this.seqCycle-=this.spotanim.seq.getFrameDuration(this.seqFrame)+1,this.seqFrame++,this.seqFrame>=this.spotanim.seq.frameCount)this.seqFrame=0}getModel(){let u=this.spotanim.getModel();if(!u)return null;let R=J.modelShareColored(u,!0,!this.spotanim.animHasAlpha,!1);if(this.spotanim.seq&&this.spotanim.seq.frames)R.createLabelReferences(),R.applyTransform(this.spotanim.seq.frames[this.seqFrame]),R.labelFaces=null,R.labelVertices=null;if(this.spotanim.resizeh!==128||this.spotanim.resizev!==128)R.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh);return R.rotateX(this.pitch),R.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,!0),R}}class J1 extends j0{spotType;spotLevel;x;z;y;startCycle;seqComplete=!1;seqFrame=0;seqCycle=0;constructor(u,R,m,_,b,E,O){super();this.spotType=q0.types[u],this.spotLevel=R,this.x=m,this.z=_,this.y=b,this.startCycle=E+O}update(u){if(!this.spotType.seq)return;for(this.seqCycle+=u;this.seqCycle>this.spotType.seq.getFrameDuration(this.seqFrame);)if(this.seqCycle-=this.spotType.seq.getFrameDuration(this.seqFrame)+1,this.seqFrame++,this.seqFrame>=this.spotType.seq.frameCount)this.seqFrame=0,this.seqComplete=!0}getModel(){let u=this.spotType.getModel();if(!u)return null;let R=J.modelShareColored(u,!0,!this.spotType.animHasAlpha,!1);if(!this.seqComplete&&this.spotType.seq&&this.spotType.seq.frames)R.createLabelReferences(),R.applyTransform(this.spotType.seq.frames[this.seqFrame]),R.labelFaces=null,R.labelVertices=null;if(this.spotType.resizeh!==128||this.spotType.resizev!==128)R.scale(this.spotType.resizeh,this.spotType.resizev,this.spotType.resizeh);if(this.spotType.angle!==0){if(this.spotType.angle===90)R.rotateY90();else if(this.spotType.angle===180)R.rotateY90(),R.rotateY90();else if(this.spotType.angle===270)R.rotateY90(),R.rotateY90(),R.rotateY90()}return R.calculateNormals(64+this.spotType.ambient,850+this.spotType.contrast,-30,-50,-30,!0),R}}class K1{seed;constructor(u){this.seed=(u^0x5deece66dn)&(1n<<48n)-1n}setSeed(u){this.seed=(u^0x5deece66dn)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(u){return this.seed=this.seed*0x5deece66dn+0xbn&(1n<<48n)-1n,Number(this.seed)>>>48-u}}class k0 extends V0{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new K1(BigInt(Date.now()));height2d=0;static{let u=navigator.userAgent.includes("Capacitor");for(let R=0;R<256;R++){let m=k0.CHARSET.indexOf(String.fromCharCode(R));if(u){if(m>=63)m--}if(m===-1)m=74;k0.CHARCODESET[R]=m}}static fromArchive(u,R){let m=new z(u.read(R+".dat")),_=new z(u.read("index.dat"));_.pos=m.g2()+4;let b=_.g1();if(b>0)_.pos+=(b-1)*3;let E=new k0;for(let O=0;O<94;O++){E.charOffsetX[O]=_.g1(),E.charOffsetY[O]=_.g1();let I=E.charMaskWidth[O]=_.g2(),L=E.charMaskHeight[O]=_.g2(),H=_.g1(),N=I*L;if(E.charMask[O]=new Int8Array(N),H===0)for(let G=0;G<I*L;G++)E.charMask[O][G]=m.g1b();else if(H===1)for(let G=0;G<I;G++)for(let Q=0;Q<L;Q++)E.charMask[O][G+Q*I]=m.g1b();if(L>E.height2d)E.height2d=L;E.charOffsetX[O]=1,E.charAdvance[O]=I+2;{let G=0;for(let Q=L/7|0;Q<L;Q++)G+=E.charMask[O][Q*I];if(G<=(L/7|0))E.charAdvance[O]--,E.charOffsetX[O]=0}{let G=0;for(let Q=L/7|0;Q<L;Q++)G+=E.charMask[O][I+Q*I-1];if(G<=(L/7|0))E.charAdvance[O]--}}E.charAdvance[94]=E.charAdvance[8];for(let O=0;O<256;O++)E.drawWidth[O]=E.charAdvance[k0.CHARCODESET[O]];return E}drawString(u,R,m,_){if(!m)return;u|=0,R|=0;let b=m.length;R-=this.height2d;for(let E=0;E<b;E++){let O=k0.CHARCODESET[m.charCodeAt(E)];if(O!==94)this.drawChar(this.charMask[O],u+this.charOffsetX[O],R+this.charOffsetY[O],this.charMaskWidth[O],this.charMaskHeight[O],_);u+=this.charAdvance[O]}}drawStringTaggable(u,R,m,_,b){u|=0,R|=0;let E=m.length;R-=this.height2d;for(let O=0;O<E;O++)if(m.charAt(O)==="@"&&O+4<E&&m.charAt(O+4)==="@")_=this.evaluateTag(m.substring(O+1,O+4)),O+=4;else{let I=k0.CHARCODESET[m.charCodeAt(O)];if(I!==94){if(b)this.drawChar(this.charMask[I],u+this.charOffsetX[I]+1,R+this.charOffsetY[I]+1,this.charMaskWidth[I],this.charMaskHeight[I],0);this.drawChar(this.charMask[I],u+this.charOffsetX[I],R+this.charOffsetY[I],this.charMaskWidth[I],this.charMaskHeight[I],_)}u+=this.charAdvance[I]}}stringWidth(u){if(!u)return 0;let R=u.length,m=0;for(let _=0;_<R;_++)if(u.charAt(_)==="@"&&_+4<R&&u.charAt(_+4)==="@")_+=4;else m+=this.drawWidth[u.charCodeAt(_)];return m}drawStringTaggableCenter(u,R,m,_,b){u|=0,R|=0,this.drawStringTaggable(u-(this.stringWidth(m)/2|0),R,m,_,b)}drawStringCenter(u,R,m,_){if(!m)return;u|=0,R|=0,this.drawString(u-(this.stringWidth(m)/2|0),R,m,_)}drawStringTooltip(u,R,m,_,b,E){u|=0,R|=0,this.random.setSeed(BigInt(E));let O=(this.random.nextInt()&31)+192,I=R-this.height2d;for(let L=0;L<m.length;L++)if(m.charAt(L)==="@"&&L+4<m.length&&m.charAt(L+4)==="@")_=this.evaluateTag(m.substring(L+1,L+4)),L+=4;else{let H=k0.CHARCODESET[m.charCodeAt(L)];if(H!==94){if(b)this.drawCharAlpha(u+this.charOffsetX[H]+1,I+this.charOffsetY[H]+1,this.charMaskWidth[H],this.charMaskHeight[H],0,192,this.charMask[H]);this.drawCharAlpha(u+this.charOffsetX[H],I+this.charOffsetY[H],this.charMaskWidth[H],this.charMaskHeight[H],_,O,this.charMask[H])}if(u+=this.charAdvance[H],(this.random.nextInt()&3)===0)u++}}drawStringRight(u,R,m,_,b=!0){if(u|=0,R|=0,b)this.drawString(u-this.stringWidth(m)+1,R+1,m,0);this.drawString(u-this.stringWidth(m),R,m,_)}drawCenteredWave(u,R,m,_,b){if(!m)return;u|=0,R|=0,u-=this.stringWidth(m)/2|0;let E=R-this.height2d;for(let O=0;O<m.length;O++){let I=k0.CHARCODESET[m.charCodeAt(O)];if(I!=94)this.drawChar(this.charMask[I],u+this.charOffsetX[I],E+this.charOffsetY[I]+(Math.sin(O/2+b/5)*5|0),this.charMaskWidth[I],this.charMaskHeight[I],_);u+=this.charAdvance[I]}}drawChar(u,R,m,_,b,E){R|=0,m|=0,_|=0,b|=0;let O=R+m*F.width2d,I=F.width2d-_,L=0,H=0;if(m<F.top){let N=F.top-m;b-=N,m=F.top,H+=N*_,O+=N*F.width2d}if(m+b>=F.bottom)b-=m+b+1-F.bottom;if(R<F.left){let N=F.left-R;_-=N,R=F.left,H+=N,O+=N,L+=N,I+=N}if(R+_>=F.right){let N=R+_+1-F.right;_-=N,L+=N,I+=N}if(_>0&&b>0)this.drawMask(_,b,u,H,L,F.pixels,O,I,E)}drawCharAlpha(u,R,m,_,b,E,O){u|=0,R|=0,m|=0,_|=0;let I=u+R*F.width2d,L=F.width2d-m,H=0,N=0;if(R<F.top){let G=F.top-R;_-=G,R=F.top,N+=G*m,I+=G*F.width2d}if(R+_>=F.bottom)_-=R+_+1-F.bottom;if(u<F.left){let G=F.left-u;m-=G,u=F.left,N+=G,I+=G,H+=G,L+=G}if(u+m>=F.right){let G=u+m+1-F.right;m-=G,H+=G,L+=G}if(m>0&&_>0)this.drawMaskAlpha(m,_,F.pixels,I,L,O,N,H,b,E)}drawMask(u,R,m,_,b,E,O,I,L){u|=0,R|=0;let H=-(u>>2);u=-(u&3);for(let N=-R;N<0;N++){for(let G=H;G<0;G++){if(m[_++]===0)O++;else E[O++]=L;if(m[_++]===0)O++;else E[O++]=L;if(m[_++]===0)O++;else E[O++]=L;if(m[_++]===0)O++;else E[O++]=L}for(let G=u;G<0;G++)if(m[_++]===0)O++;else E[O++]=L;O+=I,_+=b}}drawMaskAlpha(u,R,m,_,b,E,O,I,L,H){u|=0,R|=0;let N=((L&16711935)*H&4278255360)+((L&65280)*H&16711680)>>8,G=256-H;for(let Q=-R;Q<0;Q++){for(let $=-u;$<0;$++)if(E[O++]===0)_++;else{let T=m[_];m[_++]=(((T&16711935)*G&4278255360)+((T&65280)*G&16711680)>>8)+N}_+=b,O+=I}}evaluateTag(u){if(u==="red")return 16711680;else if(u==="gre")return 65280;else if(u==="blu")return 255;else if(u==="yel")return 16776960;else if(u==="cya")return 65535;else if(u==="mag")return 16711935;else if(u==="whi")return 16777215;else if(u==="bla")return 0;else if(u==="lre")return 16748608;else if(u==="dre")return 8388608;else if(u==="dbl")return 128;else if(u==="or1")return 16756736;else if(u==="or2")return 16740352;else if(u==="or3")return 16723968;else if(u==="gr1")return 12648192;else if(u==="gr2")return 8453888;else if(u==="gr3")return 4259584;else return 0}split(u,R){if(u.length===0)return[u];let m=[];while(u.length>0){if(this.stringWidth(u)<=R&&u.indexOf("|")===-1){m.push(u);break}let b=u.length;for(let E=0;E<u.length;E++)if(u[E]===" "){if(this.stringWidth(u.substring(0,E))>R)break;b=E}else if(u[E]==="|"){b=E;break}m.push(u.substring(0,b)),u=u.substring(b+1)}return m}}class z0{socket;wsin;wsout;closed=!1;ioerror=!1;static async openSocket(u,R){return await new Promise((m,_)=>{let E=new WebSocket(`${R?"wss":"ws"}://${u}`,"binary");E.addEventListener("open",()=>{m(E)}),E.addEventListener("error",()=>{_(E)})})}constructor(u){u.onclose=this.onclose,u.onerror=this.onerror,this.wsin=new s1(u,5000),this.wsout=new P1(u,5000),this.socket=u}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(u,R){if(!this.closed)this.wsout.write(u,R)}async read(){return this.closed?0:await this.wsin.read()}async readBytes(u,R,m){if(this.closed)return;await this.wsin.readBytes(u,R,m)}close(){this.closed=!0,this.socket.close(),this.wsin.close(),this.wsout.close()}onclose=(u)=>{if(this.closed)return;this.close()};onerror=(u)=>{if(this.closed)return;this.ioerror=!0,this.close()}}class P1{socket;limit;closed=!1;ioerror=!1;constructor(u,R){this.socket=u,this.limit=R}write(u,R){if(this.closed)return;if(this.ioerror)throw this.ioerror=!1,new Error;if(R>this.limit||u.length>this.limit)throw new Error;try{this.socket.send(u.slice(0,R))}catch(m){this.ioerror=!0}}close(){this.closed=!0}}class g1{bytes;position;constructor(u){this.bytes=u,this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class s1{limit;queue=[];event=null;callback=null;closed=!1;total=0;constructor(u,R){this.limit=R,u.binaryType="arraybuffer",u.onmessage=this.onmessage}get available(){return this.total}onmessage=(u)=>{if(this.closed)throw new Error;let R=new g1(new Uint8Array(u.data));if(this.total+=R.available,this.callback){let m=this.callback;this.callback=null,m(R)}else this.queue.push(R)};async read(){if(this.closed)throw new Error;return await Promise.race([new Promise((u)=>{if(!this.event||this.event.available===0)this.event=this.queue.shift()??null;if(this.event&&this.event.available>0)u(this.event.read),this.total--;else this.callback=(R)=>{this.event=R,this.total--,u(R.read)}}),new Promise((u,R)=>{setTimeout(()=>{if(this.closed)R(new Error);else R(new Error)},20000)})])}async readBytes(u,R,m){if(this.closed)throw new Error;for(let _=0;_<m;_++)u[R+_]=await this.read();return u}close(){this.closed=!0,this.callback=null,this.event=null,this.queue=[]}}class o0{db;constructor(u){u.onerror=this.onerror,u.onclose=this.onclose,this.db=u}static async openDatabase(){return await new Promise((u,R)=>{let m=indexedDB.open("lostcity",1);m.onsuccess=(_)=>{let b=_.target;u(b.result)},m.onupgradeneeded=(_)=>{_.target.result.createObjectStore("cache")},m.onerror=(_)=>{let b=_.target;R(b.result)}})}async read(u,R){return await new Promise((m)=>{let E=this.db.transaction("cache","readonly").objectStore("cache").get(`${u}.${R}`);E.onsuccess=()=>{if(E.result)m(new Uint8Array(E.result));else m(void 0)},E.onerror=()=>{m(void 0)}})}async cacheload(u){return await new Promise((R)=>{let b=this.db.transaction("cache","readonly").objectStore("cache").get(u);b.onsuccess=()=>{if(b.result)R(new Uint8Array(b.result));else R(void 0)},b.onerror=()=>{R(void 0)}})}async write(u,R,m){if(m===null)return;return await new Promise((_,b)=>{let I=this.db.transaction("cache","readwrite").objectStore("cache").put(m,`${u}.${R}`);I.onsuccess=()=>{_()},I.onerror=()=>{_()}})}async cachesave(u,R){if(R===null)return;return await new Promise((m,_)=>{let O=this.db.transaction("cache","readwrite").objectStore("cache").put(R,u);O.onsuccess=()=>{m()},O.onerror=()=>{m()}})}onclose=(u)=>{};onerror=(u)=>{}}class e0{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(u){for(let R=0;R<u.length;R++)this.rsl[R]=u[R];this.init()}get nextInt(){if(this.count--===0)this.isaac(),this.count=255;return this.rsl[this.count]}init(){let u=2654435769,R=2654435769,m=2654435769,_=2654435769,b=2654435769,E=2654435769,O=2654435769,I=2654435769;for(let L=0;L<4;L++)u^=R<<11,_+=u,R+=m,R^=m>>>2,b+=R,m+=_,m^=_<<8,E+=m,_+=b,_^=b>>>16,O+=_,b+=E,b^=E<<10,I+=b,E+=O,E^=O>>>4,u+=E,O+=I,O^=I<<8,R+=O,I+=u,I^=u>>>9,m+=I,u+=R;for(let L=0;L<256;L+=8)u+=this.rsl[L],R+=this.rsl[L+1],m+=this.rsl[L+2],_+=this.rsl[L+3],b+=this.rsl[L+4],E+=this.rsl[L+5],O+=this.rsl[L+6],I+=this.rsl[L+7],u^=R<<11,_+=u,R+=m,R^=m>>>2,b+=R,m+=_,m^=_<<8,E+=m,_+=b,_^=b>>>16,O+=_,b+=E,b^=E<<10,I+=b,E+=O,E^=O>>>4,u+=E,O+=I,O^=I<<8,R+=O,I+=u,I^=u>>>9,m+=I,u+=R,this.mem[L]=u,this.mem[L+1]=R,this.mem[L+2]=m,this.mem[L+3]=_,this.mem[L+4]=b,this.mem[L+5]=E,this.mem[L+6]=O,this.mem[L+7]=I;for(let L=0;L<256;L+=8)u+=this.mem[L],R+=this.mem[L+1],m+=this.mem[L+2],_+=this.mem[L+3],b+=this.mem[L+4],E+=this.mem[L+5],O+=this.mem[L+6],I+=this.mem[L+7],u^=R<<11,_+=u,R+=m,R^=m>>>2,b+=R,m+=_,m^=_<<8,E+=m,_+=b,_^=b>>>16,O+=_,b+=E,b^=E<<10,I+=b,E+=O,E^=O>>>4,u+=E,O+=I,O^=I<<8,R+=O,I+=u,I^=u>>>9,m+=I,u+=R,this.mem[L]=u,this.mem[L+1]=R,this.mem[L+2]=m,this.mem[L+3]=_,this.mem[L+4]=b,this.mem[L+5]=E,this.mem[L+6]=O,this.mem[L+7]=I;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let u=0;u<256;u++){let R=this.mem[u],m=u&3;if(m===0)this.a^=this.a<<13;else if(m===1)this.a^=this.a>>>6;else if(m===2)this.a^=this.a<<2;else if(m===3)this.a^=this.a>>>16;this.a+=this.mem[u+128&255];let _;this.mem[u]=_=this.mem[R>>>2&255]+this.a+this.b,this.rsl[u]=this.b=this.mem[_>>>8>>>2&255]+R}}}import{BZip2 as v1}from"./deps.js";class y0{static genHash(u){let R=0;u=u.toUpperCase();for(let m=0;m<u.length;m++)R=R*61+u.charCodeAt(m)-32|0;return R}jagSrc;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(u){let R=new z(new Uint8Array(u)),m=R.g3(),_=R.g3();if(m===_)this.jagSrc=u,this.compressedWhole=!1;else this.jagSrc=v1.decompress(u.subarray(6),m,!0),R=new z(new Uint8Array(this.jagSrc)),this.compressedWhole=!0;this.fileCount=R.g2(),this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let b=R.pos+this.fileCount*10;for(let E=0;E<this.fileCount;E++)this.fileHash.push(R.g4()),this.fileUnpackedSize.push(R.g3()),this.filePackedSize.push(R.g3()),this.fileOffset.push(b),b+=this.filePackedSize[E]}read(u){let R=y0.genHash(u),m=this.fileHash.indexOf(R);if(m===-1)return null;return this.readIndex(m)}readIndex(u){if(u<0||u>=this.fileCount)return null;if(this.fileUnpacked[u])return this.fileUnpacked[u];let R=this.fileOffset[u],m=R+this.filePackedSize[u],_=new Uint8Array(this.jagSrc.subarray(R,R+m));if(this.compressedWhole)return this.fileUnpacked[u]=_,_;else{let b=v1.decompress(_,this.fileUnpackedSize[u],!0);return this.fileUnpacked[u]=b,b}}}var p1=[0,0,0,0,0,0,0,-2,0,3,2,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,14,-1,0,0,0,0,0,0,0,0,3,0,0,0,0,10,0,0,0,0,6,4,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,7,9,0,-2,0,0,0,0,0,4,0,0,0,0,0,0,2,-2,0,0,0,0,0,0,0,2,-1,0,1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,2,0,0,0,4,0,2,-2,0,0,0,0,15,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,-2,4,0,0,2,0,2,0,2,0,6,4,0,0,1,0,0,0,0,4,2,0,2,1,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,6,0,3,0,0,0,0,0,0,4,0,7,3,0,0,0,0,0,0,0,0,4,0,0,6,0,0,0,6,0,0,0,0,0,4,-2,5,0,3,0,0,0,2,6,0,0,-2,4,0,0,0,0,0,0,0,0,0];class D0{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((u)=>u.charCodeAt(0)));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((u)=>u.charCodeAt(0)));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((u)=>u.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack(u){let R=new z(u.read("fragmentsenc.txt")),m=new z(u.read("badenc.txt")),_=new z(u.read("domainenc.txt")),b=new z(u.read("tldlist.txt"));this.read(m,_,R,b)}static filter(u){let R=[...u];this.format(R);let m=R.join("").trim(),_=m.toLowerCase(),b=[..._];this.filterTlds(b),this.filterBadWords(b),this.filterDomains(b),this.filterFragments(b);for(let E=0;E<this.whitelist.length;E++){let O=-1;while((O=_.indexOf(this.whitelist[E],O+1))!==-1){let I=[...this.whitelist[E]];for(let L=0;L<I.length;L++)b[L+O]=I[L]}}return this.replaceUppercases(b,[...m]),this.formatUppercases(b),b.join("").trim()}static read(u,R,m,_){this.readBadWords(u),this.readDomains(R),this.readFragments(m),this.readTld(_)}static readTld(u){let R=u.g4();for(let m=0;m<R;m++)this.tldTypes[m]=u.g1(),this.tlds[m]=new Uint16Array(u.g1()).map(()=>u.g1())}static readBadWords(u){let R=u.g4();for(let m=0;m<R;m++){this.bads[m]=new Uint16Array(u.g1()).map(()=>u.g1());let _=new Array(u.g1()).fill([]).map(()=>[u.g1b(),u.g1b()]);if(_.length>0)this.badCombinations[m]=_}}static readDomains(u){let R=u.g4();for(let m=0;m<R;m++)this.domains[m]=new Uint16Array(u.g1()).map(()=>u.g1())}static readFragments(u){let R=u.g4();for(let m=0;m<R;m++)this.fragments[m]=u.g2()}static filterTlds(u){let R=[...u],m=[...u];this.filterBadCombinations(null,R,this.PERIOD),this.filterBadCombinations(null,m,this.SLASH);for(let _=0;_<this.tlds.length;_++)this.filterTld(m,this.tldTypes[_],u,this.tlds[_],R)}static filterBadWords(u){for(let R=0;R<2;R++)for(let m=this.bads.length-1;m>=0;m--)this.filterBadCombinations(this.badCombinations[m],u,this.bads[m])}static filterDomains(u){let R=[...u],m=[...u];this.filterBadCombinations(null,R,this.AMPERSAT),this.filterBadCombinations(null,m,this.PERIOD);for(let _=this.domains.length-1;_>=0;_--)this.filterDomain(m,R,this.domains[_],u)}static filterFragments(u){for(let R=0;R<u.length;){let m=this.indexOfNumber(u,R);if(m===-1)return;let _=!1;for(let O=R;O>=0&&O<m&&!_;O++)if(!this.isSymbol(u[O])&&!this.isNotLowercaseAlpha(u[O]))_=!0;let b=0;if(_)b=0;if(b===0)b=1,R=m;let E=0;for(let O=m;O<u.length&&O<R;O++)E=E*10+u[O].charCodeAt(0)-48;if(E<=255&&R-m<=8)b++;else b=0;if(b===4)this.maskChars(m,R,u),b=0;R=this.indexOfNonNumber(R,u)}}static isBadFragment(u){if(this.isNumericalChars(u))return!0;let R=this.getInteger(u),m=this.fragments,_=m.length;if(R===m[0]||R===m[_-1])return!0;let b=0,E=_-1;while(b<=E){let O=(b+E)/2|0;if(R===m[O])return!0;else if(R<m[O])E=O-1;else b=O+1}return!1}static getInteger(u){if(u.length>6)return 0;let R=0;for(let m=0;m<u.length;m++){let _=u[u.length-m-1];if(this.isLowercaseAlpha(_))R=R*38+_.charCodeAt(0)+1-97;else if(_==="'")R=R*38+27;else if(this.isNumerical(_))R=R*38+_.charCodeAt(0)+28-48;else if(_!=="\x00")return 0}return R}static indexOfNumber(u,R){for(let m=R;m<u.length&&m>=0;m++)if(this.isNumerical(u[m]))return m;return-1}static indexOfNonNumber(u,R){for(let m=u;m<R.length&&m>=0;m++)if(!this.isNumerical(R[m]))return m;return R.length}static getEmulatedDomainCharLen(u,R,m){if(R===m)return 1;else if(R==="o"&&m==="0")return 1;else if(R==="o"&&m==="("&&u===")")return 2;else if(R==="c"&&(m==="("||m==="<"||m==="["))return 1;else if(R==="e"&&m==="€")return 1;else if(R==="s"&&m==="$")return 1;else if(R==="l"&&m==="i")return 1;return 0}static filterDomain(u,R,m,_){let b=m.length,E=_.length;for(let O=0;O<=E-b;O++){let{matched:I,currentIndex:L}=this.findMatchingDomain(O,m,_);if(!I)continue;let H=this.prefixSymbolStatus(O,_,3,R,["@"]),N=this.suffixSymbolStatus(L-1,_,3,u,[".",","]);if(!(H>2||N>2))continue;this.maskChars(O,L,_)}}static findMatchingDomain(u,R,m){let _=R.length,b=u,E=0;while(b<m.length&&E<_){let O=m[b],I=b+1<m.length?m[b+1]:"\x00",L=this.getEmulatedDomainCharLen(I,String.fromCharCode(R[E]),O);if(L>0)b+=L,E++;else{if(E===0)break;let H=this.getEmulatedDomainCharLen(I,String.fromCharCode(R[E-1]),O);if(H>0){if(b+=H,E===1)u++}else{if(E>=_||!this.isSymbol(O))break;b++}}}return{matched:E>=_,currentIndex:b}}static filterBadCombinations(u,R,m){if(m.length>R.length)return;for(let _=0;_<=R.length-m.length;_++){let b=_,{currentIndex:E,badIndex:O,hasSymbol:I,hasNumber:L,hasDigit:H}=this.processBadCharacters(R,m,b);b=E;let N=R[b],G=b+1<R.length?R[b+1]:"\x00";if(!(O>=m.length&&(!L||!H)))continue;let Q=!0,$;if(I){let K=!1,q=!1;if(_-1<0||this.isSymbol(R[_-1])&&R[_-1]!=="'")K=!0;if(b>=R.length||this.isSymbol(R[b])&&R[b]!=="'")q=!0;if(!K||!q){let w=!1;if($=_-2,K)$=_;while(!w&&$<b){if($>=0&&(!this.isSymbol(R[$])||R[$]==="'")){let V=[],Y;for(Y=0;Y<3&&$+Y<R.length&&(!this.isSymbol(R[$+Y])||R[$+Y]==="'");Y++)V[Y]=R[$+Y];let A=!0;if(Y===0)A=!1;if(Y<3&&$-1>=0&&(!this.isSymbol(R[$-1])||R[$-1]==="'"))A=!1;if(A&&!this.isBadFragment(V))w=!0}$++}if(!w)Q=!1}}else{if(N=" ",_-1>=0)N=R[_-1];if(G=" ",b<R.length)G=R[b];let K=this.getIndex(N),q=this.getIndex(G);if(u&&this.comboMatches(K,u,q))Q=!1}if(!Q)continue;let T=0,U=0;for(let K=_;K<b;K++)if(this.isNumerical(R[K]))T++;else if(this.isAlpha(R[K]))U++;if(T<=U)this.maskChars(_,b,R)}}static processBadCharacters(u,R,m){let _=m,b=0,E=0,O=!1,I=!1,L=!1;for(;_<u.length&&!(I&&L);){if(_>=u.length||I&&L)break;let H=u[_],N=_+1<u.length?u[_+1]:"\x00",G;if(b<R.length&&(G=this.getEmulatedBadCharLen(N,String.fromCharCode(R[b]),H))>0){if(G===1&&this.isNumerical(H))I=!0;if(G===2&&(this.isNumerical(H)||this.isNumerical(N)))I=!0;_+=G,b++}else{if(b===0)break;let Q;if((Q=this.getEmulatedBadCharLen(N,String.fromCharCode(R[b-1]),H))>0)_+=Q;else{if(b>=R.length||!this.isNotLowercaseAlpha(H))break;if(this.isSymbol(H)&&H!=="'")O=!0;if(this.isNumerical(H))L=!0;if(_++,E++,(E*100/(_-m)|0)>90)break}}}return{currentIndex:_,badIndex:b,hasSymbol:O,hasNumber:I,hasDigit:L}}static getEmulatedBadCharLen(u,R,m){if(R===m)return 1;if(R>="a"&&R<="m"){if(R==="a"){if(m!=="4"&&m!=="@"&&m!=="^"){if(m==="/"&&u==="\\")return 2;return 0}return 1}if(R==="b"){if(m!=="6"&&m!=="8"){if(m==="1"&&u==="3")return 2;return 0}return 1}if(R==="c"){if(m!=="("&&m!=="<"&&m!=="{"&&m!=="[")return 0;return 1}if(R==="d"){if(m==="["&&u===")")return 2;return 0}if(R==="e"){if(m!=="3"&&m!=="€")return 0;return 1}if(R==="f"){if(m==="p"&&u==="h")return 2;if(m==="£")return 1;return 0}if(R==="g"){if(m!=="9"&&m!=="6")return 0;return 1}if(R==="h"){if(m==="#")return 1;return 0}if(R==="i"){if(m!=="y"&&m!=="l"&&m!=="j"&&m!=="1"&&m!=="!"&&m!==":"&&m!==";"&&m!=="|")return 0;return 1}if(R==="j")return 0;if(R==="k")return 0;if(R==="l"){if(m!=="1"&&m!=="|"&&m!=="i")return 0;return 1}if(R==="m")return 0}if(R>="n"&&R<="z"){if(R==="n")return 0;if(R==="o"){if(m!=="0"&&m!=="*"){if((m!=="("||u!==")")&&(m!=="["||u!=="]")&&(m!=="{"||u!=="}")&&(m!=="<"||u!==">"))return 0;return 2}return 1}if(R==="p")return 0;if(R==="q")return 0;if(R==="r")return 0;if(R==="s"){if(m!=="5"&&m!=="z"&&m!=="$"&&m!=="2")return 0;return 1}if(R==="t"){if(m!=="7"&&m!=="+")return 0;return 1}if(R==="u"){if(m==="v")return 1;if((m!=="\\"||u!=="/")&&(m!=="\\"||u!=="|")&&(m!=="|"||u!=="/"))return 0;return 2}if(R==="v"){if((m!=="\\"||u!=="/")&&(m!=="\\"||u!=="|")&&(m!=="|"||u!=="/"))return 0;return 2}if(R==="w"){if(m==="v"&&u==="v")return 2;return 0}if(R==="x"){if((m!==")"||u!=="(")&&(m!=="}"||u!=="{")&&(m!=="]"||u!=="[")&&(m!==">"||u!=="<"))return 0;return 2}if(R==="y")return 0;if(R==="z")return 0}if(R>="0"&&R<="9")if(R==="0")if(m==="o"||m==="O")return 1;else if((m!=="("||u!==")")&&(m!=="{"||u!=="}")&&(m!=="["||u!=="]"))return 0;else return 2;else if(R==="1")return m==="l"?1:0;else return 0;else if(R===",")return m==="."?1:0;else if(R===".")return m===","?1:0;else if(R==="!")return m==="i"?1:0;return 0}static comboMatches(u,R,m){let _=0,b=R.length-1;while(_<=b){let E=(_+b)/2|0;if(R[E][0]===u&&R[E][1]===m)return!0;else if(u<R[E][0]||u===R[E][0]&&m<R[E][1])b=E-1;else _=E+1}return!1}static getIndex(u){if(this.isLowercaseAlpha(u))return u.charCodeAt(0)+1-97;else if(u==="'")return 28;else if(this.isNumerical(u))return u.charCodeAt(0)+29-48;return 27}static filterTld(u,R,m,_,b){if(_.length>m.length)return;for(let E=0;E<=m.length-_.length;E++){let{currentIndex:O,tldIndex:I}=this.processTlds(m,_,E);if(I<_.length)continue;let L=!1,H=this.prefixSymbolStatus(E,m,3,b,[",","."]),N=this.suffixSymbolStatus(O-1,m,5,u,["\\","/"]);if(R===1&&H>0&&N>0)L=!0;if(R===2&&(H>2&&N>0||H>0&&N>2))L=!0;if(R===3&&H>0&&N>2)L=!0;if(!L)continue;let G=E,Q=O-1,$=!1,T;if(H>2){if(H===4){$=!1;for(T=E-1;T>=0;T--)if($){if(b[T]!=="*")break;G=T}else if(b[T]==="*")G=T,$=!0}$=!1;for(T=G-1;T>=0;T--)if($){if(this.isSymbol(m[T]))break;G=T}else if(!this.isSymbol(m[T]))$=!0,G=T}if(N>2){if(N===4){$=!1;for(T=Q+1;T<m.length;T++)if($){if(u[T]!=="*")break;Q=T}else if(u[T]==="*")Q=T,$=!0}$=!1;for(T=Q+1;T<m.length;T++)if($){if(this.isSymbol(m[T]))break;Q=T}else if(!this.isSymbol(m[T]))$=!0,Q=T}this.maskChars(G,Q+1,m)}}static processTlds(u,R,m){let _=0;while(m<u.length&&_<R.length){let b=u[m],E=m+1<u.length?u[m+1]:"\x00",O;if((O=this.getEmulatedDomainCharLen(E,String.fromCharCode(R[_]),b))>0)m+=O,_++;else{if(_===0)break;let I;if((I=this.getEmulatedDomainCharLen(E,String.fromCharCode(R[_-1]),b))>0)m+=I;else{if(!this.isSymbol(b))break;m++}}}return{currentIndex:m,tldIndex:_}}static isSymbol(u){return!this.isAlpha(u)&&!this.isNumerical(u)}static isNotLowercaseAlpha(u){return this.isLowercaseAlpha(u)?u==="v"||u==="x"||u==="j"||u==="q"||u==="z":!0}static isAlpha(u){return this.isLowercaseAlpha(u)||this.isUppercaseAlpha(u)}static isNumerical(u){return u>="0"&&u<="9"}static isLowercaseAlpha(u){return u>="a"&&u<="z"}static isUppercaseAlpha(u){return u>="A"&&u<="Z"}static isNumericalChars(u){for(let R=0;R<u.length;R++)if(!this.isNumerical(u[R])&&u[R]!=="\x00")return!1;return!0}static maskChars(u,R,m){for(let _=u;_<R;_++)m[_]="*"}static maskedCountBackwards(u,R){let m=0;for(let _=R-1;_>=0&&this.isSymbol(u[_]);_--)if(u[_]==="*")m++;return m}static maskedCountForwards(u,R){let m=0;for(let _=R+1;_<u.length&&this.isSymbol(u[_]);_++)if(u[_]==="*")m++;return m}static maskedCharsStatus(u,R,m,_,b){if((b?this.maskedCountBackwards(R,m):this.maskedCountForwards(R,m))>=_)return 4;else if(this.isSymbol(b?u[m-1]:u[m+1]))return 1;return 0}static prefixSymbolStatus(u,R,m,_,b){if(u===0)return 2;for(let E=u-1;E>=0&&this.isSymbol(R[E]);E--)if(b.includes(R[E]))return 3;return this.maskedCharsStatus(R,_,u,m,!0)}static suffixSymbolStatus(u,R,m,_,b){if(u+1===R.length)return 2;for(let E=u+1;E<R.length&&this.isSymbol(R[E]);E++)if(b.includes(R[E]))return 3;return this.maskedCharsStatus(R,_,u,m,!1)}static format(u){let R=0;for(let m=0;m<u.length;m++){if(this.isCharacterAllowed(u[m]))u[R]=u[m];else u[R]=" ";if(R===0||u[R]!==" "||u[R-1]!==" ")R++}for(let m=R;m<u.length;m++)u[m]=" "}static isCharacterAllowed(u){return u>=" "&&u<=""||u===" "||u===`
`||u==="\t"||u==="£"||u==="€"}static replaceUppercases(u,R){for(let m=0;m<R.length;m++)if(u[m]!=="*"&&this.isUppercaseAlpha(R[m]))u[m]=R[m]}static formatUppercases(u){let R=!0;for(let m=0;m<u.length;m++){let _=u[m];if(!this.isAlpha(_))R=!0;else if(R){if(this.isLowercaseAlpha(_))R=!1}else if(this.isUppercaseAlpha(_))u[m]=String.fromCharCode(_.charCodeAt(0)+97-65)}}}class v0{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","£","$","%",'"',"[","]"];static charBuffer=[];static unpack(u,R){let m=0,_=-1,b;for(let O=0;O<R&&m<100;O++){let I=u.g1();if(b=I>>4&15,_!==-1)this.charBuffer[m++]=this.TABLE[(_<<4)+b-195],_=-1;else if(b<13)this.charBuffer[m++]=this.TABLE[b];else _=b;if(b=I&15,_!==-1)this.charBuffer[m++]=this.TABLE[(_<<4)+b-195],_=-1;else if(b<13)this.charBuffer[m++]=this.TABLE[b];else _=b}let E=!0;for(let O=0;O<m;O++){let I=this.charBuffer[O];if(E&&I>="a"&&I<="z")this.charBuffer[O]=I.toUpperCase(),E=!1;if(I==="."||I==="!")E=!0}return this.charBuffer.slice(0,m).join("")}static pack(u,R){if(R.length>80)R=R.substring(0,80);R=R.toLowerCase();let m=-1;for(let _=0;_<R.length;_++){let b=R.charAt(_),E=0;for(let O=0;O<this.TABLE.length;O++)if(b===this.TABLE[O]){E=O;break}if(E>12)E+=195;if(m===-1)if(E<13)m=E;else u.p1(E);else if(E<13)u.p1((m<<4)+E),m=-1;else u.p1((m<<4)+(E>>4)),m=E&15}if(m!==-1)u.p1(m<<4)}}class B0{length=0;shapeDelta=null;shapePeak=null;start=0;end=0;form=0;threshold=0;position=0;delta=0;amplitude=0;ticks=0;unpack(u){this.form=u.g1(),this.start=u.g4(),this.end=u.g4(),this.length=u.g1(),this.shapeDelta=new Int32Array(this.length),this.shapePeak=new Int32Array(this.length);for(let R=0;R<this.length;R++)this.shapeDelta[R]=u.g2(),this.shapePeak[R]=u.g2()}reset(){this.threshold=0,this.position=0,this.delta=0,this.amplitude=0,this.ticks=0}evaluate(u){if(this.ticks>=this.threshold&&this.shapePeak&&this.shapeDelta){if(this.amplitude=this.shapePeak[this.position++]<<15,this.position>=this.length)this.position=this.length-1;if(this.threshold=this.shapeDelta[this.position]/65536*u|0,this.threshold>this.ticks)this.delta=((this.shapePeak[this.position]<<15)-this.amplitude)/(this.threshold-this.ticks)|0}return this.amplitude+=this.delta,this.ticks++,this.amplitude-this.delta>>15}}class E0{frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;release=null;attack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);reverbDelay=0;reverbVolume=100;start=0;length=500;static buffer=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);static init(){this.noise=new Int32Array(32768);for(let u=0;u<32768;u++)if(Math.random()>0.5)this.noise[u]=1;else this.noise[u]=-1;this.sin=new Int32Array(32768);for(let u=0;u<32768;u++)this.sin[u]=Math.sin(u/5215.1903)*16384|0;this.buffer=new Int32Array(220500)}generate(u,R){if(!this.frequencyBase||!this.amplitudeBase)return E0.buffer;for(let H=0;H<u;H++)E0.buffer[H]=0;if(R<10)return E0.buffer;let m=u/R|0;this.frequencyBase.reset(),this.amplitudeBase.reset();let _=0,b=0,E=0;if(this.frequencyModRate&&this.frequencyModRange)this.frequencyModRate.reset(),this.frequencyModRange.reset(),_=(this.frequencyModRate.end-this.frequencyModRate.start)*32.768/m|0,b=this.frequencyModRate.start*32.768/m|0;let O=0,I=0,L=0;if(this.amplitudeModRate&&this.amplitudeModRange)this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),O=(this.amplitudeModRate.end-this.amplitudeModRate.start)*32.768/m|0,I=this.amplitudeModRate.start*32.768/m|0;for(let H=0;H<5;H++)if(this.frequencyBase&&this.harmonicVolume[H]!==0)E0.tmpPhases[H]=0,E0.tmpDelays[H]=this.harmonicDelay[H]*m,E0.tmpVolumes[H]=(this.harmonicVolume[H]<<14)/100|0,E0.tmpSemitones[H]=(this.frequencyBase.end-this.frequencyBase.start)*32.768*Math.pow(1.0057929410678534,this.harmonicSemitone[H])/m|0,E0.tmpStarts[H]=this.frequencyBase.start*32.768/m|0;for(let H=0;H<u;H++){let N=this.frequencyBase.evaluate(u),G=this.amplitudeBase.evaluate(u);if(this.frequencyModRate&&this.frequencyModRange){let Q=this.frequencyModRate.evaluate(u),$=this.frequencyModRange.evaluate(u);N+=this.generate2($,E,this.frequencyModRate.form)>>1,E+=(Q*_>>16)+b}if(this.amplitudeModRate&&this.amplitudeModRange){let Q=this.amplitudeModRate.evaluate(u),$=this.amplitudeModRange.evaluate(u);G=G*((this.generate2($,L,this.amplitudeModRate.form)>>1)+32768)>>15,L+=(Q*O>>16)+I}for(let Q=0;Q<5;Q++)if(this.harmonicVolume[Q]!==0){let $=H+E0.tmpDelays[Q];if($<u)E0.buffer[$]+=this.generate2(G*E0.tmpVolumes[Q]>>15,E0.tmpPhases[Q],this.frequencyBase.form),E0.tmpPhases[Q]+=(N*E0.tmpSemitones[Q]>>16)+E0.tmpStarts[Q]}}if(this.release&&this.attack){this.release.reset(),this.attack.reset();let H=0,N=!0;for(let G=0;G<u;G++){let Q=this.release.evaluate(u),$=this.attack.evaluate(u),T;if(N)T=this.release.start+((this.release.end-this.release.start)*Q>>8);else T=this.release.start+((this.release.end-this.release.start)*$>>8);if(H+=256,H>=T)H=0,N=!N;if(N)E0.buffer[G]=0}}if(this.reverbDelay>0&&this.reverbVolume>0){let H=this.reverbDelay*m;for(let N=H;N<u;N++)E0.buffer[N]+=E0.buffer[N-H]*this.reverbVolume/100|0,E0.buffer[N]|=0}for(let H=0;H<u;H++){if(E0.buffer[H]<-32768)E0.buffer[H]=-32768;if(E0.buffer[H]>32767)E0.buffer[H]=32767}return E0.buffer}generate2(u,R,m){if(m===1)return(R&32767)<16384?u:-u;else if(m===2)return E0.sin[R&32767]*u>>14;else if(m===3)return((R&32767)*u>>14)-u;else if(m===4)return E0.noise[(R/2607|0)&32767]*u;else return 0}unpack(u){if(this.frequencyBase=new B0,this.frequencyBase.unpack(u),this.amplitudeBase=new B0,this.amplitudeBase.unpack(u),u.g1()!==0)u.pos--,this.frequencyModRate=new B0,this.frequencyModRate.unpack(u),this.frequencyModRange=new B0,this.frequencyModRange.unpack(u);if(u.g1()!==0)u.pos--,this.amplitudeModRate=new B0,this.amplitudeModRate.unpack(u),this.amplitudeModRange=new B0,this.amplitudeModRange.unpack(u);if(u.g1()!==0)u.pos--,this.release=new B0,this.release.unpack(u),this.attack=new B0,this.attack.unpack(u);for(let R=0;R<10;R++){let m=u.gsmarts();if(m===0)break;this.harmonicVolume[R]=m,this.harmonicSemitone[R]=u.gsmart(),this.harmonicDelay[R]=u.gsmarts()}this.reverbDelay=u.gsmarts(),this.reverbVolume=u.gsmarts(),this.length=u.g2(),this.start=u.g2()}}class b0{static tracks=new p(1000,null);static delays=new Int32Array(1000);static waveBytes=new Uint8Array(441000);static waveBuffer=null;tones=new p(10,null);loopBegin=0;loopEnd=0;static unpack(u){let R=new z(u.read("sounds.dat"));this.waveBytes=new Uint8Array(441000),this.waveBuffer=new z(this.waveBytes),E0.init();while(!0){let m=R.g2();if(m===65535)break;this.tracks[m]=new b0,this.tracks[m].read(R),this.delays[m]=this.tracks[m].trim()}}static generate(u,R){if(!this.tracks[u])return null;return this.tracks[u]?.getWave(R)??null}read(u){for(let R=0;R<10;R++)if(u.g1()!==0)u.pos--,this.tones[R]=new E0,this.tones[R]?.unpack(u);this.loopBegin=u.g2(),this.loopEnd=u.g2()}trim(){let u=9999999;for(let R=0;R<10;R++)if(this.tones[R]&&(this.tones[R].start/20|0)<u)u=this.tones[R].start/20|0;if(this.loopBegin<this.loopEnd&&(this.loopBegin/20|0)<u)u=this.loopBegin/20|0;if(u===9999999||u===0)return 0;for(let R=0;R<10;R++)if(this.tones[R])this.tones[R].start-=u*20;if(this.loopBegin<this.loopEnd)this.loopBegin-=u*20,this.loopEnd-=u*20;return u}getWave(u){if(!b0.waveBuffer)return null;let R=this.generate(u);return b0.waveBuffer.pos=0,b0.waveBuffer.p4(1380533830),b0.waveBuffer.ip4(R+36),b0.waveBuffer.p4(1463899717),b0.waveBuffer.p4(1718449184),b0.waveBuffer.ip4(16),b0.waveBuffer.ip2(1),b0.waveBuffer.ip2(1),b0.waveBuffer.ip4(22050),b0.waveBuffer.ip4(22050),b0.waveBuffer.ip2(1),b0.waveBuffer.ip2(8),b0.waveBuffer.p4(1684108385),b0.waveBuffer.ip4(R),b0.waveBuffer.pos+=R,b0.waveBuffer}generate(u){let R=0;for(let O=0;O<10;O++)if(this.tones[O]&&this.tones[O].length+this.tones[O].start>R)R=this.tones[O].length+this.tones[O].start;if(R===0)return 0;let m=R*22050/1000|0,_=this.loopBegin*22050/1000|0,b=this.loopEnd*22050/1000|0;if(_<0||b<0||b>m||_>=b)u=0;let E=m+(b-_)*(u-1);for(let O=44;O<E+44;O++)if(b0.waveBytes)b0.waveBytes[O]=-128;for(let O=0;O<10;O++)if(this.tones[O]){let I=this.tones[O].length*22050/1000|0,L=this.tones[O].start*22050/1000|0,H=this.tones[O].generate(I,this.tones[O].length);for(let N=0;N<I;N++)if(b0.waveBytes)b0.waveBytes[N+L+44]+=H[N]>>8<<24>>24}if(u>1){_+=44,b+=44,m+=44,E+=44;let O=E-m;for(let I=m-1;I>=b;I--)if(b0.waveBytes)b0.waveBytes[I+O]=b0.waveBytes[I];for(let I=1;I<u;I++){let L=(b-_)*I;for(let H=_;H<b;H++)if(b0.waveBytes)b0.waveBytes[H+L]=b0.waveBytes[H]}E-=44}return E}}class q1{requestModel(u){}}class a0 extends V0{archive=0;file=0;data=null;cycle=0;urgent=!0}import{gunzipSync as e1,unzipSync as uu}from"./deps.js";class U1 extends q1{modernized=!0;versions=[];crcs=[];priorities=[];topPriority=0;models=[];mapIndex=[];mapLand=[];mapLoc=[];mapMembers=[];animIndex=[];midiIndex=[];running=!0;app;active=!1;importantCount=0;requestCount=0;requests=new C0;queue=new J0;missing=new J0;pending=new J0;completed=new J0;prefetches=new J0;message="";buf=new Uint8Array(500);data=new Uint8Array(65000);loadedPrefetchFiles=0;totalPrefetchFiles=0;partOffset=0;partAvailable=0;waitCycles=0;heartbeatCycle=0;cycle=0;socketOpenTime=0;current=null;stream=null;constructor(u,R){super();let m=["model_version","anim_version","midi_version","map_version"];for(let E=0;E<4;E++){let O=u.read(m[E]);if(!O)throw new Error;let I=O.length/2,L=new z(O);this.versions[E]=new Array(I),this.priorities[E]=new Array(I);for(let H=0;H<I;H++)this.versions[E][H]=L.g2()}let _=["model_crc","anim_crc","midi_crc","map_crc"];for(let E=0;E<4;E++){let O=u.read(_[E]);if(!O)throw new Error;let I=O.length/4,L=new z(O);this.crcs[E]=new Array(I);for(let H=0;H<I;H++)this.crcs[E][H]=L.g4()}let b=u.read("model_index");if(b){let E=this.versions[0].length;this.models=new Array(E);for(let O=0;O<E;O++)if(O<b.length)this.models[O]=b[O];else this.models[O]=0}if(b=u.read("map_index"),b){let E=b.length/7,O=new z(b);this.mapIndex=new Array(E),this.mapLand=new Array(E),this.mapLoc=new Array(E),this.mapMembers=new Array(E);for(let I=0;I<E;I++)this.mapIndex[I]=O.g2(),this.mapLand[I]=O.g2(),this.mapLoc[I]=O.g2(),this.mapMembers[I]=O.g1()}if(b=u.read("anim_index"),b){let E=b.length/2,O=new z(b);this.animIndex=new Array(E);for(let I=0;I<E;I++)this.animIndex[I]=O.g2()}if(b=u.read("midi_index"),b){let E=b.length,O=new z(b);this.midiIndex=new Array(E);for(let I=0;I<E;I++)this.midiIndex[I]=O.g1()}this.app=R,this.running=!0}stop(){this.running=!1}getFileCount(u){return this.versions[u].length}getAnimCount(){return this.animIndex.length}getMapFile(u,R,m){let _=(u<<8)+R;for(let b=0;b<this.mapIndex.length;b++)if(this.mapIndex[b]===_)if(m===0)return this.mapLand[b];else return this.mapLoc[b];return-1}async prefetchMaps(u){let R=this.mapIndex.length;for(let m=0;m<R;m++)if(u||this.mapMembers[m]!=0)await this.prefetchPriority(3,this.mapLoc[m],2),await this.prefetchPriority(3,this.mapLand[m],2)}hasMapLocFile(u){for(let R=0;R<this.mapIndex.length;R++)if(this.mapLoc[R]===u)return!0;return!1}getModelFlags(u){return this.models[u]&255}shouldPrefetchMidi(u){return this.midiIndex[u]===1}requestModel(u){this.request(0,u)}request(u,R){if(u<0||u>this.versions.length||R<0||R>this.versions[u].length||this.versions[u][R]==0)return;for(let _=this.requests.head();_!==null;_=this.requests.next())if(_.archive==u&&_.file==R)return;let m=new a0;m.archive=u,m.file=R,m.urgent=!0,this.queue.push(m),this.requests.push(m)}remaining(){return this.requests.size()}loop(){let u=this.completed.pop();if(u===null)return null;if(u.unlink2(),u.data===null)return u;return u.data=e1(u.data.slice(0,u.data.length-2)),u}async prefetchPriority(u,R,m){if(!this.app.db||this.versions[u][R]===0)return;let _=await this.app.db.read(u+1,R);if(this.validate(_,this.crcs[u][R],this.versions[u][R]))return;if(this.priorities[u][R]=m,m>this.topPriority)this.topPriority=m;this.totalPrefetchFiles++}clearPrefetches(){this.prefetches.clear()}prefetch(u,R){if(!this.app.db||this.versions[u][R]===0||this.priorities[u][R]===0||this.topPriority===0)return;let m=new a0;m.archive=u,m.file=R,m.urgent=!1,this.prefetches.push(m)}async run(){if(!this.running)return;this.cycle++,this.active=!0;for(let R=0;R<100&&this.active;R++){if(this.active=!1,await this.handleQueue(),await this.handlePending(),this.importantCount===0&&R>=5)break;await this.handleExtras(),await this.read()}let u=!1;for(let R=this.pending.head();R!==null;R=this.pending.next())if(R.urgent){if(u=!0,R.cycle++,R.cycle>50)R.cycle=0,this.send(R)}if(!u){for(let R=this.pending.head();R!==null;R=this.pending.next())if(u=!0,R.cycle++,R.cycle>50)R.cycle=0,this.send(R)}if(u){if(this.waitCycles++,this.waitCycles>750){if(this.stream)this.stream.close(),this.stream=null;this.partAvailable=0}}else this.waitCycles=0,this.message="";if(this.app.ingame&&this.stream&&(this.topPriority>0||!this.app.db)){if(this.heartbeatCycle++,this.heartbeatCycle>500)this.heartbeatCycle=0,this.buf[0]=0,this.buf[1]=0,this.buf[2]=0,this.buf[3]=10,this.stream.write(this.buf,4)}}async handleQueue(){let u=this.queue.pop();while(u!==null){this.active=!0;let R;if(this.app.db)R=await this.app.db.read(u.archive+1,u.file);if(!this.validate(R,this.crcs[u.archive][u.file],this.versions[u.archive][u.file]))R=void 0;if(!R)this.missing.push(u);else u.data=R,this.completed.push(u);u=this.queue.pop()}}async handlePending(){this.importantCount=0,this.requestCount=0;for(let u=this.pending.head();u!==null;u=this.pending.next())if(u.urgent)this.importantCount++;else this.requestCount++;while(this.importantCount<10){let u=this.missing.pop();if(u===null)break;if(this.priorities[u.archive][u.file]!==0)this.loadedPrefetchFiles++;this.priorities[u.archive][u.file]=0,this.pending.push(u),this.importantCount++,await this.send(u),this.active=!0}}async handleExtras(){while(this.importantCount===0&&this.requestCount<10){if(this.topPriority===0)return;let u=this.prefetches.pop();while(u!==null){if(this.priorities[u.archive][u.file]!=0){if(this.priorities[u.archive][u.file]=0,this.pending.push(u),await this.send(u),this.active=!0,this.loadedPrefetchFiles<this.totalPrefetchFiles)this.loadedPrefetchFiles++;if(this.message="Loading extra files - "+(this.loadedPrefetchFiles*100/this.totalPrefetchFiles|0)+"%",this.requestCount++,this.requestCount==10)return}u=this.prefetches.pop()}for(let R=0;R<4;R++){let m=this.priorities[R],_=m.length;for(let b=0;b<_;b++)if(m[b]==this.topPriority){m[b]=0;let E=new a0;if(E.archive=R,E.file=b,E.urgent=!1,this.pending.push(E),await this.send(E),this.active=!0,this.loadedPrefetchFiles<this.totalPrefetchFiles)this.loadedPrefetchFiles++;if(this.message="Loading extra files - "+(this.loadedPrefetchFiles*100/this.totalPrefetchFiles|0)+"%",this.requestCount++,this.requestCount==10)return}}this.topPriority--}}async read(){if(this.modernized){for(let u=this.pending.head();u!==null;u=this.pending.next()){this.current=u;break}if(this.current){if(this.current.data=await r0(`/${this.current.archive+1}/${this.current.file}`),this.app.db)this.app.db.write(this.current.archive+1,this.current.file,this.current.data);if(!this.current.urgent&&this.current.archive===3)this.current.urgent=!0,this.current.archive=93;if(this.current.urgent)this.completed.push(this.current);else this.current.unlink();this.current=null}}else{if(!this.stream)return;try{let u=this.stream.available;if(this.partAvailable===0&&u>=6){this.active=!0,await this.stream.readBytes(this.buf,0,6);let R=this.buf[0]&255,m=((this.buf[1]&255)<<8)+(this.buf[2]&255),_=((this.buf[3]&255)<<8)+(this.buf[4]&255),b=this.buf[5]&255;this.current=null;for(let E=this.pending.head();E!==null;E=this.pending.next()){if(E.archive==R&&E.file==m)this.current=E;if(this.current!=null)E.cycle=0}if(this.current)if(this.waitCycles=0,_===0){if(this.current.data=null,this.current.urgent)this.completed.push(this.current);else this.current.unlink();this.current=null}else{if(this.current.data===null&&b===0)this.current.data=new Uint8Array(_);if(this.current.data===null&&b!=0)throw new Error}if(this.partOffset=b*500,this.partAvailable=500,this.partAvailable>_-b*500)this.partAvailable=_-b*500}if(this.partAvailable>0&&u>=this.partAvailable){this.active=!0;let R=this.buf,m=0;if(this.current&&this.current.data)R=this.current.data,m=this.partOffset;if(await this.stream.readBytes(R,m,this.partAvailable),this.partAvailable+this.partOffset>=R.length&&this.current){if(this.app.db)this.app.db.write(this.current.archive+1,this.current.file,R);if(!this.current.urgent&&this.current.archive===3)this.current.urgent=!0,this.current.archive=93;if(this.current.urgent)this.completed.push(this.current);else this.current.unlink()}this.partAvailable=0}}catch(u){if(this.stream)this.stream.close();this.stream=null,this.partAvailable=0}}}validate(u,R,m){if(typeof u==="undefined"||u.length<2)return!1;let _=u.length-2,b=((u[_]&255)<<8)+(u[_+1]&255),E=z.getcrc(u,0,u.length-2);return b===m&&E===R}async send(u){if(this.modernized)return;try{if(this.stream===null){let R=performance.now();if(R-this.socketOpenTime<5000)return;this.socketOpenTime=R,this.stream=new z0(await z0.openSocket(window.location.host,window.location.protocol==="https:")),this.buf[0]=15,this.stream.write(this.buf,1);for(let m=0;m<8;m++)await this.stream.read();this.waitCycles=0}if(this.buf[0]=u.archive,this.buf[1]=u.file>>8,this.buf[2]=u.file,u.urgent)this.buf[3]=2;else if(this.app.ingame)this.buf[3]=0;else this.buf[3]=1;this.stream.write(this.buf,4),this.heartbeatCycle=0}catch(R){this.stream=null,this.partAvailable=0}}async unzip(){if(!this.app.db)return;try{let u=uu(await r0("/ondemand.zip"));for(let R=0;R<4;R++){let m=this.versions[R].length;for(let _=0;_<m;_++){let b=u[`${R+1}.${_}`];if(typeof b==="undefined")continue;let E=await this.app.db.read(R+1,_);if(!E||!this.validate(E,this.crcs[R][_],this.versions[R][_]))await this.app.db.write(R+1,_,b)}}}catch(u){}}}class v extends _1{static nodeId=10;static membersWorld=!0;static lowMemory=!1;static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;errorMessage=null;db=null;loopCycle=0;jagChecksum=[];stream=null;in=z.alloc(1);out=z.alloc(1);loginout=z.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;ptype=0;psize=0;ptype0=0;ptype1=0;ptype2=0;jagTitle=null;redrawFrame=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";username="";password="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new p(13,null);imageMinimap=null;imageCompass=null;imageMapedge=null;imageMapscene=new p(50,null);imageMapfunction=new p(50,null);imageHitmarks=new p(20,null);imageHeadicon=new p(20,null);imageMapmarker0=null;imageMapmarker1=null;imageCrosses=new p(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new p(1000,null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new s;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];chatPublicMode=0;chatPrivateMode=0;chatTradeMode=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialInputType=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new p(100,null);messageSender=new p(100,null);messageType=new Int32Array(100);messageTextIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;oneMouseButton=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceId=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1000);activeMapFunctionZ=new Int32Array(1000);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;macroCameraCycle=0;macroCameraX=0;macroCameraZ=0;macroCameraAngle=0;macroCameraXModifier=2;macroCameraZModifier=2;macroCameraAngleModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new p(5,!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;macroMinimapCycle=0;macroMinimapAngle=0;macroMinimapZoom=0;macroMinimapZoomModifier=1;macroMinimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLandFile=[];sceneMapLocData=null;sceneMapLocFile=[];sceneMapIndex=null;withinTutorialIsland=!1;awaitingSync=!1;scenePrevBaseTileX=0;scenePrevBaseTileZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new p(4,null);currentLevel=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new f0(104,104);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new p(2048,null);playerCount=0;playerIds=new Int32Array(2048);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(2048);entityRemovalIds=new Int32Array(1000);playerAppearanceBuffer=new p(2048,null);npcs=new p(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new J0;spotanims=new J0;objStacks=new x0(4,104,104,null);locChanges=new J0;bfsStepX=new Int32Array(4000);bfsStepZ=new Int32Array(4000);bfsDirection=new Int32Array(104*104);bfsCost=new Int32Array(104*104);tryMoveNearest=0;localPlayer=null;runenergy=0;inMultizone=0;localPid=-1;runweight=0;noTimeoutCycle=0;wildernessLevel=0;worldLocationState=0;staffmodlevel=0;designGender=!0;updateDesignModel=!1;designKits=new Int32Array(7);designColours=new Int32Array(5);static CHAT_COLORS=Int32Array.of(16776960,16711680,65280,65535,16711935,16777215);friendCount=0;chatCount=0;chatX=new Int32Array(50);chatY=new Int32Array(50);chatHeight=new Int32Array(50);chatWidth=new Int32Array(50);chatColors=new Int32Array(50);chatEffect=new Int32Array(50);chatTimers=new Int32Array(50);chats=new p(50,null);friendName=new p(200,null);friendName37=new BigInt64Array(200);friendWorld=new Int32Array(200);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=64;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=!0;midiVolume=64;midiSong=-1;midiFading=!1;nextMidiSong=-1;displayFps=!1;onDemand=null;ingame=!1;imageModIcons=[];lastProgressPercent=0;lastProgressMessage="";drawCycle=0;sceneLoadStartTime=0;viewportOverlayInterfaceId=-1;bankArrangeMode=0;field1264=0;warnMembersInNonMembers=0;membersAccount=0;flameCycle=0;initializeLevelExperience(){let u=0;for(let R=0;R<99;R++){let m=R+1,_=m+Math.pow(2,m/7)*300|0;u+=_,this.levelExperience[R]=u/4|0}}constructor(u,R,m){super();if(typeof u==="undefined"||typeof R==="undefined"||typeof m==="undefined")return;if(v.nodeId=u,v.membersWorld=m,R)v.setLowMemory();else v.setHighMemory();this.run()}static setLowMemory(){k.lowMemory=!0,Z.lowMemory=!0,v.lowMemory=!0,t.lowMemory=!0}static setHighMemory(){k.lowMemory=!1,Z.lowMemory=!1,v.lowMemory=!1,t.lowMemory=!1}saveMidi(u,R){_u(R,this.midiVolume,u)}async load(){if(this.isMobile&&v.lowMemory)this.setTargetedFramerate(30);if(this.alreadyStarted){this.errorStarted=!0;return}this.alreadyStarted=!0;try{this.db=new o0(await o0.openDatabase())}catch(u){this.db=null}try{await this.drawProgress(10,"Connecting to web server");let u=new z(await r0("/crc"));for(let j=0;j<9;j++)this.jagChecksum[j]=u.g4();this.jagTitle=await this.getJagFile("title","title screen",1,25),this.fontPlain11=k0.fromArchive(this.jagTitle,"p11"),this.fontPlain12=k0.fromArchive(this.jagTitle,"p12"),this.fontBold12=k0.fromArchive(this.jagTitle,"b12"),this.fontQuill8=k0.fromArchive(this.jagTitle,"q8"),await this.loadTitleBackground(),await this.loadTitleImages();let R=await this.getJagFile("config","config",2,30),m=await this.getJagFile("interface","interface",3,35),_=await this.getJagFile("media","2d graphics",4,40),b=await this.getJagFile("textures","textures",6,45),E=await this.getJagFile("wordenc","chat system",7,50),O=await this.getJagFile("sounds","sound effects",8,55);this.levelTileFlags=new S0(4,104,104),this.levelHeightmap=new g0(4,104+1,104+1),this.scene=new k(this.levelHeightmap,104,4,104);for(let j=0;j<4;j++)this.levelCollisionMap[j]=new e;this.imageMinimap=new m0(512,512);let I=await this.getJagFile("versionlist","update list",5,60);if(await this.drawProgress(60,"Connecting to update server"),this.onDemand=new U1(I,this),A0.init(this.onDemand.getAnimCount()),J.init(this.onDemand.getFileCount(0),this.onDemand),await this.onDemand.unzip(),!v.lowMemory){this.midiSong=0,this.midiFading=!1,this.onDemand.request(2,this.midiSong);while(this.onDemand.remaining()>0)await this.updateOnDemand(),await X0(100)}await this.drawProgress(65,"Requesting animations");let L=this.onDemand.getFileCount(1);for(let j=0;j<L;j++)this.onDemand.request(1,j);while(this.onDemand.remaining()>0){let j=L-this.onDemand.remaining();if(j>0)await this.drawProgress(65,"Loading animations - "+(j*100/L|0)+"%");await this.updateOnDemand(),await X0(100)}await this.drawProgress(70,"Requesting models");let H=this.onDemand.getFileCount(0);for(let j=0;j<H;j++)if((this.onDemand.getModelFlags(j)&1)!=0)this.onDemand.request(0,j);let N=this.onDemand.remaining();while(this.onDemand.remaining()>0){let j=N-this.onDemand.remaining();if(j>0)await this.drawProgress(70,"Loading models - "+(j*100/N|0)+"%");await this.updateOnDemand(),await X0(100)}if(this.db){await this.drawProgress(75,"Requesting maps"),this.onDemand.request(3,this.onDemand.getMapFile(47,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(47,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(48,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(48,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(49,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(49,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(47,47,0)),this.onDemand.request(3,this.onDemand.getMapFile(47,47,1)),this.onDemand.request(3,this.onDemand.getMapFile(48,47,0)),this.onDemand.request(3,this.onDemand.getMapFile(48,47,1)),this.onDemand.request(3,this.onDemand.getMapFile(148,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(148,48,1));let j=this.onDemand.remaining();while(this.onDemand.remaining()>0){let W=j-this.onDemand.remaining();if(W>0)await this.drawProgress(75,"Loading maps - "+(W*100/j|0)+"%");await this.updateOnDemand(),await X0(100)}}let G=this.onDemand.getFileCount(0);for(let j=0;j<G;j++){let W=this.onDemand.getModelFlags(j),M=0;if((W&8)!=0)M=10;else if((W&32)!=0)M=9;else if((W&16)!=0)M=8;else if((W&64)!=0)M=7;else if((W&128)!=0)M=6;else if((W&2)!=0)M=5;else if((W&4)!=0)M=4;if((W&1)!=0)M=3;if(M!=0)await this.onDemand.prefetchPriority(0,j,M)}if(await this.onDemand.prefetchMaps(v.membersWorld),!v.lowMemory){let j=this.onDemand.getFileCount(2);for(let W=0;W<j;W++)if(this.onDemand.shouldPrefetchMidi(W))this.onDemand.prefetchPriority(2,W,1)}await this.drawProgress(80,"Unpacking media"),this.imageInvback=I0.fromArchive(_,"invback",0),this.imageChatback=I0.fromArchive(_,"chatback",0),this.imageMapback=I0.fromArchive(_,"mapback",0),this.imageBackbase1=I0.fromArchive(_,"backbase1",0),this.imageBackbase2=I0.fromArchive(_,"backbase2",0),this.imageBackhmid1=I0.fromArchive(_,"backhmid1",0);for(let j=0;j<13;j++)this.imageSideicons[j]=I0.fromArchive(_,"sideicons",j);this.imageCompass=m0.fromArchive(_,"compass",0),this.imageMapedge=m0.fromArchive(_,"mapedge",0),this.imageMapedge.crop();try{for(let j=0;j<50;j++)this.imageMapscene[j]=I0.fromArchive(_,"mapscene",j)}catch(j){}try{for(let j=0;j<50;j++)this.imageMapfunction[j]=m0.fromArchive(_,"mapfunction",j)}catch(j){}try{for(let j=0;j<20;j++)this.imageHitmarks[j]=m0.fromArchive(_,"hitmarks",j)}catch(j){}try{for(let j=0;j<20;j++)this.imageHeadicon[j]=m0.fromArchive(_,"headicons",j)}catch(j){}this.imageMapmarker0=m0.fromArchive(_,"mapmarker",0),this.imageMapmarker1=m0.fromArchive(_,"mapmarker",1);for(let j=0;j<8;j++)this.imageCrosses[j]=m0.fromArchive(_,"cross",j);this.imageMapdot0=m0.fromArchive(_,"mapdots",0),this.imageMapdot1=m0.fromArchive(_,"mapdots",1),this.imageMapdot2=m0.fromArchive(_,"mapdots",2),this.imageMapdot3=m0.fromArchive(_,"mapdots",3),this.imageScrollbar0=I0.fromArchive(_,"scrollbar",0),this.imageScrollbar1=I0.fromArchive(_,"scrollbar",1),this.imageRedstone1=I0.fromArchive(_,"redstone1",0),this.imageRedstone2=I0.fromArchive(_,"redstone2",0),this.imageRedstone3=I0.fromArchive(_,"redstone3",0),this.imageRedstone1h=I0.fromArchive(_,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=I0.fromArchive(_,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=I0.fromArchive(_,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=I0.fromArchive(_,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=I0.fromArchive(_,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=I0.fromArchive(_,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=I0.fromArchive(_,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();for(let j=0;j<2;j++)this.imageModIcons[j]=I0.fromArchive(_,"mod_icons",j);let Q=m0.fromArchive(_,"backleft1",0);this.areaBackleft1=new L0(Q.cropRight,Q.cropBottom),Q.blitOpaque(0,0);let $=m0.fromArchive(_,"backleft2",0);this.areaBackleft2=new L0($.cropRight,$.cropBottom),$.blitOpaque(0,0);let T=m0.fromArchive(_,"backright1",0);this.areaBackright1=new L0(T.cropRight,T.cropBottom),T.blitOpaque(0,0);let U=m0.fromArchive(_,"backright2",0);this.areaBackright2=new L0(U.cropRight,U.cropBottom),U.blitOpaque(0,0);let K=m0.fromArchive(_,"backtop1",0);this.areaBacktop1=new L0(K.cropRight,K.cropBottom),K.blitOpaque(0,0);let q=m0.fromArchive(_,"backvmid1",0);this.areaBackvmid1=new L0(q.cropRight,q.cropBottom),q.blitOpaque(0,0);let w=m0.fromArchive(_,"backvmid2",0);this.areaBackvmid2=new L0(w.cropRight,w.cropBottom),w.blitOpaque(0,0);let V=m0.fromArchive(_,"backvmid3",0);this.areaBackvmid3=new L0(V.cropRight,V.cropBottom),V.blitOpaque(0,0);let Y=m0.fromArchive(_,"backhmid2",0);this.areaBackhmid2=new L0(Y.cropRight,Y.cropBottom),Y.blitOpaque(0,0);let A=(Math.random()*21|0)-10,h=(Math.random()*21|0)-10,n=(Math.random()*21|0)-10,f=(Math.random()*41|0)-20;for(let j=0;j<50;j++){if(this.imageMapfunction[j])this.imageMapfunction[j]?.translate2d(A+f,h+f,n+f);if(this.imageMapscene[j])this.imageMapscene[j]?.translate2d(A+f,h+f,n+f)}if(await this.drawProgress(83,"Unpacking textures"),Z.unpackTextures(b),Z.setBrightness(0.8),Z.initPool(20),await this.drawProgress(86,"Unpacking config"),o.unpack(R),_0.unpack(R),M0.unpack(R),l.unpack(R,v.membersWorld),w0.unpack(R),K0.unpack(R),q0.unpack(R),W0.unpack(R),!v.lowMemory)await this.drawProgress(90,"Unpacking sounds"),b0.unpack(O);await this.drawProgress(95,"Unpacking interfaces"),s.unpack(m,_,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.drawProgress(100,"Preparing game engine");for(let j=0;j<33;j++){let W=999,M=0;for(let X=0;X<34;X++)if(this.imageMapback.pixels[X+j*this.imageMapback.width2d]===0){if(W===999)W=X}else if(W!==999){M=X;break}this.compassMaskLineOffsets[j]=W,this.compassMaskLineLengths[j]=M-W}for(let j=5;j<156;j++){let W=999,M=0;for(let X=25;X<172;X++)if(this.imageMapback.pixels[X+j*this.imageMapback.width2d]===0&&(X>34||j>34)){if(W===999)W=X}else if(W!==999){M=X;break}this.minimapMaskLineOffsets[j-5]=W-25,this.minimapMaskLineLengths[j-5]=M-W}Z.init3D(479,96),this.areaChatbackOffsets=Z.lineOffset,Z.init3D(190,261),this.areaSidebarOffsets=Z.lineOffset,Z.init3D(512,334),this.areaViewportOffsets=Z.lineOffset;let D=new Int32Array(9);for(let j=0;j<9;j++){let W=j*32+128+15,M=W*3+600,X=Z.sin[W];D[j]=M*X>>16}k.init(512,334,500,800,D),D0.unpack(E),this.initializeLevelExperience()}catch(u){if(u instanceof Error)this.errorMessage=`loaderror - ${this.lastProgressMessage} ${this.lastProgressPercent}%: ${u.message}`;this.errorLoading=!0}}async update(){if(this.errorStarted||this.errorLoading||this.errorHost)return;if(this.loopCycle++,this.ingame)await this.updateGame();else await this.updateTitle();await this.updateOnDemand()}async draw(){if(this.errorStarted||this.errorLoading||this.errorHost){this.drawError();return}if(this.drawCycle++,this.ingame)this.drawGame();else await this.drawTitle();this.dragCycles=0}async refresh(){this.redrawFrame=!0}async drawProgress(u,R){if(this.lastProgressPercent=u,this.lastProgressMessage=R,await this.loadTitle(),!this.jagTitle){await super.drawProgress(u,R);return}this.imageTitle4?.bind();let m=360,_=200,b=20;this.fontBold12?.drawStringCenter(m/2|0,(_/2|0)-b-26,"RuneScape is loading - please wait...",16777215);let E=(_/2|0)-18-b;if(F.drawRect((m/2|0)-152,E,304,34,9179409),F.drawRect((m/2|0)-151,E+1,302,32,0),F.fillRect2d((m/2|0)-150,E+2,u*3,30,9179409),F.fillRect2d((m/2|0)-150+u*3,E+2,300-u*3,30,0),this.fontBold12?.drawStringCenter(m/2|0,(_/2|0)+5-b,R,16777215),this.imageTitle4?.draw(202,171),this.redrawFrame){if(this.redrawFrame=!1,!this.flameActive)this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(637,0);this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(202,371),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(562,265),this.imageTitle7?.draw(128,171),this.imageTitle8?.draw(562,171)}await X0(5)}drawError(){C.fillStyle="black",C.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.flameActive=!1;let u=0;if(this.errorLoading)C.font="bold 16px helvetica, sans-serif",C.textAlign="left",C.fillStyle="yellow",u=35,C.fillText("Sorry, an error has occured whilst loading RuneScape",30,u),u+=50,C.fillStyle="white",C.fillText("To fix this try the following (in order):",30,u),u+=50,C.font="bold 12px helvetica, sans-serif",C.fillText("1: Try closing ALL open web-browser windows, and reloading",30,u),u+=30,C.fillText("2: Try clearing your web-browsers cache",30,u),u+=30,C.fillText("3: Try using a different game-world",30,u),u+=30,C.fillText("4: Try rebooting your computer",30,u),u+=30,C.fillText("5: Try selecting a different method from the play-game menu",30,u);else if(this.errorHost)C.font="bold 20px helvetica, sans-serif",C.textAlign="left",C.fillStyle="white",u=50,C.fillText("Error - unable to load game!",50,u),u+=50,C.fillText("To play RuneScape make sure you play from",50,u),u+=50,C.fillText("An approved domain",50,u);else if(this.errorStarted)C.font="bold 13px helvetica, sans-serif",C.textAlign="left",C.fillStyle="yellow",u=35,C.fillText("Error a copy of RuneScape already appears to be loaded",30,u),u+=50,C.fillStyle="white",C.fillText("To fix this try the following (in order):",30,u),u+=50,C.font="bold 12px helvetica, sans-serif",C.fillText("1: Try closing ALL open web-browser windows, and reloading",30,u),u+=30,C.fillText("2: Try rebooting your computer, and reloading",30,u);if(this.errorMessage)u+=50,C.fillStyle="red",C.fillText(this.errorMessage,30,u)}async getJagFile(u,R,m,_){let b=this.jagChecksum[m],E,O=5;try{if(this.db)E=await this.db.read(0,m)}catch(L){}if(E&&z.getcrc(E,0,E.length)!==b)E=void 0;if(E)return new y0(E);let I=0;while(!E){await this.drawProgress(_,`Requesting ${R}`);try{E=await r0(`/${u}${b}`);let L=z.getcrc(E,0,E.length);if(b===L)try{if(this.db)await this.db.write(0,m,E)}catch(H){}else E=void 0,I++}catch(L){E=void 0}if(!E){for(let L=O;L>0;L--){if(I>=3)await this.drawProgress(_,"Game updated - please reload page"),L=10;else await this.drawProgress(_,`Error loading - Will retry in ${L} secs.`);await X0(1000)}if(O*=2,O>60)O=60}}return new y0(E)}async updateOnDemand(){if(!this.onDemand)return;await this.onDemand.run();while(!0){let u=this.onDemand.loop();if(u===null)return;if(!u.data)continue;if(u.archive===0){if(J.unpack(u.file,u.data),(this.onDemand.getModelFlags(u.file)&98)!=0){if(this.redrawSidebar=!0,this.chatInterfaceId!==-1)this.redrawChatback=!0}}else if(u.archive===1)A0.unpack(u.data);else if(u.archive===2){if(this.midiSong===u.file)this.saveMidi(this.midiFading,u.data)}else if(u.archive===3){if(this.sceneMapLandData&&this.sceneMapLocData&&this.sceneState===1)for(let R=0;R<this.sceneMapLandData.length;R++){if(this.sceneMapLandFile[R]==u.file){if(this.sceneMapLandData[R]=u.data,u.data==null)this.sceneMapLandFile[R]=-1;break}if(this.sceneMapLocFile[R]==u.file){if(this.sceneMapLocData[R]=u.data,u.data==null)this.sceneMapLocFile[R]=-1;break}}}else if(u.archive===93){if(this.onDemand.hasMapLocFile(u.file))t.prefetchLocs(new z(u.data),this.onDemand)}}}async updateTitle(){if(this.titleScreenState===0){let u=(this.width/2|0)-80,R=(this.height/2|0)+20;if(R+=20,this.mouseClickButton===1&&this.mouseClickX>=u-75&&this.mouseClickX<=u+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.titleScreenState=3,this.titleLoginField=0;if(u=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=u-75&&this.mouseClickX<=u+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0}else if(this.titleScreenState===2){let u=(this.height/2|0)-40;if(u+=30,u+=25,this.mouseClickButton===1&&this.mouseClickY>=u-15&&this.mouseClickY<u)this.titleLoginField=0;if(u+=15,this.mouseClickButton===1&&this.mouseClickY>=u-15&&this.mouseClickY<u)this.titleLoginField=1;let R=(this.width/2|0)-80;if(u=(this.height/2|0)+50,u+=20,this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=u-20&&this.mouseClickY<=u+20){if(await this.login(this.username,this.password,!1),this.ingame)return}if(R=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=u-20&&this.mouseClickY<=u+20)this.titleScreenState=0,this.username="",this.password="";while(!0){let m=this.pollKey();if(m===-1)return;let _=!1;for(let b=0;b<k0.CHARSET.length;b++)if(String.fromCharCode(m)===k0.CHARSET.charAt(b)){_=!0;break}if(this.titleLoginField===0){if(m===8&&this.username.length>0)this.username=this.username.substring(0,this.username.length-1);if(m===9||m===10||m===13)this.titleLoginField=1;if(_)this.username=this.username+String.fromCharCode(m);if(this.username.length>12)this.username=this.username.substring(0,12)}else if(this.titleLoginField===1){if(m===8&&this.password.length>0)this.password=this.password.substring(0,this.password.length-1);if(m===9||m===10||m===13)this.titleLoginField=0;if(_)this.password=this.password+String.fromCharCode(m);if(this.password.length>20)this.password=this.password.substring(0,20)}}}else if(this.titleScreenState===3){let u=this.width/2|0,R=(this.height/2|0)+50;if(R+=20,this.mouseClickButton===1&&this.mouseClickX>=u-75&&this.mouseClickX<=u+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.titleScreenState=0}}async login(u,R,m){try{if(!m)this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitle();this.stream=new z0(await z0.openSocket(window.location.host,window.location.protocol==="https:"));let _=c.toBase37(u),b=Number(_>>16n)&31;this.out.pos=0,this.out.p1(14),this.out.p1(b),this.stream.write(this.out.data,2);for(let O=0;O<8;O++)await this.stream.read();let E=await this.stream.read();if(E===0){await this.stream.readBytes(this.in.data,0,8),this.in.pos=0,this.serverSeed=this.in.g8();let O=new Int32Array([Math.floor(Math.random()*99999999),Math.floor(Math.random()*99999999),Number(this.serverSeed>>32n),Number(this.serverSeed&BigInt(4294967295))]);if(this.out.pos=0,this.out.p1(10),this.out.p4(O[0]),this.out.p4(O[1]),this.out.p4(O[2]),this.out.p4(O[3]),this.out.p4(1337),this.out.pjstr(u),this.out.pjstr(R),this.out.rsaenc(BigInt("7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789"),BigInt("58778699976184461502525193738213253649000149147835990136706041084440742975821")),this.loginout.pos=0,m)this.loginout.p1(18);else this.loginout.p1(16);this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(244),this.loginout.p1(v.lowMemory?1:0);for(let I=0;I<9;I++)this.loginout.p4(this.jagChecksum[I]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new e0(O);for(let I=0;I<4;I++)O[I]+=50;this.randomIn=new e0(O),this.stream?.write(this.loginout.data,this.loginout.pos),E=await this.stream.read()}if(E===1)await X0(2000),await this.login(u,R,m);else if(E===2||E===18||E===19){if(this.staffmodlevel=0,E===18)this.staffmodlevel=1;else if(E===19)this.staffmodlevel=2;G0.setDisabled(),this.hasFocus=!0,this.ingame=!0,this.out.pos=0,this.in.pos=0,this.ptype=-1,this.ptype0=-1,this.ptype1=-1,this.ptype2=-1,this.psize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.field1264=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=performance.now();for(let O=0;O<100;O++)this.messageText[O]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.macroCameraX=(Math.random()*100|0)-50,this.macroCameraZ=(Math.random()*110|0)-55,this.macroCameraAngle=(Math.random()*80|0)-40,this.macroMinimapAngle=(Math.random()*120|0)-60,this.macroMinimapZoom=(Math.random()*30|0)-20,this.orbitCameraYaw=(Math.random()*20|0)-10&2047,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0,this.npcCount=0;for(let O=0;O<2048;O++)this.players[O]=null,this.playerAppearanceBuffer[O]=null;for(let O=0;O<8192;O++)this.npcs[O]=null;this.localPlayer=this.players[2047]=new Q0,this.projectiles.clear(),this.spotanims.clear();for(let O=0;O<4;O++)for(let I=0;I<104;I++)for(let L=0;L<104;L++)this.objStacks[O][I][L]=null;this.locChanges=new J0,this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.viewportOverlayInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,this.designGender=!0,this.validateCharacterDesign();for(let O=0;O<5;O++)this.designColours[O]=0;v.oplogic1=0,v.oplogic2=0,v.oplogic3=0,v.oplogic4=0,v.oplogic5=0,v.oplogic6=0,v.oplogic7=0,v.oplogic8=0,v.oplogic9=0,this.prepareGame()}else if(E===3)this.loginMessage0="",this.loginMessage1="Invalid username or password.";else if(E===4)this.loginMessage0="Your account has been disabled.",this.loginMessage1="Please check your message-centre for details.";else if(E===5)this.loginMessage0="Your account is already logged in.",this.loginMessage1="Try again in 60 secs...";else if(E===6)this.loginMessage0="RuneScape has been updated!",this.loginMessage1="Please reload this page.";else if(E===7)this.loginMessage0="This world is full.",this.loginMessage1="Please use a different world.";else if(E===8)this.loginMessage0="Unable to connect.",this.loginMessage1="Login server offline.";else if(E===9)this.loginMessage0="Login limit exceeded.",this.loginMessage1="Too many connections from your address.";else if(E===10)this.loginMessage0="Unable to connect.",this.loginMessage1="Bad session id.";else if(E===11)this.loginMessage1="Login server rejected session.",this.loginMessage1="Please try again.";else if(E===12)this.loginMessage0="You need a members account to login to this world.",this.loginMessage1="Please subscribe, or use a different world.";else if(E===13)this.loginMessage0="Could not complete login.",this.loginMessage1="Please try using a different world.";else if(E===14)this.loginMessage0="The server is being updated.",this.loginMessage1="Please wait 1 minute and try again.";else if(E===15)this.ingame=!0,this.out.pos=0,this.in.pos=0,this.ptype=-1,this.ptype0=-1,this.ptype1=-1,this.ptype2=-1,this.psize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,this.menuVisible=!1,this.sceneLoadStartTime=performance.now();else if(E===16)this.loginMessage0="Login attempts exceeded.",this.loginMessage1="Please wait 1 minute and try again.";else if(E===17)this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first";else if(E===20)this.loginMessage0="Invalid loginserver requested",this.loginMessage1="Please try using a different world.";else this.loginMessage0="Unexpected server response",this.loginMessage1="Please try using a different world."}catch(_){this.loginMessage0="",this.loginMessage1="Error connecting to server."}}async logout(){if(this.stream)this.stream.close();this.stream=null,this.ingame=!1,this.titleScreenState=0,this.username="",this.password="",G0.setDisabled(),this.clearCache(),this.scene?.reset();for(let u=0;u<4;u++)this.levelCollisionMap[u]?.reset();r1(!1),this.nextMidiSong=-1,this.midiSong=-1,this.nextMusicDelay=0}clearCache(){_0.modelCacheStatic?.clear(),_0.modelCacheDynamic?.clear(),w0.modelCache?.clear(),l.modelCache?.clear(),l.iconCache?.clear(),Q0.modelCache?.clear(),q0.modelCache?.clear()}prepareGame(){if(this.areaChatback)return;this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new L0(479,96),this.areaMapback=new L0(172,156),F.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new L0(190,261),this.areaViewport=new L0(512,334),F.clear(),this.areaBackbase1=new L0(496,50),this.areaBackbase2=new L0(269,37),this.areaBackhmid1=new L0(249,45),this.redrawFrame=!0}async updateGame(){if(this.players===null)return;if(this.systemUpdateTimer>1)this.systemUpdateTimer--;if(this.idleTimeout>0)this.idleTimeout--;if(this.field1264>0)this.field1264-=2;for(let u=0;u<5&&await this.readPacket();u++);if(this.ingame){this.updateSceneState(),this.updateLocChanges(),await this.updateAudio();let u=G0.flush();if(u)this.out.p1isaac(217),this.out.p2(u.pos),this.out.pdata(u.data,u.pos,0),u.release();if(this.idleNetCycles++,this.idleNetCycles>250)await this.tryReconnect();if(this.updatePlayers(),this.updateNpcs(),this.updateEntityChats(),this.sceneDelta++,this.crossMode!==0){if(this.crossCycle+=20,this.crossCycle>=400)this.crossMode=0}if(this.selectedArea!==0){if(this.selectedCycle++,this.selectedCycle>=15){if(this.selectedArea===2)this.redrawSidebar=!0;else if(this.selectedArea===3)this.redrawChatback=!0;this.selectedArea=0}}if(this.objDragArea!==0){if(this.objDragCycles++,this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)this.objGrabThreshold=!0;if(this.mouseButton===0){if(this.objDragArea===2)this.redrawSidebar=!0;else if(this.objDragArea===3)this.redrawChatback=!0;if(this.objDragArea=0,this.objGrabThreshold&&this.objDragCycles>=5){if(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){let R=s.types[this.objDragInterfaceId],m=0;if(this.bankArrangeMode==1&&R.clientCode==206)m=1;if(R.invSlotObjId&&R.invSlotObjId[this.hoveredSlot]<=0)m=0;if(m==1){let _=this.objDragSlot,b=this.hoveredSlot;while(_!=b)if(_>b)R.swapObj(_,_-1),_--;else if(_<b)R.swapObj(_,_+1),_++}else R.swapObj(this.objDragSlot,this.hoveredSlot);this.out.p1isaac(81),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot),this.out.p1(m)}}else if((this.oneMouseButton===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)this.showContextMenu();else if(this.menuSize>0)this.useMenuOption(this.menuSize-1);this.selectedCycle=10,this.mouseClickButton=0}}if(v.cyclelogic3++,v.cyclelogic3>127)v.cyclelogic3=0,this.out.p1isaac(144),this.out.p3(4991788);if(k.clickTileX!==-1){if(this.localPlayer){let R=k.clickTileX,m=k.clickTileZ,_=this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,m,0,0,0,0,0,0,!0);if(k.clickTileX=-1,_)this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=1,this.crossCycle=0}}if(this.mouseClickButton===1&&this.modalMessage)this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0;if(this.handleMouseInput(),this.handleMinimapInput(),this.handleTabInput(),this.handleChatModeInput(),this.mouseButton===1||this.mouseClickButton===1)this.dragCycles++;if(this.sceneState===2)this.updateOrbitCamera();if(this.sceneState===2&&this.cutscene)this.applyCutscene();for(let R=0;R<5;R++)this.cameraModifierCycle[R]++;if(await this.handleInputKey(),performance.now()-this.idleCycles>90000)this.idleTimeout=250,this.idleCycles=performance.now()-1e4,this.out.p1isaac(146);if(this.macroCameraCycle++,this.macroCameraCycle>500){this.macroCameraCycle=0;let R=Math.random()*8|0;if((R&1)===1)this.macroCameraX+=this.macroCameraXModifier;if((R&2)===2)this.macroCameraZ+=this.macroCameraZModifier;if((R&4)===4)this.macroCameraAngle+=this.macroCameraAngleModifier}if(this.macroCameraX<-50)this.macroCameraXModifier=2;else if(this.macroCameraX>50)this.macroCameraXModifier=-2;if(this.macroCameraZ<-55)this.macroCameraZModifier=2;else if(this.macroCameraZ>55)this.macroCameraZModifier=-2;if(this.macroCameraAngle<-40)this.macroCameraAngleModifier=1;else if(this.macroCameraAngle>40)this.macroCameraAngleModifier=-1;if(this.macroMinimapCycle++,this.macroMinimapCycle>500){this.macroMinimapCycle=0;let R=Math.random()*8|0;if((R&1)===1)this.macroMinimapAngle+=this.macroMinimapAngleModifier;if((R&2)===2)this.macroMinimapZoom+=this.macroMinimapZoomModifier}if(this.macroMinimapAngle<-60)this.macroMinimapAngleModifier=2;else if(this.macroMinimapAngle>60)this.macroMinimapAngleModifier=-2;if(this.macroMinimapZoom<-20)this.macroMinimapZoomModifier=1;else if(this.macroMinimapZoom>10)this.macroMinimapZoomModifier=-1;if(v.cyclelogic4++,v.cyclelogic4>110)v.cyclelogic4=0,this.out.p1isaac(41),this.out.p4(0);if(this.noTimeoutCycle++,this.noTimeoutCycle>50)this.out.p1isaac(107);try{if(this.stream&&this.out.pos>0)this.stream.write(this.out.data,this.out.pos),this.out.pos=0,this.noTimeoutCycle=0}catch(R){await this.tryReconnect()}}}async tryReconnect(){if(this.idleTimeout>0){await this.logout();return}if(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",0),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",16777215),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",0),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",16777215),this.areaViewport?.draw(4,4),this.flagSceneTileX=0,this.stream?.close(),this.ingame=!1,await this.login(this.username,this.password,!0),!this.ingame)await this.logout()}updateSceneState(){if(v.lowMemory&&this.sceneState===2&&t.levelBuilt!==this.currentLevel)this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(4,4),this.sceneState=1;if(this.sceneState===1){if(this.checkScene()!=0&&performance.now()-this.sceneLoadStartTime>360000)this.sceneLoadStartTime=performance.now()}if(this.sceneState===2&&this.currentLevel!==this.minimapLevel)this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel)}checkScene(){if(!this.sceneMapIndex||!this.sceneMapLandData||!this.sceneMapLocData)return-1000;for(let R=0;R<this.sceneMapLandData.length;R++){if(this.sceneMapLandData[R]==null&&this.sceneMapLandFile[R]!==-1)return-1;if(this.sceneMapLocData[R]==null&&this.sceneMapLocFile[R]!==-1)return-2}let u=!0;for(let R=0;R<this.sceneMapLandData.length;R++){let m=this.sceneMapLocData[R];if(m!=null){let _=(this.sceneMapIndex[R]>>8)*64-this.sceneBaseTileX,b=(this.sceneMapIndex[R]&255)*64-this.sceneBaseTileZ;u&&=t.locsAreReady(m,_,b)}}if(!u)return-3;else if(this.awaitingSync)return-4;return this.sceneState=2,t.levelBuilt=this.currentLevel,this.buildScene(),0}buildScene(){try{this.minimapLevel=-1,this.spotanims.clear(),this.projectiles.clear(),Z.clearTexels(),this.clearCache(),this.scene?.reset();for(let O=0;O<4;O++)this.levelCollisionMap[O]?.reset();let b=new t(104,104,this.levelHeightmap,this.levelTileFlags);t.lowMemory=k.lowMemory;let E=this.sceneMapLandData?.length??0;if(this.sceneMapIndex)for(let O=0;O<E;O++){let I=this.sceneMapIndex[O]>>8,L=this.sceneMapIndex[O]&255;if(I===33&&L>=71&&L<=73){t.lowMemory=!1;break}}if(v.lowMemory)this.scene?.setMinLevel(this.currentLevel);else this.scene?.setMinLevel(0);if(this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(107);for(let O=0;O<E;O++){let I=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,L=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ,H=this.sceneMapLandData[O];if(H)b.loadGround((this.sceneCenterZoneX-6)*8,(this.sceneCenterZoneZ-6)*8,I,L,H)}for(let O=0;O<E;O++){let I=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,L=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ;if(!this.sceneMapLandData[O]&&this.sceneCenterZoneZ<800)b.spreadHeight(I,L,64,64)}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(107);for(let O=0;O<E;O++){let I=this.sceneMapLocData[O];if(I){let L=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,H=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ;b.loadLocations(this.loopCycle,this.scene,this.levelCollisionMap,I,L,H)}}}this.out.p1isaac(107),b.build(this.scene,this.levelCollisionMap),this.areaViewport?.bind(),this.out.p1isaac(107);for(let O=0;O<104;O++)for(let I=0;I<104;I++)this.sortObjStacks(O,I);this.clearLocChanges()}catch(b){}if(_0.modelCacheStatic?.clear(),v.lowMemory&&this.db){let b=this.onDemand?.getFileCount(0)??0;for(let E=0;E<b;E++)if(((this.onDemand?.getModelFlags(E)??0)&121)==0)J.unload(E)}Z.initPool(20),this.onDemand?.clearPrefetches();let u=(this.sceneCenterZoneX-6)/8-1,R=(this.sceneCenterZoneX+6)/8+1,m=(this.sceneCenterZoneZ-6)/8-1,_=(this.sceneCenterZoneZ+6)/8+1;if(this.withinTutorialIsland)u=49,R=50,m=49,_=50;for(let b=u;b<=R;b++)for(let E=m;E<=_;E++)if(u==b||R==b||m==E||_==E){let O=this.onDemand?.getMapFile(E,b,0)??-1;if(O!=-1)this.onDemand?.prefetch(3,O);let I=this.onDemand?.getMapFile(E,b,1)??-1;if(I!=-1)this.onDemand?.prefetch(3,I)}}clearLocChanges(){for(let u=this.locChanges.head();u;u=this.locChanges.next())if(u.endTime===-1)u.startTime=0,this.storeLoc(u);else u.unlink()}createMinimap(u){if(!this.imageMinimap)return;let R=this.imageMinimap.pixels,m=R.length;for(let E=0;E<m;E++)R[E]=0;for(let E=1;E<104-1;E++){let O=(104-1-E)*512*4+24628;for(let I=1;I<104-1;I++){if(this.levelTileFlags&&(this.levelTileFlags[u][I][E]&24)===0)this.scene?.drawMinimapTile(u,I,E,R,O,512);if(u<3&&this.levelTileFlags&&(this.levelTileFlags[u+1][I][E]&8)!==0)this.scene?.drawMinimapTile(u+1,I,E,R,O,512);O+=4}}let _=((Math.random()*20|0)+238-10<<16)+((Math.random()*20|0)+238-10<<8)+(Math.random()*20|0)+238-10,b=(Math.random()*20|0)+238-10<<16;this.imageMinimap.bind();for(let E=1;E<104-1;E++)for(let O=1;O<104-1;O++){if(this.levelTileFlags&&(this.levelTileFlags[u][O][E]&24)===0)this.drawMinimapLoc(O,E,u,_,b);if(u<3&&this.levelTileFlags&&(this.levelTileFlags[u+1][O][E]&8)!==0)this.drawMinimapLoc(O,E,u+1,_,b)}this.areaViewport?.bind(),this.activeMapFunctionCount=0;for(let E=0;E<104;E++)for(let O=0;O<104;O++){let I=this.scene?.getGroundDecorTypecode(this.currentLevel,E,O)??0;if(I===0)continue;let L=I>>14&32767,H=_0.get(L).mapfunction;if(H<0)continue;let N=E,G=O;if(H!==22&&H!==29&&H!==34&&H!==36&&H!==46&&H!==47&&H!==48){let Q=104,$=104,T=this.levelCollisionMap[this.currentLevel];if(T){let U=T.flags;for(let K=0;K<10;K++){let q=Math.random()*4|0;if(q===0&&N>0&&N>E-3&&(U[e.index(N-1,G)]&2621704)===0)N--;if(q===1&&N<Q-1&&N<E+3&&(U[e.index(N+1,G)]&2621824)===0)N++;if(q===2&&G>0&&G>O-3&&(U[e.index(N,G-1)]&2621698)===0)G--;if(q===3&&G<$-1&&G<O+3&&(U[e.index(N,G+1)]&2621728)===0)G++}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[H],this.activeMapFunctionX[this.activeMapFunctionCount]=N,this.activeMapFunctionZ[this.activeMapFunctionCount]=G,this.activeMapFunctionCount++}}updateLocChanges(){if(this.sceneState!==2)return;for(let u=this.locChanges.head();u;u=this.locChanges.next()){if(u.endTime>0)u.endTime--;if(u.endTime!=0){if(u.startTime>0)u.startTime--;if(u.startTime===0&&(u.newType<0||t.isLocReady(u.newType,u.newShape))){if(this.addLoc(u.level,u.x,u.z,u.newType,u.newAngle,u.newShape,u.layer),u.startTime=-1,u.oldType===u.newType&&u.oldType===-1)u.unlink();else if(u.oldType===u.newType&&u.oldAngle===u.newAngle&&u.oldShape===u.newShape)u.unlink()}}else if(u.oldType<0||t.isLocReady(u.oldType,u.oldShape))this.addLoc(u.level,u.x,u.z,u.oldType,u.oldAngle,u.oldShape,u.layer),u.unlink()}if(v.cyclelogic5++,v.cyclelogic5>85)v.cyclelogic5=0,this.out.p1isaac(232)}async updateAudio(){for(let u=0;u<this.waveCount;u++)if(this.waveDelay[u]<=0){try{let R=b0.generate(this.waveIds[u],this.waveLoops[u]);if(!R)throw new Error;if(performance.now()+(R.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0))this.lastWaveLength=R.pos,this.lastWaveStartTime=performance.now(),this.lastWaveId=this.waveIds[u],this.lastWaveLoops=this.waveLoops[u],await Ru(R.data.slice(0,R.pos))}catch(R){}this.waveCount--;for(let R=u;R<this.waveCount;R++)this.waveIds[R]=this.waveIds[R+1],this.waveLoops[R]=this.waveLoops[R+1],this.waveDelay[R]=this.waveDelay[R+1];u--}else this.waveDelay[u]--;if(this.nextMusicDelay>0){if(this.nextMusicDelay-=20,this.nextMusicDelay<0)this.nextMusicDelay=0;if(this.nextMusicDelay===0&&this.midiActive&&!v.lowMemory)this.midiSong=this.nextMidiSong,this.midiFading=!1,this.onDemand?.request(2,this.midiSong)}}handleInput(){if(this.objDragArea!==0)return;if(this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.handlePrivateChatInput(),this.lastHoveredInterfaceId=0,this.mouseX>4&&this.mouseY>4&&this.mouseX<516&&this.mouseY<338)if(this.viewportInterfaceId===-1)this.handleViewportOptions();else this.handleInterfaceInput(s.types[this.viewportInterfaceId],this.mouseX,this.mouseY,4,4,0);if(this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex)this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>553&&this.mouseY>205&&this.mouseX<743&&this.mouseY<466){if(this.sidebarInterfaceId!==-1)this.handleInterfaceInput(s.types[this.sidebarInterfaceId],this.mouseX,this.mouseY,553,205,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.handleInterfaceInput(s.types[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,553,205,0)}if(this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex)this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>17&&this.mouseY>357&&this.mouseX<426&&this.mouseY<453){if(this.chatInterfaceId!==-1)this.handleInterfaceInput(s.types[this.chatInterfaceId],this.mouseX,this.mouseY,17,357,0);else if(this.mouseY<434)this.handleChatMouseInput(this.mouseX-17,this.mouseY-357)}if(this.chatInterfaceId!==-1&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex)this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId;let u=!1;while(!u){u=!0;for(let R=0;R<this.menuSize-1;R++)if(this.menuAction[R]<1000&&this.menuAction[R+1]>1000){let m=this.menuOption[R];this.menuOption[R]=this.menuOption[R+1],this.menuOption[R+1]=m;let _=this.menuAction[R];this.menuAction[R]=this.menuAction[R+1],this.menuAction[R+1]=_;let b=this.menuParamB[R];this.menuParamB[R]=this.menuParamB[R+1],this.menuParamB[R+1]=b;let E=this.menuParamC[R];this.menuParamC[R]=this.menuParamC[R+1],this.menuParamC[R+1]=E;let O=this.menuParamA[R];this.menuParamA[R]=this.menuParamA[R+1],this.menuParamA[R+1]=O,u=!1}}}handlePrivateChatInput(){if(this.splitPrivateChat===0)return;let u=0;if(this.systemUpdateTimer!==0)u=1;for(let R=0;R<100;R++)if(this.messageText[R]!==null){let m=this.messageType[R],_=this.messageSender[R],b=!1;if(_&&_.startsWith("@cr1@"))_=_.substring(5),b=!0;else if(_&&_.startsWith("@cr2@"))_=_.substring(5),b=!0;if((m===3||m===7)&&(m===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(_))){let E=329-u*13;if(this.mouseX>4&&this.mouseX<516&&this.mouseY-4>E-10&&this.mouseY-4<=E+3){if(this.staffmodlevel)this.menuOption[this.menuSize]="Report abuse @whi@"+_,this.menuAction[this.menuSize]=2034,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+_,this.menuAction[this.menuSize]=2436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+_,this.menuAction[this.menuSize]=2406,this.menuSize++}if(u++,u>=5)return}else if((m===5||m===6)&&this.chatPrivateMode<2){if(u++,u>=5)return}}}handleChatMouseInput(u,R){let m=0;for(let _=0;_<100;_++){if(!this.messageText[_])continue;let b=this.messageType[_],E=this.chatScrollOffset+70+4-m*14;if(E<-20)break;let O=this.messageSender[_],I=!1;if(O&&O.startsWith("@cr1@"))O=O.substring(5),I=!0;else if(O&&O.startsWith("@cr2@"))O=O.substring(5),I=!0;if(b===0)m++;else if((b==1||b==2)&&(b==1||this.chatPublicMode==0||this.chatPublicMode==1&&this.isFriend(O))){if(R>E-14&&R<=E&&this.localPlayer&&O!==this.localPlayer.name){if(this.staffmodlevel>=1)this.menuOption[this.menuSize]="Report abuse @whi@"+O,this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+O,this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+O,this.menuAction[this.menuSize]=406,this.menuSize++}m++}else if((b===3||b===7)&&this.splitPrivateChat===0&&(b===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(O))){if(R>E-14&&R<=E){if(this.staffmodlevel>=1)this.menuOption[this.menuSize]="Report abuse @whi@"+O,this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+O,this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+O,this.menuAction[this.menuSize]=406,this.menuSize++}m++}else if(b===4&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(O))){if(R>E-14&&R<=E)this.menuOption[this.menuSize]="Accept trade @whi@"+O,this.menuAction[this.menuSize]=903,this.menuSize++;m++}else if((b===5||b===6)&&this.splitPrivateChat===0&&this.chatPrivateMode<2)m++;else if(b===8&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(O))){if(R>E-14&&R<=E)this.menuOption[this.menuSize]="Accept duel @whi@"+O,this.menuAction[this.menuSize]=363,this.menuSize++;m++}}}handleViewportOptions(){if(this.objSelected===0&&this.spellSelected===0)this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++;let u=-1;for(let R=0;R<J.pickedCount;R++){let m=J.pickedBitsets[R],_=m&127,b=m>>7&127,E=m>>29&3,O=m>>14&32767;if(m===u)continue;if(u=m,E===2&&this.scene&&this.scene.getInfo(this.currentLevel,_,b,m)>=0){let I=_0.get(O);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+I.name,this.menuAction[this.menuSize]=450,this.menuParamA[this.menuSize]=m,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++;else if(this.spellSelected!==1){if(I.op){for(let L=4;L>=0;L--)if(I.op[L]){if(this.menuOption[this.menuSize]=I.op[L]+" @cya@"+I.name,L===0)this.menuAction[this.menuSize]=285;else if(L===1)this.menuAction[this.menuSize]=504;else if(L===2)this.menuAction[this.menuSize]=364;else if(L===3)this.menuAction[this.menuSize]=581;else if(L===4)this.menuAction[this.menuSize]=1501;this.menuParamA[this.menuSize]=m,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++}}this.menuOption[this.menuSize]="Examine @cya@"+I.name,this.menuAction[this.menuSize]=1175,this.menuParamA[this.menuSize]=m,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++}else if((this.activeSpellFlags&4)===4)this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+I.name,this.menuAction[this.menuSize]=55,this.menuParamA[this.menuSize]=m,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++}else if(E===1){let I=this.npcs[O];if(I&&I.type&&I.type.size===1&&(I.x&127)===64&&(I.z&127)===64)for(let L=0;L<this.npcCount;L++){let H=this.npcs[this.npcIds[L]];if(H&&H!==I&&H.type&&H.type.size===1&&H.x===I.x&&H.z===I.z)this.addNpcOptions(H.type,this.npcIds[L],_,b)}if(I&&I.type)this.addNpcOptions(I.type,O,_,b)}else if(E===0){let I=this.players[O];if(I&&(I.x&127)===64&&(I.z&127)===64){for(let L=0;L<this.npcCount;L++){let H=this.npcs[this.npcIds[L]];if(H&&H.type&&H.type.size===1&&H.x===I.x&&H.z===I.z)this.addNpcOptions(H.type,this.npcIds[L],_,b)}for(let L=0;L<this.playerCount;L++){let H=this.players[this.playerIds[L]];if(H&&H!==I&&H.x===I.x&&H.z===I.z)this.addPlayerOptions(H,this.playerIds[L],_,b)}}if(I)this.addPlayerOptions(I,O,_,b)}else if(E===3){let I=this.objStacks[this.currentLevel][_][b];if(!I)continue;for(let L=I.tail();L;L=I.prev()){let H=l.get(L.index);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+H.name,this.menuAction[this.menuSize]=217,this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++;else if(this.spellSelected!==1){for(let N=4;N>=0;N--)if(H.op&&H.op[N]){if(this.menuOption[this.menuSize]=H.op[N]+" @lre@"+H.name,N===0)this.menuAction[this.menuSize]=224;else if(N===1)this.menuAction[this.menuSize]=993;else if(N===2)this.menuAction[this.menuSize]=99;else if(N===3)this.menuAction[this.menuSize]=746;else if(N===4)this.menuAction[this.menuSize]=877;this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++}else if(N===2)this.menuOption[this.menuSize]="Take @lre@"+H.name,this.menuAction[this.menuSize]=99,this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++;this.menuOption[this.menuSize]="Examine @lre@"+H.name,this.menuAction[this.menuSize]=1102,this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++}else if((this.activeSpellFlags&1)===1)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+H.name,this.menuAction[this.menuSize]=965,this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=_,this.menuParamC[this.menuSize]=b,this.menuSize++}}}}handleMouseInput(){if(this.objDragArea!==0)return;let u=this.mouseClickButton;if(this.spellSelected===1&&this.mouseClickX>=516&&this.mouseClickY>=160&&this.mouseClickX<=765&&this.mouseClickY<=205)u=0;if(!this.menuVisible){if(u===1&&this.menuSize>0){let R=this.menuAction[this.menuSize-1];if(R==602||R==596||R==22||R==892||R==415||R==405||R==38||R==422||R==478||R==347||R==188){let m=this.menuParamB[this.menuSize-1],_=this.menuParamC[this.menuSize-1];if(s.types[_].draggable){if(this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=_,this.objDragSlot=m,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,s.types[_].layer===this.viewportInterfaceId)this.objDragArea=1;if(s.types[_].layer===this.chatInterfaceId)this.objDragArea=3;return}}}if(u===1&&(this.oneMouseButton===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)u=2;if(u===1&&this.menuSize>0)this.useMenuOption(this.menuSize-1);else if(u==2&&this.menuSize>0)this.showContextMenu();return}if(u===1){let R=this.menuX,m=this.menuY,_=this.menuWidth,b=this.mouseClickX,E=this.mouseClickY;if(this.menuArea===0)b-=4,E-=4;else if(this.menuArea===1)b-=553,E-=205;else if(this.menuArea===2)b-=17,E-=357;let O=-1;for(let I=0;I<this.menuSize;I++){let L=m+(this.menuSize-1-I)*15+31;if(b>R&&b<R+_&&E>L-13&&E<L+3)O=I}if(O!==-1)this.useMenuOption(O);if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;else if(this.menuArea===2)this.redrawChatback=!0}else{let R=this.mouseX,m=this.mouseY;if(this.menuArea===0)R-=4,m-=4;else if(this.menuArea===1)R-=553,m-=205;else if(this.menuArea===2)R-=17,m-=357;if(R<this.menuX-10||R>this.menuX+this.menuWidth+10||m<this.menuY-10||m>this.menuY+this.menuHeight+10){if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;if(this.menuArea===2)this.redrawChatback=!0}}}handleMinimapInput(){if(this.mouseClickButton!==1||!this.localPlayer)return;let u=this.mouseClickX-25-550,R=this.mouseClickY-4-4;if(u<0||R<0||u>=146||R>=151)return;u-=73,R-=75;let m=this.orbitCameraYaw+this.macroMinimapAngle&2047,_=Z.sin[m],b=Z.cos[m];_=_*(this.macroMinimapZoom+256)>>8,b=b*(this.macroMinimapZoom+256)>>8;let E=R*_+u*b>>11,O=R*b-u*_>>11,I=this.localPlayer.x+E>>7,L=this.localPlayer.z-O>>7;if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],I,L,1,0,0,0,0,0,!0))this.out.p1(u),this.out.p1(R),this.out.p2(this.orbitCameraYaw),this.out.p1(57),this.out.p1(this.macroMinimapAngle),this.out.p1(this.macroMinimapZoom),this.out.p1(89),this.out.p2(this.localPlayer.x),this.out.p2(this.localPlayer.z),this.out.p1(this.tryMoveNearest),this.out.p1(63)}handleTabInput(){if(this.mouseClickButton!==1)return;if(this.mouseClickX>=539&&this.mouseClickX<=573&&this.mouseClickY>=169&&this.mouseClickY<205&&this.tabInterfaceId[0]!=-1)this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0;else if(this.mouseClickX>=569&&this.mouseClickX<=599&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[1]!=-1)this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0;else if(this.mouseClickX>=597&&this.mouseClickX<=627&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[2]!=-1)this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0;else if(this.mouseClickX>=625&&this.mouseClickX<=669&&this.mouseClickY>=168&&this.mouseClickY<203&&this.tabInterfaceId[3]!=-1)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;else if(this.mouseClickX>=666&&this.mouseClickX<=696&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[4]!=-1)this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0;else if(this.mouseClickX>=694&&this.mouseClickX<=724&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[5]!=-1)this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0;else if(this.mouseClickX>=722&&this.mouseClickX<=756&&this.mouseClickY>=169&&this.mouseClickY<205&&this.tabInterfaceId[6]!=-1)this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0;else if(this.mouseClickX>=540&&this.mouseClickX<=574&&this.mouseClickY>=466&&this.mouseClickY<502&&this.tabInterfaceId[7]!=-1)this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0;else if(this.mouseClickX>=572&&this.mouseClickX<=602&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[8]!=-1)this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0;else if(this.mouseClickX>=599&&this.mouseClickX<=629&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[9]!=-1)this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0;else if(this.mouseClickX>=627&&this.mouseClickX<=671&&this.mouseClickY>=467&&this.mouseClickY<502&&this.tabInterfaceId[10]!=-1)this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0;else if(this.mouseClickX>=669&&this.mouseClickX<=699&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[11]!=-1)this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0;else if(this.mouseClickX>=696&&this.mouseClickX<=726&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[12]!=-1)this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0;else if(this.mouseClickX>=724&&this.mouseClickX<=758&&this.mouseClickY>=466&&this.mouseClickY<502&&this.tabInterfaceId[13]!=-1)this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0;if(v.cyclelogic1++,v.cyclelogic1>150)v.cyclelogic1=0,this.out.p1isaac(46),this.out.p1(43)}handleChatModeInput(){if(this.mouseClickButton!==1)return;if(this.mouseClickX>=6&&this.mouseClickX<=106&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatPublicMode=(this.chatPublicMode+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=135&&this.mouseClickX<=235&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatPrivateMode=(this.chatPrivateMode+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=273&&this.mouseClickX<=373&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatTradeMode=(this.chatTradeMode+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=412&&this.mouseClickX<=512&&this.mouseClickY>=467&&this.mouseClickY<=499){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let u=0;u<s.types.length;u++)if(s.types[u]&&s.types[u].clientCode===600){this.reportAbuseInterfaceId=this.viewportInterfaceId=s.types[u].layer;return}}}closeInterfaces(){if(this.out.p1isaac(187),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1;this.viewportInterfaceId=-1}updateEntityChats(){for(let u=-1;u<this.playerCount;u++){let R;if(u===-1)R=2047;else R=this.playerIds[u];let m=this.players[R];if(m&&m.chatTimer>0){if(m.chatTimer--,m.chatTimer===0)m.chatMessage=null}}for(let u=0;u<this.npcCount;u++){let R=this.npcIds[u],m=this.npcs[R];if(m&&m.chatTimer>0){if(m.chatTimer--,m.chatTimer===0)m.chatMessage=null}}}updateOrbitCamera(){if(!this.localPlayer)return;let u=this.localPlayer.x+this.macroCameraX,R=this.localPlayer.z+this.macroCameraZ;if(this.orbitCameraX-u<-500||this.orbitCameraX-u>500||this.orbitCameraZ-R<-500||this.orbitCameraZ-R>500)this.orbitCameraX=u,this.orbitCameraZ=R;if(this.orbitCameraX!==u)this.orbitCameraX+=(u-this.orbitCameraX)/16|0;if(this.orbitCameraZ!==R)this.orbitCameraZ+=(R-this.orbitCameraZ)/16|0;if(this.actionKey[1]===1)this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0;else if(this.actionKey[2]===1)this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0;else this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0;if(this.actionKey[3]===1)this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0;else if(this.actionKey[4]===1)this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0;else this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0;if(this.orbitCameraYaw=(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0)&2047,this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0,this.orbitCameraPitch<128)this.orbitCameraPitch=128;else if(this.orbitCameraPitch>383)this.orbitCameraPitch=383;let m=this.orbitCameraX>>7,_=this.orbitCameraZ>>7,b=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ),E=0;if(this.levelHeightmap){if(m>3&&_>3&&m<100&&_<100)for(let I=m-4;I<=m+4;I++)for(let L=_-4;L<=_+4;L++){let H=this.currentLevel;if(H<3&&this.levelTileFlags&&(this.levelTileFlags[1][I][L]&2)===2)H++;let N=b-this.levelHeightmap[H][I][L];if(N>E)E=N}}let O=E*192;if(O>98048)O=98048;else if(O<32768)O=32768;if(O>this.cameraPitchClamp)this.cameraPitchClamp+=(O-this.cameraPitchClamp)/24|0;else if(O<this.cameraPitchClamp)this.cameraPitchClamp+=(O-this.cameraPitchClamp)/80|0}applyCutscene(){let u=this.cutsceneSrcLocalTileX*128+64,R=this.cutsceneSrcLocalTileZ*128+64,m=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;if(this.cameraX<u){if(this.cameraX+=this.cutsceneMoveSpeed+((u-this.cameraX)*this.cutsceneMoveAcceleration/1000|0),this.cameraX>u)this.cameraX=u}if(this.cameraX>u){if(this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-u)*this.cutsceneMoveAcceleration/1000|0),this.cameraX<u)this.cameraX=u}if(this.cameraY<m){if(this.cameraY+=this.cutsceneMoveSpeed+((m-this.cameraY)*this.cutsceneMoveAcceleration/1000|0),this.cameraY>m)this.cameraY=m}if(this.cameraY>m){if(this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-m)*this.cutsceneMoveAcceleration/1000|0),this.cameraY<m)this.cameraY=m}if(this.cameraZ<R){if(this.cameraZ+=this.cutsceneMoveSpeed+((R-this.cameraZ)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ>R)this.cameraZ=R}if(this.cameraZ>R){if(this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-R)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ<R)this.cameraZ=R}u=this.cutsceneDstLocalTileX*128+64,R=this.cutsceneDstLocalTileZ*128+64,m=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;let _=u-this.cameraX,b=m-this.cameraY,E=R-this.cameraZ,O=Math.sqrt(_*_+E*E)|0,I=(Math.atan2(b,O)*325.949|0)&2047,L=(Math.atan2(_,E)*-325.949|0)&2047;if(I<128)I=128;else if(I>383)I=383;if(this.cameraPitch<I){if(this.cameraPitch+=this.cutsceneRotateSpeed+((I-this.cameraPitch)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch>I)this.cameraPitch=I}if(this.cameraPitch>I){if(this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-I)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch<I)this.cameraPitch=I}let H=L-this.cameraYaw;if(H>1024)H-=2048;else if(H<-1024)H+=2048;if(H>0)this.cameraYaw+=this.cutsceneRotateSpeed+(H*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;if(H<0)this.cameraYaw-=this.cutsceneRotateSpeed+(-H*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;let N=L-this.cameraYaw;if(N>1024)N-=2048;else if(N<-1024)N+=2048;if(N<0&&H>0||N>0&&H<0)this.cameraYaw=L}async handleInputKey(){while(!0){let u;do while(!0){if(u=this.pollKey(),u===-1)return;if(this.viewportInterfaceId!==-1&&this.viewportInterfaceId===this.reportAbuseInterfaceId){if(u===8&&this.reportAbuseInput.length>0)this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1);break}if(this.showSocialInput){if(u>=32&&u<=122&&this.socialInput.length<80)this.socialInput=this.socialInput+String.fromCharCode(u),this.redrawChatback=!0;if(u===8&&this.socialInput.length>0)this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0;if(u===13||u===10){this.showSocialInput=!1,this.redrawChatback=!0;let R;if(this.socialInputType===1)R=c.toBase37(this.socialInput),this.addFriend(R);if(this.socialInputType===2&&this.friendCount>0)R=c.toBase37(this.socialInput),this.removeFriend(R);if(this.socialInputType===3&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(170),this.out.p1(0);let m=this.out.pos;if(this.out.p8(this.socialName37),v0.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-m),this.socialInput=c.toSentenceCase(this.socialInput),this.socialInput=D0.filter(this.socialInput),this.addMessage(6,this.socialInput,c.formatName(c.fromBase37(this.socialName37))),this.chatPrivateMode===2)this.chatPrivateMode=1,this.redrawPrivacySettings=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode)}if(this.socialInputType===4&&this.ignoreCount<100)R=c.toBase37(this.socialInput),this.addIgnore(R);if(this.socialInputType===5&&this.ignoreCount>0)R=c.toBase37(this.socialInput),this.removeIgnore(R)}}else if(this.chatbackInputOpen){if(u>=48&&u<=57&&this.chatbackInput.length<10)this.chatbackInput=this.chatbackInput+String.fromCharCode(u),this.redrawChatback=!0;if(u===8&&this.chatbackInput.length>0)this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0;if(u===13||u===10){if(this.chatbackInput.length>0){let R=0;try{R=parseInt(this.chatbackInput,10)}catch(m){}this.out.p1isaac(190),this.out.p4(R)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(this.chatInterfaceId===-1){if(u>=32&&(u<=122||this.chatTyped.startsWith("::")&&u<=126)&&this.chatTyped.length<80)this.chatTyped=this.chatTyped+String.fromCharCode(u),this.redrawChatback=!0;if(u===8&&this.chatTyped.length>0)this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0;if((u===13||u===10)&&this.chatTyped.length>0){if(this.staffmodlevel===2){if(this.chatTyped==="::clientdrop")await this.tryReconnect();else if(this.chatTyped==="::prefetchmusic"){if(this.onDemand)for(let R=0;R<this.onDemand.getFileCount(2);R++)this.onDemand.prefetchPriority(2,R,1)}else if(this.chatTyped==="::lag")this.lag()}if(this.chatTyped==="::fpson")this.displayFps=!0;else if(this.chatTyped==="::fpsoff")this.displayFps=!1;else if(this.chatTyped.startsWith("::fps "))try{let R=parseInt(this.chatTyped.substring(6))||50;this.setTargetedFramerate(R)}catch(R){}else if(this.chatTyped.startsWith("::"))this.out.p1isaac(76),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let R=0;if(this.chatTyped.startsWith("yellow:"))R=0,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("red:"))R=1,this.chatTyped=this.chatTyped.substring(4);else if(this.chatTyped.startsWith("green:"))R=2,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("cyan:"))R=3,this.chatTyped=this.chatTyped.substring(5);else if(this.chatTyped.startsWith("purple:"))R=4,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("white:"))R=5,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("flash1:"))R=6,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash2:"))R=7,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash3:"))R=8,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("glow1:"))R=9,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow2:"))R=10,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow3:"))R=11,this.chatTyped=this.chatTyped.substring(6);let m=0;if(this.chatTyped.startsWith("wave:"))m=1,this.chatTyped=this.chatTyped.substring(5);if(this.chatTyped.startsWith("scroll:"))m=2,this.chatTyped=this.chatTyped.substring(7);this.out.p1isaac(171),this.out.p1(0);let _=this.out.pos;if(this.out.p1(R),this.out.p1(m),v0.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-_),this.chatTyped=c.toSentenceCase(this.chatTyped),this.chatTyped=D0.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name)if(this.localPlayer.chatMessage=this.chatTyped,this.localPlayer.chatColour=R,this.localPlayer.chatEffect=m,this.localPlayer.chatTimer=150,this.staffmodlevel===2)this.addMessage(2,this.localPlayer.chatMessage,"@cr2@"+this.localPlayer.name);else if(this.staffmodlevel===1)this.addMessage(2,this.localPlayer.chatMessage,"@cr1@"+this.localPlayer.name);else this.addMessage(2,this.localPlayer.chatMessage,this.localPlayer.name);if(this.chatPublicMode===2)this.chatPublicMode=3,this.redrawPrivacySettings=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode)}this.chatTyped="",this.redrawChatback=!0}}}while((u<97||u>122)&&(u<65||u>90)&&(u<48||u>57)&&u!==32);if(this.reportAbuseInput.length<12)this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(u)}}lag(){if(this.onDemand);}updatePlayers(){for(let u=-1;u<this.playerCount;u++){let R;if(u===-1)R=2047;else R=this.playerIds[u];let m=this.players[R];if(m)this.updateEntity(m)}if(v.cyclelogic6++,v.cyclelogic6>1406){v.cyclelogic6=0,this.out.p1isaac(215),this.out.p1(0);let u=this.out.pos;if(this.out.p1(162),this.out.p1(22),(Math.random()*2|0)===0)this.out.p1(84);if(this.out.p2(31824),this.out.p2(13490),(Math.random()*2|0)===0)this.out.p1(123);if((Math.random()*2|0)===0)this.out.p1(134);this.out.p1(100),this.out.p1(94),this.out.p2(35521),this.out.psize1(this.out.pos-u)}}updateNpcs(){for(let u=0;u<this.npcCount;u++){let R=this.npcIds[u],m=this.npcs[R];if(m&&m.type)this.updateEntity(m)}}updateEntity(u){if(u.x<128||u.z<128||u.x>=13184||u.z>=13184)u.primarySeqId=-1,u.spotanimId=-1,u.forceMoveEndCycle=0,u.forceMoveStartCycle=0,u.x=u.routeTileX[0]*128+u.size*64,u.z=u.routeTileZ[0]*128+u.size*64,u.clearRoute();if(u===this.localPlayer&&(u.x<1536||u.z<1536||u.x>=11776||u.z>=11776))u.primarySeqId=-1,u.spotanimId=-1,u.forceMoveEndCycle=0,u.forceMoveStartCycle=0,u.x=u.routeTileX[0]*128+u.size*64,u.z=u.routeTileZ[0]*128+u.size*64,u.clearRoute();if(u.forceMoveEndCycle>this.loopCycle)this.updateForceMovement(u);else if(u.forceMoveStartCycle>=this.loopCycle)this.startForceMovement(u);else this.updateMovement(u);this.updateFacingDirection(u),this.updateSequences(u)}updateForceMovement(u){let R=u.forceMoveEndCycle-this.loopCycle,m=u.forceMoveStartSceneTileX*128+u.size*64,_=u.forceMoveStartSceneTileZ*128+u.size*64;if(u.x+=(m-u.x)/R|0,u.z+=(_-u.z)/R|0,u.seqDelayMove=0,u.forceMoveFaceDirection===0)u.dstYaw=1024;else if(u.forceMoveFaceDirection===1)u.dstYaw=1536;else if(u.forceMoveFaceDirection===2)u.dstYaw=0;else if(u.forceMoveFaceDirection===3)u.dstYaw=512}startForceMovement(u){if(u.forceMoveStartCycle===this.loopCycle||u.primarySeqId===-1||u.primarySeqDelay!==0||u.primarySeqCycle+1>o.types[u.primarySeqId].getFrameDuration(u.primarySeqFrame)){let R=u.forceMoveStartCycle-u.forceMoveEndCycle,m=this.loopCycle-u.forceMoveEndCycle,_=u.forceMoveStartSceneTileX*128+u.size*64,b=u.forceMoveStartSceneTileZ*128+u.size*64,E=u.forceMoveEndSceneTileX*128+u.size*64,O=u.forceMoveEndSceneTileZ*128+u.size*64;u.x=(_*(R-m)+E*m)/R|0,u.z=(b*(R-m)+O*m)/R|0}if(u.seqDelayMove=0,u.forceMoveFaceDirection===0)u.dstYaw=1024;else if(u.forceMoveFaceDirection===1)u.dstYaw=1536;else if(u.forceMoveFaceDirection===2)u.dstYaw=0;else if(u.forceMoveFaceDirection===3)u.dstYaw=512;u.yaw=u.dstYaw}updateMovement(u){if(u.secondarySeqId=u.readyanim,u.routeLength===0){u.seqDelayMove=0;return}if(u.primarySeqId!==-1&&u.primarySeqDelay===0){let L=o.types[u.primarySeqId];if(u.preanimRouteLength>0&&L.preanim_move===0){u.seqDelayMove++;return}if(u.preanimRouteLength<=0&&L.postanim_move===0){u.seqDelayMove++;return}}let{x:R,z:m}=u,_=u.routeTileX[u.routeLength-1]*128+u.size*64,b=u.routeTileZ[u.routeLength-1]*128+u.size*64;if(_-R>256||_-R<-256||b-m>256||b-m<-256){u.x=_,u.z=b;return}if(R<_)if(m<b)u.dstYaw=1280;else if(m>b)u.dstYaw=1792;else u.dstYaw=1536;else if(R>_)if(m<b)u.dstYaw=768;else if(m>b)u.dstYaw=256;else u.dstYaw=512;else if(m<b)u.dstYaw=1024;else u.dstYaw=0;let E=u.dstYaw-u.yaw&2047;if(E>1024)E-=2048;let O=u.walkanim_b;if(E>=-256&&E<=256)O=u.walkanim;else if(E>=256&&E<768)O=u.walkanim_r;else if(E>=-768&&E<=-256)O=u.walkanim_l;if(O===-1)O=u.walkanim;u.secondarySeqId=O;let I=4;if(u.yaw!==u.dstYaw&&u.targetId===-1)I=2;if(u.routeLength>2)I=6;if(u.routeLength>3)I=8;if(u.seqDelayMove>0&&u.routeLength>1)I=8,u.seqDelayMove--;if(u.routeRun[u.routeLength-1])I<<=1;if(I>=8&&u.secondarySeqId===u.walkanim&&u.runanim!==-1)u.secondarySeqId=u.runanim;if(R<_){if(u.x+=I,u.x>_)u.x=_}else if(R>_){if(u.x-=I,u.x<_)u.x=_}if(m<b){if(u.z+=I,u.z>b)u.z=b}else if(m>b){if(u.z-=I,u.z<b)u.z=b}if(u.x===_&&u.z===b){if(u.routeLength--,u.preanimRouteLength>0)u.preanimRouteLength--}}updateFacingDirection(u){if(u.targetId!==-1&&u.targetId<32768){let m=this.npcs[u.targetId];if(m){let _=u.x-m.x,b=u.z-m.z;if(_!==0||b!==0)u.dstYaw=(Math.atan2(_,b)*325.949|0)&2047}}if(u.targetId>=32768){let m=u.targetId-32768;if(m===this.localPid)m=2047;let _=this.players[m];if(_){let b=u.x-_.x,E=u.z-_.z;if(b!==0||E!==0)u.dstYaw=(Math.atan2(b,E)*325.949|0)&2047}}if((u.targetTileX!==0||u.targetTileZ!==0)&&(u.routeLength===0||u.seqDelayMove>0)){let m=u.x-(u.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX)*64,_=u.z-(u.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ)*64;if(m!==0||_!==0)u.dstYaw=(Math.atan2(m,_)*325.949|0)&2047;u.targetTileX=0,u.targetTileZ=0}let R=u.dstYaw-u.yaw&2047;if(R!==0){if(R<32||R>2016)u.yaw=u.dstYaw;else if(R>1024)u.yaw-=32;else u.yaw+=32;if(u.yaw&=2047,u.secondarySeqId===u.readyanim&&u.yaw!==u.dstYaw)if(u.turnanim!=-1)u.secondarySeqId=u.turnanim;else u.secondarySeqId=u.walkanim}}updateSequences(u){u.needsForwardDrawPadding=!1;let R;if(u.secondarySeqId!==-1){if(R=o.types[u.secondarySeqId],u.secondarySeqCycle++,u.secondarySeqFrame<R.frameCount&&u.secondarySeqCycle>R.getFrameDuration(u.secondarySeqFrame))u.secondarySeqCycle=0,u.secondarySeqFrame++;if(u.secondarySeqFrame>=R.frameCount)u.secondarySeqCycle=0,u.secondarySeqFrame=0}if(u.spotanimId!==-1&&this.loopCycle>=u.spotanimLastCycle){if(u.spotanimFrame<0)u.spotanimFrame=0;R=q0.types[u.spotanimId].seq,u.spotanimCycle++;while(R&&u.spotanimFrame<R.frameCount&&u.spotanimCycle>R.getFrameDuration(u.spotanimFrame))u.spotanimCycle-=R.getFrameDuration(u.spotanimFrame),u.spotanimFrame++;if(R&&u.spotanimFrame>=R.frameCount){if(u.spotanimFrame<0||u.spotanimFrame>=R.frameCount)u.spotanimId=-1}}if(u.primarySeqId!=-1&&u.primarySeqDelay<=1){if(R=o.types[u.primarySeqId],R.preanim_move===1&&u.preanimRouteLength>0&&this.loopCycle>=u.forceMoveStartCycle&&this.loopCycle>u.forceMoveEndCycle){u.primarySeqDelay=1;return}}if(u.primarySeqId!==-1&&u.primarySeqDelay===0){R=o.types[u.primarySeqId],u.primarySeqCycle++;while(u.primarySeqFrame<R.frameCount&&u.primarySeqCycle>R.getFrameDuration(u.primarySeqFrame))u.primarySeqCycle-=R.getFrameDuration(u.primarySeqFrame),u.primarySeqFrame++;if(u.primarySeqFrame>=R.frameCount){if(u.primarySeqFrame-=R.replayoff,u.primarySeqLoop++,u.primarySeqLoop>=R.replaycount)u.primarySeqId=-1;if(u.primarySeqFrame<0||u.primarySeqFrame>=R.frameCount)u.primarySeqId=-1}u.needsForwardDrawPadding=R.stretches}if(u.primarySeqDelay>0)u.primarySeqDelay--}async loadTitle(){if(this.imageTitle2)return;if(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new L0(128,265),F.clear(),this.imageTitle1=new L0(128,265),F.clear(),this.imageTitle2=new L0(509,171),F.clear(),this.imageTitle3=new L0(360,132),F.clear(),this.imageTitle4=new L0(360,200),F.clear(),this.imageTitle5=new L0(202,238),F.clear(),this.imageTitle6=new L0(203,238),F.clear(),this.imageTitle7=new L0(74,94),F.clear(),this.imageTitle8=new L0(75,94),F.clear(),this.jagTitle)await this.loadTitleBackground(),await this.loadTitleImages();this.redrawFrame=!0}async loadTitleBackground(){if(!this.jagTitle)return;let u=await m0.fromJpeg(this.jagTitle,"title");this.imageTitle0?.bind(),u.blitOpaque(0,0),this.imageTitle1?.bind(),u.blitOpaque(-637,0),this.imageTitle2?.bind(),u.blitOpaque(-128,0),this.imageTitle3?.bind(),u.blitOpaque(-202,-371),this.imageTitle4?.bind(),u.blitOpaque(-202,-171),this.imageTitle5?.bind(),u.blitOpaque(0,-265),this.imageTitle6?.bind(),u.blitOpaque(-562,-265),this.imageTitle7?.bind(),u.blitOpaque(-128,-171),this.imageTitle8?.bind(),u.blitOpaque(-562,-171),u.flipHorizontally(),this.imageTitle0?.bind(),u.blitOpaque(382,0),this.imageTitle1?.bind(),u.blitOpaque(-255,0),this.imageTitle2?.bind(),u.blitOpaque(254,0),this.imageTitle3?.bind(),u.blitOpaque(180,-371),this.imageTitle4?.bind(),u.blitOpaque(180,-171),this.imageTitle5?.bind(),u.blitOpaque(382,-265),this.imageTitle6?.bind(),u.blitOpaque(-180,-265),this.imageTitle7?.bind(),u.blitOpaque(254,-171),this.imageTitle8?.bind(),u.blitOpaque(-180,-171);let R=m0.fromArchive(this.jagTitle,"logo");this.imageTitle2?.bind(),R.draw((this.width/2|0)-(R.cropRight/2|0)-128,18)}async loadTitleImages(){if(!this.jagTitle)return;this.imageTitlebox=I0.fromArchive(this.jagTitle,"titlebox"),this.imageTitlebutton=I0.fromArchive(this.jagTitle,"titlebutton");for(let u=0;u<12;u++)this.imageRunes[u]=I0.fromArchive(this.jagTitle,"runes",u);if(this.imageFlamesLeft=new m0(128,265),this.imageFlamesRight=new m0(128,265),this.imageTitle0)V1(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920);if(this.imageTitle1)V1(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920);this.flameGradient0=new Int32Array(256);for(let u=0;u<64;u++)this.flameGradient0[u]=u*262144;for(let u=0;u<64;u++)this.flameGradient0[u+64]=u*1024+16711680;for(let u=0;u<64;u++)this.flameGradient0[u+128]=u*4+16776960;for(let u=0;u<64;u++)this.flameGradient0[u+192]=16777215;this.flameGradient1=new Int32Array(256);for(let u=0;u<64;u++)this.flameGradient1[u]=u*1024;for(let u=0;u<64;u++)this.flameGradient1[u+64]=u*4+65280;for(let u=0;u<64;u++)this.flameGradient1[u+128]=u*262144+65535;for(let u=0;u<64;u++)this.flameGradient1[u+192]=16777215;this.flameGradient2=new Int32Array(256);for(let u=0;u<64;u++)this.flameGradient2[u]=u*4;for(let u=0;u<64;u++)this.flameGradient2[u+64]=u*262144+255;for(let u=0;u<64;u++)this.flameGradient2[u+128]=u*1024+16711935;for(let u=0;u<64;u++)this.flameGradient2[u+192]=16777215;if(this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),await this.drawProgress(10,"Connecting to fileserver"),!this.flameActive)this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames.bind(this),35)}async drawTitle(){await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0);let u=360,R=200;if(this.titleScreenState===0){let m=(R/2|0)+80,_=(R/2|0)-20;if(this.onDemand)this.fontPlain11?.drawStringTaggableCenter(u/2,m,this.onDemand.message,7711145,!0);this.fontBold12?.drawStringTaggableCenter(u/2,_,"Welcome to RuneScape",16776960,!0),_+=30;let b=(u/2|0)-80;_=(R/2|0)+20,this.imageTitlebutton?.draw(b-73,_-20),this.fontBold12?.drawStringTaggableCenter(b,_+5,"New user",16777215,!0),b=(u/2|0)+80,this.imageTitlebutton?.draw(b-73,_-20),this.fontBold12?.drawStringTaggableCenter(b,_+5,"Existing User",16777215,!0)}else if(this.titleScreenState===2){let m=(u/2|0)-80,_=(R/2|0)-40;if(this.loginMessage0.length>0)this.fontBold12?.drawStringTaggableCenter(u/2,_-15,this.loginMessage0,16776960,!0),this.fontBold12?.drawStringTaggableCenter(u/2,_,this.loginMessage1,16776960,!0),_+=30;else this.fontBold12?.drawStringTaggableCenter(u/2,_-7,this.loginMessage1,16776960,!0),_+=30;this.fontBold12?.drawStringTaggable(u/2-90,_,`Username: ${this.username}${this.titleLoginField===0&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),_+=15,this.fontBold12?.drawStringTaggable(u/2-88,_,`Password: ${c.toAsterisks(this.password)}${this.titleLoginField===1&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),_+=15,m=(u/2|0)-80,_=(R/2|0)+50,this.imageTitlebutton?.draw(m-73,_-20),this.fontBold12?.drawStringTaggableCenter(m,_+5,"Login",16777215,!0),m=(u/2|0)+80,this.imageTitlebutton?.draw(m-73,_-20),this.fontBold12?.drawStringTaggableCenter(m,_+5,"Cancel",16777215,!0)}else if(this.titleScreenState===3){let m=u/2|0,_=(R/2|0)-60;this.fontBold12?.drawStringTaggableCenter(m,_,"Create a free account",16776960,!0),_=(R/2|0)-35,this.fontBold12?.drawStringTaggableCenter(m,_,"To create a new account you need to",16777215,!0),_+=15,this.fontBold12?.drawStringTaggableCenter(m,_,"go back to the main RuneScape webpage",16777215,!0),_+=15,this.fontBold12?.drawStringTaggableCenter(m,_,"and choose the red 'create account'",16777215,!0),_+=15,this.fontBold12?.drawStringTaggableCenter(m,_,"button at the top right of that page.",16777215,!0),_+=15,m=u/2|0,_=(R/2|0)+50,this.imageTitlebutton?.draw(m-73,_-20),this.fontBold12?.drawStringTaggableCenter(m,_+5,"Cancel",16777215,!0)}if(this.imageTitle4?.draw(202,171),this.redrawFrame)this.redrawFrame=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(202,371),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(562,265),this.imageTitle7?.draw(128,171),this.imageTitle8?.draw(562,171)}drawGame(){if(this.players===null)return;if(this.redrawFrame){if(this.redrawFrame=!1,this.areaBackleft1?.draw(0,4),this.areaBackleft2?.draw(0,357),this.areaBackright1?.draw(722,4),this.areaBackright2?.draw(743,205),this.areaBacktop1?.draw(0,0),this.areaBackvmid1?.draw(516,4),this.areaBackvmid2?.draw(516,205),this.areaBackvmid3?.draw(496,357),this.areaBackhmid2?.draw(0,338),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,this.sceneState!==2)this.areaViewport?.draw(4,4),this.areaMapback?.draw(550,4)}if(this.sceneState===2)this.drawScene();if(this.menuVisible&&this.menuArea===1)this.redrawSidebar=!0;if(this.sidebarInterfaceId!==-1){if(this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta))this.redrawSidebar=!0}if(this.selectedArea===2)this.redrawSidebar=!0;if(this.objDragArea===2)this.redrawSidebar=!0;if(this.redrawSidebar)this.drawSidebar(),this.redrawSidebar=!1;if(this.chatInterfaceId===-1){if(this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,this.mouseX>448&&this.mouseX<560&&this.mouseY>332)this.handleScrollInput(this.mouseX-17,this.mouseY-357,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let u=this.chatScrollHeight-this.chatInterface.scrollPosition-77;if(u<0)u=0;if(u>this.chatScrollHeight-77)u=this.chatScrollHeight-77;if(this.chatScrollOffset!==u)this.chatScrollOffset=u,this.redrawChatback=!0}if(this.chatInterfaceId!==-1){if(this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta))this.redrawChatback=!0}if(this.selectedArea===3)this.redrawChatback=!0;if(this.objDragArea===3)this.redrawChatback=!0;if(this.modalMessage)this.redrawChatback=!0;if(this.menuVisible&&this.menuArea===2)this.redrawChatback=!0;if(this.redrawChatback)this.drawChat(),this.redrawChatback=!1;if(this.sceneState===2)this.drawMinimap(),this.areaMapback?.draw(550,4);if(this.flashingTab!==-1)this.redrawSideicons=!0;if(this.redrawSideicons){if(this.flashingTab!==-1&&this.flashingTab===this.selectedTab)this.flashingTab=-1,this.out.p1isaac(233),this.out.p1(this.selectedTab);if(this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===0)this.imageRedstone1?.draw(22,10);else if(this.selectedTab===1)this.imageRedstone2?.draw(54,8);else if(this.selectedTab===2)this.imageRedstone2?.draw(82,8);else if(this.selectedTab===3)this.imageRedstone3?.draw(110,8);else if(this.selectedTab===4)this.imageRedstone2h?.draw(153,8);else if(this.selectedTab===5)this.imageRedstone2h?.draw(181,8);else if(this.selectedTab===6)this.imageRedstone1h?.draw(209,9)}if(this.tabInterfaceId[0]!==-1&&(this.flashingTab!==0||this.loopCycle%20<10))this.imageSideicons[0]?.draw(29,13);if(this.tabInterfaceId[1]!==-1&&(this.flashingTab!==1||this.loopCycle%20<10))this.imageSideicons[1]?.draw(53,11);if(this.tabInterfaceId[2]!==-1&&(this.flashingTab!==2||this.loopCycle%20<10))this.imageSideicons[2]?.draw(82,11);if(this.tabInterfaceId[3]!==-1&&(this.flashingTab!==3||this.loopCycle%20<10))this.imageSideicons[3]?.draw(115,12);if(this.tabInterfaceId[4]!==-1&&(this.flashingTab!==4||this.loopCycle%20<10))this.imageSideicons[4]?.draw(153,13);if(this.tabInterfaceId[5]!==-1&&(this.flashingTab!==5||this.loopCycle%20<10))this.imageSideicons[5]?.draw(180,11);if(this.tabInterfaceId[6]!==-1&&(this.flashingTab!==6||this.loopCycle%20<10))this.imageSideicons[6]?.draw(208,13)}if(this.areaBackhmid1?.draw(516,160),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===7)this.imageRedstone1v?.draw(42,0);else if(this.selectedTab===8)this.imageRedstone2v?.draw(74,0);else if(this.selectedTab===9)this.imageRedstone2v?.draw(102,0);else if(this.selectedTab===10)this.imageRedstone3v?.draw(130,1);else if(this.selectedTab===11)this.imageRedstone2hv?.draw(173,0);else if(this.selectedTab===12)this.imageRedstone2hv?.draw(201,0);else if(this.selectedTab===13)this.imageRedstone1hv?.draw(229,0)}if(this.tabInterfaceId[8]!==-1&&(this.flashingTab!==8||this.loopCycle%20<10))this.imageSideicons[7]?.draw(74,2);if(this.tabInterfaceId[9]!==-1&&(this.flashingTab!==9||this.loopCycle%20<10))this.imageSideicons[8]?.draw(102,3);if(this.tabInterfaceId[10]!==-1&&(this.flashingTab!==10||this.loopCycle%20<10))this.imageSideicons[9]?.draw(137,4);if(this.tabInterfaceId[11]!==-1&&(this.flashingTab!==11||this.loopCycle%20<10))this.imageSideicons[10]?.draw(174,2);if(this.tabInterfaceId[12]!==-1&&(this.flashingTab!==12||this.loopCycle%20<10))this.imageSideicons[11]?.draw(201,2);if(this.tabInterfaceId[13]!==-1&&(this.flashingTab!==13||this.loopCycle%20<10))this.imageSideicons[12]?.draw(226,2)}this.areaBackbase2?.draw(496,466),this.areaViewport?.bind()}if(this.redrawPrivacySettings){if(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(55,28,"Public chat",16777215,!0),this.chatPublicMode===0)this.fontPlain12?.drawStringTaggableCenter(55,41,"On",65280,!0);if(this.chatPublicMode===1)this.fontPlain12?.drawStringTaggableCenter(55,41,"Friends",16776960,!0);if(this.chatPublicMode===2)this.fontPlain12?.drawStringTaggableCenter(55,41,"Off",16711680,!0);if(this.chatPublicMode===3)this.fontPlain12?.drawStringTaggableCenter(55,41,"Hide",65535,!0);if(this.fontPlain12?.drawStringTaggableCenter(184,28,"Private chat",16777215,!0),this.chatPrivateMode===0)this.fontPlain12?.drawStringTaggableCenter(184,41,"On",65280,!0);if(this.chatPrivateMode===1)this.fontPlain12?.drawStringTaggableCenter(184,41,"Friends",16776960,!0);if(this.chatPrivateMode===2)this.fontPlain12?.drawStringTaggableCenter(184,41,"Off",16711680,!0);if(this.fontPlain12?.drawStringTaggableCenter(324,28,"Trade/duel",16777215,!0),this.chatTradeMode===0)this.fontPlain12?.drawStringTaggableCenter(324,41,"On",65280,!0);if(this.chatTradeMode===1)this.fontPlain12?.drawStringTaggableCenter(324,41,"Friends",16776960,!0);if(this.chatTradeMode===2)this.fontPlain12?.drawStringTaggableCenter(324,41,"Off",16711680,!0);this.fontPlain12?.drawStringTaggableCenter(458,33,"Report abuse",16777215,!0),this.areaBackbase1?.draw(0,453),this.areaViewport?.bind()}this.sceneDelta=0}drawScene(){if(this.sceneCycle++,this.pushNpcs(!0),this.pushPlayers(),this.pushNpcs(!1),this.pushProjectiles(),this.pushSpotanims(),!this.cutscene){let I=this.orbitCameraPitch;if((this.cameraPitchClamp/256|0)>I)I=this.cameraPitchClamp/256|0;if(this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>I)I=this.cameraModifierWobbleScale[4]+128;let L=this.orbitCameraYaw+this.macroCameraAngle&2047;if(this.localPlayer)this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,L,I,I*3+600);if(v.cyclelogic2++,v.cyclelogic2>1802){v.cyclelogic2=0,this.out.p1isaac(148),this.out.p1(0);let H=this.out.pos;if(this.out.p2(29711),this.out.p1(70),this.out.p1(Math.random()*256|0),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),(Math.random()*2|0)===0)this.out.p1(13);if((Math.random()*2|0)===0)this.out.p2(57856);this.out.p2(Math.random()*65536|0),this.out.psize1(this.out.pos-H)}}let u;if(this.cutscene)u=this.getTopLevelCutscene();else u=this.getTopLevel();let R=this.cameraX,m=this.cameraY,_=this.cameraZ,b=this.cameraPitch,E=this.cameraYaw;for(let I=0;I<5;I++)if(this.cameraModifierEnabled[I]){let L=Math.random()*(this.cameraModifierJitter[I]*2+1)-this.cameraModifierJitter[I]+Math.sin(this.cameraModifierCycle[I]*(this.cameraModifierWobbleSpeed[I]/100))*this.cameraModifierWobbleScale[I]|0;if(I===0)this.cameraX+=L;else if(I===1)this.cameraY+=L;else if(I===2)this.cameraZ+=L;else if(I===3)this.cameraYaw=this.cameraYaw+L&2047;else if(I===4){if(this.cameraPitch+=L,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}}let O=Z.cycle;J.checkHover=!0,J.pickedCount=0,J.mouseX=this.mouseX-4,J.mouseY=this.mouseY-4,F.clear(),this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,u,this.cameraYaw,this.cameraPitch,this.loopCycle),this.scene?.clearLocChanges(),this.draw2DEntityElements(),this.drawTileHint(),this.updateTextures(O),this.draw3DEntityElements(),this.areaViewport?.draw(4,4),this.cameraX=R,this.cameraY=m,this.cameraZ=_,this.cameraPitch=b,this.cameraYaw=E}pushPlayers(){if(!this.localPlayer)return;if(this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ)this.flagSceneTileX=0;for(let u=-1;u<this.playerCount;u++){let R,m;if(u===-1)R=this.localPlayer,m=33538048;else R=this.players[this.playerIds[u]],m=this.playerIds[u]<<14;if(!R||!R.isVisible())continue;if(R.lowMemory=!1,(v.lowMemory&&this.playerCount>50||this.playerCount>200)&&u!=-1&&R.secondarySeqId==R.readyanim)R.lowMemory=!0;let _=R.x>>7,b=R.z>>7;if(_<0||_>=104||b<0||b>=104)continue;if(!R.locModel||this.loopCycle<R.locStartCycle||this.loopCycle>=R.locStopCycle){if((R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[_][b]==this.sceneCycle&&u!=-1)continue;this.tileLastOccupiedCycle[_][b]=this.sceneCycle}R.y=this.getHeightmapY(this.currentLevel,R.x,R.z),this.scene?.addTemporary(this.currentLevel,R.x,R.y,R.z,R,m,R.yaw,60,R.needsForwardDrawPadding)}else R.lowMemory=!1,R.y=this.getHeightmapY(this.currentLevel,R.x,R.z),this.scene?.addTemporary2(this.currentLevel,R.x,R.y,R.z,R.minTileX,R.minTileZ,R.maxTileX,R.maxTileZ,R,m,R.yaw)}}pushNpcs(u){for(let R=0;R<this.npcCount;R++){let m=this.npcs[this.npcIds[R]],_=(this.npcIds[R]<<14)+536870912|0;if(!m||!m.isVisible()||m.type?.alwaysontop!==u)continue;let b=m.x>>7,E=m.z>>7;if(b<0||b>=104||E<0||E>=104)continue;if(m.size===1&&(m.x&127)===64&&(m.z&127)===64){if(this.tileLastOccupiedCycle[b][E]===this.sceneCycle)continue;this.tileLastOccupiedCycle[b][E]=this.sceneCycle}this.scene?.addTemporary(this.currentLevel,m.x,this.getHeightmapY(this.currentLevel,m.x,m.z),m.z,m,_,m.yaw,(m.size-1)*64+60,m.needsForwardDrawPadding)}}pushProjectiles(){for(let u=this.projectiles.head();u;u=this.projectiles.next())if(u.projLevel!==this.currentLevel||this.loopCycle>u.lastCycle)u.unlink();else if(this.loopCycle>=u.startCycle){if(u.projTarget>0){let R=this.npcs[u.projTarget-1];if(R)u.updateVelocity(R.x,this.getHeightmapY(u.projLevel,R.x,R.z)-u.projOffsetY,R.z,this.loopCycle)}if(u.projTarget<0){let R=-u.projTarget-1,m;if(R===this.localPid)m=this.localPlayer;else m=this.players[R];if(m)u.updateVelocity(m.x,this.getHeightmapY(u.projLevel,m.x,m.z)-u.projOffsetY,m.z,this.loopCycle)}u.update(this.sceneDelta),this.scene?.addTemporary(this.currentLevel,u.x|0,u.y|0,u.z|0,u,-1,u.yaw,60,!1)}}pushSpotanims(){for(let u=this.spotanims.head();u;u=this.spotanims.next())if(u.spotLevel!==this.currentLevel||u.seqComplete)u.unlink();else if(this.loopCycle>=u.startCycle)if(u.update(this.sceneDelta),u.seqComplete)u.unlink();else this.scene?.addTemporary(u.spotLevel,u.x,u.y,u.z,u,-1,0,60,!1)}orbitCamera(u,R,m,_,b,E){let O=2048-b&2047,I=2048-_&2047,L=0,H=0,N=E,G,Q,$;if(O!==0)G=Z.sin[O],Q=Z.cos[O],$=H*Q-E*G>>16,N=H*G+E*Q>>16,H=$;if(I!==0)G=Z.sin[I],Q=Z.cos[I],$=N*G+L*Q>>16,N=N*Q-L*G>>16,L=$;this.cameraX=u-L,this.cameraY=R-H,this.cameraZ=m-N,this.cameraPitch=b,this.cameraYaw=_}getTopLevelCutscene(){if(!this.levelTileFlags)return 0;return this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ)-this.cameraY>=800||(this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7]&4)===0?3:this.currentLevel}getTopLevel(){let u=3;if(this.cameraPitch<310&&this.localPlayer){let R=this.cameraX>>7,m=this.cameraZ>>7,_=this.localPlayer.x>>7,b=this.localPlayer.z>>7;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][m]&4)!==0)u=this.currentLevel;let E;if(_>R)E=_-R;else E=R-_;let O;if(b>m)O=b-m;else O=m-b;if(E>O){let I=O*65536/E|0,L=32768;while(R!==_){if(R<_)R++;else if(R>_)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][m]&4)!==0)u=this.currentLevel;if(L+=I,L>=65536){if(L-=65536,m<b)m++;else if(m>b)m--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][m]&4)!==0)u=this.currentLevel}}}else{let I=E*65536/O|0,L=32768;while(m!==b){if(m<b)m++;else if(m>b)m--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][m]&4)!==0)u=this.currentLevel;if(L+=I,L>=65536){if(L-=65536,R<_)R++;else if(R>_)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][m]&4)!==0)u=this.currentLevel}}}}if(this.localPlayer&&this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7]&4)!==0)u=this.currentLevel;return u}draw2DEntityElements(){this.chatCount=0;for(let u=-1;u<this.playerCount+this.npcCount;u++){let R=null;if(u===-1)R=this.localPlayer;else if(u<this.playerCount)R=this.players[this.playerIds[u]];else R=this.npcs[this.npcIds[u-this.playerCount]];if(!R||!R.isVisible())continue;if(u>=this.playerCount){let m=R.type;if(m&&m.headicon>=0&&m.headicon<this.imageHeadicon.length){if(this.projectFromEntity(R,R.height+15),this.projectX>-1)this.imageHeadicon[m.headicon]?.draw(this.projectX-12,this.projectY-30)}if(this.hintType===1&&this.hintNpc===this.npcIds[u-this.playerCount]&&this.loopCycle%20<10){if(this.projectFromEntity(R,R.height+15),this.projectX>-1)this.imageHeadicon[2]?.draw(this.projectX-12,this.projectY-28)}}else{let m=30,_=R;if(_.headicons!==0){if(this.projectFromEntity(R,R.height+15),this.projectX>-1){for(let b=0;b<8;b++)if((_.headicons&1<<b)!==0)this.imageHeadicon[b]?.draw(this.projectX-12,this.projectY-m),m-=25}}if(u>=0&&this.hintType===10&&this.hintPlayer===this.playerIds[u]){if(this.projectFromEntity(R,R.height+15),this.projectX>-1)this.imageHeadicon[7]?.draw(this.projectX-12,this.projectY-m)}}if(R.chatMessage&&(u>=this.playerCount||this.chatPublicMode===0||this.chatPublicMode===3||this.chatPublicMode===1&&this.isFriend(R.name))){if(this.projectFromEntity(R,R.height),this.projectX>-1&&this.chatCount<50&&this.fontBold12){if(this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(R.chatMessage)/2|0,this.chatHeight[this.chatCount]=this.fontBold12.height2d,this.chatX[this.chatCount]=this.projectX,this.chatY[this.chatCount]=this.projectY,this.chatColors[this.chatCount]=R.chatColour,this.chatEffect[this.chatCount]=R.chatEffect,this.chatTimers[this.chatCount]=R.chatTimer,this.chats[this.chatCount++]=R.chatMessage,this.chatEffects===0&&R.chatEffect===1)this.chatHeight[this.chatCount]+=10,this.chatY[this.chatCount]+=5;if(this.chatEffects===0&&R.chatEffect===2)this.chatWidth[this.chatCount]=60}}if(R.combatCycle>this.loopCycle+100){if(this.projectFromEntity(R,R.height+15),this.projectX>-1){let m=R.health*30/R.totalHealth|0;if(m>30)m=30;F.fillRect2d(this.projectX-15,this.projectY-3,m,5,65280),F.fillRect2d(this.projectX-15+m,this.projectY-3,30-m,5,16711680)}}for(let m=0;m<4;++m)if(R.damageCycles[m]>this.loopCycle){if(this.projectFromEntity(R,R.height/2|0),this.projectX<=-1)continue;if(m==1)this.projectY-=20;else if(m==2)this.projectX-=15,this.projectY-=10;else if(m==3)this.projectX+=15,this.projectY-=10;this.imageHitmarks[R.damageTypes[m]]?.draw(this.projectX-12,this.projectY-12),this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,R.damageValues[m].toString(),0),this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,R.damageValues[m].toString(),16777215)}}for(let u=0;u<this.chatCount;u++){let R=this.chatX[u],m=this.chatY[u],_=this.chatWidth[u],b=this.chatHeight[u],E=!0;while(E){E=!1;for(let I=0;I<u;I++)if(m+2>this.chatY[I]-this.chatHeight[I]&&m-b<this.chatY[I]+2&&R-_<this.chatX[I]+this.chatWidth[I]&&R+_>this.chatX[I]-this.chatWidth[I]&&this.chatY[I]-this.chatHeight[I]<m)m=this.chatY[I]-this.chatHeight[I],E=!0}this.projectX=this.chatX[u],this.projectY=this.chatY[u]=m;let O=this.chats[u];if(this.chatEffects===0){let I=16776960;if(this.chatColors[u]<6)I=v.CHAT_COLORS[this.chatColors[u]];else if(this.chatColors[u]===6)I=this.sceneCycle%20<10?16711680:16776960;else if(this.chatColors[u]===7)I=this.sceneCycle%20<10?255:65535;else if(this.chatColors[u]===8)I=this.sceneCycle%20<10?45056:8454016;else if(this.chatColors[u]===9){let L=150-this.chatTimers[u];if(L<50)I=L*1280+16711680;else if(L<100)I=16776960-(L-50)*327680;else if(L<150)I=(L-100)*5+65280}else if(this.chatColors[u]===10){let L=150-this.chatTimers[u];if(L<50)I=L*5+16711680;else if(L<100)I=16711935-(L-50)*327680;else if(L<150)I=(L-100)*327680+255-(L-100)*5}if(this.chatColors[u]===11){let L=150-this.chatTimers[u];if(L<50)I=16777215-L*327685;else if(L<100)I=(L-50)*327685+65280;else if(L<150)I=16777215-(L-100)*327680}if(this.chatEffect[u]===0)this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,O,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,O,I);else if(this.chatEffect[u]===1)this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,O,0,this.sceneCycle),this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,O,I,this.sceneCycle);else if(this.chatEffect[u]===2){let L=this.fontBold12?.stringWidth(O)??0,H=(150-this.chatTimers[u])*(L+100)/150;F.setBounds(this.projectX-50,0,this.projectX+50,334),this.fontBold12?.drawString(this.projectX+50-H,this.projectY+1,O,0),this.fontBold12?.drawString(this.projectX+50-H,this.projectY,O,I),F.resetBounds()}}else this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,O,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,O,16776960)}}drawTileHint(){if(this.hintType!==2||!this.imageHeadicon[2])return;if(this.projectFromGround((this.hintTileX-this.sceneBaseTileX<<7)+this.hintOffsetX,this.hintHeight*2,(this.hintTileZ-this.sceneBaseTileZ<<7)+this.hintOffsetZ),this.projectX>-1&&this.loopCycle%20<10)this.imageHeadicon[2].draw(this.projectX-12,this.projectY-28)}projectFromEntity(u,R){this.projectFromGround(u.x,R,u.z)}projectFromGround(u,R,m){if(u<128||m<128||u>13056||m>13056){this.projectX=-1,this.projectY=-1;return}let _=this.getHeightmapY(this.currentLevel,u,m)-R;this.project(u,_,m)}project(u,R,m){let _=u-this.cameraX,b=R-this.cameraY,E=m-this.cameraZ,O=Z.sin[this.cameraPitch],I=Z.cos[this.cameraPitch],L=Z.sin[this.cameraYaw],H=Z.cos[this.cameraYaw],N=E*L+_*H>>16;if(E=E*H-_*L>>16,_=N,N=b*I-E*O>>16,E=b*O+E*I>>16,b=N,E>=50)this.projectX=Z.centerX+((_<<9)/E|0),this.projectY=Z.centerY+((b<<9)/E|0);else this.projectX=-1,this.projectY=-1}getHeightmapY(u,R,m){if(!this.levelHeightmap)return 0;let _=R>>7,b=m>>7;if(_<0||b<0||_>103||b>103)return 0;let E=u;if(u<3&&this.levelTileFlags&&(this.levelTileFlags[1][_][b]&2)===2)E=u+1;let O=R&127,I=m&127,L=this.levelHeightmap[E][_][b]*(128-O)+this.levelHeightmap[E][_+1][b]*O>>7,H=this.levelHeightmap[E][_][b+1]*(128-O)+this.levelHeightmap[E][_+1][b+1]*O>>7;return L*(128-I)+H*I>>7}updateTextures(u){if(!v.lowMemory){if(Z.textureCycle[17]>=u){let R=Z.textures[17];if(!R)return;let m=R.width2d*R.height2d-1,_=R.width2d*this.sceneDelta*2,b=R.pixels,E=this.textureBuffer;for(let O=0;O<=m;O++)E[O]=b[O-_&m];R.pixels=E,this.textureBuffer=b,Z.pushTexture(17)}if(Z.textureCycle[24]>=u){let R=Z.textures[24];if(!R)return;let m=R.width2d*R.height2d-1,_=R.width2d*this.sceneDelta*2,b=R.pixels,E=this.textureBuffer;for(let O=0;O<=m;O++)E[O]=b[O-_&m];R.pixels=E,this.textureBuffer=b,Z.pushTexture(24)}}}draw3DEntityElements(){if(this.drawPrivateMessages(),this.crossMode===1)this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-4,this.crossY-8-4);else if(this.crossMode===2)this.imageCrosses[(this.crossCycle/100|0)+4]?.draw(this.crossX-8-4,this.crossY-8-4);if(this.viewportOverlayInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportOverlayInterfaceId,this.sceneDelta),this.drawInterface(s.types[this.viewportOverlayInterfaceId],0,0,0);if(this.field1264>0){let u=302-(Math.abs(Math.sin(this.field1264/10)*10)|0);for(let R=0;R<30;R++){let m=(30-R)*16;F.drawHorizontalLineAlpha(256-m/2,u+R,16776960,m,this.field1264)}}if(this.viewportInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(s.types[this.viewportInterfaceId],0,0,0);if(this.updateWorldLocation(),!this.menuVisible)this.handleInput(),this.drawTooltip();else if(this.menuArea===0)this.drawMenu();if(this.inMultizone===1)if(this.wildernessLevel>0||this.worldLocationState===1)this.imageHeadicon[1]?.draw(472,258);else this.imageHeadicon[1]?.draw(472,296);if(this.wildernessLevel>0)this.imageHeadicon[0]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,16776960);if(this.worldLocationState===1)this.imageHeadicon[6]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",16776960);if(this.displayFps){let u=507,R=20,m=16776960;if(this.fps<15)m=16711680;this.fontPlain12?.drawStringRight(u,R,"Fps:"+this.fps,m),R+=15;let _=-1;if(typeof window.performance.memory!=="undefined")_=window.performance.memory.usedJSHeapSize/1024|0;if(_!==-1)this.fontPlain12?.drawStringRight(u,R,"Mem:"+_+"k",16776960)}if(this.systemUpdateTimer!==0){let u=this.systemUpdateTimer/50|0,R=u/60|0;if(u%=60,u<10)this.fontPlain12?.drawString(4,329,"System update in: "+R+":0"+u,16776960);else this.fontPlain12?.drawString(4,329,"System update in: "+R+":"+u,16776960)}}drawPrivateMessages(){if(this.splitPrivateChat===0)return;let u=this.fontPlain12,R=0;if(this.systemUpdateTimer!==0)R=1;for(let m=0;m<100;m++){if(!this.messageText[m])continue;let _=this.messageType[m],b=this.messageSender[m],E=0;if(b&&b.startsWith("@cr1@"))b=b.substring(5),E=1;else if(b&&b.startsWith("@cr2@"))b=b.substring(5),E=2;if((_==3||_==7)&&(_==7||this.chatPrivateMode==0||this.chatPrivateMode==1&&this.isFriend(b))){let O=329-R*13,I=4;if(u?.drawString(4,O,"From",0),u?.drawString(4,O-1,"From",65535),I+=u?.stringWidth("From ")??0,E==1)this.imageModIcons[0].draw(I,O-12),I+=14;else if(E==2)this.imageModIcons[1].draw(I,O-12),I+=14;if(u?.drawString(I,O,b+": "+this.messageText[m],0),u?.drawString(I,O-1,b+": "+this.messageText[m],65535),R++,R>=5)return}else if(_===5&&this.chatPrivateMode<2){let O=329-R*13;if(u?.drawString(4,O,this.messageText[m],0),u?.drawString(4,O-1,this.messageText[m],65535),R++,R>=5)return}else if(_===6&&this.chatPrivateMode<2){let O=329-R*13;if(u?.drawString(4,O,"To "+b+": "+this.messageText[m],0),u?.drawString(4,O-1,"To "+b+": "+this.messageText[m],65535),R++,R>=5)return}}}updateWorldLocation(){if(!this.localPlayer)return;let u=(this.localPlayer.x>>7)+this.sceneBaseTileX,R=(this.localPlayer.z>>7)+this.sceneBaseTileZ;if(u>=2944&&u<3392&&R>=3520&&R<6400)this.wildernessLevel=((R-3520)/8|0)+1;else if(u>=2944&&u<3392&&R>=9920&&R<12800)this.wildernessLevel=((R-9920)/8|0)+1;else this.wildernessLevel=0;if(this.worldLocationState=0,u>=3328&&u<3392&&R>=3200&&R<3264){let m=u&63,_=R&63;if(m>=4&&m<=29&&_>=44&&_<=58)this.worldLocationState=1;else if(m>=36&&m<=61&&_>=44&&_<=58)this.worldLocationState=1;else if(m>=4&&m<=29&&_>=25&&_<=39)this.worldLocationState=1;else if(m>=36&&m<=61&&_>=25&&_<=39)this.worldLocationState=1;else if(m>=4&&m<=29&&_>=6&&_<=20)this.worldLocationState=1;else if(m>=36&&m<=61&&_>=6&&_<=20)this.worldLocationState=1}if(this.worldLocationState===0&&u>=3328&&u<=3393&&R>=3203&&R<=3325)this.worldLocationState=2;if(this.overrideChat=0,u>=3053&&u<=3156&&R>=3056&&R<=3136)this.overrideChat=1;else if(u>=3072&&u<=3118&&R>=9492&&R<=9535)this.overrideChat=1;if(this.overrideChat===1&&u>=3139&&u<=3199&&R>=3008&&R<=3062)this.overrideChat=0}drawTooltip(){if(this.menuSize<2&&this.objSelected===0&&this.spellSelected===0)return;let u;if(this.objSelected===1&&this.menuSize<2)u="Use "+this.objSelectedName+" with...";else if(this.spellSelected===1&&this.menuSize<2)u=this.spellCaption+"...";else u=this.menuOption[this.menuSize-1];if(this.menuSize>2)u=u+"@whi@ / "+(this.menuSize-2)+" more options";this.fontBold12?.drawStringTooltip(4,15,u,16777215,!0,this.loopCycle/1000|0)}drawMenu(){let u=this.menuX,R=this.menuY,m=this.menuWidth,_=this.menuHeight,b=6116423;F.fillRect2d(u,R,m,_,b),F.fillRect2d(u+1,R+1,m-2,16,0),F.drawRect(u+1,R+18,m-2,_-19,0),this.fontBold12?.drawString(u+3,R+14,"Choose Option",b);let E=this.mouseX,O=this.mouseY;if(this.menuArea===0)E-=4,O-=4;else if(this.menuArea===1)E-=553,O-=205;else if(this.menuArea===2)E-=17,O-=357;for(let I=0;I<this.menuSize;I++){let L=R+(this.menuSize-1-I)*15+31,H=16777215;if(E>u&&E<u+m&&O>L-13&&O<L+3)H=16776960;this.fontBold12?.drawStringTaggable(u+3,L,this.menuOption[I],H,!0)}}drawMinimapLoc(u,R,m,_,b){if(!this.scene||!this.imageMinimap)return;let E=this.scene.getWallTypecode(m,u,R);if(E!==0){let O=this.scene.getInfo(m,u,R,E),I=O>>6&3,L=O&31,H=_;if(E>0)H=b;let N=this.imageMinimap.pixels,G=u*4+(103-R)*512*4+24624,Q=E>>14&32767,$=_0.get(Q);if($.mapscene===-1){if(L===g.WALL_STRAIGHT.id||L===g.WALL_L.id){if(I===0)N[G]=H,N[G+512]=H,N[G+1024]=H,N[G+1536]=H;else if(I===1)N[G]=H,N[G+1]=H,N[G+2]=H,N[G+3]=H;else if(I===2)N[G+3]=H,N[G+3+512]=H,N[G+3+1024]=H,N[G+3+1536]=H;else if(I===3)N[G+1536]=H,N[G+1536+1]=H,N[G+1536+2]=H,N[G+1536+3]=H}if(L===g.WALL_SQUARE_CORNER.id){if(I===0)N[G]=H;else if(I===1)N[G+3]=H;else if(I===2)N[G+3+1536]=H;else if(I===3)N[G+1536]=H}if(L===g.WALL_L.id){if(I===3)N[G]=H,N[G+512]=H,N[G+1024]=H,N[G+1536]=H;else if(I===0)N[G]=H,N[G+1]=H,N[G+2]=H,N[G+3]=H;else if(I===1)N[G+3]=H,N[G+3+512]=H,N[G+3+1024]=H,N[G+3+1536]=H;else if(I===2)N[G+1536]=H,N[G+1536+1]=H,N[G+1536+2]=H,N[G+1536+3]=H}}else{let T=this.imageMapscene[$.mapscene];if(T){let U=($.width*4-T.width2d)/2|0,K=($.length*4-T.height2d)/2|0;T.draw(u*4+48+U,(104-R-$.length)*4+K+48)}}}if(E=this.scene.getLocTypecode(m,u,R),E!==0){let O=this.scene.getInfo(m,u,R,E),I=O>>6&3,L=O&31,H=E>>14&32767,N=_0.get(H);if(N.mapscene===-1){if(L===g.WALL_DIAGONAL.id){let G=15658734;if(E>0)G=15597568;let Q=this.imageMinimap.pixels,$=u*4+(104-1-R)*512*4+24624;if(I===0||I===2)Q[$+1536]=G,Q[$+1024+1]=G,Q[$+512+2]=G,Q[$+3]=G;else Q[$]=G,Q[$+512+1]=G,Q[$+1024+2]=G,Q[$+1536+3]=G}}else{let G=this.imageMapscene[N.mapscene];if(G){let Q=(N.width*4-G.width2d)/2|0,$=(N.length*4-G.height2d)/2|0;G.draw(u*4+48+Q,(104-R-N.length)*4+$+48)}}}if(E=this.scene.getGroundDecorTypecode(m,u,R),E!==0){let O=E>>14&32767,I=_0.get(O);if(I.mapscene!==-1){let L=this.imageMapscene[I.mapscene];if(L){let H=(I.width*4-L.width2d)/2|0,N=(I.length*4-L.height2d)/2|0;L.draw(u*4+48+H,(104-R-I.length)*4+N+48)}}}}interactWithLoc(u,R,m,_){if(!this.localPlayer||!this.scene)return!1;let b=_>>14&32767,E=this.scene.getInfo(this.currentLevel,R,m,_);if(E===-1)return!1;let O=E&31,I=E>>6&3;if(O===g.CENTREPIECE_STRAIGHT.id||O===g.CENTREPIECE_DIAGONAL.id||O===g.GROUND_DECOR.id){let L=_0.get(b),H,N;if(I===0||I===2)H=L.width,N=L.length;else H=L.length,N=L.width;let G=L.forceapproach;if(I!==0)G=(G<<I&15)+(G>>4-I);this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,m,2,H,N,0,0,G,!1)}else this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,m,2,0,0,I,O+1,0,!1);return this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(u),this.out.p2(R+this.sceneBaseTileX),this.out.p2(m+this.sceneBaseTileZ),this.out.p2(b),!0}tryMove(u,R,m,_,b,E,O,I,L,H,N){let G=this.levelCollisionMap[this.currentLevel];if(!G)return!1;let Q=104,$=104;for(let f=0;f<Q;f++)for(let D=0;D<$;D++){let j=e.index(f,D);this.bfsDirection[j]=0,this.bfsCost[j]=99999999}let T=u,U=R,K=e.index(u,R);this.bfsDirection[K]=99,this.bfsCost[K]=0;let q=0,w=0;this.bfsStepX[q]=u,this.bfsStepZ[q++]=R;let V=!1,Y=this.bfsStepX.length,A=G.flags;while(w!==q){if(T=this.bfsStepX[w],U=this.bfsStepZ[w],w=(w+1)%Y,T===m&&U===_){V=!0;break}if(L!==g.WALL_STRAIGHT.id){if((L<g.WALLDECOR_STRAIGHT_OFFSET.id||L===g.CENTREPIECE_STRAIGHT.id)&&G.reachedWall(T,U,m,_,L-1,I)){V=!0;break}if(L<g.CENTREPIECE_STRAIGHT.id&&G.reachedWallDecoration(T,U,m,_,L-1,I)){V=!0;break}}if(E!==0&&O!==0&&G.reachedLoc(T,U,m,_,E,O,H)){V=!0;break}let f=this.bfsCost[e.index(T,U)]+1,D=e.index(T-1,U);if(T>0&&this.bfsDirection[D]===0&&(A[D]&2621704)===0)this.bfsStepX[q]=T-1,this.bfsStepZ[q]=U,q=(q+1)%Y,this.bfsDirection[D]=2,this.bfsCost[D]=f;if(D=e.index(T+1,U),T<Q-1&&this.bfsDirection[D]===0&&(A[D]&2621824)===0)this.bfsStepX[q]=T+1,this.bfsStepZ[q]=U,q=(q+1)%Y,this.bfsDirection[D]=8,this.bfsCost[D]=f;if(D=e.index(T,U-1),U>0&&this.bfsDirection[D]===0&&(A[D]&2621698)===0)this.bfsStepX[q]=T,this.bfsStepZ[q]=U-1,q=(q+1)%Y,this.bfsDirection[D]=1,this.bfsCost[D]=f;if(D=e.index(T,U+1),U<$-1&&this.bfsDirection[D]===0&&(A[D]&2621728)===0)this.bfsStepX[q]=T,this.bfsStepZ[q]=U+1,q=(q+1)%Y,this.bfsDirection[D]=4,this.bfsCost[D]=f;if(D=e.index(T-1,U-1),T>0&&U>0&&this.bfsDirection[D]===0&&(A[D]&2621710)===0&&(A[e.index(T-1,U)]&2621704)===0&&(A[e.index(T,U-1)]&2621698)===0)this.bfsStepX[q]=T-1,this.bfsStepZ[q]=U-1,q=(q+1)%Y,this.bfsDirection[D]=3,this.bfsCost[D]=f;if(D=e.index(T+1,U-1),T<Q-1&&U>0&&this.bfsDirection[D]===0&&(A[D]&2621827)===0&&(A[e.index(T+1,U)]&2621824)===0&&(A[e.index(T,U-1)]&2621698)===0)this.bfsStepX[q]=T+1,this.bfsStepZ[q]=U-1,q=(q+1)%Y,this.bfsDirection[D]=9,this.bfsCost[D]=f;if(D=e.index(T-1,U+1),T>0&&U<$-1&&this.bfsDirection[D]===0&&(A[D]&2621752)===0&&(A[e.index(T-1,U)]&2621704)===0&&(A[e.index(T,U+1)]&2621728)===0)this.bfsStepX[q]=T-1,this.bfsStepZ[q]=U+1,q=(q+1)%Y,this.bfsDirection[D]=6,this.bfsCost[D]=f;if(D=e.index(T+1,U+1),T<Q-1&&U<$-1&&this.bfsDirection[D]===0&&(A[D]&2621920)===0&&(A[e.index(T+1,U)]&2621824)===0&&(A[e.index(T,U+1)]&2621728)===0)this.bfsStepX[q]=T+1,this.bfsStepZ[q]=U+1,q=(q+1)%Y,this.bfsDirection[D]=12,this.bfsCost[D]=f}if(this.tryMoveNearest=0,!V){if(N){let f=100;for(let D=1;D<2;D++){for(let j=m-D;j<=m+D;j++)for(let W=_-D;W<=_+D;W++){let M=e.index(j,W);if(j>=0&&W>=0&&j<104&&W<104&&this.bfsCost[M]<f)f=this.bfsCost[M],T=j,U=W,this.tryMoveNearest=1,V=!0}if(V)break}}if(!V)return!1}w=0,this.bfsStepX[w]=T,this.bfsStepZ[w++]=U;let h=this.bfsDirection[e.index(T,U)],n=h;while(T!==u||U!==R){if(n!==h)h=n,this.bfsStepX[w]=T,this.bfsStepZ[w++]=U;if((n&2)!==0)T++;else if((n&8)!==0)T--;if((n&1)!==0)U++;else if((n&4)!==0)U--;n=this.bfsDirection[e.index(T,U)]}if(w>0){Y=Math.min(w,25),w--;let f=this.bfsStepX[w],D=this.bfsStepZ[w];if(b===0)this.out.p1isaac(63),this.out.p1(Y+Y+3);else if(b===1)this.out.p1isaac(56),this.out.p1(Y+Y+3+14);else if(b===2)this.out.p1isaac(167),this.out.p1(Y+Y+3);if(this.actionKey[5]===1)this.out.p1(1);else this.out.p1(0);this.out.p2(f+this.sceneBaseTileX),this.out.p2(D+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let j=1;j<Y;j++)w--,this.out.p1(this.bfsStepX[w]-f),this.out.p1(this.bfsStepZ[w]-D);return!0}return b!==1}async readPacket(){if(!this.stream)return!1;try{let u=this.stream.available;if(u===0)return!1;if(this.ptype===-1){if(await this.stream.readBytes(this.in.data,0,1),this.ptype=this.in.data[0]&255,this.randomIn)this.ptype=this.ptype-this.randomIn.nextInt&255;this.psize=p1[this.ptype],u--}if(this.psize===-1){if(u<=0)return!1;await this.stream.readBytes(this.in.data,0,1),this.psize=this.in.data[0]&255,u--}if(this.psize===-2){if(u<=1)return!1;await this.stream.readBytes(this.in.data,0,2),this.in.pos=0,this.psize=this.in.g2(),u-=2}if(u<this.psize)return!1;if(this.in.pos=0,await this.stream.readBytes(this.in.data,0,this.psize),this.idleNetCycles=0,this.ptype2=this.ptype1,this.ptype1=this.ptype0,this.ptype0=this.ptype,this.ptype===44){if(this.lastAddress=this.in.g4(),this.daysSinceLastLogin=this.in.g2(),this.daysSinceRecoveriesChanged=this.in.g1(),this.unreadMessages=this.in.g2(),this.warnMembersInNonMembers=this.in.g1(),this.lastAddress!==0&&this.viewportInterfaceId===-1){this.closeInterfaces();let R=650;if(this.daysSinceRecoveriesChanged!==201||this.warnMembersInNonMembers==1)R=655;this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let m=0;m<s.types.length;m++)if(s.types[m]&&s.types[m].clientCode===R){this.viewportInterfaceId=s.types[m].layer;break}}return this.ptype=-1,!0}if(this.ptype===72){this.redrawSidebar=!0;let R=this.in.g2(),m=s.types[R],_=this.in.g1();if(m.invSlotObjId&&m.invSlotObjCount){for(let b=0;b<_;b++){m.invSlotObjId[b]=this.in.g2();let E=this.in.g1();if(E===255)E=this.in.g4();m.invSlotObjCount[b]=E}for(let b=_;b<m.invSlotObjId.length;b++)m.invSlotObjId[b]=0,m.invSlotObjCount[b]=0}else for(let b=0;b<_;b++)if(this.in.g2(),this.in.g1()===255)this.in.g4();return this.ptype=-1,!0}if(this.ptype===164){let R=this.in.g2(),m=this.in.g2(),_=this.in.g2(),b=l.get(m);return s.types[R].modelType=4,s.types[R].model=m,s.types[R].xan=b.xan2d,s.types[R].yan=b.yan2d,s.types[R].zoom=b.zoom2d*100/_|0,this.ptype=-1,!0}if(this.ptype===207){let R=this.in.g2(),m=this.in.g2();if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=R,this.sidebarInterfaceId=m,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype==192)return this.field1264=255,this.ptype=-1,!0;if(this.ptype===70){let R=this.in.g8(),m=this.in.g1(),_=c.formatName(c.fromBase37(R));for(let E=0;E<this.friendCount;E++)if(R===this.friendName37[E]){if(this.friendWorld[E]!==m){if(this.friendWorld[E]=m,this.redrawSidebar=!0,m>0)this.addMessage(5,_+" has logged in.","");if(m===0)this.addMessage(5,_+" has logged out.","")}_=null;break}if(_&&this.friendCount<200)this.friendName37[this.friendCount]=R,this.friendName[this.friendCount]=_,this.friendWorld[this.friendCount]=m,this.friendCount++,this.redrawSidebar=!0;let b=!1;while(!b){b=!0;for(let E=0;E<this.friendCount-1;E++)if(this.friendWorld[E]!==v.nodeId&&this.friendWorld[E+1]===v.nodeId||this.friendWorld[E]===0&&this.friendWorld[E+1]!==0){let O=this.friendWorld[E];this.friendWorld[E]=this.friendWorld[E+1],this.friendWorld[E+1]=O;let I=this.friendName[E];this.friendName[E]=this.friendName[E+1],this.friendName[E+1]=I;let L=this.friendName37[E];this.friendName37[E]=this.friendName37[E+1],this.friendName37[E+1]=L,this.redrawSidebar=!0,b=!1}}return this.ptype=-1,!0}if(this.ptype===17)return await this.logout(),this.ptype=-1,!1;if(this.ptype===50){let R=this.in.g1(),m=this.in.g1(),_=this.in.g1(),b=this.in.g1();return this.cameraModifierEnabled[R]=!0,this.cameraModifierJitter[R]=m,this.cameraModifierWobbleScale[R]=_,this.cameraModifierWobbleSpeed[R]=b,this.cameraModifierCycle[R]=0,this.ptype=-1,!0}if(this.ptype===22)return G0.setEnabled(),this.ptype=-1,!0;if(this.ptype===160){if(this.selectedTab===12)this.redrawSidebar=!0;return this.runweight=this.in.g2b(),this.ptype=-1,!0}if(this.ptype===94)return this.baseX=this.in.g1(),this.baseZ=this.in.g1(),this.ptype=-1,!0;if(this.ptype===78){let R=this.in.g2(),m=this.in.g2(),_=m>>10&31,b=m>>5&31,E=m&31;return s.types[R].colour=(_<<19)+(b<<11)+(E<<3),this.ptype=-1,!0}if(this.ptype===152){if(this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.isMobile)Y0.draw();return this.ptype=-1,!0}if(this.ptype===53){this.cutscene=!1;for(let R=0;R<5;R++)this.cameraModifierEnabled[R]=!1;return this.ptype=-1,!0}if(this.ptype===240){let R=this.in.g2();if(R==65535)R=-1;if(this.nextMidiSong!=R&&this.midiActive&&!v.lowMemory)this.midiSong=R,this.midiFading=!0,this.onDemand?.request(2,this.midiSong);return this.nextMidiSong=R,this.nextMusicDelay=0,this.ptype=-1,!0}if(this.ptype===173){let R=this.in.g2(),m=this.in.g2();if(this.midiActive&&!v.lowMemory)this.midiSong=R,this.midiFading=!1,this.onDemand?.request(2,this.midiSong),this.nextMusicDelay=m;return this.ptype=-1,!0}if(this.ptype==158){let R=this.in.g2b();return this.viewportOverlayInterfaceId=R,this.ptype=-1,!0}if(this.ptype===9)return this.chatPublicMode=this.in.g1(),this.chatPrivateMode=this.in.g1(),this.chatTradeMode=this.in.g1(),this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype===209||this.ptype===29||this.ptype===69||this.ptype===198||this.ptype===137||this.ptype===39||this.ptype===234||this.ptype===155||this.ptype===125||this.ptype===232)return this.readZonePacket(this.in,this.ptype),this.ptype=-1,!0;if(this.ptype===241){let R=this.in.g2(),m=this.in.g2b(),_=this.in.g2b(),b=s.types[R];return b.x=m,b.y=_,this.ptype=-1,!0}if(this.ptype===226){let R=this.in.g2(),m=this.in.g4();if(this.varCache[R]=m,this.varps[R]!==m){if(this.varps[R]=m,this.updateVarp(R),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.ptype=-1,!0}if(this.ptype===210)return this.localPid=this.in.g2(),this.membersAccount=this.in.g1(),this.ptype=-1,!0;if(this.ptype===97)return this.inMultizone=this.in.g1(),this.ptype=-1,!0;if(this.ptype===85)return this.systemUpdateTimer=this.in.g2()*30,this.ptype=-1,!0;if(this.ptype===245){let R=this.in.g2(),m=this.in.g2();return s.types[R].modelType=1,s.types[R].model=m,this.ptype=-1,!0}if(this.ptype===151){let R=this.in.g2(),m=this.in.g1(),_=this.in.g2();if(this.waveEnabled&&!v.lowMemory&&this.waveCount<50)this.waveIds[this.waveCount]=R,this.waveLoops[this.waveCount]=m,this.waveDelay[this.waveCount]=_+b0.delays[R],this.waveCount++;return this.ptype=-1,!0}if(this.ptype===87){for(let R=0;R<this.varps.length;R++)if(this.varps[R]!==this.varCache[R])this.varps[R]=this.varCache[R],this.updateVarp(R),this.redrawSidebar=!0;return this.ptype=-1,!0}if(this.ptype===165){let R=this.in.g2(),m=this.in.g2();if(this.sceneCenterZoneX===R&&this.sceneCenterZoneZ===m&&this.sceneState!==0)return this.ptype=-1,!0;if(this.sceneCenterZoneX=R,this.sceneCenterZoneZ=m,this.sceneBaseTileX=(this.sceneCenterZoneX-6)*8,this.sceneBaseTileZ=(this.sceneCenterZoneZ-6)*8,this.withinTutorialIsland=!1,(this.sceneCenterZoneX/8==48||this.sceneCenterZoneX/8==49)&&this.sceneCenterZoneZ/8==48)this.withinTutorialIsland=!0;else if(this.sceneCenterZoneX/8==48&&this.sceneCenterZoneZ/8==148)this.withinTutorialIsland=!0;this.sceneState=1,this.sceneLoadStartTime=performance.now(),this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(4,4);let _=0;for(let $=(this.sceneCenterZoneX-6)/8|0;$<=((this.sceneCenterZoneX+6)/8|0);$++)for(let T=(this.sceneCenterZoneZ-6)/8|0;T<=((this.sceneCenterZoneZ+6)/8|0);T++)_++;this.sceneMapLandData=new p(_,null),this.sceneMapLocData=new p(_,null),this.sceneMapIndex=new Int32Array(_),this.sceneMapLandFile=new Array(_),this.sceneMapLocFile=new Array(_);let b=0;for(let $=(this.sceneCenterZoneX-6)/8|0;$<=((this.sceneCenterZoneX+6)/8|0);$++)for(let T=(this.sceneCenterZoneZ-6)/8|0;T<=((this.sceneCenterZoneZ+6)/8|0);T++)if(this.sceneMapIndex[b]=($<<8)+T,this.withinTutorialIsland&&(T==49||T==149||T==147||$==50||$==49&&T==47))this.sceneMapLandFile[b]=-1,this.sceneMapLocFile[b]=-1,b++;else if(this.onDemand){let U=this.sceneMapLandFile[b]=this.onDemand.getMapFile($,T,0);if(U!=-1)this.onDemand.request(3,U);let K=this.sceneMapLocFile[b]=this.onDemand.getMapFile($,T,1);if(K!=-1)this.onDemand.request(3,K);b++}let E=this.sceneBaseTileX-this.scenePrevBaseTileX,O=this.sceneBaseTileZ-this.scenePrevBaseTileZ;this.scenePrevBaseTileX=this.sceneBaseTileX,this.scenePrevBaseTileZ=this.sceneBaseTileZ;for(let $=0;$<8192;$++){let T=this.npcs[$];if(T){for(let U=0;U<10;U++)T.routeTileX[U]-=E,T.routeTileZ[U]-=O;T.x-=E*128,T.z-=O*128}}for(let $=0;$<2048;$++){let T=this.players[$];if(T){for(let U=0;U<10;U++)T.routeTileX[U]-=E,T.routeTileZ[U]-=O;T.x-=E*128,T.z-=O*128}}this.awaitingSync=!0;let I=0,L=104,H=1;if(E<0)I=104-1,L=-1,H=-1;let N=0,G=104,Q=1;if(O<0)N=104-1,G=-1,Q=-1;for(let $=I;$!==L;$+=H)for(let T=N;T!==G;T+=Q){let U=$+E,K=T+O;for(let q=0;q<4;q++)if(U>=0&&K>=0&&U<104&&K<104)this.objStacks[q][$][T]=this.objStacks[q][U][K];else this.objStacks[q][$][T]=null}for(let $=this.locChanges.head();$;$=this.locChanges.next())if($.x-=E,$.z-=O,$.x<0||$.z<0||$.x>=104||$.z>=104)$.unlink();if(this.flagSceneTileX!==0)this.flagSceneTileX-=E,this.flagSceneTileZ-=O;return this.cutscene=!1,this.ptype=-1,!0}if(this.ptype===214){if(this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===219){let R=this.in.g2();return s.types[R].anim=this.in.g2(),this.ptype=-1,!0}if(this.ptype===95){let R=this.in.gjstr();if(R.endsWith(":tradereq:")){let m=R.substring(0,R.indexOf(":")),_=c.toBase37(m),b=!1;for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===_){b=!0;break}if(!b&&this.overrideChat===0)this.addMessage(4,"wishes to trade with you.",m)}else if(R.endsWith(":duelreq:")){let m=R.substring(0,R.indexOf(":")),_=c.toBase37(m),b=!1;for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===_){b=!0;break}if(!b&&this.overrideChat===0)this.addMessage(8,"wishes to duel with you.",m)}else this.addMessage(0,R,"");return this.ptype=-1,!0}if(this.ptype===24){this.redrawSidebar=!0;let R=this.in.g1(),m=this.in.g4(),_=this.in.g1();this.skillExperience[R]=m,this.skillLevel[R]=_,this.skillBaseLevel[R]=1;for(let b=0;b<98;b++)if(m>=this.levelExperience[b])this.skillBaseLevel[R]=b+2;return this.ptype=-1,!0}if(this.ptype===60){let R=G0.stop();if(R)this.out.p1isaac(217),this.out.p2(R.pos),this.out.pdata(R.data,R.pos,0),R.release();return this.ptype=-1,!0}if(this.ptype===242){for(let R=0;R<this.players.length;R++){let m=this.players[R];if(!m)continue;m.primarySeqId=-1}for(let R=0;R<this.npcs.length;R++){let m=this.npcs[R];if(!m)continue;m.primarySeqId=-1}return this.ptype=-1,!0}if(this.ptype===108){let R=this.in.g2();if(this.localPlayer)s.types[R].modelType=3,s.types[R].model=(this.localPlayer.appearance[8]<<6)+(this.localPlayer.appearance[0]<<12)+(this.localPlayer.colour[0]<<24)+(this.localPlayer.colour[4]<<18)+this.localPlayer.appearance[11];return this.ptype=-1,!0}if(this.ptype===86)return this.getPlayerPos(this.in,this.psize),this.awaitingSync=!1,this.ptype=-1,!0;if(this.ptype===176){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.sidebarInterfaceId=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===168){if(this.flashingTab=this.in.g1(),this.flashingTab===this.selectedTab){if(this.flashingTab===3)this.selectedTab=1;else this.selectedTab=3;this.redrawSidebar=!0}return this.ptype=-1,!0}if(this.ptype===174)return this.stickyChatInterfaceId=this.in.g2b(),this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype===154){let R=this.in.g2(),m=this.in.gjstr();if(s.types[R].text=m,s.types[R].layer===this.tabInterfaceId[this.selectedTab])this.redrawSidebar=!0;return this.ptype=-1,!0}if(this.ptype===200){let R=this.in.g2(),m=this.in.g1();if(R===65535)R=-1;return this.tabInterfaceId[m]=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.ptype=-1,!0}if(this.ptype===56)return this.selectedTab=this.in.g1(),this.redrawSidebar=!0,this.redrawSideicons=!0,this.ptype=-1,!0;if(this.ptype===129){let R=this.in.g2(),m=this.in.g2();return s.types[R].modelType=2,s.types[R].model=m,this.ptype=-1,!0}if(this.ptype===222){if(this.cutscene=!0,this.cutsceneDstLocalTileX=this.in.g1(),this.cutsceneDstLocalTileZ=this.in.g1(),this.cutsceneDstHeight=this.in.g2(),this.cutsceneRotateSpeed=this.in.g1(),this.cutsceneRotateAcceleration=this.in.g1(),this.cutsceneRotateAcceleration>=100){let R=this.cutsceneDstLocalTileX*128+64,m=this.cutsceneDstLocalTileZ*128+64,_=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,b=R-this.cameraX,E=_-this.cameraY,O=m-this.cameraZ,I=Math.sqrt(b*b+O*O)|0;if(this.cameraPitch=(Math.atan2(E,I)*325.949|0)&2047,this.cameraYaw=(Math.atan2(b,O)*-325.949|0)&2047,this.cameraPitch<128)this.cameraPitch=128;else if(this.cameraPitch>383)this.cameraPitch=383}return this.ptype=-1,!0}if(this.ptype===177){if(this.selectedTab===12)this.redrawSidebar=!0;return this.runenergy=this.in.g1(),this.ptype=-1,!0}if(this.ptype===62)return this.flagSceneTileX=0,this.ptype=-1,!0;if(this.ptype===162){let R=this.in.g2(),m=s.types[R];if(m.invSlotObjId)for(let _=0;_<m.invSlotObjId.length;_++)m.invSlotObjId[_]=-1,m.invSlotObjId[_]=0;return this.ptype=-1,!0}if(this.ptype===49){if(this.hintType=this.in.g1(),this.hintType===1)this.hintNpc=this.in.g2();if(this.hintType>=2&&this.hintType<=6){if(this.hintType===2)this.hintOffsetX=64,this.hintOffsetZ=64;else if(this.hintType===3)this.hintOffsetX=0,this.hintOffsetZ=64;else if(this.hintType===4)this.hintOffsetX=128,this.hintOffsetZ=64;else if(this.hintType===5)this.hintOffsetX=64,this.hintOffsetZ=0;else if(this.hintType===6)this.hintOffsetX=64,this.hintOffsetZ=128;this.hintType=2,this.hintTileX=this.in.g2(),this.hintTileZ=this.in.g2(),this.hintHeight=this.in.g1()}if(this.hintType===10)this.hintPlayer=this.in.g2();return this.ptype=-1,!0}if(this.ptype===10){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=R,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===189){let R=this.in.g2();if(this.resetInterfaceAnimation(R),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.chatInterfaceId=R,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===244)return this.getNpcPos(this.in,this.psize),this.ptype=-1,!0;if(this.ptype===132){this.redrawSidebar=!0;let R=this.in.g2(),m=s.types[R];while(this.in.pos<this.psize){let _=this.in.g1(),b=this.in.g2(),E=this.in.g1();if(E===255)E=this.in.g4();if(m.invSlotObjId&&m.invSlotObjCount&&_>=0&&_<m.invSlotObjId.length)m.invSlotObjId[_]=b,m.invSlotObjCount[_]=E}return this.ptype=-1,!0}if(this.ptype===12){if(this.cutscene=!0,this.cutsceneSrcLocalTileX=this.in.g1(),this.cutsceneSrcLocalTileZ=this.in.g1(),this.cutsceneSrcHeight=this.in.g2(),this.cutsceneMoveSpeed=this.in.g1(),this.cutsceneMoveAcceleration=this.in.g1(),this.cutsceneMoveAcceleration>=100)this.cameraX=this.cutsceneSrcLocalTileX*128+64,this.cameraZ=this.cutsceneSrcLocalTileZ*128+64,this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;return this.ptype=-1,!0}if(this.ptype===233){this.baseX=this.in.g1(),this.baseZ=this.in.g1();while(this.in.pos<this.psize){let R=this.in.g1();this.readZonePacket(this.in,R)}return this.ptype=-1,!0}if(this.ptype===131){this.baseX=this.in.g1(),this.baseZ=this.in.g1();for(let R=this.baseX;R<this.baseX+8;R++)for(let m=this.baseZ;m<this.baseZ+8;m++)if(this.objStacks[this.currentLevel][R][m])this.objStacks[this.currentLevel][R][m]=null,this.sortObjStacks(R,m);for(let R=this.locChanges.head();R;R=this.locChanges.next())if(R.x>=this.baseX&&R.x<this.baseX+8&&R.z>=this.baseZ&&R.z<this.baseZ+8&&R.level===this.currentLevel)R.endTime=0;return this.ptype=-1,!0}if(this.ptype===30){let R=this.in.g8(),m=this.in.g4(),_=this.in.g1(),b=!1;for(let E=0;E<100;E++)if(this.messageTextIds[E]===m){b=!0;break}if(_<=1){for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===R){b=!0;break}}if(!b&&this.overrideChat===0)try{this.messageTextIds[this.privateMessageCount]=m,this.privateMessageCount=(this.privateMessageCount+1)%100;let E=v0.unpack(this.in,this.psize-13),O=D0.filter(E);if(_===2||_===3)this.addMessage(7,O,"@cr2@"+c.formatName(c.fromBase37(R)));else if(_===1)this.addMessage(7,O,"@cr1@"+c.formatName(c.fromBase37(R)));else this.addMessage(3,O,c.formatName(c.fromBase37(R)))}catch(E){}return this.ptype=-1,!0}if(this.ptype===123){let R=this.in.g2(),m=this.in.g1()===1;return s.types[R].hide=m,this.ptype=-1,!0}if(this.ptype===236){let R=this.in.g2(),m=this.in.g1b();if(this.varCache[R]=m,this.varps[R]!==m){if(this.varps[R]=m,this.updateVarp(R),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.ptype=-1,!0}if(this.ptype===7){this.ignoreCount=this.psize/8|0;for(let R=0;R<this.ignoreCount;R++)this.ignoreName37[R]=this.in.g8();return this.ptype=-1,!0}await this.logout()}catch(u){let R=`T1 - ${this.ptype},${this.psize} - ${this.ptype1},${this.ptype2} - ${this.psize},${(this.localPlayer?.routeTileX[0]??0)+this.sceneBaseTileX},${(this.localPlayer?.routeTileZ[0]??0)+this.sceneBaseTileZ} -`;for(let m=0;m<this.psize&&m<50;m++)R+=this.in.data[m]+",";await this.logout()}return!0}readZonePacket(u,R){let m=u.g1(),_=this.baseX+(m>>4&7),b=this.baseZ+(m&7);if(R===232){let E=u.g1(),O=E>>2,I=E&3,L=g.of(O).layer,H=u.g2();if(_>=0&&b>=0&&_<104&&b<104)this.appendLoc(-1,H,I,L,b,O,this.currentLevel,_,0)}else if(R===125){let E=u.g1(),O=E>>2,I=E&3,L=g.of(O).layer;if(_>=0&&b>=0&&_<104&&b<104)this.appendLoc(-1,-1,I,L,b,O,this.currentLevel,_,0)}else if(R===155){let E=u.g1(),O=E>>2,I=E&3,L=g.of(O).layer,H=u.g2();if(_>=0&&b>=0&&_<104&&b<104&&this.scene&&this.levelHeightmap){let N=this.levelHeightmap[this.currentLevel][_][b],G=this.levelHeightmap[this.currentLevel][_+1][b],Q=this.levelHeightmap[this.currentLevel][_+1][b+1],$=this.levelHeightmap[this.currentLevel][_][b+1];if(L==0){let T=this.scene.getWall(this.currentLevel,_,b);if(T){let U=T.typecode>>14&32767;if(O==2)T.model1=new u0(this.loopCycle,U,2,I+4,N,G,Q,$,H,!1),T.model2=new u0(this.loopCycle,U,2,I+1&3,N,G,Q,$,H,!1);else T.model1=new u0(this.loopCycle,U,O,I,N,G,Q,$,H,!1)}}else if(L==1){let T=this.scene.getDecor(this.currentLevel,b,_);if(T)T.model=new u0(this.loopCycle,T.typecode>>14&32767,4,0,N,Q,Q,$,H,!1)}else if(L==2){let T=this.scene.getLoc(this.currentLevel,_,b);if(O==11)O=10;if(T)T.model=new u0(this.loopCycle,T.typecode>>14&32767,O,I,N,G,Q,$,H,!1)}else if(L==3){let T=this.scene.getGroundDecor(this.currentLevel,_,b);if(T)T.model=new u0(this.loopCycle,T.typecode>>14&32767,22,I,N,G,Q,$,H,!1)}}}else if(R===234){let E=u.g2(),O=u.g2();if(_>=0&&b>=0&&_<104&&b<104){let I=new l0(E,O);if(!this.objStacks[this.currentLevel][_][b])this.objStacks[this.currentLevel][_][b]=new J0;this.objStacks[this.currentLevel][_][b]?.push(I),this.sortObjStacks(_,b)}}else if(R===39){let E=u.g2();if(_>=0&&b>=0&&_<104&&b<104){let O=this.objStacks[this.currentLevel][_][b];if(O){for(let I=O.head();I;I=O.next())if(I.index===(E&32767)){I.unlink();break}if(!O.head())this.objStacks[this.currentLevel][_][b]=null;this.sortObjStacks(_,b)}}}else if(R===137){let E=_+u.g1b(),O=b+u.g1b(),I=u.g2b(),L=u.g2(),H=u.g1(),N=u.g1(),G=u.g2(),Q=u.g2(),$=u.g1(),T=u.g1();if(_>=0&&b>=0&&_<104&&b<104&&E>=0&&O>=0&&E<104&&O<104){_=_*128+64,b=b*128+64,E=E*128+64,O=O*128+64;let U=new $1(L,this.currentLevel,_,this.getHeightmapY(this.currentLevel,_,b)-H,b,G+this.loopCycle,Q+this.loopCycle,$,T,I,N);U.updateVelocity(E,this.getHeightmapY(this.currentLevel,E,O)-N,O,G+this.loopCycle),this.projectiles.push(U)}}else if(R===198){let E=u.g2(),O=u.g1(),I=u.g2();if(_>=0&&b>=0&&_<104&&b<104){_=_*128+64,b=b*128+64;let L=new J1(E,this.currentLevel,_,b,this.getHeightmapY(this.currentLevel,_,b)-O,this.loopCycle,I);this.spotanims.push(L)}}else if(R===69){let E=u.g2(),O=u.g2(),I=u.g2();if(_>=0&&b>=0&&_<104&&b<104&&I!==this.localPid){let L=new l0(E,O);if(!this.objStacks[this.currentLevel][_][b])this.objStacks[this.currentLevel][_][b]=new J0;this.objStacks[this.currentLevel][_][b]?.push(L),this.sortObjStacks(_,b)}}else if(R===29){let E=u.g1(),O=E>>2,I=E&3,L=g.of(O).layer,H=u.g2(),N=u.g2(),G=u.g2(),Q=u.g2(),$=u.g1b(),T=u.g1b(),U=u.g1b(),K=u.g1b(),q;if(Q===this.localPid)q=this.localPlayer;else q=this.players[Q];if(q&&this.levelHeightmap){let w=_0.get(H),V=this.levelHeightmap[this.currentLevel][_][b],Y=this.levelHeightmap[this.currentLevel][_+1][b],A=this.levelHeightmap[this.currentLevel][_+1][b+1],h=this.levelHeightmap[this.currentLevel][_][b+1],n=w.getModel(O,I,V,Y,A,h,-1);if(n){this.appendLoc(N+this.loopCycle,-1,I,L,b,O,this.currentLevel,_,G+this.loopCycle),q.locStartCycle=N+this.loopCycle,q.locStopCycle=G+this.loopCycle,q.locModel=n;let{width:f,length:D}=w;if(I===1||I===3)f=w.length,D=w.width;q.locOffsetX=_*128+f*64,q.locOffsetZ=b*128+D*64,q.locOffsetY=this.getHeightmapY(this.currentLevel,q.locOffsetX,q.locOffsetZ);let j;if($>U)j=$,$=U,U=j;if(T>K)j=T,T=K,K=j;q.minTileX=_+$,q.maxTileX=_+U,q.minTileZ=b+T,q.maxTileZ=b+K}}}else if(R===209){let E=u.g2(),O=u.g2(),I=u.g2();if(_>=0&&b>=0&&_<104&&b<104){let L=this.objStacks[this.currentLevel][_][b];if(L){for(let H=L.head();H;H=L.next())if(H.index===(E&32767)&&H.count===O){H.count=I;break}this.sortObjStacks(_,b)}}}}appendLoc(u,R,m,_,b,E,O,I,L){let H=null;for(let N=this.locChanges.head();N;N=this.locChanges.next())if(N.level===this.currentLevel&&N.x===I&&N.z===b&&N.layer===_){H=N;break}if(!H)H=new T1,H.level=O,H.layer=_,H.x=I,H.z=b,this.storeLoc(H),this.locChanges.push(H);H.newType=R,H.newShape=E,H.newAngle=m,H.startTime=L,H.endTime=u}storeLoc(u){if(!this.scene)return;let R=0,m=-1,_=0,b=0;if(u.layer===0)R=this.scene.getWallTypecode(u.level,u.x,u.z);else if(u.layer===1)R=this.scene.getDecorTypecode(u.level,u.z,u.x);else if(u.layer===2)R=this.scene.getLocTypecode(u.level,u.x,u.z);else if(u.layer===3)R=this.scene.getGroundDecorTypecode(u.level,u.x,u.z);if(R!==0){let E=this.scene.getInfo(u.level,u.x,u.z,R);m=R>>14&32767,_=E&31,b=E>>6}u.oldType=m,u.oldShape=_,u.oldAngle=b}addLoc(u,R,m,_,b,E,O){if(R<1||m<1||R>102||m>102)return;if(v.lowMemory&&u!==this.currentLevel)return;if(!this.scene)return;let I=0;if(O===0)I=this.scene.getWallTypecode(u,R,m);else if(O===1)I=this.scene.getDecorTypecode(u,m,R);else if(O===2)I=this.scene.getLocTypecode(u,R,m);else if(O===3)I=this.scene.getGroundDecorTypecode(u,R,m);if(I!==0){let L=this.scene.getInfo(u,R,m,I),H=I>>14&32767,N=L&31,G=L>>6;if(O===0){this.scene?.removeWall(u,R,m,1);let Q=_0.get(H);if(Q.blockwalk)this.levelCollisionMap[u]?.removeWall(R,m,N,G,Q.blockrange)}else if(O===1)this.scene?.removeWallDecoration(u,R,m);else if(O===2){this.scene.removeLoc(u,R,m);let Q=_0.get(H);if(R+Q.width>104-1||m+Q.width>104-1||R+Q.length>104-1||m+Q.length>104-1)return;if(Q.blockwalk)this.levelCollisionMap[u]?.removeLoc(R,m,Q.width,Q.length,G,Q.blockrange)}else if(O===3){this.scene?.removeGroundDecoration(u,R,m);let Q=_0.get(H);if(Q.blockwalk&&Q.active)this.levelCollisionMap[u]?.removeFloor(R,m)}}if(_>=0){let L=u;if(this.levelTileFlags&&u<3&&(this.levelTileFlags[1][R][m]&2)===2)L=u+1;if(this.levelHeightmap)t.addLoc(this.loopCycle,u,R,m,this.scene,this.levelHeightmap,this.levelCollisionMap[u],_,E,b,L)}}sortObjStacks(u,R){let m=this.objStacks[this.currentLevel][u][R];if(!m){this.scene?.removeGroundObject(this.currentLevel,u,R);return}let _=-99999999,b=null;for(let L=m.head();L;L=m.next()){let H=l.get(L.index),N=H.cost;if(H.stackable)N*=L.count+1;if(N>_)_=N,b=L}if(!b)return;m.addHead(b);let E=null,O=null;for(let L=m.head();L;L=m.next()){if(L.index!==b.index&&E===null)E=L;if(L.index!==b.index&&E&&L.index!==E.index&&O===null)O=L}let I=u+(R<<7)+1610612736|0;this.scene?.addGroundObject(u,R,this.getHeightmapY(this.currentLevel,u*128+64,R*128+64),this.currentLevel,I,b,O,E)}getPlayerPos(u,R){this.entityRemovalCount=0,this.entityUpdateCount=0,this.getPlayerLocal(u),this.getPlayerOldVis(u),this.getPlayerNewVis(u,R),this.getPlayerExtended(u);for(let m=0;m<this.entityRemovalCount;m++){let _=this.entityRemovalIds[m],b=this.players[_];if(!b)continue;if(b.cycle!==this.loopCycle)this.players[_]=null}if(u.pos!==R)throw new Error("eek");for(let m=0;m<this.playerCount;m++)if(!this.players[this.playerIds[m]])throw new Error("eek")}getPlayerLocal(u){if(u.bits(),u.gBit(1)!==0){let m=u.gBit(2);if(m===0)this.entityUpdateIds[this.entityUpdateCount++]=2047;else if(m===1){let _=u.gBit(3);if(this.localPlayer?.step(!1,_),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(m===2){let _=u.gBit(3);this.localPlayer?.step(!0,_);let b=u.gBit(3);if(this.localPlayer?.step(!0,b),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(m===3){this.currentLevel=u.gBit(2);let _=u.gBit(7),b=u.gBit(7),E=u.gBit(1);if(this.localPlayer?.move(E===1,_,b),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}}}getPlayerOldVis(u){let R=u.gBit(8);if(R<this.playerCount)for(let m=R;m<this.playerCount;m++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[m];if(R>this.playerCount)throw new Error;this.playerCount=0;for(let m=0;m<R;m++){let _=this.playerIds[m],b=this.players[_];if(u.gBit(1)===0){if(this.playerIds[this.playerCount++]=_,b)b.cycle=this.loopCycle}else{let O=u.gBit(2);if(O===0){if(this.playerIds[this.playerCount++]=_,b)b.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=_}else if(O===1){if(this.playerIds[this.playerCount++]=_,b)b.cycle=this.loopCycle;let I=u.gBit(3);if(b?.step(!1,I),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=_}else if(O===2){if(this.playerIds[this.playerCount++]=_,b)b.cycle=this.loopCycle;let I=u.gBit(3);b?.step(!0,I);let L=u.gBit(3);if(b?.step(!0,L),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=_}else if(O===3)this.entityRemovalIds[this.entityRemovalCount++]=_}}}getPlayerNewVis(u,R){while(u.bitPos+10<R*8){let m=u.gBit(11);if(m===2047)break;if(!this.players[m]){this.players[m]=new Q0;let L=this.playerAppearanceBuffer[m];if(L)this.players[m]?.read(L)}this.playerIds[this.playerCount++]=m;let _=this.players[m];if(_)_.cycle=this.loopCycle;let b=u.gBit(5);if(b>15)b-=32;let E=u.gBit(5);if(E>15)E-=32;let O=u.gBit(1);if(this.localPlayer)_?.move(O===1,this.localPlayer.routeTileX[0]+b,this.localPlayer.routeTileZ[0]+E);if(u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=m}u.bytes()}getPlayerExtended(u){for(let R=0;R<this.entityUpdateCount;R++){let m=this.entityUpdateIds[R],_=this.players[m];if(!_)continue;let b=u.g1();if((b&128)!==0)b+=u.g1()<<8;this.getPlayerExtendedInfo(_,m,b,u)}}getPlayerExtendedInfo(u,R,m,_){if((m&1)!==0){let b=_.g1(),E=new Uint8Array(b),O=new z(E);_.gdata(b,0,E),this.playerAppearanceBuffer[R]=O,u.read(O)}if((m&2)!==0){let b=_.g2();if(b===65535)b=-1;if(b===u.primarySeqId)u.primarySeqLoop=0;let E=_.g1();if(u.primarySeqId===b&&b!==-1){let O=o.types[b].restart_mode;if(O==1)u.primarySeqFrame=0,u.primarySeqCycle=0,u.primarySeqDelay=E,u.primarySeqLoop=0;else if(O==2)u.primarySeqLoop=0}else if(b===-1||u.primarySeqId===-1||o.types[b].priority>o.types[u.primarySeqId].priority||o.types[u.primarySeqId].priority===0)u.primarySeqId=b,u.primarySeqFrame=0,u.primarySeqCycle=0,u.primarySeqDelay=E,u.primarySeqLoop=0,u.preanimRouteLength=u.routeLength}if((m&4)!==0){if(u.targetId=_.g2(),u.targetId===65535)u.targetId=-1}if((m&8)!==0){if(u.chatMessage=_.gjstr(),u.chatColour=0,u.chatEffect=0,u.chatTimer=150,u.name)this.addMessage(2,u.chatMessage,u.name)}if((m&16)!==0){let b=_.g1(),E=_.g1();u.hit(this.loopCycle,E,b),u.combatCycle=this.loopCycle+400,u.health=_.g1(),u.totalHealth=_.g1()}if((m&32)!==0)u.targetTileX=_.g2(),u.targetTileZ=_.g2();if((m&64)!==0){let b=_.g2(),E=_.g1(),O=_.g1(),I=_.pos;if(u.name&&u.visible){let L=c.toBase37(u.name),H=!1;if(E<=1){for(let N=0;N<this.ignoreCount;N++)if(this.ignoreName37[N]===L){H=!0;break}}if(!H&&this.overrideChat===0)try{let N=v0.unpack(_,O),G=D0.filter(N);if(u.chatMessage=G,u.chatColour=b>>8,u.chatEffect=b&255,u.chatTimer=150,E===2||E===3)this.addMessage(1,G,"@cr2@"+u.name);else if(E===1)this.addMessage(1,G,"@cr1@"+u.name);else this.addMessage(2,G,u.name)}catch(N){}}_.pos=I+O}if((m&256)!==0){u.spotanimId=_.g2();let b=_.g4();if(u.spotanimHeight=b>>16,u.spotanimLastCycle=this.loopCycle+(b&65535),u.spotanimFrame=0,u.spotanimCycle=0,u.spotanimLastCycle>this.loopCycle)u.spotanimFrame=-1;if(u.spotanimId===65535)u.spotanimId=-1}if((m&512)!==0)u.forceMoveStartSceneTileX=_.g1(),u.forceMoveStartSceneTileZ=_.g1(),u.forceMoveEndSceneTileX=_.g1(),u.forceMoveEndSceneTileZ=_.g1(),u.forceMoveEndCycle=_.g2()+this.loopCycle,u.forceMoveStartCycle=_.g2()+this.loopCycle,u.forceMoveFaceDirection=_.g1(),u.clearRoute();if((m&1024)!==0){let b=_.g1(),E=_.g1();u.hit(this.loopCycle,E,b),u.combatCycle=this.loopCycle+400,u.health=_.g1(),u.totalHealth=_.g1()}}getNpcPos(u,R){this.entityRemovalCount=0,this.entityUpdateCount=0,this.getNpcPosOldVis(u),this.getNpcPosNewVis(u,R),this.getNpcPosExtended(u);for(let m=0;m<this.entityRemovalCount;m++){let _=this.entityRemovalIds[m],b=this.npcs[_];if(!b)continue;if(b.cycle!==this.loopCycle)b.type=null,this.npcs[_]=null}if(u.pos!==R)throw new Error("eek");for(let m=0;m<this.npcCount;m++)if(!this.npcs[this.npcIds[m]])throw new Error("eek")}getNpcPosOldVis(u){u.bits();let R=u.gBit(8);if(R<this.npcCount)for(let m=R;m<this.npcCount;m++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[m];if(R>this.npcCount)throw new Error("eek");this.npcCount=0;for(let m=0;m<R;m++){let _=this.npcIds[m],b=this.npcs[_];if(u.gBit(1)===0){if(this.npcIds[this.npcCount++]=_,b)b.cycle=this.loopCycle}else{let O=u.gBit(2);if(O===0){if(this.npcIds[this.npcCount++]=_,b)b.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=_}else if(O===1){if(this.npcIds[this.npcCount++]=_,b)b.cycle=this.loopCycle;let I=u.gBit(3);if(b?.step(!1,I),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=_}else if(O===2){if(this.npcIds[this.npcCount++]=_,b)b.cycle=this.loopCycle;let I=u.gBit(3);b?.step(!0,I);let L=u.gBit(3);if(b?.step(!0,L),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=_}else if(O===3)this.entityRemovalIds[this.entityRemovalCount++]=_}}}getNpcPosNewVis(u,R){while(u.bitPos+21<R*8){let m=u.gBit(13);if(m===8191)break;if(!this.npcs[m])this.npcs[m]=new Q1;let _=this.npcs[m];if(this.npcIds[this.npcCount++]=m,_)_.cycle=this.loopCycle,_.type=w0.get(u.gBit(11)),_.size=_.type.size,_.walkanim=_.type.walkanim,_.walkanim_b=_.type.walkanim_b,_.walkanim_l=_.type.walkanim_r,_.walkanim_r=_.type.walkanim_l,_.readyanim=_.type.readyanim;else u.gBit(11);let b=u.gBit(5);if(b>15)b-=32;let E=u.gBit(5);if(E>15)E-=32;if(this.localPlayer)_?.move(!1,this.localPlayer.routeTileX[0]+b,this.localPlayer.routeTileZ[0]+E);if(u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=m}u.bytes()}getNpcPosExtended(u){for(let R=0;R<this.entityUpdateCount;R++){let m=this.entityUpdateIds[R],_=this.npcs[m];if(!_)continue;let b=u.g1();if((b&1)!==0){let E=u.g1(),O=u.g1();_.hit(this.loopCycle,O,E),_.combatCycle=this.loopCycle+400,_.health=u.g1(),_.totalHealth=u.g1()}if((b&2)!==0){let E=u.g2();if(E===65535)E=-1;if(E===_.primarySeqId)_.primarySeqLoop=0;let O=u.g1();if(_.primarySeqId===E&&E!==-1){let I=o.types[E].restart_mode;if(I==1)_.primarySeqFrame=0,_.primarySeqCycle=0,_.primarySeqDelay=O,_.primarySeqLoop=0;else if(I==2)_.primarySeqLoop=0}else if(E===-1||_.primarySeqId===-1||o.types[E].priority>o.types[_.primarySeqId].priority||o.types[_.primarySeqId].priority===0)_.primarySeqId=E,_.primarySeqFrame=0,_.primarySeqCycle=0,_.primarySeqDelay=O,_.primarySeqLoop=0,_.preanimRouteLength=_.routeLength}if((b&4)!==0){if(_.targetId=u.g2(),_.targetId===65535)_.targetId=-1}if((b&8)!==0)_.chatMessage=u.gjstr(),_.chatTimer=100;if((b&16)!==0){let E=u.g1(),O=u.g1();_.hit(this.loopCycle,O,E),_.combatCycle=this.loopCycle+400,_.health=u.g1(),_.totalHealth=u.g1()}if((b&32)!==0)_.type=w0.get(u.g2()),_.walkanim=_.type.walkanim,_.walkanim_b=_.type.walkanim_b,_.walkanim_l=_.type.walkanim_r,_.walkanim_r=_.type.walkanim_l,_.readyanim=_.type.readyanim;if((b&64)!==0){_.spotanimId=u.g2();let E=u.g4();if(_.spotanimHeight=E>>16,_.spotanimLastCycle=this.loopCycle+(E&65535),_.spotanimFrame=0,_.spotanimCycle=0,_.spotanimLastCycle>this.loopCycle)_.spotanimFrame=-1;if(_.spotanimId===65535)_.spotanimId=-1}if((b&128)!==0)_.targetTileX=u.g2(),_.targetTileZ=u.g2()}}showContextMenu(){let u=0;if(this.fontBold12){u=this.fontBold12.stringWidth("Choose Option");let b;for(let E=0;E<this.menuSize;E++)if(b=this.fontBold12.stringWidth(this.menuOption[E]),b>u)u=b}u+=8;let R=this.menuSize*15+21,m,_;if(this.mouseClickX>4&&this.mouseClickY>4&&this.mouseClickX<516&&this.mouseClickY<338){if(m=this.mouseClickX-(u/2|0)-8,m+u>512)m=512-u;if(m<0)m=0;if(_=this.mouseClickY-11,_+R>334)_=334-R;if(_<0)_=0;this.menuVisible=!0,this.menuArea=0,this.menuX=m,this.menuY=_,this.menuWidth=u,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>553&&this.mouseClickY>205&&this.mouseClickX<743&&this.mouseClickY<466){if(m=this.mouseClickX-(u/2|0)-553,m<0)m=0;else if(m+u>190)m=190-u;if(_=this.mouseClickY-205,_<0)_=0;else if(_+R>261)_=261-R;this.menuVisible=!0,this.menuArea=1,this.menuX=m,this.menuY=_,this.menuWidth=u,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>17&&this.mouseClickY>357&&this.mouseClickX<496&&this.mouseClickY<453){if(m=this.mouseClickX-(u/2|0)-17,m<0)m=0;else if(m+u>479)m=479-u;if(_=this.mouseClickY-357,_<0)_=0;else if(_+R>96)_=96-R;this.menuVisible=!0,this.menuArea=2,this.menuX=m,this.menuY=_,this.menuWidth=u,this.menuHeight=this.menuSize*15+22}}isAddFriendOption(u){if(u<0)return!1;let R=this.menuAction[u];if(R>=2000)R-=2000;return R===406}useMenuOption(u){if(u<0)return;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;let R=this.menuAction[u],m=this.menuParamA[u],_=this.menuParamB[u],b=this.menuParamC[u];if(R>=2000)R-=2000;if(R===1501){if(v.oplogic6+=this.sceneBaseTileZ,v.oplogic6>=92)this.out.p1isaac(177),this.out.p4(0);this.interactWithLoc(243,_,b,m)}else if(R===34){let E=this.menuOption[u],O=E.indexOf("@whi@");if(O!==-1){this.closeInterfaces(),this.reportAbuseInput=E.substring(O+5).trim(),this.reportAbuseMuteOption=!1;for(let I=0;I<s.types.length;I++)if(s.types[I]&&s.types[I].clientCode===600){this.reportAbuseInterfaceId=this.viewportInterfaceId=s.types[I].layer;break}}}else if(R===367){let E=this.players[m];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(48),this.out.p2(m),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(R===951){let E=s.types[b],O=!0;if(E.clientCode>0)O=this.handleInterfaceAction(E);if(O)this.out.p1isaac(39),this.out.p2(b)}else if(R===217){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],_,b,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],_,b,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(111),this.out.p2(_+this.sceneBaseTileX),this.out.p2(b+this.sceneBaseTileZ),this.out.p2(m),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}}else if(R===450){if(this.interactWithLoc(106,_,b,m))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(R===265){let E=this.npcs[m];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(101),this.out.p2(m),this.out.p2(this.activeSpellId)}else if(R===364)this.interactWithLoc(19,_,b,m);else if(R===55){if(this.interactWithLoc(182,_,b,m))this.out.p2(this.activeSpellId)}else if(R===224||R===993||R===99||R===746||R===877){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],_,b,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],_,b,2,1,1,0,0,0,!1);if(this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===99)this.out.p1isaac(27);else if(R===993)this.out.p1isaac(110);else if(R===224)this.out.p1isaac(231);else if(R===877)this.out.p1isaac(225);else if(R===746)this.out.p1isaac(17);this.out.p2(_+this.sceneBaseTileX),this.out.p2(b+this.sceneBaseTileZ),this.out.p2(m)}}else if(R===581){if((m&3)===0)v.oplogic1++;if(v.oplogic1>=99)this.out.p1isaac(47),this.out.p4(0);this.interactWithLoc(55,_,b,m)}else if(R===679){let E=this.menuOption[u],O=E.indexOf("@whi@");if(O!==-1){let I=c.toBase37(E.substring(O+5).trim()),L=-1;for(let H=0;H<this.friendCount;H++)if(this.friendName37[H]===I){L=H;break}if(L!==-1&&this.friendWorld[L]>0)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=3,this.socialName37=this.friendName37[L],this.socialMessage="Enter message to send to "+this.friendName[L]}}else if(R===960){this.out.p1isaac(39),this.out.p2(b);let E=s.types[b];if(E.scripts&&E.scripts[0]&&E.scripts[0][0]===5){let O=E.scripts[0][1];if(E.scriptOperand&&this.varps[O]!==E.scriptOperand[0])this.varps[O]=E.scriptOperand[0],this.updateVarp(O),this.redrawSidebar=!0}}else if(R===1175){let E=m>>14&32767,O=_0.get(E),I;if(!O.desc)I="It's a "+O.name+".";else I=O.desc;this.addMessage(0,I,"")}else if(R===881){if(this.out.p1isaac(58),this.out.p2(m),this.out.p2(_),this.out.p2(b),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=b,this.selectedItem=_,this.selectedArea=2,s.types[b].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.types[b].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===44){if(!this.pressedContinueOption)this.out.p1isaac(11),this.out.p2(b),this.pressedContinueOption=!0}else if(R===285)this.interactWithLoc(238,_,b,m);else if(R===406||R===436||R===557||R===556){let E=this.menuOption[u],O=E.indexOf("@whi@");if(O!==-1){let I=c.toBase37(E.substring(O+5).trim());if(R===406)this.addFriend(I);else if(R===436)this.addIgnore(I);else if(R===557)this.removeFriend(I);else if(R===556)this.removeIgnore(I)}}else if(R===947)this.closeInterfaces();else if(R===405||R===38||R===422||R===478||R===347){if(R===347)this.out.p1isaac(133);else if(R===422)this.out.p1isaac(221);else if(R===478){if((_&3)===0)v.oplogic5++;if(v.oplogic5>=90)this.out.p1isaac(7);this.out.p1isaac(6)}else if(R===405){if(v.oplogic3+=m,v.oplogic3>=97)this.out.p1isaac(37),this.out.p3(14953816);this.out.p1isaac(228)}else if(R===38)this.out.p1isaac(166);if(this.out.p2(m),this.out.p2(_),this.out.p2(b),this.selectedCycle=0,this.selectedInterface=b,this.selectedItem=_,this.selectedArea=2,s.types[b].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.types[b].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===965){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],_,b,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],_,b,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(25),this.out.p2(_+this.sceneBaseTileX),this.out.p2(b+this.sceneBaseTileZ),this.out.p2(m),this.out.p2(this.activeSpellId)}}else if(R===602||R===596||R===22||R===892||R===415){if(R===415){if((b&3)===0)v.oplogic7++;if(v.oplogic7>=55)this.out.p1isaac(50),this.out.p4(0);this.out.p1isaac(212)}else if(R===22)this.out.p1isaac(158);else if(R===596)this.out.p1isaac(193);else if(R===892){if((_&3)===0)v.oplogic9++;if(v.oplogic9>=130)this.out.p1isaac(169),this.out.p1(177);this.out.p1isaac(204)}else if(R===602)this.out.p1isaac(153);if(this.out.p2(m),this.out.p2(_),this.out.p2(b),this.selectedCycle=0,this.selectedInterface=b,this.selectedItem=_,this.selectedArea=2,s.types[b].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.types[b].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===465){this.out.p1isaac(39),this.out.p2(b);let E=s.types[b];if(E.scripts&&E.scripts[0]&&E.scripts[0][0]===5){let O=E.scripts[0][1];this.varps[O]=1-this.varps[O],this.updateVarp(O),this.redrawSidebar=!0}}else if(R===900){let E=this.npcs[m];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(52),this.out.p2(m),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(R===188){this.objSelected=1,this.objSelectedSlot=_,this.objSelectedInterface=b,this.objInterface=m,this.objSelectedName=l.get(m).name,this.spellSelected=0,this.redrawSidebar=!0;return}else if(R===728||R===542||R===6||R===963||R===245){let E=this.npcs[m];if(E&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===963)this.out.p1isaac(229);else if(R===6){if((m&3)===0)v.oplogic2++;if(v.oplogic2>=124)this.out.p1isaac(218),this.out.p4(0);this.out.p1isaac(132)}else if(R===245){if((m&3)===0)v.oplogic4++;if(v.oplogic4>=85)this.out.p1isaac(34),this.out.p2(39596);this.out.p1isaac(102)}else if(R===728)this.out.p1isaac(222);else if(R===542)this.out.p1isaac(84);this.out.p2(m)}}else if(R===391){if(this.out.p1isaac(143),this.out.p2(m),this.out.p2(_),this.out.p2(b),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=b,this.selectedItem=_,this.selectedArea=2,s.types[b].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.types[b].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===930){let E=s.types[b];this.spellSelected=1,this.activeSpellId=b,this.activeSpellFlags=E.targetMask,this.objSelected=0,this.redrawSidebar=!0;let O=E.targetVerb;if(O&&O.indexOf(" ")!==-1)O=O.substring(0,O.indexOf(" "));let I=E.targetVerb;if(I&&I.indexOf(" ")!==-1)I=I.substring(I.indexOf(" ")+1);if(this.spellCaption=O+" "+E.targetText+" "+I,this.activeSpellFlags===16)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;return}else if(R===660)if(this.menuVisible)this.scene?.click(_-8,b-11);else this.scene?.click(this.mouseClickX-8,this.mouseClickY-11);else if(R===903||R===363){let E=this.menuOption[u],O=E.indexOf("@whi@");if(O!==-1){E=E.substring(O+5).trim();let I=c.formatName(c.fromBase37(c.toBase37(E))),L=!1;for(let H=0;H<this.playerCount;H++){let N=this.players[this.playerIds[H]];if(N&&N.name&&N.name.toLowerCase()===I.toLowerCase()&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],N.routeTileX[0],N.routeTileZ[0],2,1,1,0,0,0,!1),R===903)this.out.p1isaac(43);else if(R===363)this.out.p1isaac(211);this.out.p2(this.playerIds[H]),L=!0;break}}if(!L)this.addMessage(0,"Unable to find "+I,"")}}else if(R===1607){let E=this.npcs[m];if(E&&E.type){let O;if(!E.type.desc)O="It's a "+E.type.name+".";else O=E.type.desc;this.addMessage(0,O,"")}}else if(R===651){let E=this.players[m];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(73),this.out.p2(m),this.out.p2(this.activeSpellId)}else if(R===1102){let E=l.get(m),O;if(!E.desc)O="It's a "+E.name+".";else O=E.desc;this.addMessage(0,O,"")}else if(R===1373||R===1544||R===151||R===1101){let E=this.players[m];if(E&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===1544)this.out.p1isaac(64);else if(R===1373)this.out.p1isaac(43);else if(R===151){if(v.oplogic8++,v.oplogic8>=90)this.out.p1isaac(100),this.out.p2(31114);this.out.p1isaac(219)}else if(R===1101)this.out.p1isaac(211);this.out.p2(m)}}else if(R===504)this.interactWithLoc(38,_,b,m);else if(R===1773){let E=l.get(m),O;if(b>=1e5)O=b+" x "+E.name;else if(!E.desc)O="It's a "+E.name+".";else O=E.desc;this.addMessage(0,O,"")}this.objSelected=0,this.spellSelected=0,this.redrawSidebar=!0}addNpcOptions(u,R,m,_){if(this.menuSize>=400)return;let b=u.name;if(u.vislevel!==0&&this.localPlayer)b=b+this.getCombatLevelTag(this.localPlayer.combatLevel,u.vislevel)+" (level-"+u.vislevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+b,this.menuAction[this.menuSize]=900,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++;else if(this.spellSelected!==1){let E;if(u.op){for(E=4;E>=0;E--)if(u.op[E]&&u.op[E]?.toLowerCase()!=="attack"){if(this.menuOption[this.menuSize]=u.op[E]+" @yel@"+b,E===0)this.menuAction[this.menuSize]=728;else if(E===1)this.menuAction[this.menuSize]=542;else if(E===2)this.menuAction[this.menuSize]=6;else if(E===3)this.menuAction[this.menuSize]=963;else if(E===4)this.menuAction[this.menuSize]=245;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++}}if(u.op){for(E=4;E>=0;E--)if(u.op[E]&&u.op[E]?.toLowerCase()==="attack"){let O=0;if(this.localPlayer&&u.vislevel>this.localPlayer.combatLevel)O=2000;if(this.menuOption[this.menuSize]=u.op[E]+" @yel@"+b,E===0)this.menuAction[this.menuSize]=O+728;else if(E===1)this.menuAction[this.menuSize]=O+542;else if(E===2)this.menuAction[this.menuSize]=O+6;else if(E===3)this.menuAction[this.menuSize]=O+963;else if(E===4)this.menuAction[this.menuSize]=O+245;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++}}this.menuOption[this.menuSize]="Examine @yel@"+b,this.menuAction[this.menuSize]=1607,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++}else if((this.activeSpellFlags&2)===2)this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+b,this.menuAction[this.menuSize]=265,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++}addPlayerOptions(u,R,m,_){if(u===this.localPlayer||this.menuSize>=400)return;let b=null;if(this.localPlayer)b=u.name+this.getCombatLevelTag(this.localPlayer.combatLevel,u.combatLevel)+" (level-"+u.combatLevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+b,this.menuAction[this.menuSize]=367,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++;else if(this.spellSelected!==1){if(this.menuOption[this.menuSize]="Follow @whi@"+b,this.menuAction[this.menuSize]=1544,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++,this.overrideChat===0)this.menuOption[this.menuSize]="Trade with @whi@"+b,this.menuAction[this.menuSize]=1373,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++;if(this.wildernessLevel>0){if(this.menuOption[this.menuSize]="Attack @whi@"+b,this.localPlayer&&this.localPlayer.combatLevel>=u.combatLevel)this.menuAction[this.menuSize]=151;else this.menuAction[this.menuSize]=2151;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++}if(this.worldLocationState===1)this.menuOption[this.menuSize]="Fight @whi@"+b,this.menuAction[this.menuSize]=151,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++;if(this.worldLocationState===2)this.menuOption[this.menuSize]="Duel-with @whi@"+b,this.menuAction[this.menuSize]=1101,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++}else if((this.activeSpellFlags&8)===8)this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+b,this.menuAction[this.menuSize]=651,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=_,this.menuSize++;for(let E=0;E<this.menuSize;E++)if(this.menuAction[E]===660){this.menuOption[E]="Walk here @whi@"+b;break}}getCombatLevelTag(u,R){let m=u-R;if(m<-9)return"@red@";else if(m<-6)return"@or3@";else if(m<-3)return"@or2@";else if(m<0)return"@or1@";else if(m>9)return"@gre@";else if(m>6)return"@gr3@";else if(m>3)return"@gr2@";else if(m>0)return"@gr1@";else return"@yel@"}drawInterface(u,R,m,_){if(u.type!==0||!u.children||u.hide&&this.viewportHoveredInterfaceIndex!==u.id&&this.sidebarHoveredInterfaceIndex!==u.id&&this.chatHoveredInterfaceIndex!==u.id)return;let b=F.left,E=F.top,O=F.right,I=F.bottom;F.setBounds(R,m,R+u.width,m+u.height);let L=u.children.length;for(let H=0;H<L;H++){if(!u.childX||!u.childY)continue;let N=u.childX[H]+R,G=u.childY[H]+m-_,Q=s.types[u.children[H]];if(N+=Q.x,G+=Q.y,Q.clientCode>0)this.updateInterfaceContent(Q);if(Q.type===0){if(Q.scrollPosition>Q.scroll-Q.height)Q.scrollPosition=Q.scroll-Q.height;if(Q.scrollPosition<0)Q.scrollPosition=0;if(this.drawInterface(Q,N,G,Q.scrollPosition),Q.scroll>Q.height)this.drawScrollbar(N+Q.width,G,Q.scrollPosition,Q.scroll,Q.height)}else if(Q.type===2){let $=0;for(let T=0;T<Q.height;T++)for(let U=0;U<Q.width;U++){if(!Q.invSlotOffsetX||!Q.invSlotOffsetY||!Q.invSlotObjId||!Q.invSlotObjCount)continue;let K=N+U*(Q.marginX+32),q=G+T*(Q.marginY+32);if($<20)K+=Q.invSlotOffsetX[$],q+=Q.invSlotOffsetY[$];if(Q.invSlotObjId[$]>0){let w=0,V=0,Y=Q.invSlotObjId[$]-1;if(K>F.left-32&&K<F.right&&q>F.top-32&&q<F.bottom||this.objDragArea!==0&&this.objDragSlot===$){let A=0;if(this.objSelected==1&&this.objSelectedSlot==$&&this.objSelectedInterface==Q.id)A=16777215;let h=l.getIcon(Y,Q.invSlotObjCount[$],A);if(h){if(this.objDragArea!==0&&this.objDragSlot===$&&this.objDragInterfaceId===Q.id){if(w=this.mouseX-this.objGrabX,V=this.mouseY-this.objGrabY,w<5&&w>-5)w=0;if(V<5&&V>-5)V=0;if(this.objDragCycles<5)w=0,V=0;if(h.drawAlpha(128,K+w,q+V),q+V<F.top&&u.scrollPosition>0){let n=(F.top-q-V)*this.sceneDelta/3;if(n>this.sceneDelta*10)n=this.sceneDelta*10;if(n>u.scrollPosition)n=u.scrollPosition;u.scrollPosition-=n,this.objGrabY+=n}if(q+V+32>F.bottom&&u.scrollPosition<u.scroll-u.height){let n=(q+V+32-F.bottom)*this.sceneDelta/3;if(n>this.sceneDelta*10)n=this.sceneDelta*10;if(n>u.scroll-u.height-u.scrollPosition)n=u.scroll-u.height-u.scrollPosition;u.scrollPosition+=n,this.objGrabY-=n}}else if(this.selectedArea!==0&&this.selectedItem===$&&this.selectedInterface===Q.id)h.drawAlpha(128,K,q);else h.draw(K,q);if(h.width===33||Q.invSlotObjCount[$]!==1){let n=Q.invSlotObjCount[$];this.fontPlain11?.drawString(K+w+1,q+10+V,this.formatObjCount(n),0),this.fontPlain11?.drawString(K+w,q+9+V,this.formatObjCount(n),16776960)}}}}else if(Q.invSlotGraphic&&$<20)Q.invSlotGraphic[$]?.draw(K,q);$++}}else if(Q.type===3)if(Q.alpha===0)if(Q.fill)F.fillRect2d(N,G,Q.width,Q.height,Q.colour);else F.drawRect(N,G,Q.width,Q.height,Q.colour);else if(Q.fill)F.fillRectAlpha(N,G,Q.width,Q.height,Q.colour,256-(Q.alpha&255));else F.drawRect(N,G,Q.width,Q.height,Q.colour),F.drawRectAlpha(N,G,Q.width,Q.height,Q.colour,256-(Q.alpha&255));else if(Q.type===4){let{font:$,colour:T,text:U}=Q;if((this.chatHoveredInterfaceIndex===Q.id||this.sidebarHoveredInterfaceIndex===Q.id||this.viewportHoveredInterfaceIndex===Q.id)&&Q.overColour!==0)T=Q.overColour;if(this.executeInterfaceScript(Q)){if(T=Q.activeColour,Q.activeText&&Q.activeText.length>0)U=Q.activeText}if(Q.buttonType===6&&this.pressedContinueOption)U="Please wait...",T=Q.colour;if(F.width2d==479){if(T==16776960)T=255;if(T==49152)T=16777215}if(!$||!U)continue;for(let K=G+$.height2d;U.length>0;K+=$.height2d){if(U.indexOf("%")!==-1){do{let V=U.indexOf("%1");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(Q,0))+U.substring(V+2)}while(!0);do{let V=U.indexOf("%2");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(Q,1))+U.substring(V+2)}while(!0);do{let V=U.indexOf("%3");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(Q,2))+U.substring(V+2)}while(!0);do{let V=U.indexOf("%4");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(Q,3))+U.substring(V+2)}while(!0);do{let V=U.indexOf("%5");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(Q,4))+U.substring(V+2)}while(!0)}let q=U.indexOf("\\n"),w;if(q!==-1)w=U.substring(0,q),U=U.substring(q+2);else w=U,U="";if(Q.center)$.drawStringTaggableCenter(N+(Q.width/2|0),K,w,T,Q.shadowed);else $.drawStringTaggable(N,K,w,T,Q.shadowed)}}else if(Q.type===5){let $;if(this.executeInterfaceScript(Q))$=Q.activeGraphic;else $=Q.graphic;$?.draw(N,G)}else if(Q.type===6){let $=Z.centerX,T=Z.centerY;Z.centerX=N+(Q.width/2|0),Z.centerY=G+(Q.height/2|0);let U=Z.sin[Q.xan]*Q.zoom>>16,K=Z.cos[Q.xan]*Q.zoom>>16,q=this.executeInterfaceScript(Q),w;if(q)w=Q.activeAnim;else w=Q.anim;let V=null;if(w===-1)V=Q.getModel(-1,-1,q,this.localPlayer);else{let Y=o.types[w];if(Y.frames&&Y.iframes)V=Q.getModel(Y.frames[Q.seqFrame],Y.iframes[Q.seqFrame],q,this.localPlayer)}if(V)V.drawSimple(0,Q.yan,0,Q.xan,0,U,K);Z.centerX=$,Z.centerY=T}else if(Q.type===7){let $=Q.font;if(!$||!Q.invSlotObjId||!Q.invSlotObjCount)continue;let T=0;for(let U=0;U<Q.height;U++)for(let K=0;K<Q.width;K++){if(Q.invSlotObjId[T]>0){let q=l.get(Q.invSlotObjId[T]-1),w=q.name;if(q.stackable||Q.invSlotObjCount[T]!==1)w=w+" x"+this.formatObjCountTagged(Q.invSlotObjCount[T]);if(!w)continue;let V=N+K*(Q.marginX+115),Y=G+U*(Q.marginY+12);if(Q.center)$.drawStringTaggableCenter(V+(Q.width/2|0),Y,w,Q.colour,Q.shadowed);else $.drawStringTaggable(V,Y,w,Q.colour,Q.shadowed)}T++}}}F.setBounds(b,E,O,I)}drawScrollbar(u,R,m,_,b){this.imageScrollbar0?.draw(u,R),this.imageScrollbar1?.draw(u,R+b-16),F.fillRect2d(u,R+16,16,b-32,2301979);let E=(b-32)*b/_|0;if(E<8)E=8;let O=(b-E-32)*m/(_-b)|0;F.fillRect2d(u,R+O+16,16,E,5063219),F.drawVerticalLine(u,R+O+16,7759444,E),F.drawVerticalLine(u+1,R+O+16,7759444,E),F.drawHorizontalLine(u,R+O+16,7759444,16),F.drawHorizontalLine(u,R+O+17,7759444,16),F.drawVerticalLine(u+15,R+O+16,3353893,E),F.drawVerticalLine(u+14,R+O+17,3353893,E-1),F.drawHorizontalLine(u,R+O+E+15,3353893,16),F.drawHorizontalLine(u+1,R+O+E+14,3353893,15)}formatObjCount(u){if(u<1e5)return String(u);else if(u<1e7)return(u/1000|0)+"K";else return(u/1e6|0)+"M"}formatObjCountTagged(u){let R=String(u);for(let m=R.length-3;m>0;m-=3)R=R.substring(0,m)+","+R.substring(m);if(R.length>8)R="@gre@"+R.substring(0,R.length-8)+" million @whi@("+R+")";else if(R.length>4)R="@cya@"+R.substring(0,R.length-4)+"K @whi@("+R+")";return" "+R}handleScrollInput(u,R,m,_,b,E,O,I){if(this.scrollGrabbed)this.scrollInputPadding=32;else this.scrollInputPadding=0;if(this.scrollGrabbed=!1,u>=E&&u<E+16&&R>=O&&R<O+16){if(I.scrollPosition-=this.dragCycles*4,b)this.redrawSidebar=!0}else if(u>=E&&u<E+16&&R>=O+_-16&&R<O+_){if(I.scrollPosition+=this.dragCycles*4,b)this.redrawSidebar=!0}else if(u>=E-this.scrollInputPadding&&u<E+this.scrollInputPadding+16&&R>=O+16&&R<O+_-16&&this.dragCycles>0){let L=(_-32)*_/m|0;if(L<8)L=8;let H=R-O-(L/2|0)-16,N=_-L-32;if(I.scrollPosition=(m-_)*H/N|0,b)this.redrawSidebar=!0;this.scrollGrabbed=!0}}getIntString(u){return u<999999999?String(u):"*"}executeInterfaceScript(u){if(!u.scriptComparator)return!1;for(let R=0;R<u.scriptComparator.length;R++){if(!u.scriptOperand)return!1;let m=this.executeClientScript(u,R),_=u.scriptOperand[R];if(u.scriptComparator[R]===2){if(m>=_)return!1}else if(u.scriptComparator[R]===3){if(m<=_)return!1}else if(u.scriptComparator[R]===4){if(m===_)return!1}else if(m!==_)return!1}return!0}executeClientScript(u,R){if(!u.scripts||R>=u.scripts.length)return-2;try{let m=u.scripts[R];if(!m)return-1;let _=0,b=0;while(!0){let E=m[b++];if(E===0)return _;if(E===1)_+=this.skillLevel[m[b++]];else if(E===2)_+=this.skillBaseLevel[m[b++]];else if(E===3)_+=this.skillExperience[m[b++]];else if(E===4){let O=s.types[m[b++]],I=m[b++]+1;if(O.invSlotObjId&&O.invSlotObjCount){for(let L=0;L<O.invSlotObjId.length;L++)if(O.invSlotObjId[L]===I)_+=O.invSlotObjCount[L]}else _+=0}else if(E===5)_+=this.varps[m[b++]];else if(E===6)_+=this.levelExperience[this.skillBaseLevel[m[b++]]-1];else if(E===7)_+=this.varps[m[b++]]*100/46875|0;else if(E===8)_+=this.localPlayer?.combatLevel||0;else if(E===9)for(let O=0;O<19;O++){if(O===18)O=20;_+=this.skillBaseLevel[O]}else if(E===10){let O=s.types[m[b++]],I=m[b++]+1;if(O.invSlotObjId){for(let L=0;L<O.invSlotObjId.length;L++)if(O.invSlotObjId[L]===I){_+=999999999;break}}}else if(E===11)_+=this.runenergy;else if(E===12)_+=this.runweight;else if(E===13){let O=this.varps[m[b++]],I=m[b++];_+=(O&1<<I)===0?0:1}}}catch(m){return-1}}handleInterfaceInput(u,R,m,_,b,E){if(u.type!==0||!u.children||u.hide||R<_||m<b||R>_+u.width||m>b+u.height||!u.childX||!u.childY)return;let O=u.children.length;for(let I=0;I<O;I++){let L=u.childX[I]+_,H=u.childY[I]+b-E,N=s.types[u.children[I]];if(L+=N.x,H+=N.y,(N.overlayer>=0||N.overColour!==0)&&R>=L&&m>=H&&R<L+N.width&&m<H+N.height)if(N.overlayer>=0)this.lastHoveredInterfaceId=N.overlayer;else this.lastHoveredInterfaceId=N.id;if(N.type===0){if(this.handleInterfaceInput(N,R,m,L,H,N.scrollPosition),N.scroll>N.height)this.handleScrollInput(R,m,N.scroll,N.height,!0,L+N.width,H,N)}else if(N.type===2){let G=0;for(let Q=0;Q<N.height;Q++)for(let $=0;$<N.width;$++){let T=L+$*(N.marginX+32),U=H+Q*(N.marginY+32);if(G<20&&N.invSlotOffsetX&&N.invSlotOffsetY)T+=N.invSlotOffsetX[G],U+=N.invSlotOffsetY[G];if(R<T||m<U||R>=T+32||m>=U+32){G++;continue}if(this.hoveredSlot=G,this.hoveredSlotParentId=N.id,!N.invSlotObjId||N.invSlotObjId[G]<=0){G++;continue}let K=l.get(N.invSlotObjId[G]-1);if(this.objSelected===1&&N.interactable){if(N.id!==this.objSelectedInterface||G!==this.objSelectedSlot)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+K.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=N.id,this.menuSize++}else if(this.spellSelected===1&&N.interactable){if((this.activeSpellFlags&16)===16)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+K.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=N.id,this.menuSize++}else{if(N.interactable){for(let q=4;q>=3;q--)if(K.iop&&K.iop[q]){if(this.menuOption[this.menuSize]=K.iop[q]+" @lre@"+K.name,q===3)this.menuAction[this.menuSize]=478;else if(q===4)this.menuAction[this.menuSize]=347;this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=N.id,this.menuSize++}else if(q===4)this.menuOption[this.menuSize]="Drop @lre@"+K.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=N.id,this.menuSize++}if(N.usable)this.menuOption[this.menuSize]="Use @lre@"+K.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=N.id,this.menuSize++;if(N.interactable&&K.iop){for(let q=2;q>=0;q--)if(K.iop[q]){if(this.menuOption[this.menuSize]=K.iop[q]+" @lre@"+K.name,q===0)this.menuAction[this.menuSize]=405;else if(q===1)this.menuAction[this.menuSize]=38;else if(q===2)this.menuAction[this.menuSize]=422;this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=N.id,this.menuSize++}}if(N.iop){for(let q=4;q>=0;q--)if(N.iop[q]){if(this.menuOption[this.menuSize]=N.iop[q]+" @lre@"+K.name,q===0)this.menuAction[this.menuSize]=602;else if(q===1)this.menuAction[this.menuSize]=596;else if(q===2)this.menuAction[this.menuSize]=22;else if(q===3)this.menuAction[this.menuSize]=892;else if(q===4)this.menuAction[this.menuSize]=415;this.menuParamA[this.menuSize]=K.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=N.id,this.menuSize++}}if(this.menuOption[this.menuSize]="Examine @lre@"+K.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=K.id,N.invSlotObjCount)this.menuParamC[this.menuSize]=N.invSlotObjCount[G];this.menuSize++}G++}}else if(R>=L&&m>=H&&R<L+N.width&&m<H+N.height){if(N.buttonType===1){let G=!1;if(N.clientCode!==0)G=this.handleSocialMenuOption(N);if(!G&&N.option)this.menuOption[this.menuSize]=N.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=N.id,this.menuSize++}else if(N.buttonType===2&&this.spellSelected===0){let G=N.targetVerb;if(G&&G.indexOf(" ")!==-1)G=G.substring(0,G.indexOf(" "));this.menuOption[this.menuSize]=G+" @gre@"+N.targetText,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=N.id,this.menuSize++}else if(N.buttonType===3)this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=N.id,this.menuSize++;else if(N.buttonType===4&&N.option)this.menuOption[this.menuSize]=N.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=N.id,this.menuSize++;else if(N.buttonType===5&&N.option)this.menuOption[this.menuSize]=N.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=N.id,this.menuSize++;else if(N.buttonType===6&&!this.pressedContinueOption&&N.option)this.menuOption[this.menuSize]=N.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=N.id,this.menuSize++}}}handleSocialMenuOption(u){let R=u.clientCode;if(R>=1&&R<=200||R>=701&&R<=900){if(R>=801)R-=701;else if(R>=701)R-=601;else if(R>=101)R-=101;else R--;return this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[R],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[R],this.menuAction[this.menuSize]=679,this.menuSize++,!0}else if(R>=401&&R<=500)return this.menuOption[this.menuSize]="Remove @whi@"+u.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0;return!1}resetInterfaceAnimation(u){let R=s.types[u];if(!R.children)return;for(let m=0;m<R.children.length&&R.children[m]!==-1;m++){let _=s.types[R.children[m]];if(_.type===1)this.resetInterfaceAnimation(_.id);_.seqFrame=0,_.seqCycle=0}}updateInterfaceAnimation(u,R){let m=s.types[u];if(!m.children)return!1;let _=!1;for(let b=0;b<m.children.length&&m.children[b]!==-1;b++){let E=s.types[m.children[b]];if(E.type===1)_||=this.updateInterfaceAnimation(E.id,R);if(E.type===6&&(E.anim!==-1||E.activeAnim!==-1)){let O=this.executeInterfaceScript(E),I;if(O)I=E.activeAnim;else I=E.anim;if(I!==-1){let L=o.types[I];E.seqCycle+=R;while(E.seqCycle>L.getFrameDuration(E.seqFrame)){if(E.seqCycle-=L.getFrameDuration(E.seqFrame)+1,E.seqFrame++,E.seqFrame>=L.frameCount){if(E.seqFrame-=L.replayoff,E.seqFrame<0||E.seqFrame>=L.frameCount)E.seqFrame=0}_=!0}}}}return _}updateVarp(u){let R=W0.types[u].clientcode;if(R===0)return;let m=this.varps[u];if(R===1){if(m===1)Z.setBrightness(0.9);else if(m===2)Z.setBrightness(0.8);else if(m===3)Z.setBrightness(0.7);else if(m===4)Z.setBrightness(0.6);l.iconCache?.clear(),this.redrawFrame=!0}else if(R===3){let _=this.midiActive;if(m===0)this.midiVolume=128,k1(128),this.midiActive=!0;else if(m===1)this.midiVolume=96,k1(96),this.midiActive=!0;else if(m===2)this.midiVolume=64,k1(64),this.midiActive=!0;else if(m===3)this.midiVolume=32,k1(32),this.midiActive=!0;else if(m===4)this.midiActive=!1;if(this.midiActive!==_){if(this.midiActive)this.midiSong=this.nextMidiSong,this.midiFading=!1,this.onDemand?.request(2,this.midiSong);else r1(!1);this.nextMusicDelay=0}}else if(R===4){if(m===0)this.waveVolume=128,F1(128),this.waveEnabled=!0;else if(m===1)this.waveVolume=96,F1(96),this.waveEnabled=!0;else if(m===2)this.waveVolume=64,F1(64),this.waveEnabled=!0;else if(m===3)this.waveVolume=32,F1(32),this.waveEnabled=!0;else if(m===4)this.waveEnabled=!1}else if(R===5)this.oneMouseButton=m;else if(R===6)this.chatEffects=m;else if(R===8)this.splitPrivateChat=m,this.redrawChatback=!0;else if(R===9)this.bankArrangeMode=m}updateInterfaceContent(u){let R=u.clientCode;if(R>=1&&R<=100||R>=701&&R<=800){if(R>700)R-=601;else R--;if(R>=this.friendCount)u.text="",u.buttonType=0;else u.text=this.friendName[R],u.buttonType=1}else if(R>=101&&R<=200||R>=801&&R<=900){if(R>800)R-=701;else R-=101;if(R>=this.friendCount)u.text="",u.buttonType=0;else{if(this.friendWorld[R]===0)u.text="@red@Offline";else if(this.friendWorld[R]===v.nodeId)u.text="@gre@World-"+(this.friendWorld[R]-9);else u.text="@yel@World-"+(this.friendWorld[R]-9);u.buttonType=1}}else if(R===203){if(u.scroll=this.friendCount*15+20,u.scroll<=u.height)u.scroll=u.height+1}else if(R>=401&&R<=500)if(R-=401,R>=this.ignoreCount)u.text="",u.buttonType=0;else u.text=c.formatName(c.fromBase37(this.ignoreName37[R])),u.buttonType=1;else if(R===503){if(u.scroll=this.ignoreCount*15+20,u.scroll<=u.height)u.scroll=u.height+1}else if(R===327){if(u.xan=150,u.yan=(Math.sin(this.loopCycle/40)*256|0)&2047,this.updateDesignModel){for(let E=0;E<7;E++){let O=this.designKits[E];if(O>=0&&!K0.types[O].modelIsReady())return}this.updateDesignModel=!1;let m=new p(7,null),_=0;for(let E=0;E<7;E++){let O=this.designKits[E];if(O>=0)m[_++]=K0.types[O].getModel()}let b=J.modelFromModels(m,_);for(let E=0;E<5;E++)if(this.designColours[E]!==0){if(b.recolour(Q0.DESIGN_IDK_COLORS[E][0],Q0.DESIGN_IDK_COLORS[E][this.designColours[E]]),E===1)b.recolour(Q0.TORSO_RECOLORS[0],Q0.TORSO_RECOLORS[this.designColours[E]])}if(b.createLabelReferences(),b.calculateNormals(64,850,-30,-50,-30,!0),this.localPlayer){let E=o.types[this.localPlayer.readyanim].frames;if(E)b.applyTransform(E[0])}u.modelType=5,u.model=0,s.cacheModel(b,5,0)}}else if(R===324){if(!this.genderButtonImage0)this.genderButtonImage0=u.graphic,this.genderButtonImage1=u.activeGraphic;if(this.designGender)u.graphic=this.genderButtonImage1;else u.graphic=this.genderButtonImage0}else if(R===325){if(!this.genderButtonImage0)this.genderButtonImage0=u.graphic,this.genderButtonImage1=u.activeGraphic;if(this.designGender)u.graphic=this.genderButtonImage0;else u.graphic=this.genderButtonImage1}else if(R===600)if(u.text=this.reportAbuseInput,this.loopCycle%20<10)u.text=u.text+"|";else u.text=u.text+" ";else if(R===613)if(this.staffmodlevel<1)u.text="";else if(this.reportAbuseMuteOption)u.colour=16711680,u.text="Moderator option: Mute player for 48 hours: <ON>";else u.colour=16777215,u.text="Moderator option: Mute player for 48 hours: <OFF>";else if(R===650||R===655)if(this.lastAddress===0)u.text="";else{let m;if(this.daysSinceLastLogin===0)m="earlier today";else if(this.daysSinceLastLogin===1)m="yesterday";else m=this.daysSinceLastLogin+" days ago";let _=c.formatIPv4(this.lastAddress);u.text="You last logged in "+m+(_==="127.0.0.1"?".":" from: "+_)}else if(R===651){if(this.unreadMessages===0)u.text="0 unread messages",u.colour=16776960;else if(this.unreadMessages===1)u.text="1 unread message",u.colour=65280;else if(this.unreadMessages>1)u.text=this.unreadMessages+" unread messages",u.colour=65280}else if(R===652)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)u.text="@yel@This is a non-members world: @whi@Since you are a member we";else u.text="";else if(this.daysSinceRecoveriesChanged===200)u.text="You have not yet set any password recovery questions.";else{let m;if(this.daysSinceRecoveriesChanged===0)m="Earlier today";else if(this.daysSinceRecoveriesChanged===1)m="Yesterday";else m=this.daysSinceRecoveriesChanged+" days ago";u.text=m+" you changed your recovery questions"}else if(R===653)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)u.text="@whi@recommend you use a members world instead. You may use";else u.text="";else if(this.daysSinceRecoveriesChanged===200)u.text="We strongly recommend you do so now to secure your account.";else u.text="If you do not remember making this change then cancel it immediately";else if(R===654)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)u.text="@whi@this world but member benefits are unavailable whilst here.";else u.text="";else if(this.daysSinceRecoveriesChanged===200)u.text="Do this from the 'account management' area on our front webpage";else u.text="Do this from the 'account management' area on our front webpage"}handleInterfaceAction(u){let R=u.clientCode;if(R===201)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=1,this.socialMessage="Enter name of friend to add to list";else if(R===202)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=2,this.socialMessage="Enter name of friend to delete from list";else if(R===205)return this.idleTimeout=250,!0;else if(R===501)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=4,this.socialMessage="Enter name of player to add to list";else if(R===502)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=5,this.socialMessage="Enter name of player to delete from list";else if(R>=300&&R<=313){let m=(R-300)/2|0,_=R&1,b=this.designKits[m];if(b!==-1)while(!0){if(_===0){if(b--,b<0)b=K0.count-1}if(_===1){if(b++,b>=K0.count)b=0}if(!K0.types[b].disable&&K0.types[b].type===m+(this.designGender?0:7)){this.designKits[m]=b,this.updateDesignModel=!0;break}}}else if(R>=314&&R<=323){let m=(R-314)/2|0,_=R&1,b=this.designColours[m];if(_===0){if(b--,b<0)b=Q0.DESIGN_IDK_COLORS[m].length-1}if(_===1){if(b++,b>=Q0.DESIGN_IDK_COLORS[m].length)b=0}this.designColours[m]=b,this.updateDesignModel=!0}else if(R===324&&!this.designGender)this.designGender=!0,this.validateCharacterDesign();else if(R===325&&this.designGender)this.designGender=!1,this.validateCharacterDesign();else if(R===326){this.out.p1isaac(8),this.out.p1(this.designGender?0:1);for(let m=0;m<7;m++)this.out.p1(this.designKits[m]);for(let m=0;m<5;m++)this.out.p1(this.designColours[m]);return!0}else if(R===613)this.reportAbuseMuteOption=!this.reportAbuseMuteOption;else if(R>=601&&R<=612){if(this.closeInterfaces(),this.reportAbuseInput.length>0)this.out.p1isaac(251),this.out.p8(c.toBase37(this.reportAbuseInput)),this.out.p1(R-601),this.out.p1(this.reportAbuseMuteOption?1:0)}return!1}validateCharacterDesign(){this.updateDesignModel=!0;for(let u=0;u<7;u++){this.designKits[u]=-1;for(let R=0;R<K0.count;R++)if(!K0.types[R].disable&&K0.types[R].type===u+(this.designGender?0:7)){this.designKits[u]=R;break}}}drawSidebar(){if(this.areaSidebar?.bind(),this.areaSidebarOffsets)Z.lineOffset=this.areaSidebarOffsets;if(this.imageInvback?.draw(0,0),this.sidebarInterfaceId!==-1)this.drawInterface(s.types[this.sidebarInterfaceId],0,0,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.drawInterface(s.types[this.tabInterfaceId[this.selectedTab]],0,0,0);if(this.menuVisible&&this.menuArea===1)this.drawMenu();if(this.areaSidebar?.draw(553,205),this.areaViewport?.bind(),this.areaViewportOffsets)Z.lineOffset=this.areaViewportOffsets}drawChat(){if(this.areaChatback?.bind(),this.areaChatbackOffsets)Z.lineOffset=this.areaChatbackOffsets;if(this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,0),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",128);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",0),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",128);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,0),this.fontBold12?.drawStringCenter(239,60,"Click to continue",128);else if(this.chatInterfaceId!==-1)this.drawInterface(s.types[this.chatInterfaceId],0,0,0);else if(this.stickyChatInterfaceId!==-1)this.drawInterface(s.types[this.stickyChatInterfaceId],0,0,0);else{let u=this.fontPlain12,R=0;F.setBounds(0,0,463,77);for(let _=0;_<100;_++){let b=this.messageText[_];if(!b)continue;let E=this.messageType[_],O=this.chatScrollOffset+70-R*14,I=this.messageSender[_],L=0;if(I&&I.startsWith("@cr1@"))I=I.substring(5),L=1;else if(I&&I.startsWith("@cr2@"))I=I.substring(5),L=2;if(E===0){if(O>0&&O<110)u?.drawString(4,O,b,0);R++}else if((E===1||E===2)&&(this.chatPublicMode===0||this.chatPublicMode===1&&this.isFriend(I))){if(O>0&&O<110){let H=4;if(L==1)this.imageModIcons[0].draw(H,O-12),H+=14;else if(L==2)this.imageModIcons[1].draw(H,O-12),H+=14;u?.drawString(H,O,I+":",0),H+=(u?.stringWidth(I)??0)+8,u?.drawString(H,O,b,255)}R++}else if((E===3||E===7)&&this.splitPrivateChat===0&&(E===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(I))){if(O>0&&O<110){let H=4;if(u?.drawString(H,O,"From ",0),H+=u?.stringWidth("From ")??0,L==1)this.imageModIcons[0].draw(H,O-12),H+=14;else if(L==2)this.imageModIcons[1].draw(H,O-12),H+=14;u?.drawString(H,O,I+":",0),H+=(u?.stringWidth(I)??0)+8,u?.drawString(H,O,b,8388608)}R++}else if(E===4&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(I))){if(O>0&&O<110)u?.drawString(4,O,I+" "+this.messageText[_],8388736);R++}else if(E===5&&this.splitPrivateChat===0&&this.chatPrivateMode<2){if(O>0&&O<110)u?.drawString(4,O,b,8388608);R++}else if(E===6&&this.splitPrivateChat===0&&this.chatPrivateMode<2){if(O>0&&O<110)u?.drawString(4,O,"To "+I+":",0),u?.drawString(u.stringWidth("To "+I)+12,O,b,8388608);R++}else if(E===8&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(I))){if(O>0&&O<110)u?.drawString(4,O,I+" "+this.messageText[_],8270336);R++}}if(F.resetBounds(),this.chatScrollHeight=R*14+7,this.chatScrollHeight<78)this.chatScrollHeight=78;this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77);let m;if(this.localPlayer==null||this.localPlayer.name==null)m=c.formatName(this.username);else m=this.localPlayer.name;u?.drawString(4,90,m+":",0),u?.drawString(u.stringWidth(m+": ")+6,90,this.chatTyped+"*",255),F.drawHorizontalLine(0,77,0,479)}if(this.menuVisible&&this.menuArea===2)this.drawMenu();if(this.areaChatback?.draw(17,357),this.areaViewport?.bind(),this.areaViewportOffsets)Z.lineOffset=this.areaViewportOffsets}drawMinimap(){if(!this.localPlayer)return;this.areaMapback?.bind();let u=this.orbitCameraYaw+this.macroMinimapAngle&2047,R=(this.localPlayer.x/32|0)+48,m=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(25,5,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,R,m,u,this.macroMinimapZoom+256),this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let _=0;_<this.activeMapFunctionCount;_++)R=this.activeMapFunctionX[_]*4+2-(this.localPlayer.x/32|0),m=this.activeMapFunctionZ[_]*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(m,this.activeMapFunctions[_],R);for(let _=0;_<104;_++)for(let b=0;b<104;b++)if(this.objStacks[this.currentLevel][_][b])R=_*4+2-(this.localPlayer.x/32|0),m=b*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(m,this.imageMapdot0,R);for(let _=0;_<this.npcCount;_++){let b=this.npcs[this.npcIds[_]];if(b&&b.isVisible()&&b.type&&b.type.minimap)R=(b.x/32|0)-(this.localPlayer.x/32|0),m=(b.z/32|0)-(this.localPlayer.z/32|0),this.drawOnMinimap(m,this.imageMapdot1,R)}for(let _=0;_<this.playerCount;_++){let b=this.players[this.playerIds[_]];if(b&&b.isVisible()&&b.name){R=(b.x/32|0)-(this.localPlayer.x/32|0),m=(b.z/32|0)-(this.localPlayer.z/32|0);let E=!1,O=c.toBase37(b.name);for(let I=0;I<this.friendCount;I++)if(O===this.friendName37[I]&&this.friendWorld[I]!==0){E=!0;break}if(E)this.drawOnMinimap(m,this.imageMapdot3,R);else this.drawOnMinimap(m,this.imageMapdot2,R)}}if(this.hintType!=0&&this.loopCycle%20<10){if(this.hintType==1&&this.hintNpc>=0&&this.hintNpc<this.npcs.length){let _=this.npcs[this.hintNpc];if(_!=null){let b=(_.x/32|0)-(this.localPlayer.x/32|0),E=(_.z/32|0)-(this.localPlayer.z/32|0);this.drawMinimapHint(b,E,this.imageMapmarker1)}}else if(this.hintType==2){let _=(this.hintTileX-this.sceneBaseTileX)*4+2-(this.localPlayer.x/32|0),b=(this.hintTileZ-this.sceneBaseTileZ)*4+2-(this.localPlayer.z/32|0);this.drawMinimapHint(_,b,this.imageMapmarker1)}else if(this.hintType==10&&this.hintPlayer>=0&&this.hintPlayer<this.players.length){let _=this.players[this.hintPlayer];if(_!=null){let b=(_.x/32|0)-(this.localPlayer.x/32|0),E=(_.z/32|0)-(this.localPlayer.z/32|0);this.drawMinimapHint(b,E,this.imageMapmarker1)}}}if(this.flagSceneTileX!==0)R=this.flagSceneTileX*4+2-(this.localPlayer.x/32|0),m=this.flagSceneTileZ*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(m,this.imageMapmarker0,R);F.fillRect2d(97,78,3,3,16777215),this.areaViewport?.bind()}drawMinimapHint(u,R,m){if(!m)return;let _=u*u+R*R;if(_<=4225||_>=90000){this.drawOnMinimap(R,m,u);return}let b=this.orbitCameraYaw+this.macroMinimapAngle&2047,E=Z.sin[b],O=Z.cos[b];E=E*256/(this.macroMinimapZoom+256)|0,O=O*256/(this.macroMinimapZoom+256)|0;let I=R*E+u*O>>16,L=R*O-u*E>>16,H=Math.atan2(I,L),N=Math.sin(H)*63|0,G=Math.cos(H)*57|0;this.imageMapedge?.drawRotated(83-G-20,H,256,15,15,20,20,N+94+4-10)}drawOnMinimap(u,R,m){if(!R)return;let _=m*m+u*u;if(_>6400)return;let b=this.orbitCameraYaw+this.macroMinimapAngle&2047,E=Z.sin[b],O=Z.cos[b];E=E*256/(this.macroMinimapZoom+256)|0,O=O*256/(this.macroMinimapZoom+256)|0;let I=u*E+m*O>>16,L=u*O-m*E>>16;if(_>2500&&this.imageMapback)R.drawMasked(I+94-(R.width/2|0)+4,83-L-(R.height/2|0)-4,this.imageMapback);else R.draw(I+94-(R.width/2|0)+4,83-L-(R.height/2|0)-4)}addMessage(u,R,m){if(u===0&&this.stickyChatInterfaceId!==-1)this.modalMessage=R,this.mouseClickButton=0;if(this.chatInterfaceId===-1)this.redrawChatback=!0;for(let _=99;_>0;_--)this.messageType[_]=this.messageType[_-1],this.messageSender[_]=this.messageSender[_-1],this.messageText[_]=this.messageText[_-1];this.messageType[0]=u,this.messageSender[0]=m,this.messageText[0]=R}isFriend(u){if(!u)return!1;for(let R=0;R<this.friendCount;R++)if(u.toLowerCase()===this.friendName[R]?.toLowerCase())return!0;if(!this.localPlayer)return!1;return u.toLowerCase()===this.localPlayer.name?.toLowerCase()}addFriend(u){if(u===0n)return;if(this.friendCount>=100&&this.membersAccount!=1){this.addMessage(0,"Your friendlist is full. Max of 100 for free users, and 200 for members","");return}else if(this.friendCount>=200){this.addMessage(0,"Your friendlist is full. Max of 100 for free users, and 200 for members","");return}let R=c.formatName(c.fromBase37(u));for(let m=0;m<this.friendCount;m++)if(this.friendName37[m]===u){this.addMessage(0,R+" is already on your friend list","");return}for(let m=0;m<this.ignoreCount;m++)if(this.ignoreName37[m]===u){this.addMessage(0,"Please remove "+R+" from your ignore list first","");return}if(!this.localPlayer||!this.localPlayer.name)return;if(R!==this.localPlayer.name)this.friendName[this.friendCount]=R,this.friendName37[this.friendCount]=u,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(9),this.out.p8(u)}removeFriend(u){if(u===0n)return;for(let R=0;R<this.friendCount;R++)if(this.friendName37[R]===u){this.friendCount--,this.redrawSidebar=!0;for(let m=R;m<this.friendCount;m++)this.friendName[m]=this.friendName[m+1],this.friendWorld[m]=this.friendWorld[m+1],this.friendName37[m]=this.friendName37[m+1];this.out.p1isaac(69),this.out.p8(u);return}}addIgnore(u){if(u===0n)return;if(this.ignoreCount>=100){this.addMessage(0,"Your ignore list is full. Max of 100 hit","");return}let R=c.formatName(c.fromBase37(u));for(let m=0;m<this.ignoreCount;m++)if(this.ignoreName37[m]===u){this.addMessage(0,R+" is already on your ignore list","");return}for(let m=0;m<this.friendCount;m++)if(this.friendName37[m]===u){this.addMessage(0,"Please remove "+R+" from your friend list first","");return}this.ignoreName37[this.ignoreCount++]=u,this.redrawSidebar=!0,this.out.p1isaac(203),this.out.p8(u)}removeIgnore(u){if(u===0n)return;for(let R=0;R<this.ignoreCount;R++)if(this.ignoreName37[R]===u){this.ignoreCount--,this.redrawSidebar=!0;for(let m=R;m<this.ignoreCount;m++)this.ignoreName37[m]=this.ignoreName37[m+1];this.out.p1isaac(207),this.out.p8(u);return}}unloadTitle(){if(this.flameActive=!1,this.flamesInterval)clearInterval(this.flamesInterval),this.flamesInterval=null;this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null}runFlames(){if(!this.flameActive)return;this.flameCycle++,this.updateFlames(),this.updateFlames(),this.drawFlames()}updateFlames(){if(!this.flameBuffer3||!this.flameBuffer2||!this.flameBuffer0||!this.flameLineOffset)return;let u=256;for(let R=10;R<117;R++)if((Math.random()*100|0)<50)this.flameBuffer3[R+(u-2<<7)]=255;for(let R=0;R<100;R++){let m=(Math.random()*124|0)+2,_=(Math.random()*128|0)+128,b=m+(_<<7);this.flameBuffer3[b]=192}for(let R=1;R<u-1;R++)for(let m=1;m<127;m++){let _=m+(R<<7);this.flameBuffer2[_]=(this.flameBuffer3[_-1]+this.flameBuffer3[_+1]+this.flameBuffer3[_-128]+this.flameBuffer3[_+128])/4|0}if(this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length)this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[Math.random()*12|0]);for(let R=1;R<u-1;R++)for(let m=1;m<127;m++){let _=m+(R<<7),b=this.flameBuffer2[_+128]-(this.flameBuffer0[_+this.flameCycle0&this.flameBuffer0.length-1]/5|0);if(b<0)b=0;this.flameBuffer3[_]=b}for(let R=0;R<u-1;R++)this.flameLineOffset[R]=this.flameLineOffset[R+1];if(this.flameLineOffset[u-1]=Math.sin(this.loopCycle/14)*16+Math.sin(this.loopCycle/15)*14+Math.sin(this.loopCycle/16)*12|0,this.flameGradientCycle0>0)this.flameGradientCycle0-=4;if(this.flameGradientCycle1>0)this.flameGradientCycle1-=4;if(this.flameGradientCycle0===0&&this.flameGradientCycle1===0){let R=Math.random()*2000|0;if(R===0)this.flameGradientCycle0=1024;else if(R===1)this.flameGradientCycle1=1024}}updateFlameBuffer(u){if(!this.flameBuffer0||!this.flameBuffer1)return;let R=256;this.flameBuffer0.fill(0);for(let m=0;m<5000;m++){let _=Math.random()*128*R|0;this.flameBuffer0[_]=Math.random()*256|0}for(let m=0;m<20;m++){for(let b=1;b<R-1;b++)for(let E=1;E<127;E++){let O=E+(b<<7);this.flameBuffer1[O]=(this.flameBuffer0[O-1]+this.flameBuffer0[O+1]+this.flameBuffer0[O-128]+this.flameBuffer0[O+128])/4|0}let _=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=_}if(u){let m=0;for(let _=0;_<u.height2d;_++)for(let b=0;b<u.width2d;b++)if(u.pixels[m++]!==0){let E=b+u.cropX+16,O=_+u.cropY+16,I=E+(O<<7);this.flameBuffer0[I]=0}}}drawFlames(){if(!this.flameGradient||!this.flameGradient0||!this.flameGradient1||!this.flameGradient2||!this.flameLineOffset||!this.flameBuffer3)return;let u=256;if(this.flameGradientCycle0>0)for(let _=0;_<256;_++)if(this.flameGradientCycle0>768)this.flameGradient[_]=this.mix(this.flameGradient0[_],1024-this.flameGradientCycle0,this.flameGradient1[_]);else if(this.flameGradientCycle0>256)this.flameGradient[_]=this.flameGradient1[_];else this.flameGradient[_]=this.mix(this.flameGradient1[_],256-this.flameGradientCycle0,this.flameGradient0[_]);else if(this.flameGradientCycle1>0)for(let _=0;_<256;_++)if(this.flameGradientCycle1>768)this.flameGradient[_]=this.mix(this.flameGradient0[_],1024-this.flameGradientCycle1,this.flameGradient2[_]);else if(this.flameGradientCycle1>256)this.flameGradient[_]=this.flameGradient2[_];else this.flameGradient[_]=this.mix(this.flameGradient2[_],256-this.flameGradientCycle1,this.flameGradient0[_]);else for(let _=0;_<256;_++)this.flameGradient[_]=this.flameGradient0[_];for(let _=0;_<33920;_++)if(this.imageTitle0&&this.imageFlamesLeft)this.imageTitle0.pixels[_]=this.imageFlamesLeft.pixels[_];let R=0,m=1152;for(let _=1;_<u-1;_++){let E=(this.flameLineOffset[_]*(u-_)/u|0)+22;if(E<0)E=0;R+=E;for(let O=E;O<128;O++){let I=this.flameBuffer3[R++];if(I===0)m++;else{let L=I,H=256-I;if(I=this.flameGradient[I],this.imageTitle0){let N=this.imageTitle0.pixels[m];this.imageTitle0.pixels[m++]=((I&16711935)*L+(N&16711935)*H&4278255360)+((I&65280)*L+(N&65280)*H&16711680)>>8}}}m+=E}this.imageTitle0?.draw(0,0);for(let _=0;_<33920;_++)if(this.imageTitle1&&this.imageFlamesRight)this.imageTitle1.pixels[_]=this.imageFlamesRight.pixels[_];R=0,m=1176;for(let _=1;_<u-1;_++){let b=this.flameLineOffset[_]*(u-_)/u|0,E=103-b;m+=b;for(let O=0;O<E;O++){let I=this.flameBuffer3[R++];if(I===0)m++;else{let L=I,H=256-I;if(I=this.flameGradient[I],this.imageTitle1){let N=this.imageTitle1.pixels[m];this.imageTitle1.pixels[m++]=((I&16711935)*L+(N&16711935)*H&4278255360)+((I&65280)*L+(N&65280)*H&16711680)>>8}}}R+=128-E,m+=128-E-b}this.imageTitle1?.draw(637,0)}mix(u,R,m){let _=256-R;return((u&16711935)*_+(m&16711935)*R&4278255360)+((u&65280)*_+(m&65280)*R&16711680)>>8}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}getReportAbuseInterfaceId(){return this.reportAbuseInterfaceId}}export{v as Client};

//# debugId=6AAE975BA7A4FA3164756E2164756E21
